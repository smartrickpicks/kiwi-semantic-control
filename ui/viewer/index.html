<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Board Viewer v1.0</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; margin: 0; padding: 0; }
    h1 { margin-bottom: 10px; color: #1a1a2e; }

    .app-layout { display: flex; min-height: 100vh; }
    .nav-sidebar { width: 200px; background: #1a1a2e; color: white; flex-shrink: 0; display: flex; flex-direction: column; }
    .nav-header { padding: 20px; border-bottom: 1px solid #2d2d4a; }
    .nav-header h1 { font-size: 1.1em; color: white; margin: 0; }
    .nav-header .version { font-size: 0.75em; color: #888; margin-top: 4px; }
    .nav-menu { flex-grow: 1; padding: 15px 0; }
    .nav-item { display: flex; align-items: center; padding: 12px 20px; color: #aaa; text-decoration: none; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
    .nav-item:hover { background: #2d2d4a; color: white; }
    .nav-item.active { background: #0f3460; color: white; border-left-color: #1565c0; }
    .nav-icon { width: 20px; margin-right: 12px; text-align: center; }
    .nav-label { font-size: 0.9em; }
    .nav-mode-section { padding: 15px 20px; border-top: 1px solid #2d2d4a; }
    .nav-mode-label { font-size: 0.7em; color: #888; text-transform: uppercase; margin-bottom: 8px; }
    .mode-toggle { display: flex; gap: 5px; flex-wrap: wrap; }
    .mode-btn { padding: 5px 10px; font-size: 0.75em; border: 1px solid #555; background: transparent; color: #aaa; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
    .mode-btn:hover { border-color: #888; color: white; }
    .mode-btn.active { background: #1565c0; border-color: #1565c0; color: white; }
    .mode-btn.mode-operator { }
    .mode-btn.mode-reviewer { }
    .mode-btn.mode-analyst { }

    .main-content { flex-grow: 1; padding: 20px; overflow-y: auto; max-height: 100vh; }
    .page { display: none; }
    .page.active { display: block; }
    .page-header { margin-bottom: 20px; }
    .page-header h2 { color: #1a1a2e; font-size: 1.4em; margin-bottom: 5px; }
    .page-header .page-desc { color: #666; font-size: 0.9em; }

    .mode-hidden { display: none !important; }
    .mode-dimmed { opacity: 0.5; pointer-events: none; }
    h2 { margin: 20px 0 10px; color: #16213e; border-bottom: 2px solid #0f3460; padding-bottom: 5px; }
    .subtitle { color: #666; margin-bottom: 20px; font-size: 0.9em; }
    .summary { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .summary-card { background: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; min-width: 100px; }
    .summary-card .count { font-size: 2em; font-weight: bold; }
    .summary-card .label { font-size: 0.85em; color: #666; text-transform: uppercase; }
    .ready .count { color: #2e7d32; }
    .needs-review .count { color: #f57c00; }
    .blocked .count { color: #c62828; }
    .contracts .count { color: #1565c0; }
    table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9em; }
    th { background: #1a1a2e; color: white; font-weight: 600; }
    tr:hover { background: #e8f4fd; cursor: pointer; }
    tr:last-child td { border-bottom: none; }
    .severity-blocking { background: #ffebee; color: #c62828; font-weight: bold; }
    .severity-warning { background: #fff3e0; color: #e65100; }
    .severity-info { background: #e3f2fd; color: #1565c0; }
    .status-ready { color: #2e7d32; font-weight: bold; }
    .status-needs_review { color: #f57c00; font-weight: bold; }
    .status-blocked { color: #c62828; font-weight: bold; }
    .diff-pane { background: #263238; color: #eceff1; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.85em; white-space: pre-wrap; margin-bottom: 20px; }
    .diff-pane code { display: block; background: #37474f; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .info { background: #e3f2fd; color: #1565c0; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .source-info { font-size: 0.8em; color: #666; margin-bottom: 20px; }
    .null-value { color: #999; font-style: italic; }
    .table-container { overflow-x: auto; }
    .hidden-row { display: none; }

    .toolbar { background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .toolbar-btn { background: #0f3460; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: background 0.2s; }
    .toolbar-btn:hover { background: #1565c0; }
    .toolbar-confirm { display: flex; align-items: center; gap: 8px; color: #ffeb3b; font-size: 0.85em; margin-left: auto; }
    .toolbar-confirm input { width: 18px; height: 18px; cursor: pointer; }
    .toolbar-confirm label { cursor: pointer; }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 8px; max-width: 700px; width: 90%; max-height: 80vh; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .modal-header { background: #1a1a2e; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; }
    .modal-close { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; line-height: 1; }
    .modal-body { padding: 20px; overflow-y: auto; max-height: calc(80vh - 60px); }
    .modal-command { background: #263238; color: #eceff1; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.9em; word-break: break-all; margin-bottom: 15px; }
    .modal-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .modal-btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9em; }
    .modal-btn-primary { background: #1565c0; color: white; }
    .modal-btn-primary:hover { background: #1976d2; }
    .modal-btn-secondary { background: #e0e0e0; color: #333; }
    .modal-btn-secondary:hover { background: #bdbdbd; }
    .modal-btn-danger { background: #c62828; color: white; }
    .modal-btn-danger:hover { background: #d32f2f; }
    .modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-status { margin-top: 15px; padding: 10px; border-radius: 4px; font-size: 0.85em; }
    .modal-status.success { background: #e8f5e9; color: #2e7d32; }
    .modal-status.error { background: #ffebee; color: #c62828; }
    .modal-status.info { background: #e3f2fd; color: #1565c0; }

    .filters { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .filters-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-group label { font-size: 0.75em; color: #666; text-transform: uppercase; font-weight: 600; }
    .filter-search { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em; width: 250px; }
    .filter-chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .filter-chip { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
    .filter-chip.severity-blocking { background: #ffcdd2; border-color: #c62828; }
    .filter-chip.severity-warning { background: #ffe0b2; border-color: #e65100; }
    .filter-chip.severity-info { background: #bbdefb; border-color: #1565c0; }
    .filter-chip.status-ready { background: #c8e6c9; border-color: #2e7d32; }
    .filter-chip.status-needs_review { background: #ffe0b2; border-color: #f57c00; }
    .filter-chip.status-blocked { background: #ffcdd2; border-color: #c62828; }
    .filter-chip.inactive { opacity: 0.4; }
    .filter-chip:hover { opacity: 1; }
    .filter-select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em; min-width: 150px; }

    .drawer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); display: none; z-index: 900; }
    .drawer-overlay.active { display: block; }
    .drawer { position: fixed; top: 0; right: -550px; width: 550px; height: 100vh; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.2); z-index: 901; transition: right 0.3s ease; display: flex; flex-direction: column; }
    .drawer.active { right: 0; }
    .drawer-header { background: #1a1a2e; color: white; padding: 15px 20px; flex-shrink: 0; }
    .drawer-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .drawer-header h3 { margin: 0; font-size: 1em; }
    .drawer-close { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; line-height: 1; }
    .drawer-identity { display: flex; align-items: center; gap: 10px; }
    .identity-pill { background: #0f3460; padding: 6px 12px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.75em; word-break: break-all; flex-grow: 1; }
    .identity-copy { background: #1565c0; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75em; white-space: nowrap; }
    .identity-copy:hover { background: #1976d2; }
    .drawer-tabs { display: flex; background: #263238; flex-shrink: 0; }
    .drawer-tab { flex: 1; padding: 12px 8px; text-align: center; color: #90a4ae; background: none; border: none; cursor: pointer; font-size: 0.85em; border-bottom: 3px solid transparent; transition: all 0.2s; }
    .drawer-tab:hover { color: white; background: #37474f; }
    .drawer-tab.active { color: white; border-bottom-color: #1565c0; background: #37474f; }
    .drawer-tab-count { display: inline-block; background: #455a64; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75em; margin-left: 4px; }
    .drawer-body { padding: 15px; overflow-y: auto; flex-grow: 1; }
    .drawer-json { background: #263238; color: #eceff1; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.8em; white-space: pre-wrap; word-break: break-all; max-height: 100%; overflow-y: auto; }
    .drawer-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
    .drawer-table th, .drawer-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; }
    .drawer-table th { background: #f5f5f5; font-weight: 600; color: #333; }
    .drawer-table tr:hover { background: #f9f9f9; }
    .drawer-empty { color: #666; font-style: italic; padding: 20px; text-align: center; background: #f9f9f9; border-radius: 6px; }
    .drawer-actions { padding: 15px 20px; border-top: 1px solid #eee; flex-shrink: 0; }
    .drawer-btn { padding: 10px 14px; background: #1565c0; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; }
    .drawer-btn:hover { background: #1976d2; }
    .drawer-actions-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .drawer-btn-secondary { background: #455a64; }
    .drawer-btn-secondary:hover { background: #546e7a; }
    .drawer-warning { background: #fff3e0; color: #e65100; padding: 10px 15px; font-size: 0.85em; border-bottom: 1px solid #ffe0b2; }
    .identity-primary { color: #4caf50; font-weight: bold; }
    .identity-fallback { color: #90a4ae; }

    .selection-controls { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
    .selection-btn { padding: 4px 10px; font-size: 0.75em; border: 1px solid #ddd; background: #f5f5f5; border-radius: 4px; cursor: pointer; }
    .selection-btn:hover { background: #e0e0e0; }
    .selection-count { font-size: 0.8em; color: #666; margin-left: auto; }
    .drawer-table input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
    .drawer-table th:first-child, .drawer-table td:first-child { width: 30px; text-align: center; }

    .patch-studio { position: fixed; top: 0; right: -450px; width: 450px; height: 100vh; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.2); z-index: 902; transition: right 0.3s ease; display: flex; flex-direction: column; }
    .patch-studio.active { right: 0; }
    .patch-studio-header { background: #2e7d32; color: white; padding: 15px 20px; flex-shrink: 0; }
    .patch-studio-header h3 { margin: 0 0 5px 0; font-size: 1em; }
    .patch-studio-header-row { display: flex; justify-content: space-between; align-items: center; }
    .patch-studio-close { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; line-height: 1; }
    .patch-studio-body { padding: 15px; overflow-y: auto; flex-grow: 1; }
    .patch-field { margin-bottom: 15px; }
    .patch-field label { display: block; font-size: 0.8em; color: #666; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
    .patch-field input, .patch-field textarea { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; font-family: inherit; }
    .patch-field textarea { min-height: 60px; resize: vertical; }
    .patch-changes-header { display: flex; justify-content: space-between; align-items: center; margin: 15px 0 10px; }
    .patch-changes-header h4 { margin: 0; font-size: 0.9em; color: #333; }
    .patch-changes-list { background: #f9f9f9; border-radius: 6px; max-height: 250px; overflow-y: auto; }
    .patch-change-item { display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid #eee; font-size: 0.85em; }
    .patch-change-item:last-child { border-bottom: none; }
    .patch-change-info { flex-grow: 1; }
    .patch-change-remove { background: none; border: none; color: #c62828; cursor: pointer; font-size: 1.1em; padding: 4px 8px; }
    .patch-change-remove:hover { background: #ffebee; border-radius: 4px; }
    .patch-studio-actions { padding: 15px 20px; border-top: 1px solid #eee; flex-shrink: 0; display: flex; flex-direction: column; gap: 8px; }
    .patch-studio-btn { padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; }
    .patch-studio-btn-primary { background: #2e7d32; color: white; }
    .patch-studio-btn-primary:hover { background: #388e3c; }
    .patch-studio-btn-secondary { background: #455a64; color: white; }
    .patch-studio-btn-secondary:hover { background: #546e7a; }
    .patch-empty { color: #666; font-style: italic; padding: 20px; text-align: center; }
    .evidence-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
    .evidence-section h4 { margin: 0 0 10px 0; font-size: 0.85em; color: #666; text-transform: uppercase; }
    .evidence-btns { display: flex; flex-wrap: wrap; gap: 6px; }
    .evidence-btn { padding: 6px 10px; font-size: 0.75em; background: #e0e0e0; border: none; border-radius: 4px; cursor: pointer; }
    .evidence-btn:hover { background: #bdbdbd; }

    .patch-studio-tabs { display: flex; background: #1b5e20; flex-shrink: 0; }
    .patch-studio-tab { flex: 1; padding: 10px 8px; text-align: center; color: rgba(255,255,255,0.7); background: none; border: none; cursor: pointer; font-size: 0.85em; border-bottom: 3px solid transparent; transition: all 0.2s; }
    .patch-studio-tab:hover { color: white; background: rgba(255,255,255,0.1); }
    .patch-studio-tab.active { color: white; border-bottom-color: #81c784; background: rgba(255,255,255,0.1); }
    .patch-studio-panel { display: none; }
    .patch-studio-panel.active { display: block; }

    .preflight-checklist { margin-bottom: 15px; }
    .preflight-step { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: #f9f9f9; border-radius: 6px; margin-bottom: 8px; }
    .preflight-step-num { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75em; font-weight: bold; flex-shrink: 0; }
    .preflight-step-num.pending { background: #e0e0e0; color: #666; }
    .preflight-step-num.pass { background: #c8e6c9; color: #2e7d32; }
    .preflight-step-num.warn { background: #fff3e0; color: #e65100; }
    .preflight-step-num.fail { background: #ffcdd2; color: #c62828; }
    .preflight-step-info { flex-grow: 1; }
    .preflight-step-title { font-weight: 600; font-size: 0.9em; }
    .preflight-step-status { font-size: 0.75em; color: #666; }
    .preflight-step-chip { padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 600; text-transform: uppercase; }
    .preflight-step-chip.pending { background: #e0e0e0; color: #666; }
    .preflight-step-chip.pass { background: #c8e6c9; color: #2e7d32; }
    .preflight-step-chip.warn { background: #fff3e0; color: #e65100; }
    .preflight-step-chip.fail { background: #ffcdd2; color: #c62828; }

    .preflight-input-group { margin-bottom: 15px; }
    .preflight-input-group label { display: block; font-size: 0.8em; color: #666; margin-bottom: 4px; font-weight: 600; }
    .preflight-input-group textarea { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em; font-family: 'Courier New', monospace; min-height: 80px; resize: vertical; }
    .preflight-input-group input { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; }
    .preflight-input-actions { display: flex; gap: 6px; margin-top: 6px; }
    .preflight-parse-btn { padding: 4px 10px; font-size: 0.75em; background: #1565c0; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .preflight-parse-btn:hover { background: #1976d2; }
    .preflight-clear-btn { padding: 4px 10px; font-size: 0.75em; background: #e0e0e0; border: none; border-radius: 4px; cursor: pointer; }
    .preflight-clear-btn:hover { background: #bdbdbd; }

    .preflight-result { background: #f5f5f5; border-radius: 6px; padding: 10px 12px; margin-top: 8px; font-size: 0.85em; }
    .preflight-result.pass { background: #e8f5e9; border-left: 3px solid #2e7d32; }
    .preflight-result.warn { background: #fff8e1; border-left: 3px solid #f57c00; }
    .preflight-result.fail { background: #ffebee; border-left: 3px solid #c62828; }
    .preflight-result-row { display: flex; justify-content: space-between; padding: 3px 0; }
    .preflight-result-key { color: #666; }
    .preflight-result-val { font-weight: 500; font-family: 'Courier New', monospace; }

    .preflight-conflicts-table { width: 100%; border-collapse: collapse; font-size: 0.8em; margin-top: 10px; }
    .preflight-conflicts-table th, .preflight-conflicts-table td { padding: 6px 8px; text-align: left; border-bottom: 1px solid #eee; }
    .preflight-conflicts-table th { background: #f5f5f5; font-weight: 600; }

    .preflight-section-title { font-size: 0.85em; font-weight: 600; color: #333; margin: 15px 0 8px; padding-bottom: 4px; border-bottom: 1px solid #eee; }
    .preflight-reset-row { display: flex; gap: 8px; margin-top: 15px; }
    .preflight-reset-btn { padding: 8px 14px; font-size: 0.85em; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .preflight-reset-btn:hover { background: #d32f2f; }

    .session-loader { background: #e8eaf6; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .session-loader-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .session-loader-header h3 { margin: 0; font-size: 0.95em; color: #3f51b5; }
    .session-loader-toggle { padding: 6px 12px; font-size: 0.8em; background: #3f51b5; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .session-loader-toggle:hover { background: #5c6bc0; }
    .session-loader-body { display: none; }
    .session-loader-body.active { display: block; }
    .session-loader-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
    .session-loader-field { flex: 1; min-width: 200px; }
    .session-loader-field label { display: block; font-size: 0.75em; color: #666; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
    .session-loader-field input { width: 100%; padding: 8px 10px; border: 1px solid #c5cae9; border-radius: 4px; font-size: 0.85em; font-family: 'Courier New', monospace; }
    .session-loader-actions { display: flex; gap: 8px; }
    .session-loader-btn { padding: 8px 14px; font-size: 0.85em; border: none; border-radius: 4px; cursor: pointer; }
    .session-loader-btn-primary { background: #3f51b5; color: white; }
    .session-loader-btn-primary:hover { background: #5c6bc0; }
    .session-loader-btn-secondary { background: #e0e0e0; color: #333; }
    .session-loader-btn-secondary:hover { background: #bdbdbd; }
    .session-loader-status { margin-top: 10px; font-size: 0.85em; padding: 8px 12px; border-radius: 4px; }
    .session-loader-status.success { background: #e8f5e9; color: #2e7d32; }
    .session-loader-status.error { background: #ffebee; color: #c62828; }
    .session-loader-status.info { background: #e3f2fd; color: #1565c0; }

    .delta-summary { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .delta-card { background: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; min-width: 90px; border-left: 4px solid #9e9e9e; }
    .delta-card.positive { border-left-color: #4caf50; }
    .delta-card.negative { border-left-color: #f44336; }
    .delta-card.neutral { border-left-color: #9e9e9e; }
    .delta-card .delta-value { font-size: 1.5em; font-weight: bold; }
    .delta-card .delta-value.positive { color: #4caf50; }
    .delta-card .delta-value.negative { color: #f44336; }
    .delta-card .delta-value.neutral { color: #9e9e9e; }
    .delta-card .delta-label { font-size: 0.75em; color: #666; text-transform: uppercase; }
    .delta-card .delta-detail { font-size: 0.7em; color: #999; margin-top: 2px; }

    .row-added { background: #e8f5e9 !important; }
    .row-added td:first-child::before { content: '+'; color: #4caf50; font-weight: bold; margin-right: 4px; }
    .row-removed { background: #ffebee !important; text-decoration: line-through; opacity: 0.7; }
    .row-removed td:first-child::before { content: '-'; color: #f44336; font-weight: bold; margin-right: 4px; }
    .row-changed { background: #fff3e0 !important; }
    .row-changed td:first-child::before { content: '~'; color: #ff9800; font-weight: bold; margin-right: 4px; }

    .compare-legend { display: flex; gap: 15px; margin-bottom: 10px; font-size: 0.8em; }
    .compare-legend-item { display: flex; align-items: center; gap: 4px; }
    .compare-legend-dot { width: 12px; height: 12px; border-radius: 2px; }
    .compare-legend-dot.added { background: #4caf50; }
    .compare-legend-dot.changed { background: #ff9800; }
    .compare-legend-dot.removed { background: #f44336; }

    .compare-actions { display: flex; gap: 10px; margin-bottom: 15px; }
    .compare-btn { padding: 8px 14px; font-size: 0.85em; background: #7c4dff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .compare-btn:hover { background: #651fff; }

    .config-inspector { background: #fce4ec; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .config-inspector-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .config-inspector-header h3 { margin: 0; font-size: 0.95em; color: #880e4f; }
    .config-inspector-toggle { padding: 6px 12px; font-size: 0.8em; background: #880e4f; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .config-inspector-toggle:hover { background: #ad1457; }
    .config-inspector-body { display: none; }
    .config-inspector-body.active { display: block; }
    .config-inspector-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
    .config-inspector-field { flex: 1; min-width: 200px; }
    .config-inspector-field label { display: block; font-size: 0.75em; color: #666; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
    .config-inspector-field input { width: 100%; padding: 8px 10px; border: 1px solid #f8bbd9; border-radius: 4px; font-size: 0.85em; font-family: 'Courier New', monospace; }
    .config-inspector-actions { display: flex; gap: 8px; }
    .config-inspector-btn { padding: 8px 14px; font-size: 0.85em; border: none; border-radius: 4px; cursor: pointer; }
    .config-inspector-btn-primary { background: #880e4f; color: white; }
    .config-inspector-btn-primary:hover { background: #ad1457; }
    .config-inspector-btn-secondary { background: #e0e0e0; color: #333; }
    .config-inspector-btn-secondary:hover { background: #bdbdbd; }
    .config-inspector-status { margin-top: 10px; font-size: 0.85em; padding: 8px 12px; border-radius: 4px; }
    .config-inspector-status.success { background: #e8f5e9; color: #2e7d32; }
    .config-inspector-status.error { background: #ffebee; color: #c62828; }
    .config-inspector-status.info { background: #e3f2fd; color: #1565c0; }

    .patch-summary { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .patch-summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .patch-summary-header h4 { margin: 0; font-size: 0.95em; color: #333; }
    .patch-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
    .patch-summary-item { }
    .patch-summary-item label { display: block; font-size: 0.7em; color: #666; text-transform: uppercase; margin-bottom: 2px; }
    .patch-summary-item .value { font-family: 'Courier New', monospace; font-size: 0.9em; }
    .version-chip { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; font-weight: 600; }
    .version-chip.match { background: #c8e6c9; color: #2e7d32; }
    .version-chip.mismatch { background: #ffcdd2; color: #c62828; }

    .ruleset-delta { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .ruleset-delta h4 { margin: 0 0 10px 0; font-size: 0.95em; color: #333; }
    .ruleset-delta-counts { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; }
    .ruleset-count-card { background: #f5f5f5; padding: 8px 12px; border-radius: 6px; text-align: center; min-width: 80px; }
    .ruleset-count-card .count { font-size: 1.3em; font-weight: bold; }
    .ruleset-count-card .count.added { color: #4caf50; }
    .ruleset-count-card .count.deprecated { color: #f44336; }
    .ruleset-count-card .label { font-size: 0.7em; color: #666; text-transform: uppercase; }

    .changes-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
    .changes-table th, .changes-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; }
    .changes-table th { background: #880e4f; color: white; font-weight: 600; }
    .changes-table tr:hover { background: #fce4ec; }
    .action-chip { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; font-weight: 600; }
    .action-chip.add_rule { background: #c8e6c9; color: #2e7d32; }
    .action-chip.deprecate_rule { background: #ffcdd2; color: #c62828; }

    .config-inspector-copy-actions { display: flex; gap: 10px; margin-top: 15px; }
    .config-copy-btn { padding: 8px 14px; font-size: 0.85em; background: #880e4f; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .config-copy-btn:hover { background: #ad1457; }

    .stream-panel { background: #e0f2f1; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .stream-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .stream-panel-header h3 { margin: 0; font-size: 0.95em; color: #00695c; }
    .stream-panel-toggle { padding: 6px 12px; font-size: 0.8em; background: #00695c; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .stream-panel-toggle:hover { background: #00897b; }
    .stream-panel-body { display: none; }
    .stream-panel-body.active { display: block; }

    .stream-concept { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .stream-concept h4 { margin: 0 0 10px 0; font-size: 0.95em; color: #00695c; }
    .stream-concept p { font-size: 0.85em; color: #555; line-height: 1.5; margin-bottom: 10px; }

    .session-timeline { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; }
    .session-card { background: white; border-radius: 8px; padding: 12px; min-width: 180px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #00695c; }
    .session-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .session-card-title { font-weight: 600; font-size: 0.9em; color: #333; }
    .session-card-idx { font-size: 0.75em; color: #666; background: #e0e0e0; padding: 2px 6px; border-radius: 10px; }
    .session-card-stats { font-size: 0.8em; color: #666; }
    .session-card-stats div { display: flex; justify-content: space-between; padding: 2px 0; }

    .state-chip { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 600; text-transform: uppercase; }
    .state-chip.consolidated { background: #c8e6c9; color: #2e7d32; }
    .state-chip.partial { background: #fff3e0; color: #e65100; }
    .state-chip.waiting { background: #e3f2fd; color: #1565c0; }
    .state-chip.blocked { background: #ffcdd2; color: #c62828; }

    .state-legend { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
    .state-legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8em; }

    .flow-diagram { background: #fafafa; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
    .flow-diagram-title { font-weight: 600; font-size: 0.9em; color: #333; margin-bottom: 10px; }
    .flow-stages { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .flow-stage { background: white; padding: 10px 15px; border-radius: 6px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-width: 100px; }
    .flow-stage-name { font-size: 0.8em; font-weight: 600; color: #333; }
    .flow-stage-desc { font-size: 0.7em; color: #666; margin-top: 4px; }
    .flow-arrow { color: #00695c; font-size: 1.2em; }
    .flow-stage.source { border-left: 3px solid #1565c0; }
    .flow-stage.process { border-left: 3px solid #00695c; }
    .flow-stage.output { border-left: 3px solid #2e7d32; }
    .flow-stage.hold { border-left: 3px solid #ff9800; }

    .reconsolidation-table { width: 100%; border-collapse: collapse; font-size: 0.85em; margin-bottom: 15px; }
    .reconsolidation-table th, .reconsolidation-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; }
    .reconsolidation-table th { background: #00695c; color: white; font-weight: 600; }
    .reconsolidation-table tr:hover { background: #e0f2f1; }

    .stream-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .stream-btn { padding: 8px 14px; font-size: 0.85em; background: #00695c; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .stream-btn:hover { background: #00897b; }

    .record-state-summary { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
    .record-state-card { background: white; padding: 10px 15px; border-radius: 6px; text-align: center; min-width: 100px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .record-state-card .count { font-size: 1.3em; font-weight: bold; }
    .record-state-card .label { font-size: 0.7em; color: #666; text-transform: uppercase; }
    .record-state-card.consolidated .count { color: #2e7d32; }
    .record-state-card.partial .count { color: #e65100; }
    .record-state-card.waiting .count { color: #1565c0; }
    .record-state-card.blocked .count { color: #c62828; }
  </style>
</head>
<body>
  <div class="app-layout">
    <nav class="nav-sidebar">
      <div class="nav-header">
        <h1>Control Board</h1>
        <div class="version">v1.0 | Governance-only</div>
      </div>
      <div class="nav-menu">
        <a class="nav-item active" data-page="run" href="#/run">
          <span class="nav-icon">▶</span>
          <span class="nav-label">Run</span>
        </a>
        <a class="nav-item" data-page="triage" href="#/triage">
          <span class="nav-icon">⚡</span>
          <span class="nav-label">Triage</span>
        </a>
        <a class="nav-item" data-page="patch" href="#/patch">
          <span class="nav-icon">✎</span>
          <span class="nav-label">Patch Studio</span>
        </a>
        <a class="nav-item" data-page="review" href="#/review">
          <span class="nav-icon">✓</span>
          <span class="nav-label">Review</span>
        </a>
      </div>
      <div class="nav-mode-section">
        <div class="nav-mode-label">View Mode</div>
        <div class="mode-toggle">
          <button class="mode-btn mode-operator active" data-mode="operator">Operator</button>
          <button class="mode-btn mode-reviewer" data-mode="reviewer">Reviewer</button>
          <button class="mode-btn mode-analyst" data-mode="analyst">Analyst</button>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <!-- RUN PAGE -->
      <div class="page active" id="page-run">
        <div class="page-header">
          <h2>Run</h2>
          <p class="page-desc">Execute validation and preview commands, view dataset paths and last-run status.</p>
        </div>

        <div class="toolbar" id="toolbar">
          <button class="toolbar-btn" data-cmd="validate">Validate</button>
          <button class="toolbar-btn" data-cmd="preview_baseline">Preview Baseline</button>
          <button class="toolbar-btn" data-cmd="preview_edge">Preview Edge</button>
          <button class="toolbar-btn" data-cmd="smoke_baseline">Smoke Baseline</button>
          <button class="toolbar-btn" data-cmd="smoke_edge">Smoke Edge</button>
          <div class="toolbar-confirm">
            <input type="checkbox" id="confirm-run">
            <label for="confirm-run">I CONFIRM RUN</label>
          </div>
        </div>

        <div id="source-info" class="source-info"></div>
        <div id="error-container"></div>
        
        <div id="run-summary-container"></div>

        <div id="diff-container">
          <h2>Diff Verification</h2>
          <div class="diff-pane">
To verify determinism, run the smoke test in your terminal:
<code>bash scripts/replit_smoke.sh</code>
This compares out/sf_packet.preview.json against expected output.
If differences are found, the script will show a unified diff.

Note: This viewer does NOT execute any commands automatically.
          </div>
        </div>

        <div class="stream-panel" id="stream-panel">
    <div class="stream-panel-header">
      <h3>Session + Stream Model (Conceptual)</h3>
      <button class="stream-panel-toggle" id="stream-panel-toggle">Show</button>
    </div>
    <div class="stream-panel-body" id="stream-panel-body">
      <div class="stream-concept">
        <h4>Never-Stop Flow (Open Faucet Model)</h4>
        <p>In a continuous pipeline, records flow like water through an open faucet. <strong>Good records</strong> (CONSOLIDATED) pass through immediately. <strong>Partial records</strong> wait in a holding area until missing data arrives in later sessions, then rejoin the flow. <strong>Blocked records</strong> require manual intervention before proceeding.</p>
        <p>This model prevents backlogs: instead of stopping the entire pipeline for one problem, issues are isolated and resolved asynchronously while the rest of the data flows through.</p>
      </div>

      <div class="flow-diagram">
        <div class="flow-diagram-title">Flow Visualization</div>
        <div class="flow-stages">
          <div class="flow-stage source">
            <div class="flow-stage-name">Ingest</div>
            <div class="flow-stage-desc">New records arrive</div>
          </div>
          <span class="flow-arrow">→</span>
          <div class="flow-stage process">
            <div class="flow-stage-name">Validate</div>
            <div class="flow-stage-desc">Apply semantic rules</div>
          </div>
          <span class="flow-arrow">→</span>
          <div class="flow-stage output">
            <div class="flow-stage-name">Consolidated</div>
            <div class="flow-stage-desc">Ready for downstream</div>
          </div>
          <span class="flow-arrow" style="opacity: 0.3;">↓</span>
          <div class="flow-stage hold">
            <div class="flow-stage-name">Holding</div>
            <div class="flow-stage-desc">Partial/Waiting records</div>
          </div>
          <span class="flow-arrow">→</span>
          <div class="flow-stage process">
            <div class="flow-stage-name">Reconsolidate</div>
            <div class="flow-stage-desc">Later session resolves</div>
          </div>
        </div>
      </div>

      <div class="stream-concept">
        <h4>Record State Model</h4>
        <div class="state-legend">
          <div class="state-legend-item"><span class="state-chip consolidated">CONSOLIDATED</span> No blocking/warning issues - flows through</div>
          <div class="state-legend-item"><span class="state-chip partial">PARTIAL</span> Has warnings - usable but incomplete</div>
          <div class="state-legend-item"><span class="state-chip waiting">WAITING</span> Missing required data - held for later</div>
          <div class="state-legend-item"><span class="state-chip blocked">BLOCKED</span> Blocking issues - requires manual fix</div>
        </div>
      </div>

      <div class="stream-concept">
        <h4>Current Dataset State Summary</h4>
        <div id="record-state-summary" class="record-state-summary"></div>
      </div>

      <div class="stream-concept">
        <h4>Simulated Session Timeline</h4>
        <p style="margin-bottom: 10px;">This timeline models how records would arrive and be processed across multiple ingest waves. Each session shows the state distribution at that point in time.</p>
        <div id="session-timeline" class="session-timeline"></div>
      </div>

      <div class="stream-concept">
        <h4>Reconsolidation Rules</h4>
        <table class="reconsolidation-table">
          <thead>
            <tr>
              <th>Current State</th>
              <th>Condition</th>
              <th>New State</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><span class="state-chip partial">PARTIAL</span></td>
              <td>All warnings resolved in later session</td>
              <td><span class="state-chip consolidated">CONSOLIDATED</span></td>
              <td>Release to downstream</td>
            </tr>
            <tr>
              <td><span class="state-chip waiting">WAITING</span></td>
              <td>Missing data arrives</td>
              <td><span class="state-chip partial">PARTIAL</span> or <span class="state-chip consolidated">CONSOLIDATED</span></td>
              <td>Re-evaluate with new data</td>
            </tr>
            <tr>
              <td><span class="state-chip blocked">BLOCKED</span></td>
              <td>Manual intervention + re-submit</td>
              <td><span class="state-chip consolidated">CONSOLIDATED</span></td>
              <td>Operator action required</td>
            </tr>
            <tr>
              <td><span class="state-chip consolidated">CONSOLIDATED</span></td>
              <td>New blocking issue detected</td>
              <td><span class="state-chip blocked">BLOCKED</span></td>
              <td>Hold and notify</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="stream-actions">
        <button class="stream-btn" id="copy-stream-semantics">Copy Stream Semantics (Markdown)</button>
        <button class="stream-btn" id="simulate-sessions">Simulate Sessions from Data</button>
      </div>
    </div>
  </div>
      </div><!-- end page-run -->

      <!-- TRIAGE PAGE -->
      <div class="page" id="page-triage">
        <div class="page-header">
          <h2>Triage</h2>
          <p class="page-desc">View summary cards, filter issues by severity/status, and drill down into records.</p>
        </div>

        <div class="filters" id="filters">
          <div class="filters-row">
            <div class="filter-group">
              <label>Search</label>
              <input type="text" class="filter-search" id="filter-search" placeholder="Search all fields...">
            </div>
            <div class="filter-group">
              <label>Severity</label>
              <div class="filter-chips" id="severity-chips">
                <span class="filter-chip severity-blocking" data-severity="blocking">Blocking</span>
                <span class="filter-chip severity-warning" data-severity="warning">Warning</span>
                <span class="filter-chip severity-info" data-severity="info">Info</span>
              </div>
            </div>
            <div class="filter-group">
              <label>Status</label>
              <div class="filter-chips" id="status-chips">
                <span class="filter-chip status-ready" data-status="ready">Ready</span>
                <span class="filter-chip status-needs_review" data-status="needs_review">Needs Review</span>
                <span class="filter-chip status-blocked" data-status="blocked">Blocked</span>
              </div>
            </div>
            <div class="filter-group">
              <label>Subtype</label>
              <select class="filter-select" id="filter-subtype">
                <option value="">All Subtypes</option>
              </select>
            </div>
          </div>
        </div>

        <div id="delta-container" style="display: none;"></div>
        <div id="summary-container"></div>
        <div id="contract-results-container"></div>
        <div id="issues-container"></div>
        <div id="field-actions-container"></div>
      </div><!-- end page-triage -->

      <!-- PATCH STUDIO PAGE -->
      <div class="page" id="page-patch">
        <div class="page-header">
          <h2>Patch Studio</h2>
          <p class="page-desc">Select records, build rule patches, validate with preflight gate, and export.</p>
        </div>

        <div class="preflight-gate" id="preflight-gate">
          <div class="preflight-header">
            <h3>Preflight Gate (PR Checklist)</h3>
            <button class="preflight-toggle" id="preflight-toggle">Show</button>
          </div>
          <div class="preflight-body" id="preflight-body">
            <div class="preflight-checklist">
              <div class="preflight-item" data-step="1">
                <div class="preflight-checkbox"></div>
                <div class="preflight-content">
                  <div class="preflight-label">Step 1: Validate Config</div>
                  <div class="preflight-evidence" id="evidence-1"></div>
                </div>
              </div>
              <div class="preflight-item" data-step="2">
                <div class="preflight-checkbox"></div>
                <div class="preflight-content">
                  <div class="preflight-label">Step 2: Preview Baseline</div>
                  <div class="preflight-evidence" id="evidence-2"></div>
                </div>
              </div>
              <div class="preflight-item" data-step="3">
                <div class="preflight-checkbox"></div>
                <div class="preflight-content">
                  <div class="preflight-label">Step 3: Smoke Baseline</div>
                  <div class="preflight-evidence" id="evidence-3"></div>
                </div>
              </div>
              <div class="preflight-item" data-step="4">
                <div class="preflight-checkbox"></div>
                <div class="preflight-content">
                  <div class="preflight-label">Step 4: Smoke Edge</div>
                  <div class="preflight-evidence" id="evidence-4"></div>
                </div>
              </div>
            </div>
            <div class="preflight-paste">
              <label>Paste Terminal Output (auto-parses evidence)</label>
              <textarea id="preflight-paste-area" placeholder="Paste terminal output here to auto-extract evidence..."></textarea>
              <button class="preflight-parse-btn" id="preflight-parse">Parse Evidence</button>
            </div>
            <div class="preflight-actions">
              <button class="preflight-btn preflight-btn-secondary" id="preflight-reset">Reset All</button>
              <button class="preflight-btn preflight-btn-primary" id="preflight-copy-evidence">Copy Evidence Summary</button>
            </div>
            <div class="preflight-summary" id="preflight-summary"></div>
          </div>
        </div>

        <div class="patch-studio-inline" id="patch-studio-inline">
          <h3>Patch Draft Builder</h3>
          <p class="page-desc">Open Record Workbench from Triage page to select records and add rules.</p>
          <div id="patch-draft-summary"></div>
          <div class="patch-studio-inline-actions">
            <button class="toolbar-btn" id="open-patch-studio">Open Full Patch Studio</button>
            <button class="toolbar-btn" id="copy-patch-json">Copy Patch JSON</button>
            <button class="toolbar-btn" id="copy-pr-summary">Copy PR Summary</button>
          </div>
        </div>
      </div><!-- end page-patch -->

      <!-- REVIEW PAGE -->
      <div class="page" id="page-review">
        <div class="page-header">
          <h2>Review</h2>
          <p class="page-desc">Inspect config deltas, compare artifact versions, and generate evidence summaries.</p>
        </div>

        <div class="config-inspector" id="config-inspector">
    <div class="config-inspector-header">
      <h3>Config + Patch Inspector (Ruleset Delta)</h3>
      <button class="config-inspector-toggle" id="config-inspector-toggle">Show</button>
    </div>
    <div class="config-inspector-body" id="config-inspector-body">
      <div class="config-inspector-row">
        <div class="config-inspector-field">
          <label>Base Config Path</label>
          <input type="text" id="base-config-path" value="config/config_pack.base.json" placeholder="config/config_pack.base.json">
        </div>
        <div class="config-inspector-field">
          <label>Patch Path</label>
          <input type="text" id="patch-path" value="config/config_pack.example.patch.json" placeholder="config/config_pack.example.patch.json">
        </div>
        <div class="config-inspector-actions">
          <button class="config-inspector-btn config-inspector-btn-primary" id="load-config">Load Config</button>
          <button class="config-inspector-btn config-inspector-btn-secondary" id="clear-config">Clear</button>
        </div>
      </div>
      <div class="config-inspector-status" id="config-status" style="display: none;"></div>
      <div id="config-results" style="display: none;">
        <div class="patch-summary" id="patch-summary"></div>
        <div class="ruleset-delta" id="ruleset-delta"></div>
        <div class="table-container">
          <table class="changes-table" id="changes-table"></table>
        </div>
        <div class="config-inspector-copy-actions">
          <button class="config-copy-btn" id="copy-ruleset-delta">Copy Ruleset Delta (Markdown)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="session-loader" id="session-loader">
    <div class="session-loader-header">
      <h3>Session Loader (Comparison Mode)</h3>
      <button class="session-loader-toggle" id="session-loader-toggle">Show</button>
    </div>
    <div class="session-loader-body" id="session-loader-body">
      <div class="session-loader-row">
        <div class="session-loader-field">
          <label>Primary Artifact Path</label>
          <input type="text" id="primary-path" value="out/sf_packet.preview.json" placeholder="out/sf_packet.preview.json">
        </div>
        <div class="session-loader-field">
          <label>Comparison Artifact Path (optional)</label>
          <input type="text" id="compare-path" placeholder="out/sf_packet.preview.prev.json">
        </div>
        <div class="session-loader-actions">
          <button class="session-loader-btn session-loader-btn-primary" id="load-session">Load</button>
          <button class="session-loader-btn session-loader-btn-secondary" id="clear-compare">Clear Compare</button>
        </div>
      </div>
      <div class="session-loader-status" id="session-status" style="display: none;"></div>
    </div>
  </div>

        <div id="review-evidence-summary" class="evidence-summary-panel"></div>
      </div><!-- end page-review -->

    </main><!-- end main-content -->
  </div><!-- end app-layout -->

  <!-- Global Modals and Drawers (outside pages) -->
  <div class="modal-overlay" id="command-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-title">Command</h3>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p id="modal-description" style="margin-bottom: 15px; color: #666;"></p>
        <div class="modal-command" id="modal-command"></div>
        <div class="modal-actions">
          <button class="modal-btn modal-btn-primary" id="modal-copy">Copy to Clipboard</button>
          <button class="modal-btn modal-btn-danger" id="modal-run" disabled>Run (Confirm Required)</button>
          <button class="modal-btn modal-btn-secondary" id="modal-cancel">Cancel</button>
        </div>
        <div class="modal-status" id="modal-status" style="display: none;"></div>
      </div>
    </div>
  </div>

  <div class="drawer-overlay" id="drawer-overlay"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-header">
      <div class="drawer-header-row">
        <h3>Record Workbench</h3>
        <button class="drawer-close" id="drawer-close">&times;</button>
      </div>
      <div class="drawer-identity">
        <div class="identity-pill" id="identity-pill"></div>
        <button class="identity-copy" id="identity-copy">Copy ID</button>
      </div>
    </div>
    <div class="drawer-tabs" id="drawer-tabs">
      <button class="drawer-tab active" data-tab="contract">Contract</button>
      <button class="drawer-tab" data-tab="issues">Issues <span class="drawer-tab-count" id="issues-count">0</span></button>
      <button class="drawer-tab" data-tab="actions">Actions <span class="drawer-tab-count" id="actions-count">0</span></button>
      <button class="drawer-tab" data-tab="changelog">Change Log <span class="drawer-tab-count" id="changelog-count">0</span></button>
    </div>
    <div class="drawer-warning" id="drawer-warning" style="display: none;"></div>
    <div class="drawer-body" id="drawer-body"></div>
    <div class="drawer-actions">
      <div class="drawer-actions-grid">
        <button class="drawer-btn" id="drawer-copy">Copy JSON</button>
        <button class="drawer-btn drawer-btn-secondary" id="copy-pr-summary">Copy PR Summary</button>
        <button class="drawer-btn drawer-btn-secondary" id="copy-rule-draft">Copy Rule Draft</button>
        <button class="drawer-btn" id="open-patch-studio" style="background: #2e7d32;">Patch Studio</button>
      </div>
    </div>
  </div>

  <div class="patch-studio" id="patch-studio">
    <div class="patch-studio-header">
      <div class="patch-studio-header-row">
        <h3>Patch Studio</h3>
        <button class="patch-studio-close" id="patch-studio-close">&times;</button>
      </div>
      <span style="font-size: 0.8em; opacity: 0.8;">Build and validate patch drafts</span>
    </div>
    <div class="patch-studio-tabs">
      <button class="patch-studio-tab active" data-panel="draft">Draft</button>
      <button class="patch-studio-tab" data-panel="preflight">Preflight</button>
    </div>
    <div class="patch-studio-body">
      <div class="patch-studio-panel active" id="panel-draft">
        <div class="patch-field">
          <label>Base Version</label>
          <input type="text" id="patch-base-version" placeholder="0.1.0" value="0.1.0">
        </div>
        <div class="patch-field">
          <label>Author</label>
          <input type="text" id="patch-author" placeholder="operator@example.com">
        </div>
        <div class="patch-field">
          <label>Rationale</label>
          <textarea id="patch-rationale" placeholder="Describe why this patch is needed..."></textarea>
        </div>
        <div class="patch-changes-header">
          <h4>Changes (<span id="patch-changes-count">0</span>)</h4>
          <button class="selection-btn" id="clear-patch-changes">Clear All</button>
        </div>
        <div class="patch-changes-list" id="patch-changes-list">
          <div class="patch-empty">No changes added. Select issues/actions in the Workbench tabs and add them here.</div>
        </div>
        <div class="evidence-section">
          <h4>Evidence Helper (Copy Only)</h4>
          <div class="evidence-btns">
            <button class="evidence-btn" id="copy-smoke-baseline">Smoke Baseline</button>
            <button class="evidence-btn" id="copy-smoke-edge">Smoke Edge</button>
            <button class="evidence-btn" id="copy-evidence-template">Evidence Template</button>
          </div>
        </div>
      </div>
      <div class="patch-studio-panel" id="panel-preflight">
        <div class="preflight-checklist" id="preflight-checklist"></div>
        <div class="preflight-section-title">1. Base Version Check</div>
        <div class="preflight-input-group">
          <label>Base Version (or paste base JSON header)</label>
          <input type="text" id="preflight-base-version" placeholder='0.1.0 or {"version": "0.1.0", ...}'>
          <div class="preflight-input-actions">
            <button class="preflight-parse-btn" data-parse="base-version">Parse</button>
            <button class="preflight-clear-btn" data-clear="base-version">Clear</button>
          </div>
          <div class="preflight-result" id="preflight-base-result" style="display: none;"></div>
        </div>
        <div class="preflight-section-title">2. Validation Report</div>
        <div class="preflight-input-group">
          <label>Paste validator output (stdout/stderr or JSON)</label>
          <textarea id="preflight-validation-input" placeholder="OK: configuration valid&#10;base.version: 0.1.0&#10;patch.base_version: 0.1.0&#10;changes_count: 3"></textarea>
          <div class="preflight-input-actions">
            <button class="preflight-parse-btn" data-parse="validation">Parse</button>
            <button class="preflight-clear-btn" data-clear="validation">Clear</button>
          </div>
          <div class="preflight-result" id="preflight-validation-result" style="display: none;"></div>
        </div>
        <div class="preflight-section-title">3. Conflict Check</div>
        <div class="preflight-input-group">
          <label>Paste conflict report (or type "reviewed" for manual confirmation)</label>
          <textarea id="preflight-conflict-input" placeholder="No conflicts found&#10;OR&#10;reviewed"></textarea>
          <div class="preflight-input-actions">
            <button class="preflight-parse-btn" data-parse="conflict">Parse</button>
            <button class="preflight-clear-btn" data-clear="conflict">Clear</button>
          </div>
          <div class="preflight-result" id="preflight-conflict-result" style="display: none;"></div>
        </div>
        <div class="preflight-section-title">4. Smoke Evidence</div>
        <div class="preflight-input-group">
          <label>Paste smoke test output (baseline)</label>
          <textarea id="preflight-smoke-baseline-input" placeholder="OK: preview output matches expected"></textarea>
          <div class="preflight-input-actions">
            <button class="preflight-parse-btn" data-parse="smoke-baseline">Parse</button>
            <button class="preflight-clear-btn" data-clear="smoke-baseline">Clear</button>
          </div>
        </div>
        <div class="preflight-input-group">
          <label>Paste smoke test output (edge, optional)</label>
          <textarea id="preflight-smoke-edge-input" placeholder="OK: preview output matches expected"></textarea>
          <div class="preflight-input-actions">
            <button class="preflight-parse-btn" data-parse="smoke-edge">Parse</button>
            <button class="preflight-clear-btn" data-clear="smoke-edge">Clear</button>
          </div>
        </div>
        <div class="preflight-input-group">
          <label>SHA256 Hashes (optional)</label>
          <input type="text" id="preflight-sha256" placeholder="patch: abc123..., output: def456...">
        </div>
        <div class="preflight-result" id="preflight-smoke-result" style="display: none;"></div>
        <div class="preflight-reset-row">
          <button class="preflight-reset-btn" id="preflight-reset">Reset All Evidence</button>
        </div>
      </div>
    </div>
    <div class="patch-studio-actions">
      <button class="patch-studio-btn patch-studio-btn-primary" id="copy-full-patch">Copy Full Patch Draft (JSON)</button>
      <button class="patch-studio-btn patch-studio-btn-secondary" id="copy-rule-mapping">Copy Rule Mapping (JSON)</button>
      <button class="patch-studio-btn patch-studio-btn-secondary" id="copy-grouped-rules">Copy Grouped Rule Draft</button>
    </div>
  </div>

  <script>
    const PRIMARY_PATH = 'out/sf_packet.preview.json';
    const FALLBACK_PATH = 'examples/expected_outputs/sf_packet.example.json';
    const RELATIVE_PRIMARY = '../../out/sf_packet.preview.json';
    const RELATIVE_FALLBACK = '../../examples/expected_outputs/sf_packet.example.json';
    const COMMANDS_PATH = 'run_commands.json';
    const STORAGE_KEY = 'viewer_selection_v10';
    const PREFLIGHT_STORAGE_KEY = 'viewer_preflight_v10';
    const PATCH_STORAGE_KEY = 'viewer_patch_v10';
    const COMPARISON_PATH = '../../out/sf_packet.preview.prev.json';

    let loadedBaseConfig = null;
    let loadedPatch = null;
    let configVersionMatch = null;

    let commands = {};
    let allData = { contractResults: [], issues: [], fieldActions: [], changeLog: [] };
    let compareData = null;
    let rowChanges = { contractResults: {}, issues: {}, fieldActions: {} };
    let deltaStats = null;
    let activeFilters = { search: '', severities: ['blocking', 'warning', 'info'], statuses: ['ready', 'needs_review', 'blocked'], subtype: '' };
    let currentSelection = { joinIdentity: null, contractIdx: null, activeTab: 'contract' };
    let selectedRecords = { issues: new Set(), actions: new Set(), changelog: new Set() };
    let patchDraft = { baseVersion: '0.1.0', author: '', rationale: '', changes: [] };
    let preflightEvidence = {
      baseVersion: { raw: '', parsed: null, status: 'pending' },
      validation: { raw: '', parsed: null, status: 'pending' },
      conflict: { raw: '', parsed: null, status: 'pending' },
      smokeBaseline: { raw: '', parsed: null, status: 'pending' },
      smokeEdge: { raw: '', parsed: null, status: 'pending' },
      sha256: ''
    };

    let currentMode = 'operator';

    function navigateTo(page) {
      const pages = ['run', 'triage', 'patch', 'review'];
      if (!pages.includes(page)) page = 'run';
      
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      const pageEl = document.getElementById(`page-${page}`);
      const navEl = document.querySelector(`.nav-item[data-page="${page}"]`);
      
      if (pageEl) pageEl.classList.add('active');
      if (navEl) navEl.classList.add('active');
      
      window.location.hash = `#/${page}`;
    }

    function setMode(mode) {
      const modes = ['operator', 'reviewer', 'analyst'];
      if (!modes.includes(mode)) mode = 'operator';
      currentMode = mode;
      
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      const modeBtn = document.querySelector(`.mode-btn[data-mode="${mode}"]`);
      if (modeBtn) modeBtn.classList.add('active');
      
      applyModeVisibility(mode);
      localStorage.setItem('viewer_mode_v10', mode);
    }

    function applyModeVisibility(mode) {
      const opElements = document.querySelectorAll('[data-mode-operator]');
      const revElements = document.querySelectorAll('[data-mode-reviewer]');
      const anlElements = document.querySelectorAll('[data-mode-analyst]');
      
      opElements.forEach(el => {
        el.classList.toggle('mode-hidden', mode !== 'operator' && !el.dataset.modeReviewer && !el.dataset.modeAnalyst);
      });
      revElements.forEach(el => {
        el.classList.toggle('mode-hidden', mode !== 'reviewer' && !el.dataset.modeOperator && !el.dataset.modeAnalyst);
      });
      anlElements.forEach(el => {
        el.classList.toggle('mode-hidden', mode !== 'analyst' && !el.dataset.modeOperator && !el.dataset.modeReviewer);
      });
    }

    function initRouter() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const page = item.dataset.page;
          navigateTo(page);
        });
      });
      
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          setMode(btn.dataset.mode);
        });
      });
      
      window.addEventListener('hashchange', () => {
        const hash = window.location.hash.replace('#/', '') || 'run';
        navigateTo(hash);
      });
      
      const savedMode = localStorage.getItem('viewer_mode_v10');
      if (savedMode) setMode(savedMode);
      
      const hash = window.location.hash.replace('#/', '') || 'run';
      navigateTo(hash);
    }

    function getRecordHash(record) {
      const sorted = sortObjectKeys(record);
      return JSON.stringify(sorted);
    }

    function getJoinKey(record) {
      const identity = getJoinIdentity(record);
      return `${identity.contract_key || ''}|${identity.file_url || ''}|${identity.file_name || ''}`;
    }

    function getRowKey(record, type) {
      const jk = getJoinKey(record);
      if (type === 'contractResults') {
        return jk;
      } else if (type === 'issues') {
        return `${jk}|${record.sheet || ''}|${record.field || ''}|${record.issue_type || ''}`;
      } else if (type === 'fieldActions') {
        return `${jk}|${record.sheet || ''}|${record.field || ''}|${record.action || ''}`;
      }
      return jk;
    }

    function computeRowChanges(primaryArr, compareArr, type) {
      const changes = {};
      const primaryMap = new Map();
      const compareMap = new Map();
      
      primaryArr.forEach(r => {
        const key = getRowKey(r, type);
        primaryMap.set(key, { record: r, hash: getRecordHash(r) });
      });
      
      compareArr.forEach(r => {
        const key = getRowKey(r, type);
        compareMap.set(key, { record: r, hash: getRecordHash(r) });
      });
      
      primaryMap.forEach((val, key) => {
        if (!compareMap.has(key)) {
          changes[key] = 'added';
        } else if (val.hash !== compareMap.get(key).hash) {
          changes[key] = 'changed';
        }
      });
      
      compareMap.forEach((val, key) => {
        if (!primaryMap.has(key)) {
          changes[key] = 'removed';
        }
      });
      
      return changes;
    }

    function computeDeltaStats(primary, compare) {
      const pSum = primary.sf_summary || {};
      const cSum = compare.sf_summary || {};
      
      return {
        contracts: (pSum.contracts || 0) - (cSum.contracts || 0),
        ready: (pSum.ready || 0) - (cSum.ready || 0),
        needsReview: (pSum.needs_review || 0) - (cSum.needs_review || 0),
        blocked: (pSum.blocked || 0) - (cSum.blocked || 0),
        issues: {
          added: Object.values(rowChanges.issues).filter(v => v === 'added').length,
          changed: Object.values(rowChanges.issues).filter(v => v === 'changed').length,
          removed: Object.values(rowChanges.issues).filter(v => v === 'removed').length
        },
        actions: {
          added: Object.values(rowChanges.fieldActions).filter(v => v === 'added').length,
          changed: Object.values(rowChanges.fieldActions).filter(v => v === 'changed').length,
          removed: Object.values(rowChanges.fieldActions).filter(v => v === 'removed').length
        }
      };
    }

    function renderDeltaSummary() {
      const container = document.getElementById('delta-container');
      if (!deltaStats) {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'block';
      
      const formatDelta = (val) => val > 0 ? `+${val}` : val.toString();
      const getClass = (val) => val > 0 ? 'positive' : val < 0 ? 'negative' : 'neutral';
      
      container.innerHTML = `
        <h2>Delta Summary (vs. Previous)</h2>
        <div class="compare-actions">
          <button class="compare-btn" id="copy-delta-summary">Copy Delta Summary (Markdown)</button>
        </div>
        <div class="compare-legend">
          <span class="compare-legend-item"><span class="compare-legend-dot added"></span> Added</span>
          <span class="compare-legend-item"><span class="compare-legend-dot changed"></span> Changed</span>
          <span class="compare-legend-item"><span class="compare-legend-dot removed"></span> Removed</span>
        </div>
        <div class="delta-summary">
          <div class="delta-card ${getClass(deltaStats.contracts)}">
            <div class="delta-value ${getClass(deltaStats.contracts)}">${formatDelta(deltaStats.contracts)}</div>
            <div class="delta-label">Contracts</div>
          </div>
          <div class="delta-card ${getClass(deltaStats.ready)}">
            <div class="delta-value ${getClass(deltaStats.ready)}">${formatDelta(deltaStats.ready)}</div>
            <div class="delta-label">Ready</div>
          </div>
          <div class="delta-card ${getClass(deltaStats.needsReview)}">
            <div class="delta-value ${getClass(deltaStats.needsReview)}">${formatDelta(deltaStats.needsReview)}</div>
            <div class="delta-label">Needs Review</div>
          </div>
          <div class="delta-card ${getClass(deltaStats.blocked)}">
            <div class="delta-value ${getClass(deltaStats.blocked)}">${formatDelta(deltaStats.blocked)}</div>
            <div class="delta-label">Blocked</div>
          </div>
          <div class="delta-card ${deltaStats.issues.added > 0 ? 'positive' : 'neutral'}">
            <div class="delta-value ${deltaStats.issues.added > 0 ? 'positive' : 'neutral'}">+${deltaStats.issues.added}</div>
            <div class="delta-label">Issues Added</div>
          </div>
          <div class="delta-card ${deltaStats.issues.changed > 0 ? 'neutral' : 'neutral'}">
            <div class="delta-value neutral">${deltaStats.issues.changed}</div>
            <div class="delta-label">Issues Changed</div>
          </div>
          <div class="delta-card ${deltaStats.issues.removed > 0 ? 'negative' : 'neutral'}">
            <div class="delta-value ${deltaStats.issues.removed > 0 ? 'negative' : 'neutral'}">${deltaStats.issues.removed > 0 ? '-' : ''}${deltaStats.issues.removed}</div>
            <div class="delta-label">Issues Removed</div>
          </div>
          <div class="delta-card ${deltaStats.actions.added > 0 ? 'positive' : 'neutral'}">
            <div class="delta-value ${deltaStats.actions.added > 0 ? 'positive' : 'neutral'}">+${deltaStats.actions.added}</div>
            <div class="delta-label">Actions Added</div>
          </div>
          <div class="delta-card ${deltaStats.actions.removed > 0 ? 'negative' : 'neutral'}">
            <div class="delta-value ${deltaStats.actions.removed > 0 ? 'negative' : 'neutral'}">${deltaStats.actions.removed > 0 ? '-' : ''}${deltaStats.actions.removed}</div>
            <div class="delta-label">Actions Removed</div>
          </div>
        </div>
      `;
      
      document.getElementById('copy-delta-summary').addEventListener('click', async () => {
        const md = generateDeltaMarkdown();
        const success = await copyToClipboard(md);
        const btn = document.getElementById('copy-delta-summary');
        const orig = btn.textContent;
        btn.textContent = success ? 'Copied!' : 'Failed';
        setTimeout(() => btn.textContent = orig, 1500);
      });
    }

    function generateDeltaMarkdown() {
      if (!deltaStats) return '# No comparison data\n';
      
      const formatDelta = (val) => val > 0 ? `+${val}` : val.toString();
      
      let md = `# Delta Summary\n\n`;
      md += `## Contract Status Changes\n\n`;
      md += `| Metric | Delta |\n`;
      md += `|--------|-------|\n`;
      md += `| Contracts | ${formatDelta(deltaStats.contracts)} |\n`;
      md += `| Ready | ${formatDelta(deltaStats.ready)} |\n`;
      md += `| Needs Review | ${formatDelta(deltaStats.needsReview)} |\n`;
      md += `| Blocked | ${formatDelta(deltaStats.blocked)} |\n`;
      md += `\n## Row-Level Changes\n\n`;
      md += `| Type | Added | Changed | Removed |\n`;
      md += `|------|-------|---------|----------|\n`;
      md += `| Issues | ${deltaStats.issues.added} | ${deltaStats.issues.changed} | ${deltaStats.issues.removed} |\n`;
      md += `| Field Actions | ${deltaStats.actions.added} | ${deltaStats.actions.changed} | ${deltaStats.actions.removed} |\n`;
      
      return md;
    }

    function normCmp(v) {
      if (v === null || v === undefined) return '';
      return String(v).trim().toLowerCase();
    }

    function isNullOrEmpty(v) {
      return v === null || v === undefined || String(v).trim() === '';
    }

    function normalizeToNull(v) {
      if (v === undefined || (typeof v === 'string' && v.trim() === '')) return null;
      return v;
    }

    function compareNullsLast(aVal, bVal) {
      const aEmpty = isNullOrEmpty(aVal);
      const bEmpty = isNullOrEmpty(bVal);
      if (aEmpty && bEmpty) return 0;
      if (aEmpty) return 1;
      if (bEmpty) return -1;
      return normCmp(aVal).localeCompare(normCmp(bVal));
    }

    function sortByJoinTriplet(arr, extraKeys = []) {
      return [...arr].sort((a, b) => {
        const ck = compareNullsLast(a.contract_key, b.contract_key);
        if (ck !== 0) return ck;
        const fu = compareNullsLast(a.file_url, b.file_url);
        if (fu !== 0) return fu;
        const fn = compareNullsLast(a.file_name, b.file_name);
        if (fn !== 0) return fn;
        for (const key of extraKeys) {
          const cmp = normCmp(a[key]).localeCompare(normCmp(b[key]));
          if (cmp !== 0) return cmp;
        }
        return 0;
      });
    }

    function sortBySeverityFirst(arr, extraKeys = []) {
      const sevOrder = { blocking: 0, warning: 1, info: 2 };
      return [...arr].sort((a, b) => {
        const aOrd = sevOrder[a.severity] ?? 3;
        const bOrd = sevOrder[b.severity] ?? 3;
        if (aOrd !== bOrd) return aOrd - bOrd;
        const ck = compareNullsLast(a.contract_key, b.contract_key);
        if (ck !== 0) return ck;
        const fu = compareNullsLast(a.file_url, b.file_url);
        if (fu !== 0) return fu;
        const fn = compareNullsLast(a.file_name, b.file_name);
        if (fn !== 0) return fn;
        for (const key of extraKeys) {
          const cmp = compareNullsLast(a[key], b[key]);
          if (cmp !== 0) return cmp;
        }
        return 0;
      });
    }

    function getJoinIdentity(record) {
      return {
        contract_key: normalizeToNull(record.contract_key),
        file_url: normalizeToNull(record.file_url),
        file_name: normalizeToNull(record.file_name)
      };
    }

    function joinIdentityEquals(a, b) {
      if (!a || !b) return false;
      const eq = (x, y) => {
        const nx = normalizeToNull(x);
        const ny = normalizeToNull(y);
        if (nx === null && ny === null) return true;
        if (nx === null || ny === null) return false;
        return nx === ny;
      };
      return eq(a.contract_key, b.contract_key) && eq(a.file_url, b.file_url) && eq(a.file_name, b.file_name);
    }

    function getPrimaryKey(identity) {
      if (identity.contract_key !== null) return 'contract_key';
      if (identity.file_url !== null) return 'file_url';
      if (identity.file_name !== null) return 'file_name';
      return null;
    }

    function formatJoinIdentityPill(identity) {
      const primary = getPrimaryKey(identity);
      const format = (key, label, val) => {
        const v = val ?? 'null';
        if (key === primary) return `<span class="identity-primary">${label}=${v}</span>`;
        return `<span class="identity-fallback">${label}=${v}</span>`;
      };
      return `${format('contract_key', 'ck', identity.contract_key)} | ${format('file_url', 'fu', identity.file_url)} | ${format('file_name', 'fn', identity.file_name)}`;
    }

    function formatJoinIdentityText(identity) {
      const ck = identity.contract_key ?? 'null';
      const fu = identity.file_url ?? 'null';
      const fn = identity.file_name ?? 'null';
      const primary = getPrimaryKey(identity);
      return `ck=${ck} | fu=${fu} | fn=${fn} (PRIMARY: ${primary || 'none'})`;
    }

    function getRelatedRecords(identity, dataArray) {
      return dataArray.filter(r => joinIdentityEquals(getJoinIdentity(r), identity));
    }

    function formatValue(v) {
      if (v === null || v === undefined) return '<span class="null-value">null</span>';
      if (typeof v === 'object') return JSON.stringify(v);
      return String(v);
    }

    function matchesSearch(row, search) {
      if (!search) return true;
      const lowerSearch = search.toLowerCase();
      return Object.values(row).some(v => {
        if (v === null || v === undefined) return false;
        return String(v).toLowerCase().includes(lowerSearch);
      });
    }

    function filterData(data, type) {
      return data.filter(row => {
        if (!matchesSearch(row, activeFilters.search)) return false;
        if (type === 'issues' || type === 'fieldActions') {
          if (!activeFilters.severities.includes(row.severity)) return false;
        }
        if (type === 'contractResults') {
          const status = (row.sf_contract_status || '').toLowerCase();
          if (!activeFilters.statuses.includes(status)) return false;
          if (activeFilters.subtype && row.detected_subtype !== activeFilters.subtype) return false;
        }
        return true;
      });
    }

    function renderSummary(summary) {
      const container = document.getElementById('summary-container');
      container.innerHTML = `
        <h2>Summary</h2>
        <div class="summary">
          <div class="summary-card contracts"><div class="count">${summary.contracts || 0}</div><div class="label">Contracts</div></div>
          <div class="summary-card ready"><div class="count">${summary.ready || 0}</div><div class="label">Ready</div></div>
          <div class="summary-card needs-review"><div class="count">${summary.needs_review || 0}</div><div class="label">Needs Review</div></div>
          <div class="summary-card blocked"><div class="count">${summary.blocked || 0}</div><div class="label">Blocked</div></div>
        </div>
      `;
    }

    function renderTable(containerId, title, data, columns, type) {
      const container = document.getElementById(containerId);
      const filtered = filterData(data, type);
      
      if (!data || data.length === 0) {
        container.innerHTML = `<h2>${title}</h2><div class="info">No data</div>`;
        return;
      }
      
      const headers = columns.map(c => `<th>${c.label}</th>`).join('');
      const changes = rowChanges[type] || {};
      
      const rows = filtered.map((row, idx) => {
        const cells = columns.map(c => {
          let val = formatValue(row[c.key]);
          let cls = '';
          if (c.key === 'severity') cls = `severity-${row.severity}`;
          if (c.key === 'sf_contract_status') cls = `status-${(row.sf_contract_status || '').toLowerCase()}`;
          return `<td class="${cls}">${val}</td>`;
        }).join('');
        const rowKey = getRowKey(row, type);
        const changeType = changes[rowKey];
        const rowClass = changeType ? `row-${changeType}` : '';
        return `<tr data-type="${type}" data-idx="${data.indexOf(row)}" data-source="primary" class="${rowClass}">${cells}</tr>`;
      }).join('');
      
      let removedRows = '';
      if (compareData && Object.keys(changes).length > 0) {
        const removedKeys = Object.entries(changes)
          .filter(([k, v]) => v === 'removed')
          .map(([k]) => k);
        
        if (removedKeys.length > 0) {
          const compareArr = getCompareArray(type);
          const removedRecords = compareArr.filter(r => removedKeys.includes(getRowKey(r, type)));
          
          removedRows = removedRecords.map((row, idx) => {
            const cells = columns.map(c => {
              let val = formatValue(row[c.key]);
              let cls = '';
              if (c.key === 'severity') cls = `severity-${row.severity}`;
              if (c.key === 'sf_contract_status') cls = `status-${(row.sf_contract_status || '').toLowerCase()}`;
              return `<td class="${cls}">${val}</td>`;
            }).join('');
            return `<tr data-type="${type}" data-idx="${idx}" data-source="compare" class="row-removed">${cells}</tr>`;
          }).join('');
        }
      }
      
      const totalCount = data.length + (removedRows ? Object.values(changes).filter(v => v === 'removed').length : 0);
      
      container.innerHTML = `
        <h2>${title} (${filtered.length + (removedRows ? Object.values(changes).filter(v => v === 'removed').length : 0)}/${totalCount})</h2>
        <div class="table-container">
          <table><thead><tr>${headers}</tr></thead><tbody>${rows}${removedRows}</tbody></table>
        </div>
      `;
      
      container.querySelectorAll('tbody tr').forEach(tr => {
        if (tr.dataset.source === 'compare') return;
        tr.addEventListener('click', () => openDrawerFromType(type, parseInt(tr.dataset.idx)));
      });
    }

    function getCompareArray(type) {
      if (!compareData) return [];
      if (type === 'contractResults') return compareData.sf_contract_results || [];
      if (type === 'issues') return compareData.sf_issues || [];
      if (type === 'fieldActions') return compareData.sf_field_actions || [];
      return [];
    }

    function renderAllTables() {
      renderTable('contract-results-container', 'Contract Results', allData.contractResults, [
        { key: 'contract_key', label: 'Contract Key' },
        { key: 'file_name', label: 'File Name' },
        { key: 'file_url', label: 'File URL' },
        { key: 'detected_subtype', label: 'Subtype' },
        { key: 'sf_contract_status', label: 'Status' },
        { key: 'notes', label: 'Notes' }
      ], 'contractResults');
      
      renderTable('issues-container', 'Issues', allData.issues, [
        { key: 'severity', label: 'Severity' },
        { key: 'contract_key', label: 'Contract Key' },
        { key: 'file_name', label: 'File Name' },
        { key: 'sheet', label: 'Sheet' },
        { key: 'field', label: 'Field' },
        { key: 'issue_type', label: 'Issue Type' },
        { key: 'details', label: 'Details' }
      ], 'issues');
      
      renderTable('field-actions-container', 'Field Actions', allData.fieldActions, [
        { key: 'severity', label: 'Severity' },
        { key: 'contract_key', label: 'Contract Key' },
        { key: 'file_name', label: 'File Name' },
        { key: 'sheet', label: 'Sheet' },
        { key: 'field', label: 'Field' },
        { key: 'action', label: 'Action' },
        { key: 'proposed_value', label: 'Proposed Value' },
        { key: 'reason_text', label: 'Reason' }
      ], 'fieldActions');
    }

    function populateSubtypeDropdown() {
      const subtypes = [...new Set(allData.contractResults.map(r => r.detected_subtype).filter(Boolean))].sort();
      const select = document.getElementById('filter-subtype');
      select.innerHTML = '<option value="">All Subtypes</option>' + 
        subtypes.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function renderDrawerTab(tab) {
      const body = document.getElementById('drawer-body');
      const identity = currentSelection.joinIdentity;
      if (!identity) return;

      let content = '';
      let jsonData = null;

      if (tab === 'contract') {
        const contract = currentSelection.contractIdx !== null 
          ? allData.contractResults[currentSelection.contractIdx]
          : allData.contractResults.find(r => joinIdentityEquals(getJoinIdentity(r), identity));
        if (contract) {
          jsonData = contract;
          content = `<pre class="drawer-json">${JSON.stringify(contract, null, 2)}</pre>`;
        } else {
          content = '<div class="drawer-empty">No contract record found for this join identity.</div>';
        }
      } else if (tab === 'issues') {
        const related = sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']);
        jsonData = related;
        if (related.length === 0) {
          content = '<div class="drawer-empty">No related issues for this join identity.</div>';
        } else {
          content = renderSelectionControls('issues', related.length) + renderDrawerTable(related, [
            { key: 'severity', label: 'Severity' },
            { key: 'sheet', label: 'Sheet' },
            { key: 'field', label: 'Field' },
            { key: 'issue_type', label: 'Type' },
            { key: 'details', label: 'Details' }
          ], 'issues');
        }
      } else if (tab === 'actions') {
        const related = sortBySeverityFirst(getRelatedRecords(identity, allData.fieldActions), ['sheet', 'field', 'action']);
        jsonData = related;
        if (related.length === 0) {
          content = '<div class="drawer-empty">No related field actions for this join identity.</div>';
        } else {
          content = renderSelectionControls('actions', related.length) + renderDrawerTable(related, [
            { key: 'severity', label: 'Severity' },
            { key: 'sheet', label: 'Sheet' },
            { key: 'field', label: 'Field' },
            { key: 'action', label: 'Action' },
            { key: 'proposed_value', label: 'Value' },
            { key: 'reason_text', label: 'Reason' }
          ], 'actions');
        }
      } else if (tab === 'changelog') {
        const related = sortBySeverityFirst(getRelatedRecords(identity, allData.changeLog), ['sheet', 'field', 'notes']);
        jsonData = related;
        if (related.length === 0) {
          content = '<div class="drawer-empty">No related change log entries for this join identity.</div>';
        } else {
          content = renderSelectionControls('changelog', related.length) + renderDrawerTable(related, [
            { key: 'severity', label: 'Severity' },
            { key: 'sheet', label: 'Sheet' },
            { key: 'field', label: 'Field' },
            { key: 'notes', label: 'Notes' }
          ], 'changelog');
        }
      }

      body.innerHTML = content;
      body.dataset.json = JSON.stringify(jsonData, null, 2);
      body.dataset.tabType = tab;
      body.dataset.records = JSON.stringify(jsonData);
    }

    function getRecordKey(record) {
      const ck = normalizeToNull(record.contract_key) ?? '';
      const fu = normalizeToNull(record.file_url) ?? '';
      const fn = normalizeToNull(record.file_name) ?? '';
      const sh = record.sheet ?? '';
      const fi = record.field ?? '';
      const ty = record.issue_type ?? record.action ?? record.notes ?? '';
      return `${ck}|${fu}|${fn}|${sh}|${fi}|${ty}`;
    }

    function renderDrawerTable(data, columns, tabType) {
      const selectionSet = selectedRecords[tabType];
      const headers = (tabType ? '<th></th>' : '') + columns.map(c => `<th>${c.label}</th>`).join('');
      const rows = data.map((row, idx) => {
        const key = getRecordKey(row);
        const checked = selectionSet?.has(key) ? 'checked' : '';
        const checkbox = tabType ? `<td><input type="checkbox" data-key="${key}" data-idx="${idx}" ${checked}></td>` : '';
        const cells = columns.map(c => {
          let val = formatValue(row[c.key]);
          let cls = '';
          if (c.key === 'severity') cls = `severity-${row.severity}`;
          return `<td class="${cls}">${val}</td>`;
        }).join('');
        return `<tr>${checkbox}${cells}</tr>`;
      }).join('');
      return `<table class="drawer-table"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderSelectionControls(tabType, totalCount) {
      const selectedCount = selectedRecords[tabType]?.size || 0;
      return `
        <div class="selection-controls">
          <button class="selection-btn" data-action="select-all" data-tab="${tabType}">Select All</button>
          <button class="selection-btn" data-action="clear" data-tab="${tabType}">Clear</button>
          <button class="selection-btn" data-action="add-to-patch" data-tab="${tabType}" style="background: #2e7d32; color: white; border-color: #2e7d32;">Add Selected to Patch</button>
          <span class="selection-count">${selectedCount} of ${totalCount} selected</span>
        </div>
      `;
    }

    function updateTabCounts(identity) {
      const issuesCount = getRelatedRecords(identity, allData.issues).length;
      const actionsCount = getRelatedRecords(identity, allData.fieldActions).length;
      const changelogCount = getRelatedRecords(identity, allData.changeLog).length;
      document.getElementById('issues-count').textContent = issuesCount;
      document.getElementById('actions-count').textContent = actionsCount;
      document.getElementById('changelog-count').textContent = changelogCount;
    }

    function openDrawerFromType(type, idx) {
      const dataMap = { contractResults: allData.contractResults, issues: allData.issues, fieldActions: allData.fieldActions };
      const record = dataMap[type]?.[idx];
      if (!record) return;

      const identity = getJoinIdentity(record);
      currentSelection.joinIdentity = identity;
      currentSelection.sourceType = type;

      const matchingContracts = allData.contractResults.filter(r => joinIdentityEquals(getJoinIdentity(r), identity));
      if (type === 'contractResults') {
        currentSelection.contractIdx = idx;
      } else {
        const contractIdx = allData.contractResults.findIndex(r => joinIdentityEquals(getJoinIdentity(r), identity));
        currentSelection.contractIdx = contractIdx >= 0 ? contractIdx : null;
      }
      currentSelection.activeTab = 'contract';

      document.getElementById('identity-pill').innerHTML = formatJoinIdentityPill(identity);
      updateTabCounts(identity);

      const warning = document.getElementById('drawer-warning');
      if (matchingContracts.length > 1) {
        warning.textContent = `Warning: ${matchingContracts.length} contracts share this join identity. Showing first match deterministically.`;
        warning.style.display = 'block';
      } else {
        warning.style.display = 'none';
      }

      document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.drawer-tab[data-tab="contract"]').classList.add('active');

      renderDrawerTab('contract');

      document.getElementById('drawer').classList.add('active');
      document.getElementById('drawer-overlay').classList.add('active');

      saveSelection();
    }

    function openDrawer(idx) {
      openDrawerFromType('contractResults', idx);
    }

    function closeDrawer() {
      document.getElementById('drawer').classList.remove('active');
      document.getElementById('drawer-overlay').classList.remove('active');
      currentSelection.joinIdentity = null;
      clearSelection();
    }

    function saveSelection() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(currentSelection));
      } catch (e) {}
    }

    function clearSelection() {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {}
    }

    function restoreSelection() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return;
        const sel = JSON.parse(stored);
        if (!sel.joinIdentity) return;

        let contractIdx = sel.contractIdx;
        if (contractIdx !== null && contractIdx !== undefined) {
          const storedRecord = allData.contractResults[contractIdx];
          if (!storedRecord || !joinIdentityEquals(getJoinIdentity(storedRecord), sel.joinIdentity)) {
            contractIdx = allData.contractResults.findIndex(r => joinIdentityEquals(getJoinIdentity(r), sel.joinIdentity));
          }
        } else {
          contractIdx = allData.contractResults.findIndex(r => joinIdentityEquals(getJoinIdentity(r), sel.joinIdentity));
        }

        if (contractIdx < 0) {
          clearSelection();
          return;
        }

        const validTabs = ['contract', 'issues', 'actions', 'changelog'];
        if (!validTabs.includes(sel.activeTab)) {
          sel.activeTab = 'contract';
        }

        sel.contractIdx = contractIdx;
        currentSelection = sel;
        document.getElementById('identity-pill').innerHTML = formatJoinIdentityPill(sel.joinIdentity);
        updateTabCounts(sel.joinIdentity);

        document.querySelectorAll('.drawer-tab').forEach(t => {
          t.classList.toggle('active', t.dataset.tab === sel.activeTab);
        });

        renderDrawerTab(sel.activeTab);

        document.getElementById('drawer').classList.add('active');
        document.getElementById('drawer-overlay').classList.add('active');
      } catch (e) {
        clearSelection();
      }
    }

    function openCommandModal(cmdKey) {
      const cmd = commands.commands?.[cmdKey];
      const desc = commands.descriptions?.[cmdKey] || '';
      if (!cmd) return;
      
      document.getElementById('modal-title').textContent = cmdKey.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      document.getElementById('modal-description').textContent = desc;
      document.getElementById('modal-command').textContent = cmd;
      document.getElementById('modal-status').style.display = 'none';
      updateRunButton();
      document.getElementById('command-modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('command-modal').classList.remove('active');
    }

    function updateRunButton() {
      const confirmChecked = document.getElementById('confirm-run').checked;
      const runBtn = document.getElementById('modal-run');
      runBtn.disabled = !confirmChecked;
      runBtn.textContent = confirmChecked ? 'Run Command' : 'Run (Confirm Required)';
    }

    function showModalStatus(message, type) {
      const status = document.getElementById('modal-status');
      status.textContent = message;
      status.className = 'modal-status ' + type;
      status.style.display = 'block';
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        return true;
      }
    }

    async function loadCommands() {
      try {
        const resp = await fetch(COMMANDS_PATH);
        if (resp.ok) {
          commands = await resp.json();
        }
      } catch (e) {
        console.warn('Could not load run_commands.json');
      }
    }

    async function loadData() {
      const errorContainer = document.getElementById('error-container');
      const sourceInfo = document.getElementById('source-info');
      
      let data = null;
      let source = '';
      
      try {
        const resp = await fetch(RELATIVE_PRIMARY);
        if (resp.ok) {
          data = await resp.json();
          source = PRIMARY_PATH;
        }
      } catch (e) {}
      
      if (!data) {
        try {
          const resp = await fetch(RELATIVE_FALLBACK);
          if (resp.ok) {
            data = await resp.json();
            source = FALLBACK_PATH + ' (fallback)';
          }
        } catch (e) {}
      }
      
      if (!data) {
        errorContainer.innerHTML = `<div class="error">Could not load sf_packet data. Ensure you are serving this file from the repository root or the JSON files exist at the expected paths.</div>`;
        return;
      }
      
      sourceInfo.textContent = `Data source: ${source}`;
      
      renderSummary(data.sf_summary || {});
      
      allData.contractResults = sortByJoinTriplet(data.sf_contract_results || []);
      allData.issues = sortBySeverityFirst(data.sf_issues || [], ['sheet', 'field', 'issue_type']);
      allData.fieldActions = sortBySeverityFirst(data.sf_field_actions || [], ['sheet', 'field', 'action']);
      allData.changeLog = sortBySeverityFirst(data.sf_change_log || [], ['sheet', 'field', 'notes']);
      
      populateSubtypeDropdown();
      renderAllTables();
      restoreSelection();
    }

    document.getElementById('toolbar').addEventListener('click', async e => {
      const btn = e.target.closest('.toolbar-btn');
      if (btn) {
        const cmdKey = btn.dataset.cmd;
        const cmd = commands.commands?.[cmdKey];
        if (cmd) {
          const success = await copyToClipboard(cmd);
          openCommandModal(cmdKey);
          showModalStatus(success ? 'Command copied to clipboard!' : 'Could not auto-copy', success ? 'success' : 'error');
        }
      }
    });

    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-cancel').addEventListener('click', closeModal);
    document.getElementById('command-modal').addEventListener('click', e => {
      if (e.target.id === 'command-modal') closeModal();
    });

    document.getElementById('modal-copy').addEventListener('click', async () => {
      const cmd = document.getElementById('modal-command').textContent;
      const success = await copyToClipboard(cmd);
      showModalStatus(success ? 'Copied to clipboard!' : 'Copy failed', success ? 'success' : 'error');
    });

    document.getElementById('modal-run').addEventListener('click', () => {
      showModalStatus('Execution is not available in browser environment. Please run the copied command in your terminal.', 'info');
    });

    document.getElementById('confirm-run').addEventListener('change', updateRunButton);

    document.getElementById('drawer-close').addEventListener('click', closeDrawer);
    document.getElementById('drawer-overlay').addEventListener('click', closeDrawer);

    document.getElementById('drawer-tabs').addEventListener('click', e => {
      const tab = e.target.closest('.drawer-tab');
      if (!tab) return;
      const tabName = tab.dataset.tab;
      currentSelection.activeTab = tabName;
      document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      renderDrawerTab(tabName);
      saveSelection();
    });

    document.getElementById('drawer-copy').addEventListener('click', async () => {
      const rawJson = document.getElementById('drawer-body').dataset.json || '{}';
      const parsed = JSON.parse(rawJson);
      const sorted = sortObjectKeys(parsed);
      const json = JSON.stringify(sorted, null, 2);
      const success = await copyToClipboard(json);
      const btn = document.getElementById('drawer-copy');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('identity-copy').addEventListener('click', async () => {
      const identity = currentSelection.joinIdentity;
      if (!identity) return;
      const text = formatJoinIdentityText(identity);
      const success = await copyToClipboard(text);
      const btn = document.getElementById('identity-copy');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    function sortObjectKeys(obj) {
      if (obj === null || typeof obj !== 'object') return obj;
      if (Array.isArray(obj)) return obj.map(sortObjectKeys);
      return Object.keys(obj).sort().reduce((acc, key) => {
        acc[key] = sortObjectKeys(obj[key]);
        return acc;
      }, {});
    }

    function generatePRSummary() {
      const identity = currentSelection.joinIdentity;
      if (!identity) return '';
      const contract = currentSelection.contractIdx !== null 
        ? allData.contractResults[currentSelection.contractIdx] : null;
      const issues = sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']);
      const actions = sortBySeverityFirst(getRelatedRecords(identity, allData.fieldActions), ['sheet', 'field', 'action']);
      const primary = getPrimaryKey(identity);
      const primaryVal = identity[primary] || 'unknown';

      let md = `# PR: Fix issues for ${primary}=${primaryVal}\n\n`;
      md += `## WHY\n`;
      md += `This record has ${issues.length} issue(s) and ${actions.length} pending action(s) that need resolution.\n\n`;
      md += `## Affected Artifacts\n`;
      md += `- **Join Identity**: ${formatJoinIdentityText(identity)}\n`;
      md += `- **Contract Status**: ${contract?.sf_contract_status || 'unknown'}\n`;
      md += `- **Detected Subtype**: ${contract?.detected_subtype || 'unknown'}\n`;
      if (issues.length > 0) {
        md += `- **Issues**: ${issues.map(i => i.issue_type).join(', ')}\n`;
      }
      md += `\n## Smoke Status\nunknown (run \`bash scripts/replit_smoke.sh\` to verify)\n`;
      return md;
    }

    function generatePatchSkeleton() {
      const identity = currentSelection.joinIdentity;
      if (!identity) return '{}';
      const issues = sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']);
      const primary = getPrimaryKey(identity);
      const primaryVal = (identity[primary] || 'unknown').replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
      const patch = {
        base_version: "0.1.0",
        changes: issues.map((issue, idx) => ({
          op: "add_rule",
          rule_id: `NEW_RULE_${primaryVal}_${idx + 1}`,
          description: `Fix: ${issue.issue_type} on ${issue.field || 'unknown'}`,
          when: { sheet: issue.sheet || "", field: issue.field || "", operator: "EXISTS", value: null },
          then: { action: "REQUIRE_PRESENT", sheet: issue.sheet || "", field: issue.field || "", severity: issue.severity || "warning" }
        }))
      };
      return JSON.stringify(sortObjectKeys(patch), null, 2);
    }

    function generateRuleDraft() {
      const identity = currentSelection.joinIdentity;
      if (!identity) return '';
      const issues = sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']);
      const primary = getPrimaryKey(identity);
      
      let draft = `# Rule Draft\n\n`;
      if (issues.length === 0) {
        draft += `No issues found for this join identity.\n`;
      } else {
        issues.forEach((issue, idx) => {
          draft += `## Rule ${idx + 1}\n\n`;
          draft += `**WHEN**\n`;
          draft += `- Sheet: ${issue.sheet || 'any'}\n`;
          draft += `- Field: ${issue.field || 'any'}\n`;
          draft += `- Condition: ${issue.issue_type || 'unknown'}\n\n`;
          draft += `**THEN**\n`;
          draft += `- Action: REQUIRE_PRESENT\n`;
          draft += `- Severity: ${issue.severity || 'warning'}\n\n`;
          draft += `**BECAUSE**\n`;
          draft += `- ${issue.details || 'Issue detected during validation'}\n`;
          draft += `- Primary key: ${primary}=${identity[primary]}\n\n`;
        });
      }
      return draft;
    }

    document.getElementById('copy-pr-summary').addEventListener('click', async () => {
      const text = generatePRSummaryWithEvidence();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-pr-summary');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-rule-draft').addEventListener('click', async () => {
      const text = generateRuleDraft();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-rule-draft');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('filter-search').addEventListener('input', e => {
      activeFilters.search = e.target.value;
      renderAllTables();
    });

    document.getElementById('severity-chips').addEventListener('click', e => {
      const chip = e.target.closest('.filter-chip');
      if (!chip) return;
      const sev = chip.dataset.severity;
      const idx = activeFilters.severities.indexOf(sev);
      if (idx >= 0) {
        activeFilters.severities.splice(idx, 1);
        chip.classList.add('inactive');
      } else {
        activeFilters.severities.push(sev);
        chip.classList.remove('inactive');
      }
      renderAllTables();
    });

    document.getElementById('status-chips').addEventListener('click', e => {
      const chip = e.target.closest('.filter-chip');
      if (!chip) return;
      const status = chip.dataset.status;
      const idx = activeFilters.statuses.indexOf(status);
      if (idx >= 0) {
        activeFilters.statuses.splice(idx, 1);
        chip.classList.add('inactive');
      } else {
        activeFilters.statuses.push(status);
        chip.classList.remove('inactive');
      }
      renderAllTables();
    });

    document.getElementById('filter-subtype').addEventListener('change', e => {
      activeFilters.subtype = e.target.value;
      renderAllTables();
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeModal();
        closeDrawer();
        closePatchStudio();
      }
    });

    document.getElementById('drawer-body').addEventListener('change', e => {
      if (e.target.type !== 'checkbox') return;
      const key = e.target.dataset.key;
      const tabType = document.getElementById('drawer-body').dataset.tabType;
      if (!tabType || tabType === 'contract') return;
      
      const selectionSet = selectedRecords[tabType];
      if (!selectionSet) return;
      
      if (e.target.checked) {
        selectionSet.add(key);
      } else {
        selectionSet.delete(key);
      }
      updateSelectionCount(tabType);
    });

    document.getElementById('drawer-body').addEventListener('click', e => {
      const btn = e.target.closest('.selection-btn');
      if (!btn) return;
      
      const action = btn.dataset.action;
      const tabType = btn.dataset.tab;
      const records = JSON.parse(document.getElementById('drawer-body').dataset.records || '[]');
      
      if (action === 'select-all') {
        records.forEach(r => selectedRecords[tabType].add(getRecordKey(r)));
        renderDrawerTab(currentSelection.activeTab);
      } else if (action === 'clear') {
        selectedRecords[tabType].clear();
        renderDrawerTab(currentSelection.activeTab);
      } else if (action === 'add-to-patch') {
        addSelectedToPatch(tabType);
      }
    });

    function updateSelectionCount(tabType) {
      const countEl = document.querySelector(`.selection-count`);
      if (countEl) {
        const records = JSON.parse(document.getElementById('drawer-body').dataset.records || '[]');
        countEl.textContent = `${selectedRecords[tabType]?.size || 0} of ${records.length} selected`;
      }
    }

    function addSelectedToPatch(tabType) {
      const records = JSON.parse(document.getElementById('drawer-body').dataset.records || '[]');
      const selectionSet = selectedRecords[tabType];
      const selected = records.filter(r => selectionSet.has(getRecordKey(r)));
      
      selected.forEach(record => {
        const key = getRecordKey(record);
        const exists = patchDraft.changes.some(c => c._key === key);
        if (!exists) {
          patchDraft.changes.push({
            _key: key,
            _source: tabType,
            record: record
          });
        }
      });
      
      renderPatchChanges();
      savePatchDraft();
      document.getElementById('patch-studio').classList.add('active');
    }

    function renderPatchChanges() {
      const list = document.getElementById('patch-changes-list');
      const count = document.getElementById('patch-changes-count');
      count.textContent = patchDraft.changes.length;
      
      if (patchDraft.changes.length === 0) {
        list.innerHTML = '<div class="patch-empty">No changes added. Select issues/actions in the Workbench tabs and add them here.</div>';
        return;
      }
      
      const sorted = sortBySeverityFirst([...patchDraft.changes].map(c => c.record), ['sheet', 'field']);
      const sortedChanges = sorted.map(r => patchDraft.changes.find(c => c._key === getRecordKey(r)));
      
      list.innerHTML = sortedChanges.map((change, idx) => {
        const r = change.record;
        const typeLabel = change._source === 'issues' ? 'Issue' : change._source === 'actions' ? 'Action' : 'Log';
        const desc = r.issue_type || r.action || r.notes || 'unknown';
        return `
          <div class="patch-change-item" data-idx="${idx}">
            <div class="patch-change-info">
              <strong>${typeLabel}:</strong> ${desc}<br>
              <small>${r.sheet || '-'} / ${r.field || '-'} (${r.severity || 'info'})</small>
            </div>
            <button class="patch-change-remove" data-key="${change._key}">&times;</button>
          </div>
        `;
      }).join('');
    }

    document.getElementById('patch-changes-list').addEventListener('click', e => {
      const btn = e.target.closest('.patch-change-remove');
      if (!btn) return;
      const key = btn.dataset.key;
      patchDraft.changes = patchDraft.changes.filter(c => c._key !== key);
      renderPatchChanges();
      savePatchDraft();
    });

    document.getElementById('clear-patch-changes').addEventListener('click', () => {
      patchDraft.changes = [];
      renderPatchChanges();
      savePatchDraft();
    });

    document.getElementById('open-patch-studio').addEventListener('click', () => {
      document.getElementById('patch-studio').classList.add('active');
    });

    document.getElementById('patch-studio-close').addEventListener('click', closePatchStudio);

    function closePatchStudio() {
      document.getElementById('patch-studio').classList.remove('active');
    }

    document.getElementById('patch-base-version').addEventListener('input', e => {
      patchDraft.baseVersion = e.target.value;
      savePatchDraft();
    });

    document.getElementById('patch-author').addEventListener('input', e => {
      patchDraft.author = e.target.value;
      savePatchDraft();
    });

    document.getElementById('patch-rationale').addEventListener('input', e => {
      patchDraft.rationale = e.target.value;
      savePatchDraft();
    });

    function generateGroupedRules() {
      const changes = patchDraft.changes;
      if (changes.length === 0) return '';
      
      const sorted = sortBySeverityFirst(changes.map(c => c.record), ['sheet', 'field']);
      const groups = new Map();
      
      sorted.forEach(record => {
        const whenKey = `${record.sheet || ''}|${record.field || ''}`;
        if (!groups.has(whenKey)) {
          groups.set(whenKey, []);
        }
        groups.get(whenKey).push(record);
      });
      
      let draft = `# Grouped Rule Draft\n\n`;
      let ruleNum = 1;
      
      groups.forEach((records, whenKey) => {
        const [sheet, field] = whenKey.split('|');
        draft += `## Rule ${ruleNum}\n\n`;
        draft += `**WHEN**\n`;
        draft += `- Sheet: ${sheet || 'any'}\n`;
        draft += `- Field: ${field || 'any'}\n\n`;
        draft += `**THEN**\n`;
        records.forEach(r => {
          const actionType = r.issue_type || r.action || 'REQUIRE_PRESENT';
          draft += `- ${actionType} (${r.severity || 'warning'})\n`;
        });
        draft += `\n**BECAUSE**\n`;
        records.forEach(r => {
          draft += `- ${r.details || r.reason_text || r.notes || 'Issue detected'}\n`;
        });
        draft += `\n`;
        ruleNum++;
      });
      
      return draft;
    }

    function getRuleIdPrefix(record) {
      const identity = getJoinIdentity(record);
      const primary = getPrimaryKey(identity);
      const primaryVal = identity[primary] || 'unknown';
      return String(primaryVal).replace(/[^a-zA-Z0-9]/g, '_').substring(0, 15);
    }

    function generateRuleMapping() {
      const changes = patchDraft.changes;
      if (changes.length === 0) return '[]';
      
      const sorted = sortBySeverityFirst(changes.map(c => c.record), ['sheet', 'field']);
      
      const rules = sorted.map((record, idx) => ({
        op: 'add_rule',
        rule_id: `RULE_${getRuleIdPrefix(record)}_${idx + 1}`,
        description: `Fix: ${record.issue_type || record.action || 'unknown'} on ${record.field || 'unknown'}`,
        when: {
          sheet: record.sheet || '',
          field: record.field || '',
          operator: 'EXISTS',
          value: null
        },
        then: {
          action: record.action || 'REQUIRE_PRESENT',
          sheet: record.sheet || '',
          field: record.field || '',
          severity: record.severity || 'warning'
        }
      }));
      
      return JSON.stringify(sortObjectKeys(rules), null, 2);
    }

    function generateFullPatchDraft() {
      const baseVersion = document.getElementById('patch-base-version').value || null;
      const author = document.getElementById('patch-author').value || null;
      const rationale = document.getElementById('patch-rationale').value || null;
      
      const changes = patchDraft.changes;
      const sorted = sortBySeverityFirst(changes.map(c => c.record), ['sheet', 'field']);
      
      const changesArray = sorted.map((record, idx) => ({
        op: 'add_rule',
        rule_id: `RULE_${getRuleIdPrefix(record)}_${idx + 1}`,
        description: `Fix: ${record.issue_type || record.action || 'unknown'} on ${record.field || 'unknown'}`,
        when: {
          sheet: record.sheet || '',
          field: record.field || '',
          operator: 'EXISTS',
          value: null
        },
        then: {
          action: record.action || 'REQUIRE_PRESENT',
          sheet: record.sheet || '',
          field: record.field || '',
          severity: record.severity || 'warning'
        }
      }));
      
      const patch = {
        base_version: baseVersion,
        author: author,
        rationale: rationale,
        changes: changesArray
      };
      
      return JSON.stringify(sortObjectKeys(patch), null, 2);
    }

    document.getElementById('copy-full-patch').addEventListener('click', async () => {
      const text = generateFullPatchDraft();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-full-patch');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-rule-mapping').addEventListener('click', async () => {
      const text = generateRuleMapping();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-rule-mapping');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-grouped-rules').addEventListener('click', async () => {
      const text = generateGroupedRules();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-grouped-rules');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-smoke-baseline').addEventListener('click', async () => {
      const cmd = commands.commands?.smoke_baseline || 'bash scripts/replit_smoke.sh';
      const success = await copyToClipboard(cmd);
      const btn = document.getElementById('copy-smoke-baseline');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-smoke-edge').addEventListener('click', async () => {
      const cmd = commands.commands?.smoke_edge || 'bash scripts/replit_smoke.sh edge';
      const success = await copyToClipboard(cmd);
      const btn = document.getElementById('copy-smoke-edge');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-evidence-template').addEventListener('click', async () => {
      const identity = currentSelection.joinIdentity;
      const primary = identity ? getPrimaryKey(identity) : null;
      const primaryVal = identity?.[primary] || 'unknown';
      
      const template = `# Evidence for Patch

## Commit
- **SHA**: <COMMIT_SHA>
- **Branch**: main

## Verification
- [ ] Smoke baseline passed
- [ ] Smoke edge passed
- [ ] Manual review completed

## Artifacts
- **Join Identity**: ${identity ? formatJoinIdentityText(identity) : 'N/A'}
- **Primary Key**: ${primary || 'N/A'}=${primaryVal}
- **Patch File SHA256**: <SHA256_HASH>

## Notes
Add any additional notes here.
`;
      const success = await copyToClipboard(template);
      const btn = document.getElementById('copy-evidence-template');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.querySelector('.patch-studio-tabs').addEventListener('click', e => {
      const tab = e.target.closest('.patch-studio-tab');
      if (!tab) return;
      const panelName = tab.dataset.panel;
      document.querySelectorAll('.patch-studio-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('.patch-studio-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`panel-${panelName}`).classList.add('active');
      if (panelName === 'preflight') renderPreflightChecklist();
    });

    function parseBaseVersion(input) {
      const trimmed = input.trim();
      if (!trimmed) return { parsed: null, status: 'pending' };
      if (trimmed.startsWith('{')) {
        try {
          const json = JSON.parse(trimmed);
          if (json.version) return { parsed: { version: json.version }, status: 'pass' };
          return { parsed: null, status: 'warn', message: 'No version field found in JSON' };
        } catch (e) {
          return { parsed: null, status: 'warn', message: 'Invalid JSON, storing as raw text' };
        }
      }
      const versionMatch = trimmed.match(/^(\d+\.\d+\.\d+)$/);
      if (versionMatch) return { parsed: { version: versionMatch[1] }, status: 'pass' };
      return { parsed: { version: trimmed }, status: 'warn', message: 'Non-standard version format' };
    }

    function parseValidation(input) {
      const trimmed = input.trim();
      if (!trimmed) return { parsed: null, status: 'pending' };
      const result = { status: 'unknown', baseVersion: null, patchBaseVersion: null, changesCount: null, conflicts: [] };
      if (trimmed.toLowerCase().includes('ok:') || trimmed.toLowerCase().includes('valid')) {
        result.status = 'ok';
      } else if (trimmed.toLowerCase().includes('error') || trimmed.toLowerCase().includes('fail')) {
        result.status = 'error';
      }
      const bvMatch = trimmed.match(/base\.version[:\s]+([0-9.]+)/i);
      if (bvMatch) result.baseVersion = bvMatch[1];
      const pbvMatch = trimmed.match(/patch\.base_version[:\s]+([0-9.]+)/i);
      if (pbvMatch) result.patchBaseVersion = pbvMatch[1];
      const ccMatch = trimmed.match(/changes_count[:\s]+(\d+)/i);
      if (ccMatch) result.changesCount = parseInt(ccMatch[1]);
      const conflictMatches = [...trimmed.matchAll(/conflict[:\s]*(.*?)(?:\n|$)/gi)];
      result.conflicts = conflictMatches.map(m => m[1].trim()).filter(Boolean);
      if (result.status === 'ok') return { parsed: result, status: 'pass' };
      if (result.status === 'error') return { parsed: result, status: 'fail' };
      return { parsed: result, status: 'warn', message: 'Could not determine validation status' };
    }

    function parseConflict(input) {
      const trimmed = input.trim().toLowerCase();
      if (!trimmed) return { parsed: null, status: 'pending' };
      if (trimmed === 'reviewed') return { parsed: { reviewed: true }, status: 'warn', message: 'Manual review confirmed' };
      if (trimmed.includes('no conflict') || trimmed.includes('0 conflicts')) {
        return { parsed: { conflicts: [], count: 0 }, status: 'pass' };
      }
      const conflictLines = input.trim().split('\n').filter(l => l.trim() && !l.toLowerCase().includes('no conflict'));
      if (conflictLines.length > 0) {
        return { parsed: { conflicts: conflictLines, count: conflictLines.length }, status: 'fail', message: `${conflictLines.length} conflict(s) found` };
      }
      return { parsed: { reviewed: true }, status: 'warn', message: 'Content stored for manual review' };
    }

    function parseSmoke(input) {
      const trimmed = input.trim();
      if (!trimmed) return { parsed: null, status: 'pending' };
      if (trimmed.toLowerCase().includes('ok:') || trimmed.toLowerCase().includes('matches expected')) {
        return { parsed: { pass: true }, status: 'pass' };
      }
      if (trimmed.toLowerCase().includes('fail') || trimmed.toLowerCase().includes('error') || trimmed.toLowerCase().includes('mismatch')) {
        return { parsed: { pass: false }, status: 'fail' };
      }
      return { parsed: { raw: trimmed }, status: 'warn', message: 'Could not determine pass/fail' };
    }

    function renderPreflightChecklist() {
      const steps = [
        { id: 1, title: 'Base Version Check', key: 'baseVersion', desc: getStepDescription('baseVersion') },
        { id: 2, title: 'Validation Report', key: 'validation', desc: getStepDescription('validation') },
        { id: 3, title: 'Conflict Check', key: 'conflict', desc: getStepDescription('conflict') },
        { id: 4, title: 'Smoke Evidence', key: 'smoke', desc: getStepDescription('smoke') }
      ];
      const html = steps.map(step => {
        const status = getStepStatus(step.key);
        return `
          <div class="preflight-step">
            <div class="preflight-step-num ${status}">${step.id}</div>
            <div class="preflight-step-info">
              <div class="preflight-step-title">${step.title}</div>
              <div class="preflight-step-status">${step.desc}</div>
            </div>
            <span class="preflight-step-chip ${status}">${status}</span>
          </div>
        `;
      }).join('');
      document.getElementById('preflight-checklist').innerHTML = html;
    }

    function getStepStatus(key) {
      if (key === 'smoke') {
        const baseline = preflightEvidence.smokeBaseline.status;
        if (baseline === 'pass') return 'pass';
        if (baseline === 'fail') return 'fail';
        if (baseline === 'warn') return 'warn';
        return 'pending';
      }
      return preflightEvidence[key]?.status || 'pending';
    }

    function getStepDescription(key) {
      const ev = preflightEvidence;
      if (key === 'baseVersion') {
        if (ev.baseVersion.parsed?.version) return `Version: ${ev.baseVersion.parsed.version}`;
        if (ev.baseVersion.status === 'warn') return ev.baseVersion.message || 'Needs review';
        return 'Not provided';
      }
      if (key === 'validation') {
        if (ev.validation.parsed) {
          const p = ev.validation.parsed;
          if (p.status === 'ok') return `Valid (base: ${p.baseVersion || '?'}, changes: ${p.changesCount || '?'})`;
          if (p.status === 'error') return 'Validation failed';
        }
        if (ev.validation.status === 'warn') return ev.validation.message || 'Needs review';
        return 'Not provided';
      }
      if (key === 'conflict') {
        if (ev.conflict.parsed?.count === 0) return 'No conflicts';
        if (ev.conflict.parsed?.count > 0) return `${ev.conflict.parsed.count} conflict(s)`;
        if (ev.conflict.parsed?.reviewed) return 'Manual review confirmed';
        return 'Not provided';
      }
      if (key === 'smoke') {
        const parts = [];
        if (ev.smokeBaseline.parsed?.pass === true) parts.push('Baseline: PASS');
        else if (ev.smokeBaseline.parsed?.pass === false) parts.push('Baseline: FAIL');
        else if (ev.smokeBaseline.status === 'warn') parts.push('Baseline: Review');
        if (ev.smokeEdge.parsed?.pass === true) parts.push('Edge: PASS');
        else if (ev.smokeEdge.parsed?.pass === false) parts.push('Edge: FAIL');
        else if (ev.smokeEdge.status === 'warn') parts.push('Edge: Review');
        return parts.length > 0 ? parts.join(', ') : 'Not provided';
      }
      return 'Unknown';
    }

    function renderPreflightResult(containerId, evidence) {
      const container = document.getElementById(containerId);
      if (!evidence.parsed && evidence.status === 'pending') {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'block';
      container.className = `preflight-result ${evidence.status}`;
      let html = '';
      if (evidence.message) {
        html += `<div style="margin-bottom:6px;"><em>${evidence.message}</em></div>`;
      }
      if (evidence.parsed) {
        const entries = Object.entries(evidence.parsed).filter(([k, v]) => v !== null && k !== 'conflicts');
        entries.sort((a, b) => a[0].localeCompare(b[0]));
        entries.forEach(([key, val]) => {
          html += `<div class="preflight-result-row"><span class="preflight-result-key">${key}:</span><span class="preflight-result-val">${val}</span></div>`;
        });
        if (evidence.parsed.conflicts && evidence.parsed.conflicts.length > 0) {
          html += `<table class="preflight-conflicts-table"><thead><tr><th>#</th><th>Conflict</th></tr></thead><tbody>`;
          evidence.parsed.conflicts.forEach((c, i) => {
            html += `<tr><td>${i + 1}</td><td>${c}</td></tr>`;
          });
          html += `</tbody></table>`;
        }
      }
      container.innerHTML = html || '<em>Parsed successfully</em>';
    }

    function handlePreflightParse(type) {
      if (type === 'base-version') {
        const input = document.getElementById('preflight-base-version').value;
        const result = parseBaseVersion(input);
        preflightEvidence.baseVersion = { raw: input, ...result };
        renderPreflightResult('preflight-base-result', preflightEvidence.baseVersion);
      } else if (type === 'validation') {
        const input = document.getElementById('preflight-validation-input').value;
        const result = parseValidation(input);
        preflightEvidence.validation = { raw: input, ...result };
        renderPreflightResult('preflight-validation-result', preflightEvidence.validation);
      } else if (type === 'conflict') {
        const input = document.getElementById('preflight-conflict-input').value;
        const result = parseConflict(input);
        preflightEvidence.conflict = { raw: input, ...result };
        renderPreflightResult('preflight-conflict-result', preflightEvidence.conflict);
      } else if (type === 'smoke-baseline') {
        const input = document.getElementById('preflight-smoke-baseline-input').value;
        const result = parseSmoke(input);
        preflightEvidence.smokeBaseline = { raw: input, ...result };
        updateSmokeResult();
      } else if (type === 'smoke-edge') {
        const input = document.getElementById('preflight-smoke-edge-input').value;
        const result = parseSmoke(input);
        preflightEvidence.smokeEdge = { raw: input, ...result };
        updateSmokeResult();
      }
      renderPreflightChecklist();
      savePreflightEvidence();
    }

    function updateSmokeResult() {
      const container = document.getElementById('preflight-smoke-result');
      const baseline = preflightEvidence.smokeBaseline;
      const edge = preflightEvidence.smokeEdge;
      const sha = document.getElementById('preflight-sha256').value;
      preflightEvidence.sha256 = sha;
      if (baseline.status === 'pending' && edge.status === 'pending') {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'block';
      const overallStatus = (baseline.status === 'fail' || edge.status === 'fail') ? 'fail' :
        (baseline.status === 'pass' && (edge.status === 'pass' || edge.status === 'pending')) ? 'pass' : 'warn';
      container.className = `preflight-result ${overallStatus}`;
      let html = '';
      html += `<div class="preflight-result-row"><span class="preflight-result-key">Baseline:</span><span class="preflight-result-val">${baseline.parsed?.pass === true ? 'PASS' : baseline.parsed?.pass === false ? 'FAIL' : baseline.status}</span></div>`;
      if (edge.status !== 'pending') {
        html += `<div class="preflight-result-row"><span class="preflight-result-key">Edge:</span><span class="preflight-result-val">${edge.parsed?.pass === true ? 'PASS' : edge.parsed?.pass === false ? 'FAIL' : edge.status}</span></div>`;
      }
      if (sha) {
        html += `<div class="preflight-result-row"><span class="preflight-result-key">SHA256:</span><span class="preflight-result-val" style="word-break:break-all;">${sha}</span></div>`;
      }
      container.innerHTML = html;
    }

    function handlePreflightClear(type) {
      if (type === 'base-version') {
        document.getElementById('preflight-base-version').value = '';
        preflightEvidence.baseVersion = { raw: '', parsed: null, status: 'pending' };
        document.getElementById('preflight-base-result').style.display = 'none';
      } else if (type === 'validation') {
        document.getElementById('preflight-validation-input').value = '';
        preflightEvidence.validation = { raw: '', parsed: null, status: 'pending' };
        document.getElementById('preflight-validation-result').style.display = 'none';
      } else if (type === 'conflict') {
        document.getElementById('preflight-conflict-input').value = '';
        preflightEvidence.conflict = { raw: '', parsed: null, status: 'pending' };
        document.getElementById('preflight-conflict-result').style.display = 'none';
      } else if (type === 'smoke-baseline') {
        document.getElementById('preflight-smoke-baseline-input').value = '';
        preflightEvidence.smokeBaseline = { raw: '', parsed: null, status: 'pending' };
        updateSmokeResult();
      } else if (type === 'smoke-edge') {
        document.getElementById('preflight-smoke-edge-input').value = '';
        preflightEvidence.smokeEdge = { raw: '', parsed: null, status: 'pending' };
        updateSmokeResult();
      }
      renderPreflightChecklist();
      savePreflightEvidence();
    }

    document.getElementById('panel-preflight').addEventListener('click', e => {
      const parseBtn = e.target.closest('.preflight-parse-btn');
      if (parseBtn) {
        handlePreflightParse(parseBtn.dataset.parse);
        return;
      }
      const clearBtn = e.target.closest('.preflight-clear-btn');
      if (clearBtn) {
        handlePreflightClear(clearBtn.dataset.clear);
        return;
      }
    });

    document.getElementById('preflight-sha256').addEventListener('input', () => {
      preflightEvidence.sha256 = document.getElementById('preflight-sha256').value;
      updateSmokeResult();
      savePreflightEvidence();
    });

    document.getElementById('preflight-reset').addEventListener('click', () => {
      preflightEvidence = {
        baseVersion: { raw: '', parsed: null, status: 'pending' },
        validation: { raw: '', parsed: null, status: 'pending' },
        conflict: { raw: '', parsed: null, status: 'pending' },
        smokeBaseline: { raw: '', parsed: null, status: 'pending' },
        smokeEdge: { raw: '', parsed: null, status: 'pending' },
        sha256: ''
      };
      document.getElementById('preflight-base-version').value = '';
      document.getElementById('preflight-validation-input').value = '';
      document.getElementById('preflight-conflict-input').value = '';
      document.getElementById('preflight-smoke-baseline-input').value = '';
      document.getElementById('preflight-smoke-edge-input').value = '';
      document.getElementById('preflight-sha256').value = '';
      document.getElementById('preflight-base-result').style.display = 'none';
      document.getElementById('preflight-validation-result').style.display = 'none';
      document.getElementById('preflight-conflict-result').style.display = 'none';
      document.getElementById('preflight-smoke-result').style.display = 'none';
      renderPreflightChecklist();
      savePreflightEvidence();
    });

    function savePreflightEvidence() {
      try {
        localStorage.setItem(PREFLIGHT_STORAGE_KEY, JSON.stringify(preflightEvidence));
      } catch (e) {}
    }

    function restorePreflightEvidence() {
      try {
        const stored = localStorage.getItem(PREFLIGHT_STORAGE_KEY);
        if (!stored) return;
        preflightEvidence = JSON.parse(stored);
        document.getElementById('preflight-base-version').value = preflightEvidence.baseVersion?.raw || '';
        document.getElementById('preflight-validation-input').value = preflightEvidence.validation?.raw || '';
        document.getElementById('preflight-conflict-input').value = preflightEvidence.conflict?.raw || '';
        document.getElementById('preflight-smoke-baseline-input').value = preflightEvidence.smokeBaseline?.raw || '';
        document.getElementById('preflight-smoke-edge-input').value = preflightEvidence.smokeEdge?.raw || '';
        document.getElementById('preflight-sha256').value = preflightEvidence.sha256 || '';
        if (preflightEvidence.baseVersion?.status !== 'pending') renderPreflightResult('preflight-base-result', preflightEvidence.baseVersion);
        if (preflightEvidence.validation?.status !== 'pending') renderPreflightResult('preflight-validation-result', preflightEvidence.validation);
        if (preflightEvidence.conflict?.status !== 'pending') renderPreflightResult('preflight-conflict-result', preflightEvidence.conflict);
        if (preflightEvidence.smokeBaseline?.status !== 'pending' || preflightEvidence.smokeEdge?.status !== 'pending') updateSmokeResult();
      } catch (e) {}
    }

    function savePatchDraft() {
      try {
        const toSave = { ...patchDraft, changes: patchDraft.changes.map(c => ({ _key: c._key, _source: c._source, record: c.record })) };
        localStorage.setItem(PATCH_STORAGE_KEY, JSON.stringify(toSave));
      } catch (e) {}
    }

    function restorePatchDraft() {
      try {
        const stored = localStorage.getItem(PATCH_STORAGE_KEY);
        if (!stored) return;
        const data = JSON.parse(stored);
        patchDraft.baseVersion = data.baseVersion || '0.1.0';
        patchDraft.author = data.author || '';
        patchDraft.rationale = data.rationale || '';
        patchDraft.changes = data.changes || [];
        document.getElementById('patch-base-version').value = patchDraft.baseVersion;
        document.getElementById('patch-author').value = patchDraft.author;
        document.getElementById('patch-rationale').value = patchDraft.rationale;
        renderPatchChanges();
      } catch (e) {}
    }

    function generatePRSummaryWithEvidence() {
      const identity = currentSelection.joinIdentity;
      const contract = currentSelection.contractIdx !== null 
        ? allData.contractResults[currentSelection.contractIdx] : null;
      const issues = identity ? sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']) : [];
      const actions = identity ? sortBySeverityFirst(getRelatedRecords(identity, allData.fieldActions), ['sheet', 'field', 'action']) : [];
      const primary = identity ? getPrimaryKey(identity) : null;
      const primaryVal = identity?.[primary] || 'unknown';

      const ev = preflightEvidence;
      const baseVer = ev.baseVersion.parsed?.version || document.getElementById('patch-base-version').value || 'unknown';
      const patchBaseVer = ev.validation.parsed?.patchBaseVersion || document.getElementById('patch-base-version').value || 'unknown';
      const smokeBaselineStatus = ev.smokeBaseline.parsed?.pass === true ? 'PASS' : ev.smokeBaseline.parsed?.pass === false ? 'FAIL' : 'unknown';
      const smokeEdgeStatus = ev.smokeEdge.parsed?.pass === true ? 'PASS' : ev.smokeEdge.parsed?.pass === false ? 'FAIL' : ev.smokeEdge.status === 'pending' ? 'N/A' : 'unknown';
      const sha256 = ev.sha256 || '<SHA256_HASH>';

      let md = `# PR: Fix issues for ${primary || 'unknown'}=${primaryVal}\n\n`;
      md += `## WHY\n`;
      if (identity) {
        md += `This record has ${issues.length} issue(s) and ${actions.length} pending action(s) that need resolution.\n\n`;
      } else {
        md += `Patch draft with ${patchDraft.changes.length} change(s).\n\n`;
      }
      md += `## Affected Artifacts\n`;
      if (identity) {
        md += `- **Join Identity**: ${formatJoinIdentityText(identity)}\n`;
        md += `- **Contract Status**: ${contract?.sf_contract_status || 'unknown'}\n`;
        md += `- **Detected Subtype**: ${contract?.detected_subtype || 'unknown'}\n`;
        if (issues.length > 0) {
          md += `- **Issues**: ${issues.map(i => i.issue_type).join(', ')}\n`;
        }
      }
      md += `\n## Evidence\n`;
      md += `- **base.version**: ${baseVer}\n`;
      md += `- **patch.base_version**: ${patchBaseVer}\n`;
      md += `- **Smoke Baseline**: ${smokeBaselineStatus}\n`;
      md += `- **Smoke Edge**: ${smokeEdgeStatus}\n`;
      md += `- **SHA256**: ${sha256}\n`;
      return md;
    }

    document.getElementById('stream-panel-toggle').addEventListener('click', () => {
      const body = document.getElementById('stream-panel-body');
      const btn = document.getElementById('stream-panel-toggle');
      body.classList.toggle('active');
      btn.textContent = body.classList.contains('active') ? 'Hide' : 'Show';
      if (body.classList.contains('active')) {
        renderRecordStateSummary();
        renderSessionTimeline();
      }
    });

    function deriveRecordState(record) {
      const joinKey = getJoinKey(record);
      const recordIssues = allData.issues.filter(i => getJoinKey(i) === joinKey);
      
      const hasBlocking = recordIssues.some(i => i.severity === 'blocking');
      const hasWarning = recordIssues.some(i => i.severity === 'warning');
      const hasInfo = recordIssues.some(i => i.severity === 'info');
      const hasMissingData = recordIssues.some(i => 
        i.issue_type === 'missing_data' || 
        i.issue_type === 'join_failure' ||
        i.issue_type === 'missing_required'
      );
      
      if (hasBlocking) return 'BLOCKED';
      if (hasMissingData && hasWarning) return 'WAITING';
      if (hasWarning) return 'PARTIAL';
      return 'CONSOLIDATED';
    }

    function computeRecordStates() {
      const states = { CONSOLIDATED: 0, PARTIAL: 0, WAITING: 0, BLOCKED: 0 };
      allData.contractResults.forEach(record => {
        const state = deriveRecordState(record);
        states[state]++;
      });
      return states;
    }

    function renderRecordStateSummary() {
      const container = document.getElementById('record-state-summary');
      const states = computeRecordStates();
      
      container.innerHTML = `
        <div class="record-state-card consolidated">
          <div class="count">${states.CONSOLIDATED}</div>
          <div class="label">Consolidated</div>
        </div>
        <div class="record-state-card partial">
          <div class="count">${states.PARTIAL}</div>
          <div class="label">Partial</div>
        </div>
        <div class="record-state-card waiting">
          <div class="count">${states.WAITING}</div>
          <div class="label">Waiting</div>
        </div>
        <div class="record-state-card blocked">
          <div class="count">${states.BLOCKED}</div>
          <div class="label">Blocked</div>
        </div>
      `;
    }

    function simulateSessions() {
      const total = allData.contractResults.length;
      if (total === 0) return [];
      
      const sessionCount = Math.min(3, Math.ceil(total / 2));
      const sessions = [];
      
      for (let i = 0; i < sessionCount; i++) {
        const isLast = i === sessionCount - 1;
        const consolidatedPct = 0.3 + (i * 0.25);
        const partialPct = 0.3 - (i * 0.1);
        const waitingPct = 0.2 - (i * 0.08);
        const blockedPct = 1 - consolidatedPct - partialPct - waitingPct;
        
        const sessionRecords = Math.ceil(total / sessionCount);
        
        sessions.push({
          index: i + 1,
          name: `Session ${i + 1}`,
          timestamp: `T+${i * 30}min`,
          records: sessionRecords,
          states: {
            CONSOLIDATED: Math.round(sessionRecords * consolidatedPct),
            PARTIAL: Math.round(sessionRecords * partialPct),
            WAITING: Math.round(sessionRecords * waitingPct),
            BLOCKED: Math.max(0, sessionRecords - Math.round(sessionRecords * consolidatedPct) - Math.round(sessionRecords * partialPct) - Math.round(sessionRecords * waitingPct))
          },
          reconsolidated: i > 0 ? Math.round(sessionRecords * 0.1) : 0
        });
      }
      
      return sessions;
    }

    function renderSessionTimeline() {
      const container = document.getElementById('session-timeline');
      const sessions = simulateSessions();
      
      if (sessions.length === 0) {
        container.innerHTML = '<div class="stream-concept"><p>No data loaded. Load an artifact to see simulated sessions.</p></div>';
        return;
      }
      
      container.innerHTML = sessions.map(s => `
        <div class="session-card">
          <div class="session-card-header">
            <span class="session-card-title">${s.name}</span>
            <span class="session-card-idx">${s.timestamp}</span>
          </div>
          <div class="session-card-stats">
            <div><span>Records:</span><span>${s.records}</span></div>
            <div><span class="state-chip consolidated">CONS</span><span>${s.states.CONSOLIDATED}</span></div>
            <div><span class="state-chip partial">PART</span><span>${s.states.PARTIAL}</span></div>
            <div><span class="state-chip waiting">WAIT</span><span>${s.states.WAITING}</span></div>
            <div><span class="state-chip blocked">BLCK</span><span>${s.states.BLOCKED}</span></div>
            ${s.reconsolidated > 0 ? `<div style="color: #2e7d32; font-weight: 500;"><span>Reconsolidated:</span><span>+${s.reconsolidated}</span></div>` : ''}
          </div>
        </div>
      `).join('');
    }

    function generateStreamSemanticsMarkdown() {
      const states = computeRecordStates();
      const sessions = simulateSessions();
      const total = Object.values(states).reduce((a, b) => a + b, 0);
      
      let md = `# Stream Semantics Model\n\n`;
      md += `## Overview\n\n`;
      md += `This document describes the conceptual streaming model for continuous data processing.\n\n`;
      
      md += `## Never-Stop Flow (Open Faucet Model)\n\n`;
      md += `Records flow continuously through the pipeline:\n`;
      md += `- **CONSOLIDATED** records pass through immediately\n`;
      md += `- **PARTIAL** records are usable but flagged for completion\n`;
      md += `- **WAITING** records are held until missing data arrives\n`;
      md += `- **BLOCKED** records require manual intervention\n\n`;
      md += `This prevents backlogs by isolating issues rather than stopping the entire pipeline.\n\n`;
      
      md += `## Current State Distribution\n\n`;
      md += `| State | Count | Percentage |\n`;
      md += `|-------|-------|------------|\n`;
      md += `| CONSOLIDATED | ${states.CONSOLIDATED} | ${total > 0 ? Math.round(states.CONSOLIDATED / total * 100) : 0}% |\n`;
      md += `| PARTIAL | ${states.PARTIAL} | ${total > 0 ? Math.round(states.PARTIAL / total * 100) : 0}% |\n`;
      md += `| WAITING | ${states.WAITING} | ${total > 0 ? Math.round(states.WAITING / total * 100) : 0}% |\n`;
      md += `| BLOCKED | ${states.BLOCKED} | ${total > 0 ? Math.round(states.BLOCKED / total * 100) : 0}% |\n`;
      md += `| **Total** | ${total} | 100% |\n\n`;
      
      md += `## Reconsolidation Rules\n\n`;
      md += `| From State | Condition | To State |\n`;
      md += `|------------|-----------|----------|\n`;
      md += `| PARTIAL | Warnings resolved | CONSOLIDATED |\n`;
      md += `| WAITING | Missing data arrives | PARTIAL or CONSOLIDATED |\n`;
      md += `| BLOCKED | Manual fix + re-submit | CONSOLIDATED |\n`;
      md += `| CONSOLIDATED | New blocking issue | BLOCKED |\n\n`;
      
      if (sessions.length > 0) {
        md += `## Simulated Session Timeline\n\n`;
        md += `| Session | Timestamp | Records | Consolidated | Partial | Waiting | Blocked | Reconsolidated |\n`;
        md += `|---------|-----------|---------|--------------|---------|---------|---------|----------------|\n`;
        sessions.forEach(s => {
          md += `| ${s.name} | ${s.timestamp} | ${s.records} | ${s.states.CONSOLIDATED} | ${s.states.PARTIAL} | ${s.states.WAITING} | ${s.states.BLOCKED} | ${s.reconsolidated > 0 ? '+' + s.reconsolidated : '-'} |\n`;
        });
        md += `\n`;
      }
      
      md += `## Key Benefits\n\n`;
      md += `1. **No Backlogs**: Problems don't stop the entire pipeline\n`;
      md += `2. **Async Resolution**: Issues are resolved in parallel\n`;
      md += `3. **Deterministic States**: State transitions are rule-based and auditable\n`;
      md += `4. **Visibility**: Operators can see exactly where records are in the flow\n`;
      
      return md;
    }

    document.getElementById('copy-stream-semantics').addEventListener('click', async () => {
      const md = generateStreamSemanticsMarkdown();
      const success = await copyToClipboard(md);
      const btn = document.getElementById('copy-stream-semantics');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('simulate-sessions').addEventListener('click', () => {
      renderRecordStateSummary();
      renderSessionTimeline();
    });

    document.getElementById('config-inspector-toggle').addEventListener('click', () => {
      const body = document.getElementById('config-inspector-body');
      const btn = document.getElementById('config-inspector-toggle');
      body.classList.toggle('active');
      btn.textContent = body.classList.contains('active') ? 'Hide' : 'Show';
    });

    async function loadConfigFile(path) {
      const relativePath = path.startsWith('../../') ? path : `../../${path}`;
      const resp = await fetch(relativePath);
      if (!resp.ok) throw new Error(`Failed to load ${path}`);
      return await resp.json();
    }

    function sortChangesArray(changes) {
      const sevOrder = { blocking: 0, warning: 1, info: 2 };
      return [...changes].sort((a, b) => {
        const targetCmp = (a.target || '').localeCompare(b.target || '');
        if (targetCmp !== 0) return targetCmp;
        const actionCmp = (a.action || '').localeCompare(b.action || '');
        if (actionCmp !== 0) return actionCmp;
        const ruleIdA = a.rule?.rule_id || a.rule_id || null;
        const ruleIdB = b.rule?.rule_id || b.rule_id || null;
        if (ruleIdA === null && ruleIdB !== null) return 1;
        if (ruleIdA !== null && ruleIdB === null) return -1;
        if (ruleIdA !== null && ruleIdB !== null) {
          const ruleIdCmp = ruleIdA.localeCompare(ruleIdB);
          if (ruleIdCmp !== 0) return ruleIdCmp;
        }
        const whenSheetA = a.rule?.when?.sheet || '';
        const whenSheetB = b.rule?.when?.sheet || '';
        const whenSheetCmp = whenSheetA.localeCompare(whenSheetB);
        if (whenSheetCmp !== 0) return whenSheetCmp;
        const whenFieldA = a.rule?.when?.field || '';
        const whenFieldB = b.rule?.when?.field || '';
        const whenFieldCmp = whenFieldA.localeCompare(whenFieldB);
        if (whenFieldCmp !== 0) return whenFieldCmp;
        const thenArrA = a.rule?.then || [];
        const thenArrB = b.rule?.then || [];
        const minLen = Math.min(thenArrA.length, thenArrB.length);
        for (let i = 0; i < minLen; i++) {
          const thenA = thenArrA[i] || {};
          const thenB = thenArrB[i] || {};
          const sevA = sevOrder[thenA.severity] ?? 3;
          const sevB = sevOrder[thenB.severity] ?? 3;
          if (sevA !== sevB) return sevA - sevB;
          const thenSheetCmp = (thenA.sheet || '').localeCompare(thenB.sheet || '');
          if (thenSheetCmp !== 0) return thenSheetCmp;
          const thenFieldCmp = (thenA.field || '').localeCompare(thenB.field || '');
          if (thenFieldCmp !== 0) return thenFieldCmp;
        }
        return thenArrA.length - thenArrB.length;
      });
    }

    function computeRulesetDelta(baseConfig, patch) {
      const delta = {
        salesforce_rules: { added: 0, deprecated: 0 },
        qa_rules: { added: 0, deprecated: 0 },
        resolver_rules: { added: 0, deprecated: 0 }
      };
      
      (patch.changes || []).forEach(change => {
        const target = change.target;
        if (!delta[target]) return;
        if (change.action === 'add_rule') delta[target].added++;
        if (change.action === 'deprecate_rule') delta[target].deprecated++;
      });
      
      return delta;
    }

    function renderPatchSummary(baseConfig, patch) {
      const container = document.getElementById('patch-summary');
      const baseVersion = baseConfig.version || '(unknown)';
      const patchBaseVersion = patch.base_version || '(unknown)';
      configVersionMatch = baseVersion === patchBaseVersion;
      const chipClass = configVersionMatch ? 'match' : 'mismatch';
      const chipText = configVersionMatch ? 'MATCH' : 'MISMATCH';
      
      container.innerHTML = `
        <div class="patch-summary-header">
          <h4>Patch Summary</h4>
          <span class="version-chip ${chipClass}">${chipText}</span>
        </div>
        <div class="patch-summary-grid">
          <div class="patch-summary-item">
            <label>base.version</label>
            <div class="value">${baseVersion}</div>
          </div>
          <div class="patch-summary-item">
            <label>patch.base_version</label>
            <div class="value">${patchBaseVersion}</div>
          </div>
          <div class="patch-summary-item">
            <label>Author</label>
            <div class="value">${patch.author || '(not set)'}</div>
          </div>
          <div class="patch-summary-item">
            <label>Rationale</label>
            <div class="value">${patch.rationale || '(not set)'}</div>
          </div>
          <div class="patch-summary-item">
            <label>Changes Count</label>
            <div class="value">${(patch.changes || []).length}</div>
          </div>
        </div>
      `;
      
      updatePreflightFromLoadedConfig(baseVersion, patchBaseVersion, configVersionMatch);
    }

    function updatePreflightFromLoadedConfig(baseVersion, patchBaseVersion, isMatch) {
      preflightEvidence.baseVersion.raw = `base.version: ${baseVersion}, patch.base_version: ${patchBaseVersion}`;
      preflightEvidence.baseVersion.parsed = {
        version: baseVersion,
        patchBaseVersion: patchBaseVersion,
        match: isMatch
      };
      preflightEvidence.baseVersion.status = isMatch ? 'pass' : 'fail';
      
      preflightEvidence.validation.parsed = preflightEvidence.validation.parsed || {};
      preflightEvidence.validation.parsed.baseVersion = baseVersion;
      preflightEvidence.validation.parsed.patchBaseVersion = patchBaseVersion;
      
      savePreflightEvidence();
    }

    function renderRulesetDelta(delta) {
      const container = document.getElementById('ruleset-delta');
      const targets = ['salesforce_rules', 'qa_rules', 'resolver_rules'];
      
      let cardsHtml = '';
      targets.forEach(t => {
        const d = delta[t] || { added: 0, deprecated: 0 };
        cardsHtml += `
          <div class="ruleset-count-card">
            <div class="count added">+${d.added}</div>
            <div class="label">${t.replace('_rules', '')} Added</div>
          </div>
          <div class="ruleset-count-card">
            <div class="count deprecated">-${d.deprecated}</div>
            <div class="label">${t.replace('_rules', '')} Deprecated</div>
          </div>
        `;
      });
      
      container.innerHTML = `
        <h4>Ruleset Delta</h4>
        <div class="ruleset-delta-counts">${cardsHtml}</div>
      `;
    }

    function renderChangesTable(changes) {
      const container = document.getElementById('changes-table');
      const sorted = sortChangesArray(changes);
      
      let rowsHtml = sorted.map(change => {
        const action = change.action || '';
        const target = change.target || '';
        const ruleId = change.rule?.rule_id || change.rule_id || '';
        const when = change.rule?.when || {};
        const whenStr = when.sheet && when.field ? `${when.sheet}.${when.field} ${when.operator || ''} ${JSON.stringify(when.value || '')}` : (change.reason || '');
        const then = change.rule?.then || [];
        const thenStr = then.map(t => `${t.action || ''} ${t.sheet || ''}.${t.field || ''}`).join('; ') || '';
        const severity = then[0]?.severity || '';
        
        return `
          <tr>
            <td><span class="action-chip ${action}">${action}</span></td>
            <td>${target}</td>
            <td>${ruleId || '<span class="null-value">null</span>'}</td>
            <td style="font-size: 0.8em; font-family: monospace;">${whenStr}</td>
            <td style="font-size: 0.8em; font-family: monospace;">${thenStr}</td>
            <td><span class="severity-${severity}">${severity}</span></td>
          </tr>
        `;
      }).join('');
      
      container.innerHTML = `
        <thead><tr>
          <th>Action</th>
          <th>Target</th>
          <th>Rule ID</th>
          <th>When</th>
          <th>Then</th>
          <th>Severity</th>
        </tr></thead>
        <tbody>${rowsHtml}</tbody>
      `;
    }

    function generateRulesetDeltaMarkdown() {
      if (!loadedBaseConfig || !loadedPatch) return '# No config loaded\n';
      
      const baseVersion = loadedBaseConfig.version || '(unknown)';
      const patchBaseVersion = loadedPatch.base_version || '(unknown)';
      const delta = computeRulesetDelta(loadedBaseConfig, loadedPatch);
      const sorted = sortChangesArray(loadedPatch.changes || []);
      
      let md = `# Ruleset Delta\n\n`;
      md += `## Summary\n\n`;
      md += `| Field | Value |\n`;
      md += `|-------|-------|\n`;
      md += `| base.version | ${baseVersion} |\n`;
      md += `| patch.base_version | ${patchBaseVersion} |\n`;
      md += `| Version Match | ${configVersionMatch ? 'YES' : 'NO'} |\n`;
      md += `| Author | ${loadedPatch.author || '(not set)'} |\n`;
      md += `| Changes Count | ${(loadedPatch.changes || []).length} |\n`;
      md += `\n## Rule Counts by Target\n\n`;
      md += `| Target | Added | Deprecated |\n`;
      md += `|--------|-------|------------|\n`;
      ['salesforce_rules', 'qa_rules', 'resolver_rules'].forEach(t => {
        const d = delta[t] || { added: 0, deprecated: 0 };
        md += `| ${t} | +${d.added} | -${d.deprecated} |\n`;
      });
      md += `\n## Changes Detail\n\n`;
      md += `| Action | Target | Rule ID | Severity |\n`;
      md += `|--------|--------|---------|----------|\n`;
      sorted.forEach(change => {
        const action = change.action || '';
        const target = change.target || '';
        const ruleId = change.rule?.rule_id || change.rule_id || '(null)';
        const severity = change.rule?.then?.[0]?.severity || '';
        md += `| ${action} | ${target} | ${ruleId} | ${severity} |\n`;
      });
      md += `\n## Rationale\n\n${loadedPatch.rationale || '(not set)'}\n`;
      
      return md;
    }

    async function loadConfigWithPatch() {
      const basePath = document.getElementById('base-config-path').value.trim();
      const patchPath = document.getElementById('patch-path').value.trim();
      const statusEl = document.getElementById('config-status');
      const resultsEl = document.getElementById('config-results');
      
      if (!basePath) {
        statusEl.style.display = 'block';
        statusEl.className = 'config-inspector-status error';
        statusEl.textContent = 'Base config path is required.';
        return;
      }
      
      try {
        statusEl.style.display = 'block';
        statusEl.className = 'config-inspector-status info';
        statusEl.textContent = 'Loading base config...';
        
        loadedBaseConfig = await loadConfigFile(basePath);
        
        if (patchPath) {
          statusEl.textContent = 'Loading patch...';
          loadedPatch = await loadConfigFile(patchPath);
        } else {
          loadedPatch = { base_version: loadedBaseConfig.version, changes: [], author: '', rationale: '' };
        }
        
        renderPatchSummary(loadedBaseConfig, loadedPatch);
        const delta = computeRulesetDelta(loadedBaseConfig, loadedPatch);
        renderRulesetDelta(delta);
        renderChangesTable(loadedPatch.changes || []);
        
        resultsEl.style.display = 'block';
        statusEl.className = 'config-inspector-status success';
        statusEl.textContent = `Loaded: ${basePath} + ${patchPath || '(no patch)'}`;
        
      } catch (e) {
        statusEl.className = 'config-inspector-status error';
        statusEl.textContent = `Error: ${e.message}`;
        resultsEl.style.display = 'none';
      }
    }

    document.getElementById('load-config').addEventListener('click', loadConfigWithPatch);
    
    document.getElementById('clear-config').addEventListener('click', () => {
      loadedBaseConfig = null;
      loadedPatch = null;
      configVersionMatch = null;
      document.getElementById('config-results').style.display = 'none';
      document.getElementById('config-status').style.display = 'none';
    });

    document.getElementById('copy-ruleset-delta').addEventListener('click', async () => {
      const md = generateRulesetDeltaMarkdown();
      const success = await copyToClipboard(md);
      const btn = document.getElementById('copy-ruleset-delta');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('session-loader-toggle').addEventListener('click', () => {
      const body = document.getElementById('session-loader-body');
      const btn = document.getElementById('session-loader-toggle');
      body.classList.toggle('active');
      btn.textContent = body.classList.contains('active') ? 'Hide' : 'Show';
    });

    async function loadArtifact(path) {
      const relativePath = path.startsWith('../../') ? path : `../../${path}`;
      const resp = await fetch(relativePath);
      if (!resp.ok) throw new Error(`Failed to load ${path}`);
      return await resp.json();
    }

    async function loadDataWithComparison(primaryPath, comparePath) {
      const statusEl = document.getElementById('session-status');
      const errorContainer = document.getElementById('error-container');
      const sourceInfo = document.getElementById('source-info');
      
      try {
        statusEl.style.display = 'block';
        statusEl.className = 'session-loader-status info';
        statusEl.textContent = 'Loading primary artifact...';
        
        const primaryData = await loadArtifact(primaryPath);
        
        renderSummary(primaryData.sf_summary || {});
        allData.contractResults = sortByJoinTriplet(primaryData.sf_contract_results || []);
        allData.issues = sortBySeverityFirst(primaryData.sf_issues || [], ['sheet', 'field', 'issue_type']);
        allData.fieldActions = sortBySeverityFirst(primaryData.sf_field_actions || [], ['sheet', 'field', 'action']);
        allData.changeLog = sortBySeverityFirst(primaryData.sf_change_log || [], ['sheet', 'field', 'notes']);
        
        sourceInfo.textContent = `Primary: ${primaryPath}`;
        
        if (comparePath && comparePath.trim()) {
          statusEl.textContent = 'Loading comparison artifact...';
          try {
            compareData = await loadArtifact(comparePath);
            
            const compareContractResults = sortByJoinTriplet(compareData.sf_contract_results || []);
            const compareIssues = sortBySeverityFirst(compareData.sf_issues || [], ['sheet', 'field', 'issue_type']);
            const compareFieldActions = sortBySeverityFirst(compareData.sf_field_actions || [], ['sheet', 'field', 'action']);
            
            rowChanges.contractResults = computeRowChanges(allData.contractResults, compareContractResults, 'contractResults');
            rowChanges.issues = computeRowChanges(allData.issues, compareIssues, 'issues');
            rowChanges.fieldActions = computeRowChanges(allData.fieldActions, compareFieldActions, 'fieldActions');
            
            deltaStats = computeDeltaStats(primaryData, compareData);
            
            sourceInfo.textContent = `Primary: ${primaryPath} | Compare: ${comparePath}`;
            statusEl.className = 'session-loader-status success';
            statusEl.textContent = `Loaded with comparison. Found ${Object.keys(rowChanges.issues).length + Object.keys(rowChanges.fieldActions).length} row-level changes.`;
          } catch (e) {
            statusEl.className = 'session-loader-status error';
            statusEl.textContent = `Comparison file not found: ${comparePath}. Showing primary only.`;
            compareData = null;
            rowChanges = { contractResults: {}, issues: {}, fieldActions: {} };
            deltaStats = null;
          }
        } else {
          compareData = null;
          rowChanges = { contractResults: {}, issues: {}, fieldActions: {} };
          deltaStats = null;
          statusEl.className = 'session-loader-status success';
          statusEl.textContent = 'Loaded primary artifact (no comparison).';
        }
        
        populateSubtypeDropdown();
        renderDeltaSummary();
        renderAllTables();
        restoreSelection();
        
        errorContainer.innerHTML = '';
      } catch (e) {
        statusEl.className = 'session-loader-status error';
        statusEl.textContent = `Error: ${e.message}`;
        errorContainer.innerHTML = `<div class="error">Could not load artifact: ${e.message}</div>`;
      }
    }

    document.getElementById('load-session').addEventListener('click', () => {
      const primaryPath = document.getElementById('primary-path').value.trim() || 'out/sf_packet.preview.json';
      const comparePath = document.getElementById('compare-path').value.trim();
      loadDataWithComparison(primaryPath, comparePath);
    });

    document.getElementById('clear-compare').addEventListener('click', () => {
      document.getElementById('compare-path').value = '';
      compareData = null;
      rowChanges = { contractResults: {}, issues: {}, fieldActions: {} };
      deltaStats = null;
      renderDeltaSummary();
      renderAllTables();
      document.getElementById('session-status').style.display = 'none';
      document.getElementById('source-info').textContent = `Data source: ${document.getElementById('primary-path').value || 'out/sf_packet.preview.json'}`;
    });

    initRouter();
    loadCommands();
    loadData();
    restorePreflightEvidence();
    restorePatchDraft();
  </script>
</body>
</html>
