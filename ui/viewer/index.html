<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Board Viewer v0.4</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; padding: 20px; }
    h1 { margin-bottom: 10px; color: #1a1a2e; }
    h2 { margin: 20px 0 10px; color: #16213e; border-bottom: 2px solid #0f3460; padding-bottom: 5px; }
    .subtitle { color: #666; margin-bottom: 20px; font-size: 0.9em; }
    .summary { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .summary-card { background: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; min-width: 100px; }
    .summary-card .count { font-size: 2em; font-weight: bold; }
    .summary-card .label { font-size: 0.85em; color: #666; text-transform: uppercase; }
    .ready .count { color: #2e7d32; }
    .needs-review .count { color: #f57c00; }
    .blocked .count { color: #c62828; }
    .contracts .count { color: #1565c0; }
    table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9em; }
    th { background: #1a1a2e; color: white; font-weight: 600; }
    tr:hover { background: #e8f4fd; cursor: pointer; }
    tr:last-child td { border-bottom: none; }
    .severity-blocking { background: #ffebee; color: #c62828; font-weight: bold; }
    .severity-warning { background: #fff3e0; color: #e65100; }
    .severity-info { background: #e3f2fd; color: #1565c0; }
    .status-ready { color: #2e7d32; font-weight: bold; }
    .status-needs_review { color: #f57c00; font-weight: bold; }
    .status-blocked { color: #c62828; font-weight: bold; }
    .diff-pane { background: #263238; color: #eceff1; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.85em; white-space: pre-wrap; margin-bottom: 20px; }
    .diff-pane code { display: block; background: #37474f; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .info { background: #e3f2fd; color: #1565c0; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .source-info { font-size: 0.8em; color: #666; margin-bottom: 20px; }
    .null-value { color: #999; font-style: italic; }
    .table-container { overflow-x: auto; }
    .hidden-row { display: none; }

    .toolbar { background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .toolbar-btn { background: #0f3460; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: background 0.2s; }
    .toolbar-btn:hover { background: #1565c0; }
    .toolbar-confirm { display: flex; align-items: center; gap: 8px; color: #ffeb3b; font-size: 0.85em; margin-left: auto; }
    .toolbar-confirm input { width: 18px; height: 18px; cursor: pointer; }
    .toolbar-confirm label { cursor: pointer; }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 8px; max-width: 700px; width: 90%; max-height: 80vh; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .modal-header { background: #1a1a2e; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; }
    .modal-close { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; line-height: 1; }
    .modal-body { padding: 20px; overflow-y: auto; max-height: calc(80vh - 60px); }
    .modal-command { background: #263238; color: #eceff1; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.9em; word-break: break-all; margin-bottom: 15px; }
    .modal-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .modal-btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9em; }
    .modal-btn-primary { background: #1565c0; color: white; }
    .modal-btn-primary:hover { background: #1976d2; }
    .modal-btn-secondary { background: #e0e0e0; color: #333; }
    .modal-btn-secondary:hover { background: #bdbdbd; }
    .modal-btn-danger { background: #c62828; color: white; }
    .modal-btn-danger:hover { background: #d32f2f; }
    .modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-status { margin-top: 15px; padding: 10px; border-radius: 4px; font-size: 0.85em; }
    .modal-status.success { background: #e8f5e9; color: #2e7d32; }
    .modal-status.error { background: #ffebee; color: #c62828; }
    .modal-status.info { background: #e3f2fd; color: #1565c0; }

    .filters { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .filters-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-group label { font-size: 0.75em; color: #666; text-transform: uppercase; font-weight: 600; }
    .filter-search { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em; width: 250px; }
    .filter-chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .filter-chip { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
    .filter-chip.severity-blocking { background: #ffcdd2; border-color: #c62828; }
    .filter-chip.severity-warning { background: #ffe0b2; border-color: #e65100; }
    .filter-chip.severity-info { background: #bbdefb; border-color: #1565c0; }
    .filter-chip.status-ready { background: #c8e6c9; border-color: #2e7d32; }
    .filter-chip.status-needs_review { background: #ffe0b2; border-color: #f57c00; }
    .filter-chip.status-blocked { background: #ffcdd2; border-color: #c62828; }
    .filter-chip.inactive { opacity: 0.4; }
    .filter-chip:hover { opacity: 1; }
    .filter-select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em; min-width: 150px; }

    .drawer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); display: none; z-index: 900; }
    .drawer-overlay.active { display: block; }
    .drawer { position: fixed; top: 0; right: -550px; width: 550px; height: 100vh; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.2); z-index: 901; transition: right 0.3s ease; display: flex; flex-direction: column; }
    .drawer.active { right: 0; }
    .drawer-header { background: #1a1a2e; color: white; padding: 15px 20px; flex-shrink: 0; }
    .drawer-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .drawer-header h3 { margin: 0; font-size: 1em; }
    .drawer-close { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; line-height: 1; }
    .drawer-identity { display: flex; align-items: center; gap: 10px; }
    .identity-pill { background: #0f3460; padding: 6px 12px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.75em; word-break: break-all; flex-grow: 1; }
    .identity-copy { background: #1565c0; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75em; white-space: nowrap; }
    .identity-copy:hover { background: #1976d2; }
    .drawer-tabs { display: flex; background: #263238; flex-shrink: 0; }
    .drawer-tab { flex: 1; padding: 12px 8px; text-align: center; color: #90a4ae; background: none; border: none; cursor: pointer; font-size: 0.85em; border-bottom: 3px solid transparent; transition: all 0.2s; }
    .drawer-tab:hover { color: white; background: #37474f; }
    .drawer-tab.active { color: white; border-bottom-color: #1565c0; background: #37474f; }
    .drawer-tab-count { display: inline-block; background: #455a64; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75em; margin-left: 4px; }
    .drawer-body { padding: 15px; overflow-y: auto; flex-grow: 1; }
    .drawer-json { background: #263238; color: #eceff1; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.8em; white-space: pre-wrap; word-break: break-all; max-height: 100%; overflow-y: auto; }
    .drawer-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
    .drawer-table th, .drawer-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; }
    .drawer-table th { background: #f5f5f5; font-weight: 600; color: #333; }
    .drawer-table tr:hover { background: #f9f9f9; }
    .drawer-empty { color: #666; font-style: italic; padding: 20px; text-align: center; background: #f9f9f9; border-radius: 6px; }
    .drawer-actions { padding: 15px 20px; border-top: 1px solid #eee; flex-shrink: 0; }
    .drawer-btn { padding: 10px 14px; background: #1565c0; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; }
    .drawer-btn:hover { background: #1976d2; }
    .drawer-actions-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .drawer-btn-secondary { background: #455a64; }
    .drawer-btn-secondary:hover { background: #546e7a; }
    .drawer-warning { background: #fff3e0; color: #e65100; padding: 10px 15px; font-size: 0.85em; border-bottom: 1px solid #ffe0b2; }
    .identity-primary { color: #4caf50; font-weight: bold; }
    .identity-fallback { color: #90a4ae; }
  </style>
</head>
<body>
  <h1>Control Board Viewer</h1>
  <p class="subtitle">v0.4 | Governance-only | Offline-first | Universal Drilldown + Copy PR Kit</p>

  <div class="toolbar" id="toolbar">
    <button class="toolbar-btn" data-cmd="validate">Validate</button>
    <button class="toolbar-btn" data-cmd="preview_baseline">Preview Baseline</button>
    <button class="toolbar-btn" data-cmd="preview_edge">Preview Edge</button>
    <button class="toolbar-btn" data-cmd="smoke_baseline">Smoke Baseline</button>
    <button class="toolbar-btn" data-cmd="smoke_edge">Smoke Edge</button>
    <div class="toolbar-confirm">
      <input type="checkbox" id="confirm-run">
      <label for="confirm-run">I CONFIRM RUN</label>
    </div>
  </div>

  <div class="filters" id="filters">
    <div class="filters-row">
      <div class="filter-group">
        <label>Search</label>
        <input type="text" class="filter-search" id="filter-search" placeholder="Search all fields...">
      </div>
      <div class="filter-group">
        <label>Severity</label>
        <div class="filter-chips" id="severity-chips">
          <span class="filter-chip severity-blocking" data-severity="blocking">Blocking</span>
          <span class="filter-chip severity-warning" data-severity="warning">Warning</span>
          <span class="filter-chip severity-info" data-severity="info">Info</span>
        </div>
      </div>
      <div class="filter-group">
        <label>Status</label>
        <div class="filter-chips" id="status-chips">
          <span class="filter-chip status-ready" data-status="ready">Ready</span>
          <span class="filter-chip status-needs_review" data-status="needs_review">Needs Review</span>
          <span class="filter-chip status-blocked" data-status="blocked">Blocked</span>
        </div>
      </div>
      <div class="filter-group">
        <label>Subtype</label>
        <select class="filter-select" id="filter-subtype">
          <option value="">All Subtypes</option>
        </select>
      </div>
    </div>
  </div>
  
  <div id="source-info" class="source-info"></div>
  <div id="error-container"></div>
  <div id="summary-container"></div>
  
  <div id="diff-container">
    <h2>Diff Verification</h2>
    <div class="diff-pane">
To verify determinism, run the smoke test in your terminal:
<code>bash scripts/replit_smoke.sh</code>
This compares out/sf_packet.preview.json against expected output.
If differences are found, the script will show a unified diff.

Note: This viewer does NOT execute any commands automatically.
    </div>
  </div>
  
  <div id="contract-results-container"></div>
  <div id="issues-container"></div>
  <div id="field-actions-container"></div>

  <div class="modal-overlay" id="command-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-title">Command</h3>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p id="modal-description" style="margin-bottom: 15px; color: #666;"></p>
        <div class="modal-command" id="modal-command"></div>
        <div class="modal-actions">
          <button class="modal-btn modal-btn-primary" id="modal-copy">Copy to Clipboard</button>
          <button class="modal-btn modal-btn-danger" id="modal-run" disabled>Run (Confirm Required)</button>
          <button class="modal-btn modal-btn-secondary" id="modal-cancel">Cancel</button>
        </div>
        <div class="modal-status" id="modal-status" style="display: none;"></div>
      </div>
    </div>
  </div>

  <div class="drawer-overlay" id="drawer-overlay"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-header">
      <div class="drawer-header-row">
        <h3>Record Workbench</h3>
        <button class="drawer-close" id="drawer-close">&times;</button>
      </div>
      <div class="drawer-identity">
        <div class="identity-pill" id="identity-pill"></div>
        <button class="identity-copy" id="identity-copy">Copy ID</button>
      </div>
    </div>
    <div class="drawer-tabs" id="drawer-tabs">
      <button class="drawer-tab active" data-tab="contract">Contract</button>
      <button class="drawer-tab" data-tab="issues">Issues <span class="drawer-tab-count" id="issues-count">0</span></button>
      <button class="drawer-tab" data-tab="actions">Actions <span class="drawer-tab-count" id="actions-count">0</span></button>
      <button class="drawer-tab" data-tab="changelog">Change Log <span class="drawer-tab-count" id="changelog-count">0</span></button>
    </div>
    <div class="drawer-warning" id="drawer-warning" style="display: none;"></div>
    <div class="drawer-body" id="drawer-body"></div>
    <div class="drawer-actions">
      <div class="drawer-actions-grid">
        <button class="drawer-btn" id="drawer-copy">Copy JSON</button>
        <button class="drawer-btn drawer-btn-secondary" id="copy-pr-summary">Copy PR Summary</button>
        <button class="drawer-btn drawer-btn-secondary" id="copy-patch-skeleton">Copy Patch Skeleton</button>
        <button class="drawer-btn drawer-btn-secondary" id="copy-rule-draft">Copy Rule Draft</button>
      </div>
    </div>
  </div>

  <script>
    const PRIMARY_PATH = 'out/sf_packet.preview.json';
    const FALLBACK_PATH = 'examples/expected_outputs/sf_packet.example.json';
    const RELATIVE_PRIMARY = '../../out/sf_packet.preview.json';
    const RELATIVE_FALLBACK = '../../examples/expected_outputs/sf_packet.example.json';
    const COMMANDS_PATH = 'run_commands.json';
    const STORAGE_KEY = 'viewer_selection_v04';

    let commands = {};
    let allData = { contractResults: [], issues: [], fieldActions: [], changeLog: [] };
    let activeFilters = { search: '', severities: ['blocking', 'warning', 'info'], statuses: ['ready', 'needs_review', 'blocked'], subtype: '' };
    let currentSelection = { joinIdentity: null, contractIdx: null, activeTab: 'contract' };

    function normCmp(v) {
      if (v === null || v === undefined) return '';
      return String(v).trim().toLowerCase();
    }

    function isNullOrEmpty(v) {
      return v === null || v === undefined || String(v).trim() === '';
    }

    function normalizeToNull(v) {
      if (v === undefined || (typeof v === 'string' && v.trim() === '')) return null;
      return v;
    }

    function compareNullsLast(aVal, bVal) {
      const aEmpty = isNullOrEmpty(aVal);
      const bEmpty = isNullOrEmpty(bVal);
      if (aEmpty && bEmpty) return 0;
      if (aEmpty) return 1;
      if (bEmpty) return -1;
      return normCmp(aVal).localeCompare(normCmp(bVal));
    }

    function sortByJoinTriplet(arr, extraKeys = []) {
      return [...arr].sort((a, b) => {
        const ck = compareNullsLast(a.contract_key, b.contract_key);
        if (ck !== 0) return ck;
        const fu = compareNullsLast(a.file_url, b.file_url);
        if (fu !== 0) return fu;
        const fn = compareNullsLast(a.file_name, b.file_name);
        if (fn !== 0) return fn;
        for (const key of extraKeys) {
          const cmp = normCmp(a[key]).localeCompare(normCmp(b[key]));
          if (cmp !== 0) return cmp;
        }
        return 0;
      });
    }

    function sortBySeverityFirst(arr, extraKeys = []) {
      const sevOrder = { blocking: 0, warning: 1, info: 2 };
      return [...arr].sort((a, b) => {
        const aOrd = sevOrder[a.severity] ?? 3;
        const bOrd = sevOrder[b.severity] ?? 3;
        if (aOrd !== bOrd) return aOrd - bOrd;
        const ck = compareNullsLast(a.contract_key, b.contract_key);
        if (ck !== 0) return ck;
        const fu = compareNullsLast(a.file_url, b.file_url);
        if (fu !== 0) return fu;
        const fn = compareNullsLast(a.file_name, b.file_name);
        if (fn !== 0) return fn;
        for (const key of extraKeys) {
          const cmp = compareNullsLast(a[key], b[key]);
          if (cmp !== 0) return cmp;
        }
        return 0;
      });
    }

    function getJoinIdentity(record) {
      return {
        contract_key: normalizeToNull(record.contract_key),
        file_url: normalizeToNull(record.file_url),
        file_name: normalizeToNull(record.file_name)
      };
    }

    function joinIdentityEquals(a, b) {
      if (!a || !b) return false;
      const eq = (x, y) => {
        const nx = normalizeToNull(x);
        const ny = normalizeToNull(y);
        if (nx === null && ny === null) return true;
        if (nx === null || ny === null) return false;
        return nx === ny;
      };
      return eq(a.contract_key, b.contract_key) && eq(a.file_url, b.file_url) && eq(a.file_name, b.file_name);
    }

    function getPrimaryKey(identity) {
      if (identity.contract_key !== null) return 'contract_key';
      if (identity.file_url !== null) return 'file_url';
      if (identity.file_name !== null) return 'file_name';
      return null;
    }

    function formatJoinIdentityPill(identity) {
      const primary = getPrimaryKey(identity);
      const format = (key, label, val) => {
        const v = val ?? 'null';
        if (key === primary) return `<span class="identity-primary">${label}=${v}</span>`;
        return `<span class="identity-fallback">${label}=${v}</span>`;
      };
      return `${format('contract_key', 'ck', identity.contract_key)} | ${format('file_url', 'fu', identity.file_url)} | ${format('file_name', 'fn', identity.file_name)}`;
    }

    function formatJoinIdentityText(identity) {
      const ck = identity.contract_key ?? 'null';
      const fu = identity.file_url ?? 'null';
      const fn = identity.file_name ?? 'null';
      const primary = getPrimaryKey(identity);
      return `ck=${ck} | fu=${fu} | fn=${fn} (PRIMARY: ${primary || 'none'})`;
    }

    function getRelatedRecords(identity, dataArray) {
      return dataArray.filter(r => joinIdentityEquals(getJoinIdentity(r), identity));
    }

    function formatValue(v) {
      if (v === null || v === undefined) return '<span class="null-value">null</span>';
      if (typeof v === 'object') return JSON.stringify(v);
      return String(v);
    }

    function matchesSearch(row, search) {
      if (!search) return true;
      const lowerSearch = search.toLowerCase();
      return Object.values(row).some(v => {
        if (v === null || v === undefined) return false;
        return String(v).toLowerCase().includes(lowerSearch);
      });
    }

    function filterData(data, type) {
      return data.filter(row => {
        if (!matchesSearch(row, activeFilters.search)) return false;
        if (type === 'issues' || type === 'fieldActions') {
          if (!activeFilters.severities.includes(row.severity)) return false;
        }
        if (type === 'contractResults') {
          const status = (row.sf_contract_status || '').toLowerCase();
          if (!activeFilters.statuses.includes(status)) return false;
          if (activeFilters.subtype && row.detected_subtype !== activeFilters.subtype) return false;
        }
        return true;
      });
    }

    function renderSummary(summary) {
      const container = document.getElementById('summary-container');
      container.innerHTML = `
        <h2>Summary</h2>
        <div class="summary">
          <div class="summary-card contracts"><div class="count">${summary.contracts || 0}</div><div class="label">Contracts</div></div>
          <div class="summary-card ready"><div class="count">${summary.ready || 0}</div><div class="label">Ready</div></div>
          <div class="summary-card needs-review"><div class="count">${summary.needs_review || 0}</div><div class="label">Needs Review</div></div>
          <div class="summary-card blocked"><div class="count">${summary.blocked || 0}</div><div class="label">Blocked</div></div>
        </div>
      `;
    }

    function renderTable(containerId, title, data, columns, type) {
      const container = document.getElementById(containerId);
      const filtered = filterData(data, type);
      
      if (!data || data.length === 0) {
        container.innerHTML = `<h2>${title}</h2><div class="info">No data</div>`;
        return;
      }
      
      const headers = columns.map(c => `<th>${c.label}</th>`).join('');
      const rows = filtered.map((row, idx) => {
        const cells = columns.map(c => {
          let val = formatValue(row[c.key]);
          let cls = '';
          if (c.key === 'severity') cls = `severity-${row.severity}`;
          if (c.key === 'sf_contract_status') cls = `status-${(row.sf_contract_status || '').toLowerCase()}`;
          return `<td class="${cls}">${val}</td>`;
        }).join('');
        return `<tr data-type="${type}" data-idx="${data.indexOf(row)}">${cells}</tr>`;
      }).join('');
      
      container.innerHTML = `
        <h2>${title} (${filtered.length}/${data.length})</h2>
        <div class="table-container">
          <table><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>
        </div>
      `;
      
      container.querySelectorAll('tbody tr').forEach(tr => {
        tr.addEventListener('click', () => openDrawerFromType(type, parseInt(tr.dataset.idx)));
      });
    }

    function renderAllTables() {
      renderTable('contract-results-container', 'Contract Results', allData.contractResults, [
        { key: 'contract_key', label: 'Contract Key' },
        { key: 'file_name', label: 'File Name' },
        { key: 'file_url', label: 'File URL' },
        { key: 'detected_subtype', label: 'Subtype' },
        { key: 'sf_contract_status', label: 'Status' },
        { key: 'notes', label: 'Notes' }
      ], 'contractResults');
      
      renderTable('issues-container', 'Issues', allData.issues, [
        { key: 'severity', label: 'Severity' },
        { key: 'contract_key', label: 'Contract Key' },
        { key: 'file_name', label: 'File Name' },
        { key: 'sheet', label: 'Sheet' },
        { key: 'field', label: 'Field' },
        { key: 'issue_type', label: 'Issue Type' },
        { key: 'details', label: 'Details' }
      ], 'issues');
      
      renderTable('field-actions-container', 'Field Actions', allData.fieldActions, [
        { key: 'severity', label: 'Severity' },
        { key: 'contract_key', label: 'Contract Key' },
        { key: 'file_name', label: 'File Name' },
        { key: 'sheet', label: 'Sheet' },
        { key: 'field', label: 'Field' },
        { key: 'action', label: 'Action' },
        { key: 'proposed_value', label: 'Proposed Value' },
        { key: 'reason_text', label: 'Reason' }
      ], 'fieldActions');
    }

    function populateSubtypeDropdown() {
      const subtypes = [...new Set(allData.contractResults.map(r => r.detected_subtype).filter(Boolean))].sort();
      const select = document.getElementById('filter-subtype');
      select.innerHTML = '<option value="">All Subtypes</option>' + 
        subtypes.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function renderDrawerTab(tab) {
      const body = document.getElementById('drawer-body');
      const identity = currentSelection.joinIdentity;
      if (!identity) return;

      let content = '';
      let jsonData = null;

      if (tab === 'contract') {
        const contract = currentSelection.contractIdx !== null 
          ? allData.contractResults[currentSelection.contractIdx]
          : allData.contractResults.find(r => joinIdentityEquals(getJoinIdentity(r), identity));
        if (contract) {
          jsonData = contract;
          content = `<pre class="drawer-json">${JSON.stringify(contract, null, 2)}</pre>`;
        } else {
          content = '<div class="drawer-empty">No contract record found for this join identity.</div>';
        }
      } else if (tab === 'issues') {
        const related = sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']);
        jsonData = related;
        if (related.length === 0) {
          content = '<div class="drawer-empty">No related issues for this join identity.</div>';
        } else {
          content = renderDrawerTable(related, [
            { key: 'severity', label: 'Severity' },
            { key: 'sheet', label: 'Sheet' },
            { key: 'field', label: 'Field' },
            { key: 'issue_type', label: 'Type' },
            { key: 'details', label: 'Details' }
          ]);
        }
      } else if (tab === 'actions') {
        const related = sortBySeverityFirst(getRelatedRecords(identity, allData.fieldActions), ['sheet', 'field', 'action']);
        jsonData = related;
        if (related.length === 0) {
          content = '<div class="drawer-empty">No related field actions for this join identity.</div>';
        } else {
          content = renderDrawerTable(related, [
            { key: 'severity', label: 'Severity' },
            { key: 'sheet', label: 'Sheet' },
            { key: 'field', label: 'Field' },
            { key: 'action', label: 'Action' },
            { key: 'proposed_value', label: 'Value' },
            { key: 'reason_text', label: 'Reason' }
          ]);
        }
      } else if (tab === 'changelog') {
        const related = sortBySeverityFirst(getRelatedRecords(identity, allData.changeLog), ['sheet', 'field', 'notes']);
        jsonData = related;
        if (related.length === 0) {
          content = '<div class="drawer-empty">No related change log entries for this join identity.</div>';
        } else {
          content = renderDrawerTable(related, [
            { key: 'severity', label: 'Severity' },
            { key: 'sheet', label: 'Sheet' },
            { key: 'field', label: 'Field' },
            { key: 'notes', label: 'Notes' }
          ]);
        }
      }

      body.innerHTML = content;
      body.dataset.json = JSON.stringify(jsonData, null, 2);
    }

    function renderDrawerTable(data, columns) {
      const headers = columns.map(c => `<th>${c.label}</th>`).join('');
      const rows = data.map(row => {
        const cells = columns.map(c => {
          let val = formatValue(row[c.key]);
          let cls = '';
          if (c.key === 'severity') cls = `severity-${row.severity}`;
          return `<td class="${cls}">${val}</td>`;
        }).join('');
        return `<tr>${cells}</tr>`;
      }).join('');
      return `<table class="drawer-table"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
    }

    function updateTabCounts(identity) {
      const issuesCount = getRelatedRecords(identity, allData.issues).length;
      const actionsCount = getRelatedRecords(identity, allData.fieldActions).length;
      const changelogCount = getRelatedRecords(identity, allData.changeLog).length;
      document.getElementById('issues-count').textContent = issuesCount;
      document.getElementById('actions-count').textContent = actionsCount;
      document.getElementById('changelog-count').textContent = changelogCount;
    }

    function openDrawerFromType(type, idx) {
      const dataMap = { contractResults: allData.contractResults, issues: allData.issues, fieldActions: allData.fieldActions };
      const record = dataMap[type]?.[idx];
      if (!record) return;

      const identity = getJoinIdentity(record);
      currentSelection.joinIdentity = identity;
      currentSelection.sourceType = type;

      const matchingContracts = allData.contractResults.filter(r => joinIdentityEquals(getJoinIdentity(r), identity));
      if (type === 'contractResults') {
        currentSelection.contractIdx = idx;
      } else {
        const contractIdx = allData.contractResults.findIndex(r => joinIdentityEquals(getJoinIdentity(r), identity));
        currentSelection.contractIdx = contractIdx >= 0 ? contractIdx : null;
      }
      currentSelection.activeTab = 'contract';

      document.getElementById('identity-pill').innerHTML = formatJoinIdentityPill(identity);
      updateTabCounts(identity);

      const warning = document.getElementById('drawer-warning');
      if (matchingContracts.length > 1) {
        warning.textContent = `Warning: ${matchingContracts.length} contracts share this join identity. Showing first match deterministically.`;
        warning.style.display = 'block';
      } else {
        warning.style.display = 'none';
      }

      document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.drawer-tab[data-tab="contract"]').classList.add('active');

      renderDrawerTab('contract');

      document.getElementById('drawer').classList.add('active');
      document.getElementById('drawer-overlay').classList.add('active');

      saveSelection();
    }

    function openDrawer(idx) {
      openDrawerFromType('contractResults', idx);
    }

    function closeDrawer() {
      document.getElementById('drawer').classList.remove('active');
      document.getElementById('drawer-overlay').classList.remove('active');
      currentSelection.joinIdentity = null;
      clearSelection();
    }

    function saveSelection() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(currentSelection));
      } catch (e) {}
    }

    function clearSelection() {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {}
    }

    function restoreSelection() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return;
        const sel = JSON.parse(stored);
        if (!sel.joinIdentity) return;

        let contractIdx = sel.contractIdx;
        if (contractIdx !== null && contractIdx !== undefined) {
          const storedRecord = allData.contractResults[contractIdx];
          if (!storedRecord || !joinIdentityEquals(getJoinIdentity(storedRecord), sel.joinIdentity)) {
            contractIdx = allData.contractResults.findIndex(r => joinIdentityEquals(getJoinIdentity(r), sel.joinIdentity));
          }
        } else {
          contractIdx = allData.contractResults.findIndex(r => joinIdentityEquals(getJoinIdentity(r), sel.joinIdentity));
        }

        if (contractIdx < 0) {
          clearSelection();
          return;
        }

        const validTabs = ['contract', 'issues', 'actions', 'changelog'];
        if (!validTabs.includes(sel.activeTab)) {
          sel.activeTab = 'contract';
        }

        sel.contractIdx = contractIdx;
        currentSelection = sel;
        document.getElementById('identity-pill').innerHTML = formatJoinIdentityPill(sel.joinIdentity);
        updateTabCounts(sel.joinIdentity);

        document.querySelectorAll('.drawer-tab').forEach(t => {
          t.classList.toggle('active', t.dataset.tab === sel.activeTab);
        });

        renderDrawerTab(sel.activeTab);

        document.getElementById('drawer').classList.add('active');
        document.getElementById('drawer-overlay').classList.add('active');
      } catch (e) {
        clearSelection();
      }
    }

    function openCommandModal(cmdKey) {
      const cmd = commands.commands?.[cmdKey];
      const desc = commands.descriptions?.[cmdKey] || '';
      if (!cmd) return;
      
      document.getElementById('modal-title').textContent = cmdKey.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      document.getElementById('modal-description').textContent = desc;
      document.getElementById('modal-command').textContent = cmd;
      document.getElementById('modal-status').style.display = 'none';
      updateRunButton();
      document.getElementById('command-modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('command-modal').classList.remove('active');
    }

    function updateRunButton() {
      const confirmChecked = document.getElementById('confirm-run').checked;
      const runBtn = document.getElementById('modal-run');
      runBtn.disabled = !confirmChecked;
      runBtn.textContent = confirmChecked ? 'Run Command' : 'Run (Confirm Required)';
    }

    function showModalStatus(message, type) {
      const status = document.getElementById('modal-status');
      status.textContent = message;
      status.className = 'modal-status ' + type;
      status.style.display = 'block';
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        return true;
      }
    }

    async function loadCommands() {
      try {
        const resp = await fetch(COMMANDS_PATH);
        if (resp.ok) {
          commands = await resp.json();
        }
      } catch (e) {
        console.warn('Could not load run_commands.json');
      }
    }

    async function loadData() {
      const errorContainer = document.getElementById('error-container');
      const sourceInfo = document.getElementById('source-info');
      
      let data = null;
      let source = '';
      
      try {
        const resp = await fetch(RELATIVE_PRIMARY);
        if (resp.ok) {
          data = await resp.json();
          source = PRIMARY_PATH;
        }
      } catch (e) {}
      
      if (!data) {
        try {
          const resp = await fetch(RELATIVE_FALLBACK);
          if (resp.ok) {
            data = await resp.json();
            source = FALLBACK_PATH + ' (fallback)';
          }
        } catch (e) {}
      }
      
      if (!data) {
        errorContainer.innerHTML = `<div class="error">Could not load sf_packet data. Ensure you are serving this file from the repository root or the JSON files exist at the expected paths.</div>`;
        return;
      }
      
      sourceInfo.textContent = `Data source: ${source}`;
      
      renderSummary(data.sf_summary || {});
      
      allData.contractResults = sortByJoinTriplet(data.sf_contract_results || []);
      allData.issues = sortBySeverityFirst(data.sf_issues || [], ['sheet', 'field', 'issue_type']);
      allData.fieldActions = sortBySeverityFirst(data.sf_field_actions || [], ['sheet', 'field', 'action']);
      allData.changeLog = sortBySeverityFirst(data.sf_change_log || [], ['sheet', 'field', 'notes']);
      
      populateSubtypeDropdown();
      renderAllTables();
      restoreSelection();
    }

    document.getElementById('toolbar').addEventListener('click', async e => {
      const btn = e.target.closest('.toolbar-btn');
      if (btn) {
        const cmdKey = btn.dataset.cmd;
        const cmd = commands.commands?.[cmdKey];
        if (cmd) {
          const success = await copyToClipboard(cmd);
          openCommandModal(cmdKey);
          showModalStatus(success ? 'Command copied to clipboard!' : 'Could not auto-copy', success ? 'success' : 'error');
        }
      }
    });

    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-cancel').addEventListener('click', closeModal);
    document.getElementById('command-modal').addEventListener('click', e => {
      if (e.target.id === 'command-modal') closeModal();
    });

    document.getElementById('modal-copy').addEventListener('click', async () => {
      const cmd = document.getElementById('modal-command').textContent;
      const success = await copyToClipboard(cmd);
      showModalStatus(success ? 'Copied to clipboard!' : 'Copy failed', success ? 'success' : 'error');
    });

    document.getElementById('modal-run').addEventListener('click', () => {
      showModalStatus('Execution is not available in browser environment. Please run the copied command in your terminal.', 'info');
    });

    document.getElementById('confirm-run').addEventListener('change', updateRunButton);

    document.getElementById('drawer-close').addEventListener('click', closeDrawer);
    document.getElementById('drawer-overlay').addEventListener('click', closeDrawer);

    document.getElementById('drawer-tabs').addEventListener('click', e => {
      const tab = e.target.closest('.drawer-tab');
      if (!tab) return;
      const tabName = tab.dataset.tab;
      currentSelection.activeTab = tabName;
      document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      renderDrawerTab(tabName);
      saveSelection();
    });

    document.getElementById('drawer-copy').addEventListener('click', async () => {
      const rawJson = document.getElementById('drawer-body').dataset.json || '{}';
      const parsed = JSON.parse(rawJson);
      const sorted = sortObjectKeys(parsed);
      const json = JSON.stringify(sorted, null, 2);
      const success = await copyToClipboard(json);
      const btn = document.getElementById('drawer-copy');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('identity-copy').addEventListener('click', async () => {
      const identity = currentSelection.joinIdentity;
      if (!identity) return;
      const text = formatJoinIdentityText(identity);
      const success = await copyToClipboard(text);
      const btn = document.getElementById('identity-copy');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    function sortObjectKeys(obj) {
      if (obj === null || typeof obj !== 'object') return obj;
      if (Array.isArray(obj)) return obj.map(sortObjectKeys);
      return Object.keys(obj).sort().reduce((acc, key) => {
        acc[key] = sortObjectKeys(obj[key]);
        return acc;
      }, {});
    }

    function generatePRSummary() {
      const identity = currentSelection.joinIdentity;
      if (!identity) return '';
      const contract = currentSelection.contractIdx !== null 
        ? allData.contractResults[currentSelection.contractIdx] : null;
      const issues = sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']);
      const actions = sortBySeverityFirst(getRelatedRecords(identity, allData.fieldActions), ['sheet', 'field', 'action']);
      const primary = getPrimaryKey(identity);
      const primaryVal = identity[primary] || 'unknown';

      let md = `# PR: Fix issues for ${primary}=${primaryVal}\n\n`;
      md += `## WHY\n`;
      md += `This record has ${issues.length} issue(s) and ${actions.length} pending action(s) that need resolution.\n\n`;
      md += `## Affected Artifacts\n`;
      md += `- **Join Identity**: ${formatJoinIdentityText(identity)}\n`;
      md += `- **Contract Status**: ${contract?.sf_contract_status || 'unknown'}\n`;
      md += `- **Detected Subtype**: ${contract?.detected_subtype || 'unknown'}\n`;
      if (issues.length > 0) {
        md += `- **Issues**: ${issues.map(i => i.issue_type).join(', ')}\n`;
      }
      md += `\n## Smoke Status\nunknown (run \`bash scripts/replit_smoke.sh\` to verify)\n`;
      return md;
    }

    function generatePatchSkeleton() {
      const identity = currentSelection.joinIdentity;
      if (!identity) return '{}';
      const issues = sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']);
      const primary = getPrimaryKey(identity);
      const primaryVal = (identity[primary] || 'unknown').replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
      const patch = {
        base_version: "0.1.0",
        changes: issues.map((issue, idx) => ({
          op: "add_rule",
          rule_id: `NEW_RULE_${primaryVal}_${idx + 1}`,
          description: `Fix: ${issue.issue_type} on ${issue.field || 'unknown'}`,
          when: { sheet: issue.sheet || "", field: issue.field || "", operator: "EXISTS", value: null },
          then: { action: "REQUIRE_PRESENT", sheet: issue.sheet || "", field: issue.field || "", severity: issue.severity || "warning" }
        }))
      };
      return JSON.stringify(sortObjectKeys(patch), null, 2);
    }

    function generateRuleDraft() {
      const identity = currentSelection.joinIdentity;
      if (!identity) return '';
      const issues = sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']);
      const primary = getPrimaryKey(identity);
      
      let draft = `# Rule Draft\n\n`;
      if (issues.length === 0) {
        draft += `No issues found for this join identity.\n`;
      } else {
        issues.forEach((issue, idx) => {
          draft += `## Rule ${idx + 1}\n\n`;
          draft += `**WHEN**\n`;
          draft += `- Sheet: ${issue.sheet || 'any'}\n`;
          draft += `- Field: ${issue.field || 'any'}\n`;
          draft += `- Condition: ${issue.issue_type || 'unknown'}\n\n`;
          draft += `**THEN**\n`;
          draft += `- Action: REQUIRE_PRESENT\n`;
          draft += `- Severity: ${issue.severity || 'warning'}\n\n`;
          draft += `**BECAUSE**\n`;
          draft += `- ${issue.details || 'Issue detected during validation'}\n`;
          draft += `- Primary key: ${primary}=${identity[primary]}\n\n`;
        });
      }
      return draft;
    }

    document.getElementById('copy-pr-summary').addEventListener('click', async () => {
      const text = generatePRSummary();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-pr-summary');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-patch-skeleton').addEventListener('click', async () => {
      const text = generatePatchSkeleton();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-patch-skeleton');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-rule-draft').addEventListener('click', async () => {
      const text = generateRuleDraft();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-rule-draft');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('filter-search').addEventListener('input', e => {
      activeFilters.search = e.target.value;
      renderAllTables();
    });

    document.getElementById('severity-chips').addEventListener('click', e => {
      const chip = e.target.closest('.filter-chip');
      if (!chip) return;
      const sev = chip.dataset.severity;
      const idx = activeFilters.severities.indexOf(sev);
      if (idx >= 0) {
        activeFilters.severities.splice(idx, 1);
        chip.classList.add('inactive');
      } else {
        activeFilters.severities.push(sev);
        chip.classList.remove('inactive');
      }
      renderAllTables();
    });

    document.getElementById('status-chips').addEventListener('click', e => {
      const chip = e.target.closest('.filter-chip');
      if (!chip) return;
      const status = chip.dataset.status;
      const idx = activeFilters.statuses.indexOf(status);
      if (idx >= 0) {
        activeFilters.statuses.splice(idx, 1);
        chip.classList.add('inactive');
      } else {
        activeFilters.statuses.push(status);
        chip.classList.remove('inactive');
      }
      renderAllTables();
    });

    document.getElementById('filter-subtype').addEventListener('change', e => {
      activeFilters.subtype = e.target.value;
      renderAllTables();
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeModal();
        closeDrawer();
      }
    });

    loadCommands();
    loadData();
  </script>
</body>
</html>
