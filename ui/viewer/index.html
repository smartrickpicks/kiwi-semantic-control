<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orchestrate OS â€” Semantic Control Board</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; margin: 0; padding: 0; }
    h1 { margin-bottom: 10px; color: #1a1a2e; }

    .app-layout { display: flex; min-height: 100vh; }
    .nav-sidebar { width: 280px; background: #1a1a2e; color: white; flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; }
    .nav-header { padding: 16px 20px; border-bottom: 1px solid #2d2d4a; }
    .nav-header h1 { font-size: 1em; color: white; margin: 0; }
    .nav-header .version { font-size: 0.7em; color: #888; margin-top: 4px; }
    .nav-menu { flex-grow: 1; padding: 10px 0; overflow-y: auto; }
    .nav-section { margin-bottom: 8px; }
    .nav-section-header { padding: 8px 20px 6px; font-size: 0.65em; color: #666; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .nav-item { display: flex; align-items: center; padding: 10px 20px; color: #aaa; text-decoration: none; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
    .nav-item:hover { background: #2d2d4a; color: white; }
    .nav-item.active { background: #0f3460; color: white; border-left-color: #1565c0; }
    .nav-item.queue-item { padding: 8px 20px; }
    .nav-icon { width: 18px; margin-right: 10px; text-align: center; font-size: 0.9em; }
    .nav-label { font-size: 0.85em; flex-grow: 1; }
    .nav-count { background: #3d3d5c; color: #aaa; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 600; margin-left: 8px; }
    .nav-count.has-items { background: #1565c0; color: white; }
    .nav-count.blocking { background: #c62828; color: white; }
    .nav-severity-chips { display: flex; gap: 3px; margin-left: 8px; }
    .nav-severity-chip { width: 6px; height: 6px; border-radius: 50%; }
    .nav-severity-chip.blocking { background: #c62828; }
    .nav-severity-chip.warning { background: #f57c00; }
    .nav-severity-chip.info { background: #1565c0; }
    .nav-divider { height: 1px; background: #2d2d4a; margin: 8px 20px; }
    .nav-mode-section { padding: 12px 20px; border-top: 1px solid #2d2d4a; }
    .nav-mode-label { font-size: 0.65em; color: #666; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
    .mode-toggle { display: flex; gap: 4px; flex-wrap: wrap; }
    .mode-btn { padding: 6px 12px; font-size: 0.75em; border: 1px solid #555; background: transparent; color: #aaa; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
    .mode-btn:hover { border-color: #888; color: white; }
    .mode-btn.active { background: #1565c0; border-color: #1565c0; color: white; }
    .mode-btn.mode-analyst { }
    .mode-btn.mode-reviewer { }
    .mode-btn.mode-admin { }

    .main-content { flex-grow: 1; padding: 20px; overflow-y: auto; max-height: 100vh; }
    .page { display: none; }
    .page.active { display: block; }
    .page-header { margin-bottom: 20px; }
    .page-header h2 { color: #1a1a2e; font-size: 1.4em; margin-bottom: 5px; }
    .page-header .page-desc { color: #666; font-size: 0.9em; }

    .mode-hidden { display: none !important; }
    .mode-dimmed { opacity: 0.5; pointer-events: none; }
    h2 { margin: 20px 0 10px; color: #16213e; border-bottom: 2px solid #0f3460; padding-bottom: 5px; }
    .subtitle { color: #666; margin-bottom: 20px; font-size: 0.9em; }
    .summary { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .summary-card { background: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; min-width: 100px; }
    .summary-card .count { font-size: 2em; font-weight: bold; }
    .summary-card .label { font-size: 0.85em; color: #666; text-transform: uppercase; }
    .summary-card.clickable { cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
    .summary-card.clickable:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .ready .count { color: #2e7d32; }
    .needs-review .count { color: #f57c00; }
    .blocked .count { color: #c62828; }
    .contracts .count { color: #1565c0; }
    table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9em; }
    th { background: #1a1a2e; color: white; font-weight: 600; }
    tr:hover { background: #e8f4fd; cursor: pointer; }
    tr:last-child td { border-bottom: none; }
    .severity-blocking { background: #ffebee; color: #c62828; font-weight: bold; }
    .severity-warning { background: #fff3e0; color: #e65100; }
    .severity-info { background: #e3f2fd; color: #1565c0; }
    .status-ready { color: #2e7d32; font-weight: bold; }
    .status-needs_review { color: #f57c00; font-weight: bold; }
    .status-blocked { color: #c62828; font-weight: bold; }
    .diff-pane { background: #263238; color: #eceff1; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.85em; white-space: pre-wrap; margin-bottom: 20px; }
    .diff-pane code { display: block; background: #37474f; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .info { background: #e3f2fd; color: #1565c0; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .source-info { font-size: 0.8em; color: #666; margin-bottom: 20px; }
    .null-value { color: #999; font-style: italic; }
    .table-container { overflow-x: auto; }
    .hidden-row { display: none; }

    .toolbar { background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .toolbar-btn { background: #0f3460; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: background 0.2s; }
    .toolbar-btn:hover { background: #1565c0; }
    .toolbar-confirm { display: flex; align-items: center; gap: 8px; color: #ffeb3b; font-size: 0.85em; margin-left: auto; }
    .toolbar-confirm input { width: 18px; height: 18px; cursor: pointer; }
    .toolbar-confirm label { cursor: pointer; }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 8px; max-width: 700px; width: 90%; max-height: 80vh; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    
    /* Drawer (right-side slide-over panel) */
    .drawer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); display: none; z-index: 1000; }
    .drawer-overlay.active { display: block; }
    .drawer { position: fixed; top: 0; right: -420px; width: 400px; height: 100vh; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.2); transition: right 0.25s ease-out; z-index: 1001; display: flex; flex-direction: column; }
    .drawer-overlay.active .drawer { right: 0; }
    .drawer-header { background: #1a1a2e; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .drawer-header h3 { margin: 0; font-size: 1.1em; font-weight: 600; }
    .drawer-close { background: none; border: none; color: white; font-size: 1.4em; cursor: pointer; line-height: 1; padding: 0; opacity: 0.8; }
    .drawer-close:hover { opacity: 1; }
    .drawer-body { flex: 1; overflow-y: auto; padding: 20px; }
    .drawer-footer { padding: 15px 20px; border-top: 1px solid #e0e0e0; background: #f8f9fa; flex-shrink: 0; }
    
    /* First-Run Banner */
    .first-run-banner { display: flex; align-items: center; gap: 12px; padding: 10px 20px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-bottom: 1px solid #bbdefb; font-size: 0.9em; }
    .first-run-banner .banner-icon { font-size: 1.2em; }
    .first-run-banner .banner-text { flex: 1; color: #1565c0; }
    .first-run-banner .banner-dismiss { background: none; border: none; font-size: 1.2em; color: #666; cursor: pointer; padding: 4px 8px; line-height: 1; }
    .first-run-banner .banner-dismiss:hover { color: #333; }
    
    /* Configure Button Style */
    .top-toolbar-btn.configure-btn { background: linear-gradient(135deg, #7c4dff 0%, #536dfe 100%); color: white; border: none; }
    .top-toolbar-btn.configure-btn:hover { background: linear-gradient(135deg, #651fff 0%, #304ffe 100%); }
    
    /* Wizard Progress Dots */
    .wizard-step-dot { width: 12px; height: 12px; border-radius: 50%; background: #e0e0e0; transition: background 0.2s; }
    .wizard-step-dot.active { background: #7c4dff; }
    .wizard-step-dot.completed { background: #4caf50; }
    
    /* Config Flows Rail */
    .rail-item { display: flex; align-items: center; gap: 10px; padding: 10px 15px; cursor: pointer; color: #555; text-decoration: none; transition: background 0.15s; }
    .rail-item:hover { background: #e8e8e8; }
    .rail-item.active { background: #e3f2fd; color: #1565c0; border-left: 3px solid #1565c0; }
    .rail-number { width: 22px; height: 22px; border-radius: 50%; background: #ddd; color: #666; display: flex; align-items: center; justify-content: center; font-size: 0.75em; font-weight: 600; flex-shrink: 0; }
    .rail-item.active .rail-number { background: #1565c0; color: white; }
    .rail-label { font-size: 0.85em; }
    
    /* Config Flows Tabs */
    .stage-tab { padding: 8px 16px; border: none; background: none; cursor: pointer; font-size: 0.85em; color: #666; border-bottom: 2px solid transparent; }
    .stage-tab:hover { color: #333; }
    .stage-tab.active { color: #1565c0; border-bottom-color: #1565c0; }
    
    /* Wizard Form Elements */
    .wizard-form-group { margin-bottom: 18px; }
    .wizard-form-group label { display: block; font-weight: 500; margin-bottom: 6px; color: #333; }
    .wizard-form-group .hint { font-size: 0.8em; color: #888; margin-top: 4px; }
    .wizard-toggle { display: flex; align-items: center; gap: 10px; padding: 12px; background: #f5f5f5; border-radius: 8px; cursor: pointer; }
    .wizard-toggle input { width: 18px; height: 18px; }
    .wizard-toggle-label { flex: 1; }
    .wizard-toggle-label strong { display: block; margin-bottom: 2px; }
    .wizard-toggle-label small { color: #666; }
    .wizard-multi-select { display: flex; flex-wrap: wrap; gap: 8px; }
    .wizard-multi-select label { display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #f5f5f5; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
    .wizard-multi-select label:has(input:checked) { background: #e8eaf6; border: 1px solid #7c4dff; }
    .wizard-multi-select input { width: 16px; height: 16px; }
    .modal-header { background: #1a1a2e; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; }
    .modal-close { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; line-height: 1; }
    .modal-body { padding: 20px; overflow-y: auto; max-height: calc(80vh - 60px); }
    .modal-command { background: #263238; color: #eceff1; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.9em; word-break: break-all; margin-bottom: 15px; }
    .modal-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .modal-btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9em; }
    .modal-btn-primary { background: #1565c0; color: white; }
    .modal-btn-primary:hover { background: #1976d2; }
    .modal-btn-secondary { background: #e0e0e0; color: #333; }
    .modal-btn-secondary:hover { background: #bdbdbd; }
    .modal-btn-danger { background: #c62828; color: white; }
    .modal-btn-danger:hover { background: #d32f2f; }
    .modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-status { margin-top: 15px; padding: 10px; border-radius: 4px; font-size: 0.85em; }
    .modal-status.success { background: #e8f5e9; color: #2e7d32; }
    .modal-status.error { background: #ffebee; color: #c62828; }
    .modal-status.info { background: #e3f2fd; color: #1565c0; }

    /* Welcome Hero (no data loaded) */
    .welcome-hero { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; padding: 40px; }
    .welcome-hero.hidden { display: none; }
    .welcome-hero h2 { font-size: 1.8em; color: #1a1a2e; margin-bottom: 10px; }
    .welcome-hero p { color: #666; margin-bottom: 30px; max-width: 500px; }
    .welcome-cta { background: #1565c0; color: white; border: none; padding: 16px 32px; border-radius: 8px; font-size: 1.1em; cursor: pointer; transition: background 0.2s; }
    .welcome-cta:hover { background: #1976d2; }
    .welcome-hint { margin-top: 20px; font-size: 0.85em; color: #888; }

    /* Top Toolbar (fixed) */
    .top-toolbar { background: white; border-bottom: 1px solid #ddd; padding: 10px 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .top-toolbar-left { display: flex; align-items: center; gap: 10px; }
    .top-toolbar-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
    .top-toolbar-btn { background: #e8f4fd; color: #1565c0; border: 1px solid #bbdefb; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .top-toolbar-btn:hover { background: #1565c0; color: white; border-color: #1565c0; }
    .top-toolbar-btn.primary { background: #1565c0; color: white; border-color: #1565c0; }
    .top-toolbar-btn.primary:hover { background: #0d47a1; }
    .data-indicator { display: flex; align-items: center; gap: 8px; font-size: 0.85em; color: #666; }
    .data-indicator .dot { width: 10px; height: 10px; border-radius: 50%; background: #4caf50; }
    .data-indicator .dot.no-data { background: #ff9800; }
    .data-indicator-path { font-family: monospace; background: #f5f5f5; padding: 4px 8px; border-radius: 4px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Wizard Modal */
    .wizard-modal { max-width: 600px; }
    .wizard-field { margin-bottom: 20px; }
    .wizard-field label { display: block; font-weight: 600; margin-bottom: 6px; color: #333; font-size: 0.9em; }
    .wizard-field input, .wizard-field select { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em; }
    .wizard-field input:focus, .wizard-field select:focus { border-color: #1565c0; outline: none; }
    .wizard-field .hint { font-size: 0.8em; color: #888; margin-top: 4px; }
    .wizard-section { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .wizard-section h4 { margin: 0 0 10px; font-size: 0.95em; color: #1a1a2e; }
    .wizard-divider { border-top: 1px solid #eee; margin: 20px 0; }
    .wizard-row { display: flex; gap: 15px; }
    .wizard-row .wizard-field { flex: 1; }
    .wizard-preset { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .wizard-preset-btn { padding: 6px 12px; background: #e0e0e0; border: none; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: background 0.2s; }
    .wizard-preset-btn:hover { background: #bdbdbd; }
    .wizard-preset-btn.active { background: #1565c0; color: white; }

    /* Nav item mode visibility */
    .nav-item.reviewer-only { display: none; }
    .nav-item.admin-only { display: none; }
    .mode-reviewer .nav-item.reviewer-only { display: flex; }
    .mode-admin .nav-item.reviewer-only { display: flex; }
    .mode-admin .nav-item.admin-only { display: flex; }
    
    /* Role-based visibility for any element */
    .admin-only-content { display: none !important; }
    .reviewer-only-content { display: none !important; }
    .mode-admin .admin-only-content { display: block !important; }
    .mode-admin .admin-only-content.flex { display: flex !important; }
    .mode-reviewer .reviewer-only-content { display: block !important; }
    .mode-admin .reviewer-only-content { display: block !important; }
    
    /* Loader Modal */
    .loader-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1001; justify-content: center; align-items: center; }
    .loader-modal-overlay.active { display: flex; }
    .loader-modal { background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.25); z-index: 1002; display: flex; flex-direction: column; max-width: 520px; width: 90%; max-height: 85vh; animation: modalFadeIn 0.2s ease-out; }
    @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .loader-modal-header { background: #1565c0; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-radius: 12px 12px 0 0; }
    .loader-modal-header h3 { margin: 0; font-size: 1.1em; font-weight: 600; }
    .loader-modal-close { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 4px 10px; border-radius: 4px; line-height: 1; }
    .loader-modal-close:hover { background: rgba(255,255,255,0.2); }
    .loader-modal-body { flex: 1; overflow-y: auto; padding: 24px; }

    /* Session Status Chip */
    .session-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; }
    .session-chip.not-loaded { background: #fff3e0; color: #e65100; }
    .session-chip.loaded { background: #e8f5e9; color: #2e7d32; }
    .session-chip.fallback { background: #e3f2fd; color: #1565c0; }
    .session-chip .chip-dot { width: 6px; height: 6px; border-radius: 50%; }
    .session-chip.not-loaded .chip-dot { background: #e65100; }
    .session-chip.loaded .chip-dot { background: #2e7d32; }
    .session-chip.fallback .chip-dot { background: #1565c0; }
    .session-meta { font-size: 0.75em; color: #888; margin-left: 10px; }

    /* Drop Zone */
    .drop-zone { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background: #fafafa; transition: all 0.2s; cursor: pointer; margin-bottom: 10px; }
    .drop-zone:hover { border-color: #1565c0; background: #e8f4fd; }
    .drop-zone.drag-over { border-color: #1565c0; background: #bbdefb; }
    .drop-zone.has-file { border-color: #2e7d32; background: #e8f5e9; }
    .drop-zone-icon { font-size: 1.5em; margin-bottom: 8px; }
    .drop-zone-text { font-size: 0.85em; color: #666; }
    .drop-zone-file { font-size: 0.85em; color: #2e7d32; font-weight: 600; margin-top: 5px; }

    /* Paste Area */
    .paste-area { width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.8em; resize: vertical; margin-bottom: 10px; }
    .paste-area:focus { border-color: #1565c0; outline: none; }
    .paste-area.valid { border-color: #2e7d32; background: #f1f8e9; }
    .paste-area.invalid { border-color: #c62828; background: #ffebee; }

    /* Path Hint */
    .path-hint-container { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f5f5f5; border-radius: 6px; margin-bottom: 10px; }
    .path-hint-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.85em; background: white; }
    .path-hint-label { font-size: 0.75em; color: #888; background: #eee; padding: 2px 6px; border-radius: 3px; }
    .path-hint-warning { font-size: 0.75em; color: #f57c00; margin-top: 5px; display: flex; align-items: center; gap: 5px; }

    /* Loader Tabs */
    .loader-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .loader-tab { padding: 8px 16px; border: none; background: #e0e0e0; color: #666; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
    .loader-tab:hover { background: #ccc; }
    .loader-tab.active { background: #1565c0; color: white; }
    .loader-panel { display: none; }
    .loader-panel.active { display: block; }

    /* Loader Section */
    .loader-section { background: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
    .loader-section h4 { margin: 0 0 10px; font-size: 0.95em; color: #1a1a2e; display: flex; align-items: center; gap: 8px; }
    .loader-section h4 .required { color: #c62828; font-size: 0.8em; }
    .loader-section h4 .optional { color: #888; font-size: 0.8em; font-weight: normal; }
    .loader-section-status { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 600; margin-left: auto; }
    .loader-section-status.empty { background: #eee; color: #888; }
    .loader-section-status.loaded { background: #e8f5e9; color: #2e7d32; }

    /* Remember Toggle */
    .remember-toggle { display: flex; align-items: center; gap: 8px; margin-top: 15px; padding: 10px; background: #fff8e1; border-radius: 6px; }
    .remember-toggle input { width: 18px; height: 18px; cursor: pointer; }
    .remember-toggle label { font-size: 0.85em; color: #666; cursor: pointer; }

    /* Reset Button */
    .reset-session-btn { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; }

    /* Empty Queue Message */
    .empty-queue-message { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50vh; text-align: center; padding: 40px; background: #fafafa; border-radius: 12px; margin: 20px 0; }
    .empty-queue-message.hidden { display: none; }
    .empty-queue-icon { font-size: 3em; margin-bottom: 15px; }
    .empty-queue-message h3 { font-size: 1.3em; color: #333; margin-bottom: 10px; }
    .empty-queue-message p { color: #666; margin-bottom: 20px; max-width: 400px; line-height: 1.5; }
    .empty-queue-cta { background: #1565c0; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: background 0.2s; }
    .empty-queue-cta:hover { background: #1976d2; }

    /* Data Sources Drawer (right-side slide-over) */
    .data-drawer { position: fixed; top: 0; right: -420px; width: 420px; height: 100vh; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.2); z-index: 950; transition: right 0.3s ease; display: flex; flex-direction: column; }
    .data-drawer.active { right: 0; }
    .data-drawer-header { background: #1a1a2e; color: white; padding: 16px 20px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .data-drawer-header h3 { margin: 0; font-size: 1.1em; }
    .data-drawer-close { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; line-height: 1; }
    .data-drawer-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
    .data-drawer-section { background: #f9f9f9; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .data-drawer-section h4 { margin: 0 0 8px; font-size: 0.95em; color: #333; display: flex; align-items: center; gap: 8px; }
    .data-drawer-section h4 .required { color: #c62828; font-size: 0.75em; font-weight: 600; }
    .data-drawer-section h4 .optional { color: #888; font-size: 0.75em; font-weight: normal; }
    .data-drawer-section p { font-size: 0.8em; color: #666; margin: 0 0 12px; line-height: 1.4; }
    .data-drawer-section .info-tooltip { display: inline-block; width: 14px; height: 14px; background: #1565c0; color: white; border-radius: 50%; font-size: 0.65em; text-align: center; line-height: 14px; cursor: help; margin-left: 4px; }
    .data-drawer-actions { padding: 16px 20px; border-top: 1px solid #eee; flex-shrink: 0; }
    .data-drawer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); display: none; z-index: 940; }
    .data-drawer-overlay.active { display: block; }

    .filters { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .filters-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-group label { font-size: 0.75em; color: #666; text-transform: uppercase; font-weight: 600; }
    .filter-search { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em; width: 250px; }
    .filter-chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .filter-chip { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
    .filter-chip.severity-blocking { background: #ffcdd2; border-color: #c62828; }
    .filter-chip.severity-warning { background: #ffe0b2; border-color: #e65100; }
    .filter-chip.severity-info { background: #bbdefb; border-color: #1565c0; }
    .filter-chip.status-ready { background: #c8e6c9; border-color: #2e7d32; }
    .filter-chip.status-needs_review { background: #ffe0b2; border-color: #f57c00; }
    .filter-chip.status-blocked { background: #ffcdd2; border-color: #c62828; }
    .filter-chip.inactive { opacity: 0.4; }
    .filter-chip:hover { opacity: 1; }
    .filter-chip.active { background: #1976d2; color: white; border-color: #1565c0; }

    /* Single Row Review - Three Panel Layout */
    .srr-layout { display: flex; height: calc(100vh - 160px); gap: 0; }
    .srr-panel { background: white; border: 1px solid #e0e0e0; overflow-y: auto; }
    .srr-panel-left { width: 280px; flex-shrink: 0; border-right: none; }
    .srr-panel-center { flex: 1; min-width: 300px; }
    .srr-panel-right { width: 360px; flex-shrink: 0; border-left: none; }
    .srr-panel-header { background: #f5f5f5; padding: 12px 16px; border-bottom: 1px solid #e0e0e0; font-weight: 600; font-size: 0.9em; color: #333; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 5; }
    .srr-panel-body { padding: 12px; }
    .srr-top-bar { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; padding: 12px 16px; background: #1a1a2e; border-radius: 8px; color: white; }
    .srr-identity { font-family: 'Courier New', monospace; font-size: 0.85em; background: #0f3460; padding: 6px 12px; border-radius: 4px; }
    .srr-state-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; }
    .srr-state-badge.ready { background: #c8e6c9; color: #2e7d32; }
    .srr-state-badge.needs_review { background: #ffe0b2; color: #e65100; }
    .srr-state-badge.blocked { background: #ffcdd2; color: #c62828; }
    .srr-state-badge.finalized { background: #bbdefb; color: #1565c0; }
    .srr-back-btn { background: #0f3460; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 6px; }
    .srr-back-btn:hover { background: #1565c0; }
    
    /* Field Inspector */
    .srr-field-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.15s; }
    .srr-field-item:hover { background: #f8f9fa; }
    .srr-field-item.active { background: #e3f2fd; border-left: 3px solid #1565c0; }
    .srr-field-name { flex: 1; font-size: 0.85em; font-weight: 500; word-break: break-word; }
    .srr-field-value { font-size: 0.8em; color: #666; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .srr-field-indicators { display: flex; gap: 4px; }
    .srr-indicator { width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.65em; }
    .srr-indicator.system { background: #e0e0e0; color: #666; }
    .srr-indicator.delta { background: #fff3e0; color: #e65100; }
    .srr-indicator.flag { background: #ffcdd2; color: #c62828; }
    .srr-indicator.evidence { background: #e3f2fd; color: #1565c0; }
    
    /* Document Viewer */
    .srr-doc-viewer { height: 100%; display: flex; flex-direction: column; }
    .srr-doc-controls { display: flex; gap: 8px; padding: 8px 12px; background: #263238; border-bottom: 1px solid #37474f; }
    .srr-doc-btn { background: #37474f; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
    .srr-doc-btn:hover { background: #455a64; }
    .srr-doc-frame { flex: 1; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #666; font-size: 0.9em; position: relative; min-height: 400px; }
    .srr-anchor-overlay { position: absolute; border: 2px solid #1565c0; background: rgba(21, 101, 192, 0.1); pointer-events: auto; cursor: pointer; }
    .srr-anchor-overlay:hover { background: rgba(21, 101, 192, 0.25); }
    .srr-anchor-list { padding: 12px; border-top: 1px solid #e0e0e0; max-height: 150px; overflow-y: auto; }
    .srr-anchor-item { padding: 8px 10px; background: #f8f9fa; border-radius: 4px; margin-bottom: 6px; font-size: 0.8em; cursor: pointer; border-left: 3px solid #1565c0; }
    .srr-anchor-item:hover { background: #e3f2fd; }
    
    /* Evidence Pack + Patch Request */
    .srr-evidence-block { margin-bottom: 16px; }
    .srr-evidence-label { font-size: 0.75em; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
    .srr-evidence-alias { font-weight: 400; color: #999; }
    .srr-evidence-textarea { width: 100%; min-height: 70px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85em; font-family: inherit; resize: vertical; }
    .srr-evidence-textarea:focus { border-color: #1565c0; outline: none; }
    .srr-patch-section { margin-top: 20px; padding-top: 16px; border-top: 1px solid #e0e0e0; }
    .srr-patch-list { background: #f9f9f9; border-radius: 6px; max-height: 150px; overflow-y: auto; margin-bottom: 12px; }
    .srr-patch-header { padding: 8px 10px; font-weight: 600; font-size: 0.85em; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    .srr-patch-status { font-size: 0.75em; padding: 2px 8px; border-radius: 10px; font-weight: 500; }
    .srr-patch-status.draft { background: #fff3e0; color: #e65100; }
    .srr-patch-status.submitted { background: #e3f2fd; color: #1565c0; }
    .srr-patch-item { padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 0.8em; }
    .srr-patch-item:last-child { border-bottom: none; }
    .srr-patch-path { font-family: 'Courier New', monospace; color: #7b1fa2; }
    .srr-patch-change { display: flex; gap: 8px; margin-top: 4px; }
    .srr-patch-before { color: #c62828; text-decoration: line-through; }
    .srr-patch-after { color: #2e7d32; }
    .srr-actions { display: flex; gap: 8px; margin-top: 16px; }
    .srr-btn { flex: 1; padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 500; }
    .srr-btn-secondary { background: #455a64; color: white; }
    .srr-btn-secondary:hover { background: #546e7a; }
    .srr-btn-primary { background: #1565c0; color: white; }
    .srr-btn-primary:hover { background: #1976d2; }
    .srr-empty-state { color: #999; font-style: italic; text-align: center; padding: 20px; }

    /* Grid Table Styles */
    .grid-table { min-width: 800px; }
    .grid-table th, .grid-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #e0e0e0; white-space: nowrap; }
    .grid-table th { font-weight: 600; color: #333; background: #f5f5f5; border-bottom: 2px solid #ddd; }
    .grid-table tr:hover { background: #f8f9fa; }
    .grid-table tr.clickable { cursor: pointer; }
    .grid-table td.status-ready { color: #2e7d32; }
    .grid-table td.status-needs_review { color: #f57c00; }
    .grid-table td.status-blocked { color: #c62828; }
    .grid-table td.status-finalized { color: #1565c0; }
    .grid-table td.status-flagged { color: #7b1fa2; }
    .grid-table td.truncated { max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
    .grid-table .row-index { color: #999; font-size: 0.8em; }
    .filter-select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em; min-width: 150px; }

    .drawer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); display: none; z-index: 900; }
    .drawer-overlay.active { display: block; }
    .drawer { position: fixed; top: 0; right: -550px; width: 550px; height: 100vh; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.2); z-index: 901; transition: right 0.3s ease; display: flex; flex-direction: column; }
    .drawer.active { right: 0; }
    .drawer-header { background: #1a1a2e; color: white; padding: 15px 20px; flex-shrink: 0; }
    .drawer-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .drawer-header h3 { margin: 0; font-size: 1em; }
    .drawer-close { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; line-height: 1; }
    .drawer-identity { display: flex; align-items: center; gap: 10px; }
    .identity-pill { background: #0f3460; padding: 6px 12px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.75em; word-break: break-all; flex-grow: 1; }
    .identity-copy { background: #1565c0; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75em; white-space: nowrap; }
    .identity-copy:hover { background: #1976d2; }
    .drawer-tabs { display: flex; background: #263238; flex-shrink: 0; }
    .drawer-tab { flex: 1; padding: 12px 8px; text-align: center; color: #90a4ae; background: none; border: none; cursor: pointer; font-size: 0.85em; border-bottom: 3px solid transparent; transition: all 0.2s; }
    .drawer-tab:hover { color: white; background: #37474f; }
    .drawer-tab.active { color: white; border-bottom-color: #1565c0; background: #37474f; }
    .drawer-tab-count { display: inline-block; background: #455a64; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75em; margin-left: 4px; }
    .drawer-body { padding: 15px; overflow-y: auto; flex-grow: 1; }
    .drawer-json { background: #263238; color: #eceff1; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.8em; white-space: pre-wrap; word-break: break-all; max-height: 100%; overflow-y: auto; }
    .drawer-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
    .drawer-table th, .drawer-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; }
    .drawer-table th { background: #f5f5f5; font-weight: 600; color: #333; }
    .drawer-table tr:hover { background: #f9f9f9; }
    .drawer-empty { color: #666; font-style: italic; padding: 20px; text-align: center; background: #f9f9f9; border-radius: 6px; }
    .drawer-actions { padding: 15px 20px; border-top: 1px solid #eee; flex-shrink: 0; }
    .drawer-btn { padding: 10px 14px; background: #1565c0; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; }
    .drawer-btn:hover { background: #1976d2; }
    .drawer-actions-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .drawer-btn-secondary { background: #455a64; }
    .drawer-btn-secondary:hover { background: #546e7a; }
    .drawer-warning { background: #fff3e0; color: #e65100; padding: 10px 15px; font-size: 0.85em; border-bottom: 1px solid #ffe0b2; }
    .identity-primary { color: #4caf50; font-weight: bold; }
    .identity-fallback { color: #90a4ae; }

    .selection-controls { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
    .selection-btn { padding: 4px 10px; font-size: 0.75em; border: 1px solid #ddd; background: #f5f5f5; border-radius: 4px; cursor: pointer; }
    .selection-btn:hover { background: #e0e0e0; }
    .selection-count { font-size: 0.8em; color: #666; margin-left: auto; }
    .drawer-table input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
    .drawer-table th:first-child, .drawer-table td:first-child { width: 30px; text-align: center; }

    .patch-studio { position: fixed; top: 0; right: -450px; width: 450px; height: 100vh; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.2); z-index: 902; transition: right 0.3s ease; display: flex; flex-direction: column; }
    .patch-studio.active { right: 0; }
    .patch-studio-header { background: #2e7d32; color: white; padding: 15px 20px; flex-shrink: 0; }
    .patch-studio-header h3 { margin: 0 0 5px 0; font-size: 1em; }
    .patch-studio-header-row { display: flex; justify-content: space-between; align-items: center; }
    .patch-studio-close { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; line-height: 1; }
    .patch-studio-body { padding: 15px; overflow-y: auto; flex-grow: 1; }
    .patch-field { margin-bottom: 15px; }
    .patch-field label { display: block; font-size: 0.8em; color: #666; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
    .patch-field input, .patch-field textarea { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; font-family: inherit; }
    .patch-field textarea { min-height: 60px; resize: vertical; }
    .patch-changes-header { display: flex; justify-content: space-between; align-items: center; margin: 15px 0 10px; }
    .patch-changes-header h4 { margin: 0; font-size: 0.9em; color: #333; }
    .patch-changes-list { background: #f9f9f9; border-radius: 6px; max-height: 250px; overflow-y: auto; }
    .patch-change-item { display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid #eee; font-size: 0.85em; }
    .patch-change-item:last-child { border-bottom: none; }
    .patch-change-info { flex-grow: 1; }
    .patch-change-remove { background: none; border: none; color: #c62828; cursor: pointer; font-size: 1.1em; padding: 4px 8px; }
    .patch-change-remove:hover { background: #ffebee; border-radius: 4px; }
    .patch-studio-actions { padding: 15px 20px; border-top: 1px solid #eee; flex-shrink: 0; display: flex; flex-direction: column; gap: 8px; }
    .patch-studio-btn { padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; }
    .patch-studio-btn-primary { background: #2e7d32; color: white; }
    .patch-studio-btn-primary:hover { background: #388e3c; }
    .patch-studio-btn-secondary { background: #455a64; color: white; }
    .patch-studio-btn-secondary:hover { background: #546e7a; }
    .patch-empty { color: #666; font-style: italic; padding: 20px; text-align: center; }
    .evidence-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
    .evidence-section h4 { margin: 0 0 10px 0; font-size: 0.85em; color: #666; text-transform: uppercase; }
    .evidence-btns { display: flex; flex-wrap: wrap; gap: 6px; }
    .evidence-btn { padding: 6px 10px; font-size: 0.75em; background: #e0e0e0; border: none; border-radius: 4px; cursor: pointer; }
    .evidence-btn:hover { background: #bdbdbd; }

    .patch-studio-tabs { display: flex; background: #1b5e20; flex-shrink: 0; }
    .patch-studio-tab { flex: 1; padding: 10px 8px; text-align: center; color: rgba(255,255,255,0.7); background: none; border: none; cursor: pointer; font-size: 0.85em; border-bottom: 3px solid transparent; transition: all 0.2s; }
    .patch-studio-tab:hover { color: white; background: rgba(255,255,255,0.1); }
    .patch-studio-tab.active { color: white; border-bottom-color: #81c784; background: rgba(255,255,255,0.1); }
    .patch-studio-panel { display: none; }
    .patch-studio-panel.active { display: block; }

    .preflight-checklist { margin-bottom: 15px; }
    .preflight-step { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: #f9f9f9; border-radius: 6px; margin-bottom: 8px; }
    .preflight-step-num { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75em; font-weight: bold; flex-shrink: 0; }
    .preflight-step-num.pending { background: #e0e0e0; color: #666; }
    .preflight-step-num.pass { background: #c8e6c9; color: #2e7d32; }
    .preflight-step-num.warn { background: #fff3e0; color: #e65100; }
    .preflight-step-num.fail { background: #ffcdd2; color: #c62828; }
    .preflight-step-info { flex-grow: 1; }
    .preflight-step-title { font-weight: 600; font-size: 0.9em; }
    .preflight-step-status { font-size: 0.75em; color: #666; }
    .preflight-step-chip { padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 600; text-transform: uppercase; }
    .preflight-step-chip.pending { background: #e0e0e0; color: #666; }
    .preflight-step-chip.pass { background: #c8e6c9; color: #2e7d32; }
    .preflight-step-chip.warn { background: #fff3e0; color: #e65100; }
    .preflight-step-chip.fail { background: #ffcdd2; color: #c62828; }

    .preflight-input-group { margin-bottom: 15px; }
    .preflight-input-group label { display: block; font-size: 0.8em; color: #666; margin-bottom: 4px; font-weight: 600; }
    .preflight-input-group textarea { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em; font-family: 'Courier New', monospace; min-height: 80px; resize: vertical; }
    .preflight-input-group input { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; }
    .preflight-input-actions { display: flex; gap: 6px; margin-top: 6px; }
    .preflight-parse-btn { padding: 4px 10px; font-size: 0.75em; background: #1565c0; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .preflight-parse-btn:hover { background: #1976d2; }
    .preflight-clear-btn { padding: 4px 10px; font-size: 0.75em; background: #e0e0e0; border: none; border-radius: 4px; cursor: pointer; }
    .preflight-clear-btn:hover { background: #bdbdbd; }

    .preflight-result { background: #f5f5f5; border-radius: 6px; padding: 10px 12px; margin-top: 8px; font-size: 0.85em; }
    .preflight-result.pass { background: #e8f5e9; border-left: 3px solid #2e7d32; }
    .preflight-result.warn { background: #fff8e1; border-left: 3px solid #f57c00; }
    .preflight-result.fail { background: #ffebee; border-left: 3px solid #c62828; }
    .preflight-result-row { display: flex; justify-content: space-between; padding: 3px 0; }
    .preflight-result-key { color: #666; }
    .preflight-result-val { font-weight: 500; font-family: 'Courier New', monospace; }

    .preflight-conflicts-table { width: 100%; border-collapse: collapse; font-size: 0.8em; margin-top: 10px; }
    .preflight-conflicts-table th, .preflight-conflicts-table td { padding: 6px 8px; text-align: left; border-bottom: 1px solid #eee; }
    .preflight-conflicts-table th { background: #f5f5f5; font-weight: 600; }

    .preflight-section-title { font-size: 0.85em; font-weight: 600; color: #333; margin: 15px 0 8px; padding-bottom: 4px; border-bottom: 1px solid #eee; }
    .preflight-reset-row { display: flex; gap: 8px; margin-top: 15px; }
    .preflight-reset-btn { padding: 8px 14px; font-size: 0.85em; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .preflight-reset-btn:hover { background: #d32f2f; }

    .session-loader { background: #e8eaf6; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .session-loader-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .session-loader-header h3 { margin: 0; font-size: 0.95em; color: #3f51b5; }
    .session-loader-toggle { padding: 6px 12px; font-size: 0.8em; background: #3f51b5; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .session-loader-toggle:hover { background: #5c6bc0; }
    .session-loader-body { display: none; }
    .session-loader-body.active { display: block; }
    .session-loader-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
    .session-loader-field { flex: 1; min-width: 200px; }
    .session-loader-field label { display: block; font-size: 0.75em; color: #666; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
    .session-loader-field input { width: 100%; padding: 8px 10px; border: 1px solid #c5cae9; border-radius: 4px; font-size: 0.85em; font-family: 'Courier New', monospace; }
    .session-loader-actions { display: flex; gap: 8px; }
    .session-loader-btn { padding: 8px 14px; font-size: 0.85em; border: none; border-radius: 4px; cursor: pointer; }
    .session-loader-btn-primary { background: #3f51b5; color: white; }
    .session-loader-btn-primary:hover { background: #5c6bc0; }
    .session-loader-btn-secondary { background: #e0e0e0; color: #333; }
    .session-loader-btn-secondary:hover { background: #bdbdbd; }
    .session-loader-status { margin-top: 10px; font-size: 0.85em; padding: 8px 12px; border-radius: 4px; }
    .session-loader-status.success { background: #e8f5e9; color: #2e7d32; }
    .session-loader-status.error { background: #ffebee; color: #c62828; }
    .session-loader-status.info { background: #e3f2fd; color: #1565c0; }

    .delta-summary { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .delta-card { background: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; min-width: 90px; border-left: 4px solid #9e9e9e; }
    .delta-card.positive { border-left-color: #4caf50; }
    .delta-card.negative { border-left-color: #f44336; }
    .delta-card.neutral { border-left-color: #9e9e9e; }
    .delta-card .delta-value { font-size: 1.5em; font-weight: bold; }
    .delta-card .delta-value.positive { color: #4caf50; }
    .delta-card .delta-value.negative { color: #f44336; }
    .delta-card .delta-value.neutral { color: #9e9e9e; }
    .delta-card .delta-label { font-size: 0.75em; color: #666; text-transform: uppercase; }
    .delta-card .delta-detail { font-size: 0.7em; color: #999; margin-top: 2px; }

    .row-added { background: #e8f5e9 !important; }
    .row-added td:first-child::before { content: '+'; color: #4caf50; font-weight: bold; margin-right: 4px; }
    .row-removed { background: #ffebee !important; text-decoration: line-through; opacity: 0.7; }
    .row-removed td:first-child::before { content: '-'; color: #f44336; font-weight: bold; margin-right: 4px; }
    .row-changed { background: #fff3e0 !important; }
    .row-changed td:first-child::before { content: '~'; color: #ff9800; font-weight: bold; margin-right: 4px; }

    .compare-legend { display: flex; gap: 15px; margin-bottom: 10px; font-size: 0.8em; }
    .compare-legend-item { display: flex; align-items: center; gap: 4px; }
    .compare-legend-dot { width: 12px; height: 12px; border-radius: 2px; }
    .compare-legend-dot.added { background: #4caf50; }
    .compare-legend-dot.changed { background: #ff9800; }
    .compare-legend-dot.removed { background: #f44336; }

    .compare-actions { display: flex; gap: 10px; margin-bottom: 15px; }
    .compare-btn { padding: 8px 14px; font-size: 0.85em; background: #7c4dff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .compare-btn:hover { background: #651fff; }

    .config-inspector { background: #fce4ec; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .config-inspector-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .config-inspector-header h3 { margin: 0; font-size: 0.95em; color: #880e4f; }
    .config-inspector-toggle { padding: 6px 12px; font-size: 0.8em; background: #880e4f; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .config-inspector-toggle:hover { background: #ad1457; }
    .config-inspector-body { display: none; }
    .config-inspector-body.active { display: block; }
    .config-inspector-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
    .config-inspector-field { flex: 1; min-width: 200px; }
    .config-inspector-field label { display: block; font-size: 0.75em; color: #666; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
    .config-inspector-field input { width: 100%; padding: 8px 10px; border: 1px solid #f8bbd9; border-radius: 4px; font-size: 0.85em; font-family: 'Courier New', monospace; }
    .config-inspector-actions { display: flex; gap: 8px; }
    .config-inspector-btn { padding: 8px 14px; font-size: 0.85em; border: none; border-radius: 4px; cursor: pointer; }
    .config-inspector-btn-primary { background: #880e4f; color: white; }
    .config-inspector-btn-primary:hover { background: #ad1457; }
    .config-inspector-btn-secondary { background: #e0e0e0; color: #333; }
    .config-inspector-btn-secondary:hover { background: #bdbdbd; }
    .config-inspector-status { margin-top: 10px; font-size: 0.85em; padding: 8px 12px; border-radius: 4px; }
    .config-inspector-status.success { background: #e8f5e9; color: #2e7d32; }
    .config-inspector-status.error { background: #ffebee; color: #c62828; }
    .config-inspector-status.info { background: #e3f2fd; color: #1565c0; }

    .patch-summary { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .patch-summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .patch-summary-header h4 { margin: 0; font-size: 0.95em; color: #333; }
    .patch-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
    .patch-summary-item { }
    .patch-summary-item label { display: block; font-size: 0.7em; color: #666; text-transform: uppercase; margin-bottom: 2px; }
    .patch-summary-item .value { font-family: 'Courier New', monospace; font-size: 0.9em; }
    .version-chip { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; font-weight: 600; }
    .version-chip.match { background: #c8e6c9; color: #2e7d32; }
    .version-chip.mismatch { background: #ffcdd2; color: #c62828; }

    .ruleset-delta { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .ruleset-delta h4 { margin: 0 0 10px 0; font-size: 0.95em; color: #333; }
    .ruleset-delta-counts { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; }
    .ruleset-count-card { background: #f5f5f5; padding: 8px 12px; border-radius: 6px; text-align: center; min-width: 80px; }
    .ruleset-count-card .count { font-size: 1.3em; font-weight: bold; }
    .ruleset-count-card .count.added { color: #4caf50; }
    .ruleset-count-card .count.deprecated { color: #f44336; }
    .ruleset-count-card .label { font-size: 0.7em; color: #666; text-transform: uppercase; }

    .changes-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
    .changes-table th, .changes-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; }
    .changes-table th { background: #880e4f; color: white; font-weight: 600; }
    .changes-table tr:hover { background: #fce4ec; }
    .action-chip { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; font-weight: 600; }
    .action-chip.add_rule { background: #c8e6c9; color: #2e7d32; }
    .action-chip.deprecate_rule { background: #ffcdd2; color: #c62828; }

    .config-inspector-copy-actions { display: flex; gap: 10px; margin-top: 15px; }
    .config-copy-btn { padding: 8px 14px; font-size: 0.85em; background: #880e4f; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .config-copy-btn:hover { background: #ad1457; }

    .stream-panel { background: #e0f2f1; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .stream-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .stream-panel-header h3 { margin: 0; font-size: 0.95em; color: #00695c; }
    .stream-panel-toggle { padding: 6px 12px; font-size: 0.8em; background: #00695c; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .stream-panel-toggle:hover { background: #00897b; }
    .stream-panel-body { display: none; }
    .stream-panel-body.active { display: block; }

    .stream-concept { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .stream-concept h4 { margin: 0 0 10px 0; font-size: 0.95em; color: #00695c; }
    .stream-concept p { font-size: 0.85em; color: #555; line-height: 1.5; margin-bottom: 10px; }

    .session-timeline { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; }
    .session-card { background: white; border-radius: 8px; padding: 12px; min-width: 180px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #00695c; }
    .session-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .session-card-title { font-weight: 600; font-size: 0.9em; color: #333; }
    .session-card-idx { font-size: 0.75em; color: #666; background: #e0e0e0; padding: 2px 6px; border-radius: 10px; }
    .session-card-stats { font-size: 0.8em; color: #666; }
    .session-card-stats div { display: flex; justify-content: space-between; padding: 2px 0; }

    .state-chip { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 600; text-transform: uppercase; }
    .state-chip.consolidated { background: #c8e6c9; color: #2e7d32; }
    .state-chip.partial { background: #fff3e0; color: #e65100; }
    .state-chip.waiting { background: #e3f2fd; color: #1565c0; }
    .state-chip.blocked { background: #ffcdd2; color: #c62828; }
    
    /* Queue Tab Styles */
    .queue-tab { padding: 8px 14px; border: 1px solid #ddd; border-radius: 20px; background: #f5f5f5; cursor: pointer; font-size: 0.85em; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .queue-tab:hover { background: #e0e0e0; }
    .queue-tab.active { background: #1976d2; color: white; border-color: #1976d2; }
    .queue-tab .queue-count { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 10px; font-size: 0.85em; min-width: 20px; text-align: center; }
    .queue-tab.active .queue-count { background: rgba(255,255,255,0.2); }
    
    /* Patch Console Table Styles */
    #patch-console-table tr:hover { background: #f5f5f5; }
    #patch-console-table td { padding: 8px; border-bottom: 1px solid #eee; }
    .patch-status-chip { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; font-weight: 600; }
    .patch-status-chip.draft { background: #e3f2fd; color: #1565c0; }
    .patch-status-chip.submitted { background: #fff3e0; color: #e65100; }
    .patch-status-chip.approved { background: #e8f5e9; color: #2e7d32; }
    .patch-status-chip.sent { background: #ede7f6; color: #5e35b1; }
    .patch-status-chip.returned { background: #fce4ec; color: #c2185b; }
    .patch-status-chip.applied { background: #c8e6c9; color: #1b5e20; }
    .patch-status-chip.rejected { background: #ffcdd2; color: #b71c1c; }
    
    /* Masterline / Artifact Registry Styles */
    .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 22px; transition: 0.3s; }
    .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s; }
    .toggle-switch input:checked + .toggle-slider { background-color: #4caf50; }
    .toggle-switch input:checked + .toggle-slider:before { transform: translateX(18px); }
    
    .masterline-status { font-size: 0.75em; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
    .masterline-status.on { background: #c8e6c9; color: #2e7d32; }
    .masterline-status.off { background: #e0e0e0; color: #666; }
    
    .artifact-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    .artifact-table th { text-align: left; padding: 10px 12px; background: #f5f5f5; border-bottom: 2px solid #ddd; font-weight: 600; color: #333; }
    .artifact-table td { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
    .artifact-table tr:hover { background: #fafafa; }
    
    .artifact-status { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600; }
    .artifact-status.status-loaded { background: #c8e6c9; color: #2e7d32; }
    .artifact-status.status-missing { background: #ffcdd2; color: #c62828; }
    .artifact-status.status-unknown { background: #e0e0e0; color: #666; }
    
    .rebound-badge { font-size: 0.7em; background: #e3f2fd; color: #1565c0; padding: 2px 6px; border-radius: 8px; margin-left: 6px; }
    
    .artifact-path { font-family: monospace; font-size: 0.85em; color: #666; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    .rebind-btn { padding: 4px 10px; font-size: 0.8em; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
    .rebind-btn:hover { background: #e3f2fd; border-color: #90caf9; }
    
    .info-icon { display: inline-block; width: 16px; height: 16px; line-height: 16px; text-align: center; font-size: 12px; color: #90a4ae; cursor: help; margin-left: 4px; vertical-align: middle; }
    .info-icon:hover { color: #1976d2; }
    
    .json-header { font-size: 0.75em; color: #78909c; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600; }
    
    /* Workflow Map Styles */
    .workflow-map { display: flex; flex-direction: column; gap: 0; }
    .workflow-node { display: flex; align-items: flex-start; gap: 15px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 0; background: #fafafa; cursor: pointer; transition: all 0.2s ease; position: relative; }
    .workflow-node:hover { background: #e3f2fd; border-color: #90caf9; }
    .workflow-node:not(:last-child)::after { content: ''; position: absolute; left: 28px; bottom: -12px; width: 2px; height: 12px; background: #90caf9; z-index: 1; }
    .workflow-node-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: #e3f2fd; border-radius: 50%; font-size: 1em; flex-shrink: 0; }
    .workflow-node-content { flex: 1; min-width: 0; }
    .workflow-node-title { font-weight: 600; color: #333; margin-bottom: 4px; font-size: 0.95em; }
    .workflow-node-desc { font-size: 0.8em; color: #666; margin-bottom: 8px; }
    .workflow-node-artifacts { display: flex; flex-wrap: wrap; gap: 6px; }
    .workflow-artifact { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; background: #e8f5e9; color: #2e7d32; }
    .workflow-artifact.missing { background: #ffebee; color: #c62828; }
    .workflow-artifact.unknown { background: #f5f5f5; color: #666; }
    .workflow-connector { height: 12px; margin-left: 27px; border-left: 2px solid #90caf9; }

    .state-legend { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
    .state-legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8em; }

    .flow-diagram { background: #fafafa; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
    .flow-diagram-title { font-weight: 600; font-size: 0.9em; color: #333; margin-bottom: 10px; }
    .flow-stages { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .flow-stage { background: white; padding: 10px 15px; border-radius: 6px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-width: 100px; }
    .flow-stage-name { font-size: 0.8em; font-weight: 600; color: #333; }
    .flow-stage-desc { font-size: 0.7em; color: #666; margin-top: 4px; }
    .flow-arrow { color: #00695c; font-size: 1.2em; }
    .flow-stage.source { border-left: 3px solid #1565c0; }
    .flow-stage.process { border-left: 3px solid #00695c; }
    .flow-stage.output { border-left: 3px solid #2e7d32; }
    .flow-stage.hold { border-left: 3px solid #ff9800; }

    .reconsolidation-table { width: 100%; border-collapse: collapse; font-size: 0.85em; margin-bottom: 15px; }
    .reconsolidation-table th, .reconsolidation-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; }
    .reconsolidation-table th { background: #00695c; color: white; font-weight: 600; }
    .reconsolidation-table tr:hover { background: #e0f2f1; }

    .stream-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .stream-btn { padding: 8px 14px; font-size: 0.85em; background: #00695c; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .stream-btn:hover { background: #00897b; }

    .record-state-summary { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
    .record-state-card { background: white; padding: 10px 15px; border-radius: 6px; text-align: center; min-width: 100px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .record-state-card .count { font-size: 1.3em; font-weight: bold; }
    .record-state-card .label { font-size: 0.7em; color: #666; text-transform: uppercase; }
    .record-state-card.consolidated .count { color: #2e7d32; }
    .record-state-card.partial .count { color: #e65100; }
    .record-state-card.waiting .count { color: #1565c0; }
    .record-state-card.blocked .count { color: #c62828; }
  </style>
</head>
<body>
  <!-- Debug HUD (v1.2.8) -->
  <div id="debug-hud" class="admin-only-content" style="position: fixed; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #0f0; font-family: monospace; font-size: 11px; padding: 4px 8px; border-radius: 4px; z-index: 99999;">Route: - | Data: - | Mode: -</div>
  
  <div class="app-layout">
    <nav class="nav-sidebar">
      <div class="nav-header" style="display: flex; align-items: center; gap: 12px; height: 56px; padding: 10px 16px;">
        <div style="width: 44px; height: 44px; flex-shrink: 0; filter: drop-shadow(0 0 8px rgba(100, 200, 255, 0.6)) drop-shadow(0 0 16px rgba(100, 200, 255, 0.3));">
          <img src="../../assets/brand/orchestrate-os-logo.svg" alt="Orchestrate OS" title="Orchestrate OS" style="width: 100%; height: 100%; display: block; object-fit: contain;">
        </div>
        <div>
          <h1 style="font-size: 0.95em; margin: 0;">Orchestrate OS</h1>
          <div class="version">Semantic Control Board</div>
        </div>
      </div>
      <div class="nav-menu">
        <div class="nav-section">
          <div class="nav-section-header">Views</div>
          <a class="nav-item" data-page="grid" href="#/grid">
            <span class="nav-icon">ðŸ“Š</span>
            <span class="nav-label">All Data Grid</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-header">Review States</div>
          <a class="nav-item queue-item" data-page="triage" data-queue="todo" href="#/triage">
            <span class="nav-icon">ðŸ“‹</span>
            <span class="nav-label">To Do</span>
            <span class="nav-count" id="queue-count-todo">0</span>
          </a>
          <a class="nav-item queue-item" data-page="triage" data-queue="needs_review" href="#/triage?queue=needs_review">
            <span class="nav-icon">ðŸ‘</span>
            <span class="nav-label">Needs Review</span>
            <span class="nav-count" id="queue-count-needs_review">0</span>
          </a>
          <a class="nav-item queue-item" data-page="triage" data-queue="flagged" href="#/triage?queue=flagged">
            <span class="nav-icon">ðŸš©</span>
            <span class="nav-label">Flagged</span>
            <span class="nav-count" id="queue-count-flagged">0</span>
          </a>
          <a class="nav-item queue-item" data-page="triage" data-queue="blocked" href="#/triage?queue=blocked">
            <span class="nav-icon">â›”</span>
            <span class="nav-label">Blocked</span>
            <span class="nav-count" id="queue-count-blocked">0</span>
          </a>
          <a class="nav-item queue-item" data-page="triage" data-queue="finalized" href="#/triage?queue=finalized">
            <span class="nav-icon">âœ…</span>
            <span class="nav-label">Finalized</span>
            <span class="nav-count" id="queue-count-finalized">0</span>
          </a>
        </div>

        <div class="nav-divider"></div>

        <div class="nav-section">
          <div class="nav-section-header">Session</div>
          <a class="nav-item" id="nav-evidence-status" href="#" onclick="showEvidenceStatus(); return false;">
            <span class="nav-icon">ðŸ“Š</span>
            <span class="nav-label">Evidence Status</span>
          </a>
          <a class="nav-item" id="nav-reset-session" href="#" onclick="resetSession(); return false;">
            <span class="nav-icon">ðŸ”„</span>
            <span class="nav-label">Reset Session</span>
          </a>
        </div>

        <div class="nav-divider"></div>

        <div class="nav-section">
          <div class="nav-section-header">Tools</div>
          <a class="nav-item" data-page="patch" href="#/patch">
            <span class="nav-icon">âœŽ</span>
            <span class="nav-label">Patch Studio</span>
          </a>
          <a class="nav-item reviewer-only" data-page="review" href="#/review">
            <span class="nav-icon">ðŸ”</span>
            <span class="nav-label">Config Inspector</span>
          </a>
          <a class="nav-item admin-only" data-page="admin" href="#/admin">
            <span class="nav-icon">âš™</span>
            <span class="nav-label">Governance</span>
          </a>
          <a class="nav-item admin-only" id="nav-config-flows" href="#" onclick="openConfigFlows(); return false;">
            <span class="nav-icon">ðŸ”§</span>
            <span class="nav-label">Config Flows</span>
          </a>
        </div>
      </div>
      <div class="nav-mode-section">
        <div class="nav-mode-label">Role</div>
        <div class="mode-toggle">
          <button class="mode-btn mode-analyst active" data-mode="analyst">Analyst</button>
          <button class="mode-btn mode-reviewer" data-mode="reviewer">Reviewer</button>
          <button class="mode-btn mode-admin" data-mode="admin">Admin</button>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <!-- Top Toolbar (visible when data loaded) -->
      <div class="top-toolbar" id="top-toolbar" style="display: none;">
        <div class="top-toolbar-left">
          <button class="top-toolbar-btn primary" id="btn-data-source">Data Source</button>
          <span class="session-chip not-loaded" id="session-chip">
            <span class="chip-dot"></span>
            <span id="session-chip-text">Not Loaded</span>
          </span>
          <span id="config-status-chip" style="display: none; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 600; margin-left: 8px;"></span>
          <span class="session-meta" id="session-meta"></span>
        </div>
        <div class="top-toolbar-right">
          <!-- Global Search Stub (V2) -->
          <div style="position: relative;">
            <input type="text" id="global-search-input" placeholder="Search agreements, accounts, record IDsâ€¦" 
                   style="padding: 8px 14px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85em; width: 280px;" 
                   onkeydown="handleGlobalSearchKeydown(event)">
            <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 0.7em; color: #888; pointer-events: none;">âŒ˜K</span>
          </div>
          <button class="top-toolbar-btn configure-btn admin-only-content" id="btn-configure" title="Configure Kiwi settings and defaults">Configure</button>
          <button class="top-toolbar-btn admin-only-content" id="btn-ruleset">Ruleset</button>
          <button class="top-toolbar-btn" id="btn-compare">Compare</button>
          <button class="top-toolbar-btn admin-only-content" id="btn-run">Run Commands</button>
        </div>
      </div>
      
      <!-- First-Run Banner (admin-only - refers to config) -->
      <div class="first-run-banner admin-only-content" id="first-run-banner" style="display: none;">
        <span class="banner-icon">&#9881;</span>
        <span class="banner-text">Using default setup. Click <strong>Configure</strong> to connect your local files and set your workflow defaults.</span>
        <button class="banner-dismiss" onclick="dismissFirstRunBanner()" title="Dismiss">&times;</button>
      </div>

      <!-- Empty Queue Message (visible when no data loaded) -->
      <div class="empty-queue-message" id="empty-queue-message">
        <div class="empty-queue-icon">ðŸ“‹</div>
        <h3>No records loaded yet</h3>
        <p>Import a dataset to start working.</p>
        <button class="empty-queue-cta" id="empty-queue-load" onclick="openDataSourcePanel()">Add Data Source</button>
      </div>
      
      <!-- Loader Page (DEPRECATED - v1.2.9 uses drawer instead) -->
      <div class="page-content" id="page-loader" style="display: none !important;">
        <div style="max-width: 600px; margin: 0 auto; padding: 40px 20px;">
          <div style="font-size: 0.75em; color: #999; text-align: right; margin-bottom: 10px;">PAGE: LOADER | BUILD v1.2.8</div>
          
          <!-- PRIMARY ACTION PANEL: Continue to Triage (shown when dataset active) -->
          <div id="loader-continue-panel" style="display: none; background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); border-radius: 12px; padding: 30px; margin-bottom: 30px; color: white; text-align: center;">
            <div style="font-size: 2em; margin-bottom: 10px;">âœ…</div>
            <h2 style="margin: 0 0 8px 0; font-size: 1.4em; color: white;">Dataset Ready</h2>
            <div id="loader-active-dataset-info" style="font-size: 0.9em; opacity: 0.9; margin-bottom: 20px;"></div>
            <button id="btn-continue-triage" class="empty-queue-cta" style="background: white; color: #1976d2; font-size: 1.1em; padding: 14px 28px; border-radius: 8px;">Continue to Triage</button>
            <div style="margin-top: 15px;">
              <button id="btn-copy-bundle-primary" class="top-toolbar-btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" onclick="copyBundleJSON()">Copy Bundle JSON</button>
            </div>
          </div>
          
          <!-- PRIMARY ACTION PANEL: Import CSV (shown when no dataset) -->
          <div id="loader-import-panel" style="display: none; background: linear-gradient(135deg, #455a64 0%, #37474f 100%); border-radius: 12px; padding: 30px; margin-bottom: 20px; color: white; text-align: center;">
            <div style="font-size: 2em; margin-bottom: 10px;">ðŸ“„</div>
            <h2 style="margin: 0 0 8px 0; font-size: 1.4em; color: white;">Load a File</h2>
            <p style="font-size: 0.95em; opacity: 0.9; margin: 0 0 20px 0;">Import a CSV file to start working with your data.</p>
            <input type="file" id="file-import-csv-primary" accept=".csv" style="display: none;">
            <button id="btn-import-csv-primary" class="empty-queue-cta" style="background: white; color: #37474f; font-size: 1.1em; padding: 14px 28px; border-radius: 8px;">Import CSV</button>
          </div>
          
          <!-- SECONDARY ACTION: Load Sample Dataset -->
          <div id="loader-sample-panel" style="display: none; background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 8px; padding: 16px; margin-bottom: 20px; text-align: center;">
            <span style="margin-right: 10px;">ðŸ“¦</span>
            <span style="font-size: 0.95em; color: #333;">Or try the demo:</span>
            <button id="btn-load-sample-secondary" class="top-toolbar-btn" style="margin-left: 10px; padding: 8px 16px;">Load Sample Dataset</button>
          </div>
          
          <!-- COLLAPSIBLE: Other Actions -->
          <div id="loader-other-actions" style="background: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
            <button id="loader-toggle-actions" style="width: 100%; padding: 14px 20px; background: none; border: none; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; color: #333;">
              <span style="font-weight: 600;">Other Actions</span>
              <span id="loader-toggle-icon" style="font-size: 0.8em;">&#9660;</span>
            </button>
            <div id="loader-actions-content" style="display: none; padding: 0 20px 20px 20px;">
              <div style="display: grid; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 6px;">
                  <span>ðŸ“¦</span>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 0.9em;">Load Sample Dataset</div>
                    <div style="font-size: 0.8em; color: #666;">Demo dataset for testing</div>
                  </div>
                  <button id="btn-load-sample" class="top-toolbar-btn" style="padding: 8px 16px;">Load</button>
                </div>
                
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 6px;">
                  <span>ðŸ“„</span>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 0.9em;">Import CSV</div>
                    <div style="font-size: 0.8em; color: #666;">Create dataset from CSV file</div>
                  </div>
                  <input type="file" id="file-import-csv" accept=".csv" style="display: none;">
                  <button id="btn-import-csv" class="top-toolbar-btn" style="padding: 8px 16px;">Choose...</button>
                </div>
                
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 6px;">
                  <span>ðŸ“Ž</span>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 0.9em;">Attach PDF</div>
                    <div style="font-size: 0.8em; color: #666;">Add artifact reference</div>
                  </div>
                  <input type="file" id="file-attach-pdf" accept=".pdf" style="display: none;">
                  <button id="btn-attach-pdf" class="top-toolbar-btn" style="padding: 8px 16px;">Attach...</button>
                </div>
                <div id="pdf-attachments-list" style="font-size: 0.85em; color: #666; padding-left: 30px;"></div>
              </div>
              
              <div class="admin-only-content" style="border-top: 1px solid #e0e0e0; margin-top: 15px; padding-top: 15px;">
                <div style="font-weight: 600; font-size: 0.85em; color: #666; margin-bottom: 10px;">Test Utilities</div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <button class="top-toolbar-btn" id="btn-reset-demo-state" style="font-size: 0.85em;">Reset Demo State</button>
                  <button class="top-toolbar-btn" id="btn-rebuild-field-index" style="font-size: 0.85em;">Rebuild Field Index</button>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>

      <!-- TRIAGE PAGE (default after data loaded) -->
      <div class="page" id="page-triage">
        <div class="page-header">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <h2>Triage</h2>
            <span style="font-size: 0.7em; color: #999;">PAGE: TRIAGE | BUILD v1.4.5</span>
          </div>
          <p class="page-desc">Alert summary view. Click status cards to open filtered grid views.</p>
          <div class="triage-session-info" id="triage-session-info" style="margin-top: 10px; font-size: 0.85em; color: #666;"></div>
        </div>

        <div class="filters" id="filters">
          <div class="filters-row">
            <div class="filter-group">
              <label>Search</label>
              <input type="text" class="filter-search" id="filter-search" placeholder="Search all fields...">
            </div>
            <div class="filter-group">
              <label>Severity</label>
              <div class="filter-chips" id="severity-chips">
                <span class="filter-chip severity-blocking" data-severity="blocking">Blocking</span>
                <span class="filter-chip severity-warning" data-severity="warning">Warning</span>
                <span class="filter-chip severity-info" data-severity="info">Info</span>
              </div>
            </div>
            <div class="filter-group">
              <label>Status</label>
              <div class="filter-chips" id="status-chips">
                <span class="filter-chip status-ready" data-status="ready">Ready</span>
                <span class="filter-chip status-needs_review" data-status="needs_review">Needs Review</span>
                <span class="filter-chip status-blocked" data-status="blocked">Blocked</span>
              </div>
            </div>
            <div class="filter-group">
              <label>Subtype</label>
              <select class="filter-select" id="filter-subtype">
                <option value="">All Subtypes</option>
              </select>
            </div>
          </div>
        </div>

        <div id="delta-container" style="display: none;"></div>
        <div id="summary-container"></div>
        <div id="contract-results-container"></div>
        <div id="issues-container"></div>
        <div id="field-actions-container"></div>
      </div><!-- end page-triage -->

      <!-- ALL-DATA GRID PAGE -->
      <div class="page" id="page-grid">
        <div class="page-header">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <h2>All-Data Grid</h2>
            <span style="font-size: 0.7em; color: #999;">PAGE: GRID | BUILD v1.4.5</span>
          </div>
          <p class="page-desc">Dense spreadsheet view of all records with filtering and search.</p>
        </div>

        <!-- Grid Controls -->
        <div class="grid-controls" style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px; flex-wrap: wrap;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <label style="font-size: 0.85em; color: #666;">Sheet:</label>
            <select id="grid-sheet-selector" class="filter-select" style="min-width: 160px;">
              <option value="">All Sheets</option>
            </select>
          </div>
          <div style="flex: 1; min-width: 200px;">
            <input type="text" id="grid-search" class="filter-search" placeholder="Search all fields..." style="width: 100%;">
          </div>
          <div class="filter-chips" id="grid-status-chips" style="display: flex; gap: 6px; flex-wrap: wrap;">
            <span class="filter-chip active" data-filter="all" onclick="setGridFilter('all')">All</span>
            <span class="filter-chip status-ready" data-filter="ready" onclick="setGridFilter('ready')">Ready</span>
            <span class="filter-chip status-needs_review" data-filter="needs_review" onclick="setGridFilter('needs_review')">Needs Review</span>
            <span class="filter-chip status-blocked" data-filter="blocked" onclick="setGridFilter('blocked')">Blocked</span>
          </div>
          <button class="top-toolbar-btn" id="grid-column-toggle" onclick="toggleColumnMenu()" title="Toggle columns">Columns</button>
        </div>

        <!-- Column Toggle Menu (hidden by default) -->
        <div id="grid-column-menu" style="display: none; position: fixed; top: 120px; right: 40px; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; max-height: 300px; overflow-y: auto;">
          <div style="font-weight: 600; margin-bottom: 8px; color: #333;">Visible Columns</div>
          <div id="grid-column-checkboxes"></div>
        </div>

        <!-- Per-Sheet Mini Stats -->
        <div id="grid-sheet-stats" style="display: flex; gap: 16px; align-items: center; margin-bottom: 12px; padding: 10px 16px; background: #f8f9fa; border-radius: 6px; font-size: 0.85em; color: #555;">
          <span id="grid-stat-rows"><strong>Rows:</strong> <span class="stat-value">0</span></span>
          <span class="stat-divider" style="color: #ccc;">|</span>
          <span id="grid-stat-ready"><strong>Ready:</strong> <span class="stat-value" style="color: #2e7d32;">0</span></span>
          <span id="grid-stat-review"><strong>Needs Review:</strong> <span class="stat-value" style="color: #f57c00;">0</span></span>
          <span id="grid-stat-blocked"><strong>Blocked:</strong> <span class="stat-value" style="color: #c62828;">0</span></span>
          <span class="stat-divider admin-only-content" style="color: #ccc; display: none;">|</span>
          <span id="grid-stat-unknown" class="admin-only-content" style="display: none;"><strong>Unknown Cols:</strong> <span class="stat-value" style="color: #7b1fa2;">0</span></span>
        </div>

        <!-- Dense Grid Table -->
        <div class="grid-table-container" style="overflow-x: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
          <table class="grid-table" id="grid-table" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
            <thead id="grid-thead" style="position: sticky; top: 0; background: #f5f5f5; z-index: 10;">
              <tr id="grid-header-row"></tr>
            </thead>
            <tbody id="grid-tbody"></tbody>
          </table>
        </div>

        <!-- Grid Footer -->
        <div class="grid-footer" style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center; color: #666; font-size: 0.85em;">
          <span id="grid-row-count">0 records</span>
          <span id="grid-filter-info"></span>
        </div>
      </div><!-- end page-grid -->

      <!-- SINGLE ROW REVIEW PAGE -->
      <div class="page" id="page-row">
        <div class="page-header">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <h2>Single Row Review</h2>
            <span style="font-size: 0.7em; color: #999;">PAGE: SINGLE-ROW-REVIEW | BUILD v1.4.5</span>
          </div>
          <p class="page-desc">Per-record inspection with Evidence Pack authoring and Patch Request creation.</p>
        </div>

        <!-- Top Bar: Identity, State Badge, Back Button -->
        <div class="srr-top-bar">
          <button class="srr-back-btn" onclick="navigateTo('grid')">â† Back to Grid</button>
          <div style="flex: 1;">
            <span style="font-size: 0.75em; color: #aaa; margin-right: 8px;">Record:</span>
            <span class="srr-identity" id="srr-record-id">â€”</span>
          </div>
          <div>
            <span style="font-size: 0.75em; color: #aaa; margin-right: 8px;">Review State:</span>
            <span class="srr-state-badge" id="srr-state-badge">â€”</span>
          </div>
          <button class="srr-back-btn" onclick="showAuditLogForRecord()" title="View audit log for this record">Audit Log</button>
        </div>

        <!-- Three-Panel Layout -->
        <div class="srr-layout">
          <!-- Left Panel: Field Inspector -->
          <div class="srr-panel srr-panel-left">
            <div class="srr-panel-header">
              <span>Field Inspector</span>
              <span id="srr-field-count" style="font-weight: normal; color: #666; font-size: 0.85em;">0 fields</span>
            </div>
            <div class="srr-panel-body" id="srr-field-list" style="padding: 0;">
              <div class="srr-empty-state">No fields loaded</div>
            </div>
          </div>

          <!-- Center Panel: Document Viewer -->
          <div class="srr-panel srr-panel-center">
            <div class="srr-panel-header">
              <span>Document Viewer</span>
              <span id="srr-doc-page" style="font-weight: normal; color: #666; font-size: 0.85em;">Page 1 of 1</span>
            </div>
            <div class="srr-doc-viewer">
              <div class="srr-doc-controls">
                <button class="srr-doc-btn" onclick="srrPrevPage()">â† Prev</button>
                <button class="srr-doc-btn" onclick="srrNextPage()">Next â†’</button>
                <button class="srr-doc-btn" onclick="srrZoomOut()">âˆ’</button>
                <button class="srr-doc-btn" onclick="srrZoomIn()">+</button>
              </div>
              <div class="srr-doc-frame" id="srr-doc-frame">
                <div style="text-align: center;">
                  <div style="font-size: 3em; margin-bottom: 10px;">ðŸ“„</div>
                  <div>No document attached</div>
                  <div style="font-size: 0.85em; color: #999; margin-top: 8px;">PDF viewer stub â€” attach documents via Data Source</div>
                </div>
              </div>
              <div class="srr-anchor-list" id="srr-anchor-list">
                <div style="font-size: 0.8em; font-weight: 600; color: #666; margin-bottom: 8px;">Evidence Anchors</div>
                <div class="srr-empty-state" style="padding: 10px;">No anchors defined</div>
              </div>
            </div>
          </div>

          <!-- Right Panel: Evidence Pack + Patch Request -->
          <div class="srr-panel srr-panel-right">
            <div class="srr-panel-header">
              <span>Evidence Pack + Patch Request</span>
            </div>
            <div class="srr-panel-body">
              <!-- Evidence Pack: 4 Canonical Blocks -->
              <div class="srr-evidence-block">
                <div class="srr-evidence-label">Observation <span class="srr-evidence-alias">(WHEN)</span></div>
                <textarea class="srr-evidence-textarea" id="srr-observation" placeholder="What situation was observed..."></textarea>
              </div>
              <div class="srr-evidence-block">
                <div class="srr-evidence-label">Expected <span class="srr-evidence-alias">(THEN)</span></div>
                <textarea class="srr-evidence-textarea" id="srr-expected" placeholder="What behavior is expected..."></textarea>
              </div>
              <div class="srr-evidence-block">
                <div class="srr-evidence-label">Justification <span class="srr-evidence-alias">(BECAUSE)</span></div>
                <textarea class="srr-evidence-textarea" id="srr-justification" placeholder="Why this change is correct..."></textarea>
              </div>
              <div class="srr-evidence-block">
                <div class="srr-evidence-label">Repro</div>
                <textarea class="srr-evidence-textarea" id="srr-repro" placeholder="Steps to reproduce the issue..."></textarea>
              </div>

              <!-- Patch Request Section -->
              <div class="srr-patch-section">
                <div style="font-size: 0.85em; font-weight: 600; color: #333; margin-bottom: 10px;">Proposed Changes</div>
                <div class="srr-patch-list" id="srr-patch-list">
                  <div class="srr-empty-state" style="padding: 12px;">No changes proposed yet</div>
                </div>
                <div class="srr-actions">
                  <button class="srr-btn srr-btn-secondary" onclick="srrSaveDraft()">Save Patch Draft</button>
                  <button class="srr-btn srr-btn-primary" onclick="srrSubmitPatchRequest()">Submit Patch Request</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- end page-row -->

      <!-- PATCH STUDIO PAGE -->
      <div class="page" id="page-patch">
        <div class="page-header">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <h2>Patch Studio</h2>
            <span style="font-size: 0.7em; color: #999;">PAGE: PATCH-STUDIO | BUILD v1.4.0</span>
          </div>
          <p class="page-desc">Select records, build rule patches, validate with preflight gate, and export.</p>
        </div>

        <div class="preflight-gate" id="preflight-gate">
          <div class="preflight-header">
            <h3>Preflight Gate (PR Checklist)</h3>
            <button class="preflight-toggle" id="preflight-toggle">Show</button>
          </div>
          <div class="preflight-body" id="preflight-body">
            <div class="preflight-checklist">
              <div class="preflight-item" data-step="1">
                <div class="preflight-checkbox"></div>
                <div class="preflight-content">
                  <div class="preflight-label">Step 1: Validate Config</div>
                  <div class="preflight-evidence" id="evidence-1"></div>
                </div>
              </div>
              <div class="preflight-item" data-step="2">
                <div class="preflight-checkbox"></div>
                <div class="preflight-content">
                  <div class="preflight-label">Step 2: Preview Baseline</div>
                  <div class="preflight-evidence" id="evidence-2"></div>
                </div>
              </div>
              <div class="preflight-item" data-step="3">
                <div class="preflight-checkbox"></div>
                <div class="preflight-content">
                  <div class="preflight-label">Step 3: Smoke Baseline</div>
                  <div class="preflight-evidence" id="evidence-3"></div>
                </div>
              </div>
              <div class="preflight-item" data-step="4">
                <div class="preflight-checkbox"></div>
                <div class="preflight-content">
                  <div class="preflight-label">Step 4: Smoke Edge</div>
                  <div class="preflight-evidence" id="evidence-4"></div>
                </div>
              </div>
            </div>
            <div class="preflight-paste">
              <label>Paste Terminal Output (auto-parses evidence)</label>
              <textarea id="preflight-paste-area" placeholder="Paste terminal output here to auto-extract evidence..."></textarea>
              <button class="preflight-parse-btn" id="preflight-parse">Parse Evidence</button>
            </div>
            <div class="preflight-actions">
              <button class="preflight-btn preflight-btn-secondary" id="preflight-reset">Reset All</button>
              <button class="preflight-btn preflight-btn-primary" id="preflight-copy-evidence">Copy Evidence Summary</button>
            </div>
            <div class="preflight-summary" id="preflight-summary"></div>
          </div>
        </div>

        <div class="patch-studio-inline" id="patch-studio-inline">
          <h3>Patch Draft Builder</h3>
          <p class="page-desc">Open Record Workbench from Triage page to select records and add rules.</p>
          <div id="patch-draft-summary"></div>
          <div class="patch-studio-inline-actions">
            <button class="toolbar-btn" id="copy-patch-json">Copy Patch JSON</button>
            <button class="toolbar-btn" id="copy-pr-summary">Copy PR Summary</button>
          </div>
        </div>
      </div><!-- end page-patch -->

      <!-- REVIEW PAGE -->
      <div class="page" id="page-review">
        <div class="page-header">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <h2>Review</h2>
            <span style="font-size: 0.7em; color: #999;">PAGE: CONFIG-INSPECTOR | BUILD v1.4.0</span>
          </div>
          <p class="page-desc">Inspect config deltas, compare artifact versions, and generate evidence summaries.</p>
        </div>

        <div class="config-inspector" id="config-inspector">
          <div class="config-inspector-header">
            <h3>Config + Patch Inspector (Ruleset Delta)</h3>
            <button class="config-inspector-toggle" id="config-inspector-toggle">Show</button>
          </div>
          <div class="config-inspector-body" id="config-inspector-body">
            <div class="config-inspector-row">
              <div class="config-inspector-field">
                <label>Base Config Path</label>
                <input type="text" id="base-config-path" value="config/config_pack.base.json" placeholder="config/config_pack.base.json">
              </div>
              <div class="config-inspector-field">
                <label>Patch Path</label>
                <input type="text" id="patch-path" value="config/config_pack.example.patch.json" placeholder="config/config_pack.example.patch.json">
              </div>
              <div class="config-inspector-actions">
                <button class="config-inspector-btn config-inspector-btn-primary" id="load-config">Load Config</button>
                <button class="config-inspector-btn config-inspector-btn-secondary" id="clear-config">Clear</button>
              </div>
            </div>
            <div class="config-inspector-status" id="config-status" style="display: none;"></div>
            <div id="config-results" style="display: none;">
              <div class="patch-summary" id="patch-summary"></div>
              <div class="ruleset-delta" id="ruleset-delta"></div>
              <div class="table-container">
                <table class="changes-table" id="changes-table"></table>
              </div>
              <div class="config-inspector-copy-actions">
                <button class="config-copy-btn" id="copy-ruleset-delta">Copy Ruleset Delta (Markdown)</button>
              </div>
            </div>
          </div>
        </div>

        <div class="session-loader" id="session-loader">
          <div class="session-loader-header">
            <h3>Session Loader (Comparison Mode)</h3>
            <button class="session-loader-toggle" id="session-loader-toggle">Show</button>
          </div>
          <div class="session-loader-body" id="session-loader-body">
            <div class="session-loader-row">
              <div class="session-loader-field">
                <label>Primary Artifact Path</label>
                <input type="text" id="primary-path" value="out/sf_packet.preview.json" placeholder="out/sf_packet.preview.json">
              </div>
              <div class="session-loader-field">
                <label>Comparison Artifact Path (optional)</label>
                <input type="text" id="compare-path" placeholder="out/sf_packet.preview.prev.json">
              </div>
              <div class="session-loader-actions">
                <button class="session-loader-btn session-loader-btn-primary" id="load-session">Load</button>
                <button class="session-loader-btn session-loader-btn-secondary" id="clear-compare">Clear Compare</button>
              </div>
            </div>
            <div class="session-loader-status" id="session-status" style="display: none;"></div>
          </div>
        </div>

        <div id="review-evidence-summary" class="evidence-summary-panel"></div>
      </div><!-- end page-review -->

      <!-- ADMIN PAGE (Console) -->
      <div class="page" id="page-admin">
        <div class="page-header">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <h2>Admin Console</h2>
            <span style="font-size: 0.7em; color: #999;">PAGE: ADMIN-CONSOLE | BUILD v1.4.5</span>
          </div>
          <p class="page-desc">Centralized admin tools for governance, config, standardization, and patch management.</p>
        </div>

        <!-- Admin Console Tabs -->
        <div class="admin-console-tabs" style="display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 0;">
          <button class="admin-tab active" data-admin-tab="governance" onclick="switchAdminTab('governance')" style="padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600;">Governance</button>
          <button class="admin-tab" data-admin-tab="config" onclick="switchAdminTab('config')" style="padding: 10px 20px; background: #f5f5f5; color: #666; border: none; border-radius: 6px 6px 0 0; cursor: pointer;">Config</button>
          <button class="admin-tab" data-admin-tab="inspector" onclick="switchAdminTab('inspector')" style="padding: 10px 20px; background: #f5f5f5; color: #666; border: none; border-radius: 6px 6px 0 0; cursor: pointer;">Inspector</button>
          <button class="admin-tab" data-admin-tab="standardizer" onclick="switchAdminTab('standardizer')" style="padding: 10px 20px; background: #f5f5f5; color: #666; border: none; border-radius: 6px 6px 0 0; cursor: pointer;">Standardizer</button>
          <button class="admin-tab" data-admin-tab="patch-console" onclick="switchAdminTab('patch-console')" style="padding: 10px 20px; background: #f5f5f5; color: #666; border: none; border-radius: 6px 6px 0 0; cursor: pointer;">Patch Console</button>
          <button class="admin-tab" data-admin-tab="evidence" onclick="switchAdminTab('evidence')" style="padding: 10px 20px; background: #f5f5f5; color: #666; border: none; border-radius: 6px 6px 0 0; cursor: pointer;">Evidence</button>
          <button class="admin-tab" data-admin-tab="unknown-cols" onclick="switchAdminTab('unknown-cols')" style="padding: 10px 20px; background: #f5f5f5; color: #666; border: none; border-radius: 6px 6px 0 0; cursor: pointer;">Unknown Cols</button>
        </div>

        <!-- GOVERNANCE TAB -->
        <div id="admin-tab-governance" class="admin-tab-panel" data-admin-section="true">
        <!-- Masterline / Artifact Registry Section -->
        <div class="admin-section" data-admin-section="true" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 1.1em; color: #333;">Artifact Registry <span class="info-icon" title="Manage the master artifacts that drive the semantic control board. When Dev Masterline is enabled, artifacts are auto-loaded from repository paths.">&#9432;</span></h3>
            <div style="display: flex; align-items: center; gap: 10px;">
              <label class="toggle-label" style="font-size: 0.85em; color: #666;">Dev Masterline</label>
              <label class="toggle-switch">
                <input type="checkbox" id="dev-masterline-toggle" onchange="toggleDevMasterline()">
                <span class="toggle-slider"></span>
              </label>
              <span id="dev-masterline-status" class="masterline-status on">ON</span>
            </div>
          </div>
          <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">When enabled, master artifacts are auto-loaded from repository on startup. Rebind paths if files are in different locations.</p>
          <div id="artifact-registry-table"></div>
          <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="toolbar-btn" onclick="checkAllArtifacts()">Refresh Status</button>
            <button class="toolbar-btn" onclick="masterlineAutoload()">Reload All</button>
          </div>
        </div>

        <!-- Workflow Map Section -->
        <div class="admin-section" data-admin-section="true" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 15px; font-size: 1.1em; color: #333;">Workflow Map <span class="info-icon" title="Visual overview of the semantic governance pipeline. Each step shows required artifacts and their status.">&#9432;</span></h3>
          <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">Understand the end-to-end governance pipeline at a glance. Click any step to navigate.</p>
          <div id="workflow-map" class="workflow-map"></div>
        </div>

        <!-- Governance Notes -->
        <div class="admin-section" data-admin-section="true" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 15px; font-size: 1.1em; color: #333;">Governance Notes</h3>
          <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">Admin-level notes and overrides are recorded here.</p>
          <div id="admin-governance-notes" style="background: #f9f9f9; padding: 15px; border-radius: 6px; min-height: 60px;">
            <em style="color: #888;">No governance notes recorded.</em>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="admin-section" data-admin-section="true" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 15px; font-size: 1.1em; color: #333;">Quick Actions</h3>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="toolbar-btn" onclick="document.getElementById('btn-run')?.click()">Run Commands</button>
            <button class="toolbar-btn" onclick="switchAdminTab('inspector')">Open Inspector</button>
          </div>
        </div>
        </div><!-- end admin-tab-governance -->

        <!-- PATCH CONSOLE TAB -->
        <div id="admin-tab-patch-console" class="admin-tab-panel" data-admin-section="true" style="display: none;">
        <div class="admin-section" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 15px; font-size: 1.1em; color: #333;">Patch Requests Console <span class="info-icon" title="Manage patch requests through their lifecycle. Track requests from creation through Kiwi processing to final application.">&#9432;</span></h3>
          <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">Track and manage patch requests. Batch export to Kiwi, import returns, and apply changes.</p>
          
          <!-- Queue Tabs -->
          <div id="patch-queue-tabs" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
            <button class="queue-tab active" data-queue="new" onclick="switchPatchQueueTab('new')">New <span class="queue-count">0</span></button>
            <button class="queue-tab" data-queue="needs_review" onclick="switchPatchQueueTab('needs_review')">Needs Review <span class="queue-count">0</span></button>
            <button class="queue-tab" data-queue="approved" onclick="switchPatchQueueTab('approved')">Approved <span class="queue-count">0</span></button>
            <button class="queue-tab" data-queue="sent_to_kiwi" onclick="switchPatchQueueTab('sent_to_kiwi')">Sent to Kiwi <span class="queue-count">0</span></button>
            <button class="queue-tab" data-queue="kiwi_returned" onclick="switchPatchQueueTab('kiwi_returned')">Kiwi Returned <span class="queue-count">0</span></button>
            <button class="queue-tab" data-queue="applied" onclick="switchPatchQueueTab('applied')">Applied <span class="queue-count">0</span></button>
            <button class="queue-tab" data-queue="rejected" onclick="switchPatchQueueTab('rejected')">Rejected <span class="queue-count">0</span></button>
          </div>
          
          <!-- Batch Actions -->
          <div id="patch-batch-actions" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
            <button class="toolbar-btn" onclick="selectAllCurrentQueue()">Select All</button>
            <button class="toolbar-btn" onclick="clearPatchRequestSelection(); renderPatchConsoleTable();">Clear Selection</button>
            <button class="toolbar-btn" onclick="batchMarkSentToKiwi()" style="background: #1565c0;">Export to Kiwi (Copy)</button>
            <button class="toolbar-btn" onclick="openKiwiReturnInbox()" style="background: #7b1fa2;">Paste Kiwi Return</button>
            <button class="toolbar-btn" onclick="batchMarkApplied()" style="background: #2e7d32;">Mark Applied</button>
            <button class="toolbar-btn" onclick="batchCopyCommitPack()" style="background: #f57c00;">Copy Batch Commit Pack</button>
          </div>
          
          <!-- Compact Table -->
          <div id="patch-console-table-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px;">
            <table id="patch-console-table" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
              <thead style="background: #f5f5f5; position: sticky; top: 0;">
                <tr>
                  <th style="padding: 10px 8px; text-align: left; border-bottom: 1px solid #e0e0e0; width: 40px;"><input type="checkbox" id="patch-select-all" onchange="toggleSelectAllPatches(this.checked)"></th>
                  <th style="padding: 10px 8px; text-align: left; border-bottom: 1px solid #e0e0e0;">ID</th>
                  <th style="padding: 10px 8px; text-align: left; border-bottom: 1px solid #e0e0e0;">Intent</th>
                  <th style="padding: 10px 8px; text-align: left; border-bottom: 1px solid #e0e0e0;">Target</th>
                  <th style="padding: 10px 8px; text-align: left; border-bottom: 1px solid #e0e0e0;">Status</th>
                  <th style="padding: 10px 8px; text-align: left; border-bottom: 1px solid #e0e0e0;">Updated</th>
                  <th style="padding: 10px 8px; text-align: center; border-bottom: 1px solid #e0e0e0;">Actions</th>
                </tr>
              </thead>
              <tbody id="patch-console-tbody">
                <tr><td colspan="7" style="padding: 20px; text-align: center; color: #888;">No patch requests in this queue</td></tr>
              </tbody>
            </table>
          </div>
          
          <!-- Summary Stats -->
          <div id="patch-console-summary" style="margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap; font-size: 0.85em; color: #666;">
            <span>Total: <strong id="patch-total-count">0</strong></span>
            <span>Selected: <strong id="patch-selected-count">0</strong></span>
            <span>Comments Open: <strong id="comments-open-count">0</strong></span>
          </div>
        </div>
        
        <!-- Kiwi Return Inbox Modal -->
        <div id="kiwi-return-inbox-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
              <h3>Paste Kiwi Return</h3>
              <button class="modal-close" onclick="closeKiwiReturnInbox()">&times;</button>
            </div>
            <div class="modal-body">
              <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">Paste the JSON returned from Kiwi. Each request will be matched by request_id and updated.</p>
              <textarea id="kiwi-return-textarea" placeholder="Paste Kiwi return JSON here..." style="width: 100%; height: 200px; font-family: monospace; font-size: 0.85em; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
              <div id="kiwi-return-status" style="margin-top: 10px; display: none; padding: 10px; border-radius: 6px;"></div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
              <button class="toolbar-btn" onclick="closeKiwiReturnInbox()">Cancel</button>
              <button class="toolbar-btn" onclick="processKiwiReturn()" style="background: #7b1fa2;">Process Return</button>
            </div>
          </div>
        </div>
        
        <!-- Add Comment Modal -->
        <div id="add-comment-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
              <h3>Add Comment (RFI)</h3>
              <button class="modal-close" onclick="closeAddCommentModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 15px;">
                <label style="font-size: 0.85em; color: #666; display: block; margin-bottom: 5px;">Target</label>
                <div id="comment-target-display" style="font-family: monospace; font-size: 0.9em; padding: 8px; background: #f5f5f5; border-radius: 4px;"></div>
              </div>
              <div style="margin-bottom: 15px;">
                <label style="font-size: 0.85em; color: #666; display: block; margin-bottom: 5px;">Comment</label>
                <textarea id="comment-content-input" placeholder="Describe your question or clarification request..." style="width: 100%; height: 100px; font-size: 0.9em; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
              </div>
              <input type="hidden" id="comment-target-type">
              <input type="hidden" id="comment-target-id">
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
              <button class="toolbar-btn" onclick="closeAddCommentModal()">Cancel</button>
              <button class="toolbar-btn" onclick="submitNewComment()" style="background: #1976d2;">Add Comment</button>
            </div>
          </div>
        </div>
        
        <!-- Elevate to Patch Request Modal -->
        <div id="elevate-to-patch-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
              <h3>Elevate to Patch Request</h3>
              <button class="modal-close" onclick="closeElevateToPatchModal()">&times;</button>
            </div>
            <div class="modal-body">
              <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">Create a patch request from this resolved comment. Fill in the intent of the change.</p>
              <div id="elevate-comment-preview" style="background: #f5f5f5; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em;"></div>
              <div style="margin-bottom: 15px;">
                <label style="font-size: 0.85em; color: #666; display: block; margin-bottom: 5px;">WHEN (Condition)</label>
                <input type="text" id="elevate-intent-when" placeholder="e.g., field 'label' contains 'Artist'" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div style="margin-bottom: 15px;">
                <label style="font-size: 0.85em; color: #666; display: block; margin-bottom: 5px;">THEN (Action)</label>
                <input type="text" id="elevate-intent-then" placeholder="e.g., set 'label' to 'Record Label'" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div style="margin-bottom: 15px;">
                <label style="font-size: 0.85em; color: #666; display: block; margin-bottom: 5px;">BECAUSE (Reason)</label>
                <input type="text" id="elevate-intent-because" placeholder="e.g., 'Artist' is reserved for performer names" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <input type="hidden" id="elevate-comment-id">
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
              <button class="toolbar-btn" onclick="closeElevateToPatchModal()">Cancel</button>
              <button class="toolbar-btn" onclick="submitElevateToPatch()" style="background: #7b1fa2;">Create Patch Request</button>
            </div>
          </div>
        </div>
        </div><!-- end admin-tab-patch-console -->

        <!-- EVIDENCE TAB -->
        <div id="admin-tab-evidence" class="admin-tab-panel" data-admin-section="true" style="display: none;">
        <div class="admin-section" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 15px; font-size: 1.1em; color: #333;">Version & Baseline</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
              <label style="font-size: 0.75em; color: #666; text-transform: uppercase;">Current Base Version</label>
              <div style="font-family: monospace; font-size: 1em; margin-top: 4px;" id="admin-base-version">--</div>
            </div>
            <div>
              <label style="font-size: 0.75em; color: #666; text-transform: uppercase;">Patch Target Version</label>
              <div style="font-family: monospace; font-size: 1em; margin-top: 4px;" id="admin-patch-version">--</div>
            </div>
            <div>
              <label style="font-size: 0.75em; color: #666; text-transform: uppercase;">Last Smoke Test</label>
              <div style="font-size: 0.9em; margin-top: 4px;" id="admin-last-smoke">Not Run</div>
            </div>
          </div>
        </div>

        <div class="admin-section" data-admin-section="true" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 15px; font-size: 1.1em; color: #333;">Evidence Gates</h3>
          <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">Status of preflight checks. Evidence is pasted in (UI does not run these).</p>
          <div id="admin-evidence-gates" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <div class="state-chip pending">Validation: Pending</div>
            <div class="state-chip pending">Conflicts: Pending</div>
            <div class="state-chip pending">Smoke Baseline: Pending</div>
            <div class="state-chip pending">Smoke Edge: Pending</div>
          </div>
        </div>
        </div><!-- end admin-tab-evidence -->

        <!-- UNKNOWN COLUMNS TAB -->
        <div id="admin-tab-unknown-cols" class="admin-tab-panel" data-admin-section="true" style="display: none;">
        <div class="admin-section" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 15px; font-size: 1.1em; color: #333;">Unknown Columns (Schema Drift) <span class="info-icon" title="Columns found in imported data that don't match any canonical field. Decide how to handle each.">&#9432;</span></h3>
          <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">Columns detected during standardization that aren't in the canonical schema. Decide how to classify each one.</p>
          
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="toolbar-btn" onclick="refreshUnknownColumnsTable()">Refresh</button>
            <button class="toolbar-btn" onclick="exportUnknownColumnsRequest()">Export Update Request (Copy)</button>
            <button class="toolbar-btn" onclick="clearUnknownColumnsDecisions()">Clear Decisions</button>
          </div>
          
          <div id="unknown-cols-table-container" style="overflow-x: auto;">
            <table class="grid-table" id="unknown-cols-table" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
              <thead style="background: #f5f5f5;">
                <tr>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Sheet</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Original Name</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Normalized</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Sample Values</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Non-Empty</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Action</th>
                </tr>
              </thead>
              <tbody id="unknown-cols-tbody">
                <tr><td colspan="6" style="text-align: center; padding: 40px; color: #888;">No unknown columns detected</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="admin-section" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 15px; font-size: 1.1em; color: #333;">Pending Decisions</h3>
          <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">Columns marked for action. Export to generate a standard update request artifact.</p>
          <div id="unknown-cols-decisions" style="background: #f9f9f9; padding: 15px; border-radius: 6px; min-height: 60px; font-family: monospace; font-size: 0.85em;">
            <em style="color: #888;">No decisions made yet.</em>
          </div>
        </div>
        </div><!-- end admin-tab-unknown-cols -->

        <!-- STANDARDIZER TAB -->
        <div id="admin-tab-standardizer" class="admin-tab-panel" data-admin-section="true" style="display: none;">
        <div class="admin-section" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin: 0 0 15px; font-size: 1.1em; color: #333;">Standardizer <span class="info-icon" title="Convert CSV data into the canonical merged_dataset.json format. Headers are normalized and issues are tracked.">&#9432;</span></h3>
          <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">Upload or paste CSV data to normalize into the standard merged dataset format.</p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
            <div>
              <label style="font-size: 0.8em; color: #666; display: block; margin-bottom: 6px;">Paste CSV</label>
              <textarea id="standardizer-csv-input" placeholder="Paste CSV data here..." style="width: 100%; height: 120px; font-family: monospace; font-size: 0.85em; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
            </div>
            <div>
              <label style="font-size: 0.8em; color: #666; display: block; margin-bottom: 6px;">Upload CSV File</label>
              <div id="standardizer-drop-zone" class="drop-zone" style="height: 120px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc; border-radius: 6px; cursor: pointer; background: #fafafa;">
                <span id="standardizer-drop-text" style="color: #888; font-size: 0.85em;">Drop CSV here or click to browse</span>
              </div>
              <input type="file" id="standardizer-file-input" accept=".csv,.txt" style="display: none;">
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="toolbar-btn" onclick="runStandardizer()">Run Standardizer</button>
            <button class="toolbar-btn" onclick="generateSampleCSV()">Generate Sample CSV</button>
            <button class="toolbar-btn" onclick="clearStandardizer()">Clear</button>
          </div>
          
          <div id="standardizer-status" style="display: none; padding: 10px; border-radius: 6px; margin-bottom: 15px;"></div>
          
          <div id="standardizer-output" style="display: none;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
              <button class="tab-btn active" data-std-tab="summary" onclick="showStandardizerTab('summary')">Summary</button>
              <button class="tab-btn" data-std-tab="dataset" onclick="showStandardizerTab('dataset')">Merged Dataset</button>
              <button class="tab-btn" data-std-tab="issues" onclick="showStandardizerTab('issues')">Issues</button>
              <button class="tab-btn" data-std-tab="changelog" onclick="showStandardizerTab('changelog')">Change Log</button>
            </div>
            <div id="standardizer-tab-content" style="background: #263238; color: #eceff1; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 0.8em; max-height: 300px; overflow-y: auto;"></div>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
              <button class="toolbar-btn" onclick="copyStandardizerOutput('dataset')">Copy Merged Dataset</button>
              <button class="toolbar-btn" onclick="copyStandardizerOutput('issues')">Copy Issues</button>
            </div>
          </div>
        </div>
        </div><!-- end admin-tab-standardizer -->

        <!-- CONFIG TAB -->
        <div id="admin-tab-config" class="admin-tab-panel" data-admin-section="true" style="display: none;">
          <div class="admin-section" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 15px; font-size: 1.1em; color: #333;">Config + Patch Inspector</h3>
            <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">Load and compare config packs. View ruleset deltas between base and patch.</p>
            <div class="config-inspector-row" style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
              <div style="flex: 1; min-width: 200px;">
                <label style="font-size: 0.8em; color: #666; display: block; margin-bottom: 4px;">Base Config Path</label>
                <input type="text" id="admin-base-config-path" value="config/config_pack.base.json" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.85em;">
              </div>
              <div style="flex: 1; min-width: 200px;">
                <label style="font-size: 0.8em; color: #666; display: block; margin-bottom: 4px;">Patch Path</label>
                <input type="text" id="admin-patch-path" value="config/config_pack.example.patch.json" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.85em;">
              </div>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
              <button class="toolbar-btn" onclick="loadAdminConfig()">Load Config</button>
              <button class="toolbar-btn" onclick="clearAdminConfig()">Clear</button>
            </div>
            <div id="admin-config-status" style="display: none; padding: 10px; border-radius: 6px; margin-bottom: 15px;"></div>
            <div id="admin-config-results" style="display: none;">
              <div id="admin-patch-summary" style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 15px;"></div>
              <div id="admin-ruleset-delta" style="background: #263238; color: #eceff1; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 0.8em; max-height: 300px; overflow-y: auto;"></div>
            </div>
          </div>
        </div><!-- end admin-tab-config -->

        <!-- INSPECTOR TAB -->
        <div id="admin-tab-inspector" class="admin-tab-panel" data-admin-section="true" style="display: none;">
          <div class="admin-section" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 15px; font-size: 1.1em; color: #333;">JSON Inspector</h3>
            <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">View raw JSON data for current session artifacts.</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
              <button class="toolbar-btn" onclick="inspectJSON('sf_packet')">SF Packet</button>
              <button class="toolbar-btn" onclick="inspectJSON('base_config')">Base Config</button>
              <button class="toolbar-btn" onclick="inspectJSON('patch_config')">Patch Config</button>
              <button class="toolbar-btn" onclick="inspectJSON('dataset')">Dataset</button>
            </div>
            <div id="admin-json-inspector" style="background: #263238; color: #eceff1; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 0.75em; max-height: 400px; overflow-y: auto; white-space: pre-wrap;">
              <em style="color: #888;">Select an artifact to inspect...</em>
            </div>
            <div style="margin-top: 10px;">
              <button class="toolbar-btn" onclick="copyInspectorJSON()">Copy JSON</button>
            </div>
          </div>
        </div><!-- end admin-tab-inspector -->

      </div><!-- end page-admin -->

    </main><!-- end main-content -->
  </div><!-- end app-layout -->

  <!-- Global Modals and Drawers (outside pages) -->
  <!-- Data Source Drawer (right-side slide-over) -->
  <div class="drawer-overlay" id="data-source-drawer">
    <div class="drawer">
      <div class="drawer-header">
        <h3>Data Source</h3>
        <button class="drawer-close" onclick="closeDataSourceDrawer()">&times;</button>
      </div>
      <div class="drawer-body">
        <!-- Empty State Section (shown when no data loaded) -->
        <div id="data-source-empty-section" style="display: none;">
          <div style="text-align: center; padding: 24px 20px; color: #888; background: #f5f5f5; border-radius: 8px; border: 2px dashed #ddd; margin-bottom: 20px;">
            <div style="font-size: 2em; margin-bottom: 10px;">ðŸ“</div>
            <div style="font-weight: 600; color: #333; margin-bottom: 8px;">No Active Dataset</div>
            <p style="margin: 0; font-size: 0.9em;">Upload a file or connect a source to get started.</p>
          </div>
          
          <!-- Upload | Connect Row (Two Columns) -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- Upload Tile -->
            <div style="background: #fff; border: 2px dashed #1976d2; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: background 0.15s;" onclick="document.getElementById('drawer-upload-file').click();" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='#fff'">
              <div style="font-size: 1.5em; margin-bottom: 8px;">ðŸ“„</div>
              <div style="font-weight: 600; font-size: 0.85em; color: #1976d2; margin-bottom: 4px;">Upload File</div>
              <div style="font-size: 0.7em; color: #666;">CSV or XLSX (multi-sheet)</div>
            </div>
            <input type="file" id="drawer-upload-file" accept=".csv,.xlsx" style="display: none;" onchange="handleDrawerFileUpload(this)">
            
            <!-- Connect Tile -->
            <div style="background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; text-align: center; opacity: 0.6;">
              <div style="font-size: 1.5em; margin-bottom: 8px;">ðŸ”Œ</div>
              <div style="font-weight: 600; font-size: 0.85em; color: #666; margin-bottom: 4px;">Connect Source</div>
              <div style="font-size: 0.7em; color: #888;">Google Drive, MCP <span style="background: #e0e0e0; padding: 1px 5px; border-radius: 3px; font-weight: 600;">V2</span></div>
            </div>
          </div>
          
          <!-- Sample Dataset Button -->
          <div style="margin-bottom: 16px; padding: 12px 15px; background: #f5f5f5; border-radius: 8px; border: 1px dashed #ccc;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 1.2em;">ðŸ“¦</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 0.9em;">Demo Dataset</div>
                <div style="font-size: 0.8em; color: #666;">5 sample contracts</div>
              </div>
              <button class="modal-btn modal-btn-primary" onclick="loadSampleDataset(true); closeDataSourceDrawer();">Load</button>
            </div>
          </div>
        </div>
        
        <!-- Active Dataset Section (shown when data loaded) -->
        <div id="data-source-active-section" style="display: none; margin-bottom: 20px; padding: 16px; background: #e8f5e9; border: 1px solid #81c784; border-radius: 8px; position: relative;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span style="font-size: 1.5em;">ðŸ“Š</span>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 0.95em; color: #2e7d32;">Active Dataset</div>
              <div id="active-dataset-name" style="font-size: 0.85em; color: #555; font-family: monospace;">â€”</div>
            </div>
            <div class="active-badge-container" style="position: relative;">
              <span id="active-badge" class="active-badge-hover" style="background: #4caf50; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 600; cursor: pointer;" onclick="toggleDisconnectMenu(event)">ACTIVE â–¾</span>
              <div id="disconnect-menu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; min-width: 140px;">
                <button onclick="disconnectActiveDataset()" style="display: block; width: 100%; padding: 10px 14px; background: none; border: none; text-align: left; cursor: pointer; font-size: 0.85em; color: #c62828;" onmouseover="this.style.background='#ffebee'" onmouseout="this.style.background='none'">
                  â Disconnect
                </button>
              </div>
            </div>
          </div>
          <div id="active-dataset-meta" style="font-size: 0.8em; color: #666;">
            <!-- Row count, loaded timestamp -->
          </div>
        </div>
        
        <!-- Upload | Connect Row (Active State - Two Columns) -->
        <div id="data-source-upload-section" style="display: none; margin-bottom: 16px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <!-- Upload Tile -->
            <div style="background: #fff; border: 2px dashed #1976d2; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: background 0.15s;" onclick="document.getElementById('drawer-upload-new-file').click();" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='#fff'">
              <div style="font-size: 1.5em; margin-bottom: 8px;">ðŸ“„</div>
              <div style="font-weight: 600; font-size: 0.85em; color: #1976d2; margin-bottom: 4px;">Upload New</div>
              <div style="font-size: 0.7em; color: #666;">CSV or XLSX (multi-sheet)</div>
            </div>
            <input type="file" id="drawer-upload-new-file" accept=".csv,.xlsx" style="display: none;" onchange="handleDrawerFileUpload(this)">
            
            <!-- Connect Tile -->
            <div style="background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; text-align: center; opacity: 0.6;">
              <div style="font-size: 1.5em; margin-bottom: 8px;">ðŸ”Œ</div>
              <div style="font-weight: 600; font-size: 0.85em; color: #666; margin-bottom: 4px;">Connect Source</div>
              <div style="font-size: 0.7em; color: #888;">Google Drive, MCP <span style="background: #e0e0e0; padding: 1px 5px; border-radius: 3px; font-weight: 600;">V2</span></div>
            </div>
          </div>
          <p style="color: #888; font-size: 0.75em; margin-top: 8px; text-align: center;">Uploading rotates current active dataset to Saved.</p>
        </div>
        
        <!-- Search Stub (V2) -->
        <div id="data-source-search-section" style="display: none; margin-bottom: 16px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
            <span style="font-weight: 600; font-size: 0.85em; color: #666;">Search</span>
            <span style="font-size: 0.7em; background: #e0e0e0; padding: 1px 5px; border-radius: 3px; font-weight: 600; color: #666;">V2</span>
          </div>
          <input type="text" id="data-source-search-input" placeholder="Search agreements, accounts, record IDs..." style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em; box-sizing: border-box;" oninput="showDataSourceSearchToast()" onkeydown="if(event.key==='Enter') showDataSourceSearchToast()">
        </div>
        
        <!-- Library Header (shown when saved datasets exist) -->
        <div id="data-source-library-header" style="display: none; margin-bottom: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
          <div style="font-weight: 600; font-size: 0.85em; color: #666; text-transform: uppercase; margin-bottom: 6px;">Saved Datasets</div>
          <p style="color: #888; font-size: 0.8em; margin: 0;">Select to activate. Active dataset cannot be deleted.</p>
        </div>
        
        <!-- Dataset List -->
        <div id="upload-library-list" style="display: flex; flex-direction: column; gap: 10px;">
          <!-- Populated by renderUploadLibrary() -->
        </div>
        
        <div class="modal-status" id="data-source-status" style="display: none; margin-top: 15px;"></div>
      </div>
      <div class="drawer-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeDataSourceDrawer()" style="width: 100%;">Close</button>
      </div>
    </div>
  </div>

  <!-- Loader Modal (centered overlay for data loading) -->
  <div class="loader-modal-overlay" id="loader-modal-overlay" onclick="closeLoaderModal(event)">
    <div class="loader-modal" id="loader-modal" onclick="event.stopPropagation()">
      <div class="loader-modal-header">
        <h3>Data Source</h3>
        <button class="loader-modal-close" id="loader-modal-close-btn" onclick="closeLoaderModal()" aria-label="Close">&times;</button>
      </div>
      <div class="loader-modal-body">
        <!-- Inline Error Display (v1.4.4) -->
        <div id="loader-error-display" style="display: none; margin-bottom: 16px; padding: 12px 16px; background: #ffebee; border: 1px solid #ef5350; border-radius: 8px; color: #c62828;">
          <div style="display: flex; align-items: flex-start; gap: 10px;">
            <span style="font-size: 1.1em;">âš ï¸</span>
            <div id="loader-error-message" style="flex: 1; font-size: 0.9em;"></div>
          </div>
        </div>
        
        <!-- Import CSV Section -->
        <div style="margin-bottom: 20px;">
          <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Upload / Add Data Source</div>
          <div class="drop-zone" id="loader-drawer-dropzone" onclick="document.getElementById('loader-drawer-file').click();">
            <div class="drop-zone-icon">ðŸ“„</div>
            <div class="drop-zone-text">Drop CSV or XLSX file here or click to browse</div>
            <div class="drop-zone-file" id="loader-drawer-file-name" style="display: none;"></div>
          </div>
          <input type="file" id="loader-drawer-file" accept=".csv,.xlsx" style="display: none;">
          <div style="font-size: 0.75em; color: #888; margin-top: 6px;">Supported: CSV, XLSX files</div>
        </div>
        
        <!-- Sample Dataset Section -->
        <div id="loader-drawer-sample-section" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; border: 1px dashed #ccc;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 1.2em;">ðŸ“¦</span>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 0.9em;">Demo Dataset</div>
              <div style="font-size: 0.8em; color: #666;">5 sample contracts for testing</div>
            </div>
            <button class="top-toolbar-btn" id="btn-load-sample-drawer" style="padding: 8px 16px;">Load Sample</button>
          </div>
        </div>
        
        <!-- Admin Utilities (admin-only) -->
        <div class="admin-only-content" style="border-top: 1px solid #e0e0e0; padding-top: 15px; margin-top: 15px;">
          <div style="font-weight: 600; margin-bottom: 10px; color: #888; font-size: 0.85em;">ADMIN UTILITIES</div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="top-toolbar-btn" onclick="resetDemoState();">Reset Demo State</button>
            <button class="top-toolbar-btn" onclick="rebuildFieldIndex();">Rebuild Index</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Config Flows Drawer (right-side slide-over for admin config editing) -->
  <div class="drawer-overlay" id="config-flows-drawer">
    <div class="drawer" style="width: 700px;">
      <div class="drawer-header" style="background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%);">
        <h3>Config Flows</h3>
        <button class="drawer-close" onclick="closeConfigFlows()">&times;</button>
      </div>
      <div class="drawer-body" style="display: flex; gap: 0; padding: 0;">
        <!-- Workflow Rail (Left Column) -->
        <div class="config-flows-rail" style="width: 200px; background: #f8f9fa; border-right: 1px solid #e0e0e0; padding: 15px 0; flex-shrink: 0;">
          <div class="rail-header" style="padding: 0 15px 10px; font-size: 0.75em; color: #666; text-transform: uppercase; font-weight: 600;">Workflow Stages</div>
          <div class="rail-items" id="config-flows-rail">
            <a class="rail-item active" data-stage="data_sources" onclick="selectConfigFlowStage('data_sources')">
              <span class="rail-number">1</span>
              <span class="rail-label">Data Sources</span>
            </a>
            <a class="rail-item" data-stage="dataset_mapping" onclick="selectConfigFlowStage('dataset_mapping')">
              <span class="rail-number">2</span>
              <span class="rail-label">Dataset Mapping</span>
            </a>
            <a class="rail-item" data-stage="standardization" onclick="selectConfigFlowStage('standardization')">
              <span class="rail-number">3</span>
              <span class="rail-label">Standardization</span>
            </a>
            <a class="rail-item" data-stage="ruleset" onclick="selectConfigFlowStage('ruleset')">
              <span class="rail-number">4</span>
              <span class="rail-label">Ruleset</span>
            </a>
            <a class="rail-item" data-stage="validation_gates" onclick="selectConfigFlowStage('validation_gates')">
              <span class="rail-number">5</span>
              <span class="rail-label">Validation Gates</span>
            </a>
            <a class="rail-item" data-stage="patch_generation" onclick="selectConfigFlowStage('patch_generation')">
              <span class="rail-number">6</span>
              <span class="rail-label">Patch Generation</span>
            </a>
            <a class="rail-item" data-stage="smoke_baselines" onclick="selectConfigFlowStage('smoke_baselines')">
              <span class="rail-number">7</span>
              <span class="rail-label">Smoke Baselines</span>
            </a>
            <a class="rail-item" data-stage="export" onclick="selectConfigFlowStage('export')">
              <span class="rail-number">8</span>
              <span class="rail-label">Export / PR</span>
            </a>
          </div>
        </div>
        
        <!-- Flow Stage Detail (Main Column) -->
        <div class="config-flows-detail" style="flex: 1; padding: 20px; overflow-y: auto;">
          <div class="stage-header" style="margin-bottom: 15px;">
            <h4 id="config-flow-stage-title" style="margin: 0 0 5px; font-size: 1.1em;">Data Sources</h4>
            <p id="config-flow-stage-desc" style="margin: 0; color: #666; font-size: 0.9em;">Configure where data is loaded from.</p>
          </div>
          
          <div class="stage-tabs" style="display: flex; gap: 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 15px;">
            <button class="stage-tab active" data-tab="plain-english" onclick="selectConfigFlowTab('plain-english')">Plain-English</button>
            <button class="stage-tab" data-tab="payload" onclick="selectConfigFlowTab('payload')">Payload</button>
            <button class="stage-tab" data-tab="master" onclick="selectConfigFlowTab('master')">Master</button>
            <button class="stage-tab" data-tab="diff" onclick="selectConfigFlowTab('diff')">Diff</button>
            <button class="stage-tab" data-tab="history" onclick="selectConfigFlowTab('history')">History</button>
          </div>
          
          <div id="config-flow-tab-content">
            <!-- Tab content rendered dynamically -->
            <div style="padding: 20px; background: #f5f5f5; border-radius: 6px; color: #666;">
              <p>This stage configures how Preview and Reference packets are loaded into the session.</p>
              <p style="margin-top: 10px;">Available methods:</p>
              <ul style="margin: 10px 0 0 20px;">
                <li>Repo Masters (auto-load from repository)</li>
                <li>Paste JSON (manual paste)</li>
                <li>Drag & Drop (file upload)</li>
                <li>Local Path Hint (reference local files)</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Record Detail Drawer (right-side slide-over for contract details) -->
  <div class="drawer-overlay" id="record-drawer">
    <div class="drawer" style="width: 500px;">
      <div class="drawer-header">
        <h3 id="record-drawer-title">Record Details</h3>
        <button class="drawer-close" onclick="closeRecordDrawer()">&times;</button>
      </div>
      <div class="drawer-body" id="record-drawer-content">
        <p style="color: #666;">Select a contract to view details.</p>
      </div>
      <div class="drawer-footer">
        <div style="display: flex; gap: 10px; justify-content: space-between;">
          <button class="modal-btn modal-btn-secondary" id="record-drawer-prev" onclick="navigateRecord(-1)" disabled>Previous</button>
          <span id="record-drawer-position" style="line-height: 36px; color: #666;">-/-</span>
          <button class="modal-btn modal-btn-secondary" id="record-drawer-next" onclick="navigateRecord(1)" disabled>Next</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Patch Request Detail Drawer -->
  <div class="drawer-overlay" id="patch-detail-drawer">
    <div class="drawer" style="width: 550px;">
      <div class="drawer-header" style="background: #7b1fa2; color: white;">
        <h3 id="patch-detail-title">Patch Request Details</h3>
        <button class="drawer-close" onclick="closePatchDetailDrawer()" style="color: white;">&times;</button>
      </div>
      <div class="drawer-body" id="patch-detail-content" style="padding: 20px;">
        <p style="color: #666;">Select a patch request to view details.</p>
      </div>
      <div class="drawer-footer" id="patch-detail-footer" style="border-top: 1px solid #eee; padding: 15px;">
      </div>
    </div>
  </div>

  <!-- Ruleset Modal -->
  <div class="modal-overlay" id="ruleset-modal">
    <div class="modal wizard-modal">
      <div class="modal-header">
        <h3>Ruleset Configuration</h3>
        <button class="modal-close" onclick="closeRulesetModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="wizard-section">
          <h4>Base (Truth)</h4>
          <div class="wizard-field">
            <label>Base Config Path</label>
            <input type="text" id="wizard-base-config" value="config/config_pack.base.json" placeholder="config/config_pack.base.json">
            <div class="hint">The authoritative semantic ruleset</div>
          </div>
        </div>
        <div class="wizard-section">
          <h4>Patch (Proposed)</h4>
          <div class="wizard-field">
            <label>Patch Path</label>
            <input type="text" id="wizard-patch-config" value="config/config_pack.example.patch.json" placeholder="config/config_pack.example.patch.json">
            <div class="hint">Optional patch file with proposed changes</div>
          </div>
        </div>
        <div class="modal-actions">
          <button class="modal-btn modal-btn-primary" id="wizard-load-ruleset">Load Ruleset</button>
          <button class="modal-btn modal-btn-secondary" onclick="closeRulesetModal()">Cancel</button>
        </div>
        <div class="modal-status" id="ruleset-status" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Compare Modal -->
  <div class="modal-overlay" id="compare-modal">
    <div class="modal wizard-modal">
      <div class="modal-header">
        <h3>Comparison Mode</h3>
        <button class="modal-close" onclick="closeCompareModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="wizard-section">
          <h4>Compare Artifact (Optional)</h4>
          <div class="wizard-field">
            <label>Comparison Artifact Path</label>
            <input type="text" id="wizard-compare-path" placeholder="out/sf_packet.preview.prev.json">
            <div class="hint">Load a previous artifact to compare changes and view deltas</div>
          </div>
          <div class="wizard-preset">
            <button class="wizard-preset-btn" data-compare="out/sf_packet.preview.prev.json">Previous Preview</button>
            <button class="wizard-preset-btn" data-compare="">Clear Compare</button>
          </div>
        </div>
        <div class="modal-actions">
          <button class="modal-btn modal-btn-primary" id="wizard-load-compare">Load Comparison</button>
          <button class="modal-btn modal-btn-secondary" onclick="closeCompareModal()">Cancel</button>
        </div>
        <div class="modal-status" id="compare-status" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Run Commands Modal -->
  <div class="modal-overlay" id="run-modal">
    <div class="modal wizard-modal">
      <div class="modal-header">
        <h3>Run Commands</h3>
        <button class="modal-close" onclick="closeRunModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 15px; color: #666;">Copy validation and preview commands to run in your terminal. This viewer does not execute commands directly.</p>
        <div class="wizard-section">
          <h4>Validation &amp; Preview Commands</h4>
          <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
            <button class="toolbar-btn" data-cmd="validate">Validate</button>
            <button class="toolbar-btn" data-cmd="preview_baseline">Preview Baseline</button>
            <button class="toolbar-btn" data-cmd="preview_edge">Preview Edge</button>
            <button class="toolbar-btn" data-cmd="smoke_baseline">Smoke Baseline</button>
            <button class="toolbar-btn" data-cmd="smoke_edge">Smoke Edge</button>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="run-modal-confirm">
            <label for="run-modal-confirm" style="color: #f57c00; font-size: 0.9em;">I CONFIRM RUN</label>
          </div>
        </div>
        <div class="modal-actions">
          <button class="modal-btn modal-btn-secondary" onclick="closeRunModal()">Close</button>
        </div>
        <div class="modal-status" id="run-modal-status" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Configure Wizard Modal -->
  <div class="modal-overlay" id="configure-wizard-modal">
    <div class="modal wizard-modal" style="max-width: 550px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #7c4dff 0%, #536dfe 100%);">
        <h3 id="wizard-step-title">Configure Kiwi</h3>
        <button class="modal-close" onclick="closeConfigureWizard()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="wizard-progress" style="display: flex; gap: 8px; margin-bottom: 20px;">
          <span class="wizard-step-dot active" data-step="0"></span>
          <span class="wizard-step-dot" data-step="1"></span>
          <span class="wizard-step-dot" data-step="2"></span>
          <span class="wizard-step-dot" data-step="3"></span>
        </div>
        <div id="wizard-step-content">
          <!-- Step content rendered dynamically -->
        </div>
        <div class="modal-actions" style="margin-top: 20px; justify-content: space-between;">
          <button class="modal-btn modal-btn-secondary" id="wizard-back" onclick="wizardBack()" style="display: none;">Back</button>
          <button class="modal-btn modal-btn-primary" id="wizard-next" onclick="wizardNext()" style="margin-left: auto;">Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Command Modal (legacy) -->
  <div class="modal-overlay" id="command-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-title">Command</h3>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p id="modal-description" style="margin-bottom: 15px; color: #666;"></p>
        <div class="modal-command" id="modal-command"></div>
        <div class="modal-actions">
          <button class="modal-btn modal-btn-primary" id="modal-copy">Copy to Clipboard</button>
          <button class="modal-btn modal-btn-danger" id="modal-run" disabled>Run (Confirm Required)</button>
          <button class="modal-btn modal-btn-secondary" id="modal-cancel">Cancel</button>
        </div>
        <div class="modal-status" id="modal-status" style="display: none;"></div>
      </div>
    </div>
  </div>

  <div class="drawer-overlay" id="drawer-overlay"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-header">
      <div class="drawer-header-row">
        <h3>Record Workbench</h3>
        <button class="drawer-close" id="drawer-close">&times;</button>
      </div>
      <div class="drawer-identity">
        <div class="identity-pill" id="identity-pill"></div>
        <button class="identity-copy" id="identity-copy">Copy ID</button>
      </div>
    </div>
    <div class="drawer-tabs" id="drawer-tabs">
      <button class="drawer-tab active" data-tab="contract">Contract</button>
      <button class="drawer-tab" data-tab="issues">Issues <span class="drawer-tab-count" id="issues-count">0</span></button>
      <button class="drawer-tab" data-tab="actions">Actions <span class="drawer-tab-count" id="actions-count">0</span></button>
      <button class="drawer-tab" data-tab="changelog">Change Log <span class="drawer-tab-count" id="changelog-count">0</span></button>
      <button class="drawer-tab" data-tab="patch-studio" style="background: #2e7d32; color: white;">Patch Studio</button>
    </div>
    <div class="drawer-warning" id="drawer-warning" style="display: none;"></div>
    <div class="drawer-body" id="drawer-body"></div>
    <div class="drawer-panel" id="patch-studio-panel" style="display: none; flex: 1; overflow-y: auto; padding: 0;">
      <div class="patch-studio-sub-tabs" style="display: flex; background: #263238; flex-shrink: 0;">
        <button class="patch-studio-sub-tab active" data-subtab="draft" style="flex: 1; padding: 10px; border: none; background: #1a1a2e; color: white; cursor: pointer; font-size: 0.85em;">Draft</button>
        <button class="patch-studio-sub-tab" data-subtab="preflight" style="flex: 1; padding: 10px; border: none; background: #263238; color: #aaa; cursor: pointer; font-size: 0.85em;">Preflight</button>
        <button class="patch-studio-sub-tab" data-subtab="evidence" style="flex: 1; padding: 10px; border: none; background: #263238; color: #aaa; cursor: pointer; font-size: 0.85em;">Evidence Pack</button>
      </div>
      <div class="patch-studio-sub-panel" id="subtab-draft" style="padding: 15px;">
        <fieldset style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
          <legend style="font-weight: 600; font-size: 0.85em; color: #1565c0; padding: 0 8px;">WHEN (condition)</legend>
          <div style="margin-bottom: 10px;">
            <label style="display: block; font-size: 0.8em; color: #666; margin-bottom: 4px;">Target Field</label>
            <select id="ps-target-field" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
              <option value="">-- Select field --</option>
            </select>
            <span style="font-size: 0.75em; color: #888;">e.g., contracts.label_name</span>
          </div>
          <div style="margin-bottom: 10px;">
            <label style="display: block; font-size: 0.8em; color: #666; margin-bottom: 4px;">Condition Type</label>
            <select id="ps-condition-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
              <option value="">-- Select condition --</option>
              <option value="SHOULD_BE_BLANK_BUT_POPULATED">Should be blank but has data</option>
              <option value="SHOULD_BE_PRESENT_BUT_MISSING">Should have data but is empty</option>
              <option value="INVALID_FORMAT">Invalid format/pattern</option>
              <option value="OUT_OF_RANGE">Value out of allowed range</option>
              <option value="MISMATCH_WITH_OTHER_FIELD">Mismatches another field</option>
              <option value="DUPLICATE">Duplicate value detected</option>
              <option value="OTHER">Other (specify below)</option>
            </select>
          </div>
          <div id="ps-condition-other-wrap" style="display: none; margin-bottom: 10px;">
            <label style="display: block; font-size: 0.8em; color: #666; margin-bottom: 4px;">Describe condition (required for Other)</label>
            <input type="text" id="ps-condition-other" placeholder="e.g., contains 'Various Artists'" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
          </div>
        </fieldset>
        
        <fieldset style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
          <legend style="font-weight: 600; font-size: 0.85em; color: #2e7d32; padding: 0 8px;">THEN (action)</legend>
          <div style="margin-bottom: 10px;">
            <label style="display: block; font-size: 0.8em; color: #666; margin-bottom: 4px;">Action Type</label>
            <select id="ps-action-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
              <option value="">-- Select action --</option>
              <option value="REQUIRE_PRESENT">Require field to have a value</option>
              <option value="REQUIRE_BLANK">Require field to be blank</option>
              <option value="WARN_ONLY">Warn only (non-blocking)</option>
              <option value="NORMALIZE_VALUE">Normalize/standardize value</option>
              <option value="MAP_FIELD">Map to another field</option>
              <option value="BLOCK_SUBMISSION">Block submission</option>
              <option value="OTHER">Other (specify below)</option>
            </select>
          </div>
          <div id="ps-action-other-wrap" style="display: none; margin-bottom: 10px;">
            <label style="display: block; font-size: 0.8em; color: #666; margin-bottom: 4px;">Describe action (required for Other)</label>
            <input type="text" id="ps-action-other" placeholder="e.g., require artist_name to be present" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
          </div>
        </fieldset>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.85em;">Comment (plain English) <span style="color: #c62828;">*</span></label>
          <textarea id="ps-intent-because" placeholder="Explain why this rule exists in human terms. This is what reviewers/admins will read." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; resize: vertical; min-height: 60px;"></textarea>
          <span style="font-size: 0.75em; color: #888;">Required. Max 500 characters.</span>
        </div>
        
        <div style="background: #f5f5f5; border-radius: 6px; padding: 12px; margin-bottom: 15px; border-left: 3px solid #1565c0;">
          <div style="font-weight: 600; font-size: 0.8em; color: #1565c0; margin-bottom: 8px;">Intent Preview</div>
          <div id="ps-intent-preview" style="font-size: 0.85em; color: #333;">
            <div><strong>WHEN:</strong> <span id="preview-when" style="color: #666;">(select field and condition)</span></div>
            <div><strong>THEN:</strong> <span id="preview-then" style="color: #666;">(select action)</span></div>
            <div><strong>BECAUSE:</strong> <span id="preview-because" style="color: #666;">(enter comment)</span></div>
          </div>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.85em;">Target Artifact</label>
          <select id="ps-target" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
            <option value="proposed_changes">Proposed Changes</option>
            <option value="salesforce">Salesforce Rules</option>
            <option value="qa_rules">QA Rules</option>
            <option value="resolver_rules">Resolver Rules</option>
            <option value="truth_config">Truth Config</option>
          </select>
        </div>
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.85em;">Risk Level</label>
          <select id="ps-risk" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
            <option value="low">Low - minor adjustment</option>
            <option value="medium">Medium - affects multiple records</option>
            <option value="high">High - significant system change</option>
          </select>
        </div>
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.85em;">Rationale (optional)</label>
          <textarea id="ps-rationale" placeholder="Additional context or notes..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; resize: vertical; min-height: 40px;"></textarea>
        </div>
      </div>
      <div class="patch-studio-sub-panel" id="subtab-preflight" style="display: none; padding: 15px;">
        <h4 style="margin: 0 0 15px 0; font-size: 0.95em;">Preflight Checks</h4>
        <div id="ps-preflight-checks" style="display: flex; flex-direction: column; gap: 10px;">
          <div class="preflight-check" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f5f5f5; border-radius: 6px;">
            <span class="preflight-badge" style="padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600; background: #e8f5e9; color: #2e7d32;">PASS</span>
            <span style="font-size: 0.9em;">Intent fields populated</span>
          </div>
          <div class="preflight-check" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f5f5f5; border-radius: 6px;">
            <span class="preflight-badge" style="padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600; background: #fff3e0; color: #e65100;">WARN</span>
            <span style="font-size: 0.9em;">Evidence pack incomplete</span>
          </div>
          <div class="preflight-check" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f5f5f5; border-radius: 6px;">
            <span class="preflight-badge" style="padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600; background: #e3f2fd; color: #1565c0;">INFO</span>
            <span style="font-size: 0.9em;">Target: Proposed Changes</span>
          </div>
        </div>
        <div style="margin-top: 20px;">
          <button class="toolbar-btn" id="ps-run-preflight" style="width: 100%;">Run Preflight Checks</button>
        </div>
        <div style="margin-top: 15px;">
          <button class="toolbar-btn" id="ps-copy-preflight" style="width: 100%; background: #455a64;">Copy Preflight Report</button>
        </div>
      </div>
      <div class="patch-studio-sub-panel" id="subtab-evidence" style="display: none; padding: 15px;">
        <h4 style="margin: 0 0 10px 0; font-size: 0.95em;">Evidence Pack (Copy-only)</h4>
        <p style="font-size: 0.8em; color: #666; margin-bottom: 15px;">Structured evidence blocks to support your patch request.</p>
        <div style="margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <label style="font-weight: 600; font-size: 0.85em;">Observation</label>
            <button class="toolbar-btn" onclick="copyEvidenceBlock('observation')" style="padding: 2px 8px; font-size: 0.75em;">Copy</button>
          </div>
          <textarea id="ps-evidence-observation" placeholder="What did you observe that prompted this change?" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; resize: vertical; min-height: 50px;"></textarea>
        </div>
        <div style="margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <label style="font-weight: 600; font-size: 0.85em;">Expected Behavior</label>
            <button class="toolbar-btn" onclick="copyEvidenceBlock('expected')" style="padding: 2px 8px; font-size: 0.75em;">Copy</button>
          </div>
          <textarea id="ps-evidence-expected" placeholder="What should happen instead?" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; resize: vertical; min-height: 50px;"></textarea>
        </div>
        <div style="margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <label style="font-weight: 600; font-size: 0.85em;">Rule Justification</label>
            <button class="toolbar-btn" onclick="copyEvidenceBlock('justification')" style="padding: 2px 8px; font-size: 0.75em;">Copy</button>
          </div>
          <textarea id="ps-evidence-justification" placeholder="Why is this rule change justified?" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; resize: vertical; min-height: 50px;"></textarea>
        </div>
        <div style="margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <label style="font-weight: 600; font-size: 0.85em;">Repro Steps</label>
            <button class="toolbar-btn" onclick="copyEvidenceBlock('repro')" style="padding: 2px 8px; font-size: 0.75em;">Copy</button>
          </div>
          <textarea id="ps-evidence-repro" placeholder="How can this issue be reproduced?" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; resize: vertical; min-height: 50px;"></textarea>
        </div>
      </div>
    </div>
    <div class="drawer-actions" id="drawer-actions-default">
      <div class="drawer-actions-grid">
        <button class="drawer-btn" id="drawer-copy">Copy JSON</button>
        <button class="drawer-btn drawer-btn-secondary" id="copy-pr-summary">Copy PR Summary</button>
        <button class="drawer-btn drawer-btn-secondary" id="copy-rule-draft">Copy Rule Draft</button>
        <button class="drawer-btn" id="switch-to-patch-studio-tab" style="background: #2e7d32;">Build Patch</button>
      </div>
    </div>
    <div class="drawer-actions" id="drawer-actions-patch-studio" style="display: none;">
      <div style="padding: 10px; background: #f0f0f0; border-top: 1px solid #ddd;">
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <span style="font-size: 0.75em; background: #e3f2fd; color: #1565c0; padding: 3px 8px; border-radius: 4px; display: flex; align-items: center; gap: 4px;" title="These buttons copy data to clipboard without creating queue artifacts">
            <span style="font-size: 1em;">&#128203;</span> Copy-only
          </span>
          <span style="font-size: 0.75em; background: #e8f5e9; color: #2e7d32; padding: 3px 8px; border-radius: 4px; display: flex; align-items: center; gap: 4px;" title="Submit creates a tracked Patch Request artifact">
            <span style="font-size: 1em;">&#10003;</span> Submit creates Patch Request
          </span>
        </div>
      </div>
      <div class="drawer-actions-grid" style="padding: 10px;">
        <button class="drawer-btn drawer-btn-secondary" id="ps-copy-draft" title="Copy the current draft to clipboard">Copy Draft</button>
        <button class="drawer-btn drawer-btn-secondary" id="ps-save-local" title="Save draft to browser storage">Save Draft</button>
        <button class="drawer-btn" id="ps-submit-to-queue" style="background: #2e7d32; grid-column: span 2;" title="Submit this Patch Request for review">Submit Patch Request</button>
      </div>
    </div>
  </div>

  <!-- Legacy Patch Studio overlay removed in v1.2.4 - all functionality now in Workbench tab -->

  <script>
    const PRIMARY_PATH = 'out/sf_packet.preview.json';
    const FALLBACK_PATH = 'examples/expected_outputs/sf_packet.example.json';
    const RELATIVE_PRIMARY = '../../out/sf_packet.preview.json';
    const RELATIVE_FALLBACK = '../../examples/expected_outputs/sf_packet.example.json';
    const COMMANDS_PATH = 'run_commands.json';
    const STORAGE_KEY = 'viewer_selection_v10';
    const PREFLIGHT_STORAGE_KEY = 'viewer_preflight_v10';
    const SETTINGS_STORAGE_KEY = 'viewer_settings_v12';
    const FIRST_RUN_DISMISSED_KEY = 'viewer_first_run_dismissed_v12';
    
    // Default settings (used when no user config exists)
    const DEFAULT_SETTINGS = {
      use_repo_masters: true,
      preferred_load_method: 'Repo Masters',
      local_data_root: '',
      default_queues: ['To Do', 'Needs Review', 'Flagged'],
      compare_mode_default: true,
      configured: false
    };
    
    let userSettings = { ...DEFAULT_SETTINGS };
    const PATCH_STORAGE_KEY = 'viewer_patch_v10';
    const COMPARISON_PATH = '../../out/sf_packet.preview.prev.json';

    let loadedBaseConfig = null;
    let loadedPatch = null;
    let configVersionMatch = null;

    let commands = {};
    let allData = { contractResults: [], issues: [], fieldActions: [], changeLog: [] };
    let compareData = null;
    let rowChanges = { contractResults: {}, issues: {}, fieldActions: {} };
    let deltaStats = null;
    let activeFilters = { search: '', severities: ['blocking', 'warning', 'info'], statuses: ['ready', 'needs_review', 'blocked'], subtype: '' };
    let currentSelection = { joinIdentity: null, contractIdx: null, activeTab: 'contract' };
    let selectedRecords = { issues: new Set(), actions: new Set(), changelog: new Set() };
    let patchDraft = { baseVersion: '0.1.0', author: '', rationale: '', changes: [] };
    let preflightEvidence = {
      baseVersion: { raw: '', parsed: null, status: 'pending' },
      validation: { raw: '', parsed: null, status: 'pending' },
      conflict: { raw: '', parsed: null, status: 'pending' },
      smokeBaseline: { raw: '', parsed: null, status: 'pending' },
      smokeEdge: { raw: '', parsed: null, status: 'pending' },
      sha256: ''
    };

    let currentMode = 'analyst';
    let currentQueue = 'todo';
    let dataLoaded = false;
    let currentArtifactPath = '';
    
    // Session state tracking
    const sessionState = {
      status: 'not-loaded', // 'not-loaded', 'loaded', 'fallback'
      sourceType: null, // 'paste', 'drop', 'example', null
      loadedAt: null,
      previewData: null,
      expectedData: null,
      fileName: null
    };
    
    // ========== WORKBOOK DATA STRUCTURE (v1.4.3 INGEST-01) ==========
    // Canonical multi-sheet dataset contract
    var workbook = {
      sheets: {},       // { sheetName: { headers: [], rows: [], meta: {} } }
      order: [],        // Deterministic sheet ordering
      activeSheet: null // Currently selected sheet
    };
    
    function resetWorkbook() {
      workbook.sheets = {};
      workbook.order = [];
      workbook.activeSheet = null;
    }
    
    function setActiveSheet(sheetName) {
      if (workbook.sheets[sheetName]) {
        workbook.activeSheet = sheetName;
        console.log('[Workbook] Active sheet set to:', sheetName);
        return true;
      }
      return false;
    }
    
    function getActiveSheetData() {
      if (!workbook.activeSheet || !workbook.sheets[workbook.activeSheet]) {
        return { headers: [], rows: [], meta: {} };
      }
      return workbook.sheets[workbook.activeSheet];
    }
    
    function addSheet(sheetName, headers, rows, meta) {
      workbook.sheets[sheetName] = {
        headers: headers || [],
        rows: rows || [],
        meta: meta || {}
      };
      if (!workbook.order.includes(sheetName)) {
        workbook.order.push(sheetName);
        workbook.order.sort(); // Lexical ordering
      }
      // Set active sheet if none set
      if (!workbook.activeSheet) {
        workbook.activeSheet = sheetName;
      }
      console.log('[Workbook] Added sheet:', sheetName, 'headers:', headers.length, 'rows:', rows.length);
    }
    
    const STORAGE_KEY_SESSION = 'controlboard_session_v11';
    const ARTIFACT_REGISTRY_KEY = 'orchestrateos.artifacts.v1';
    const STORAGE_KEY_DATASET = 'orchestrate.dataset.v1';
    const STORAGE_KEY_PDF_ATTACHMENTS = 'orchestrate.pdf_attachments.v1';
    const STORAGE_KEY_LIBRARY = 'orchestrate.upload_library.v1';
    const STORAGE_KEY_ACTIVE_DATASET = 'orchestrate.active_dataset_id.v1';
    
    // ========== SAMPLE DATASET (V1.2.5) ==========
    const SAMPLE_DATASET = {"dataset_id":"sample_v1","version":"1.0.0","created_at":"2026-01-30T00:00:00Z","description":"Deterministic demo dataset for testing structured intent and the full workflow.","sheets":{"contracts":{"headers":["contract_key","file_url","file_name","label_name","artist_name","subtype","status","effective_date"],"rows":[{"contract_key":"CK-001","file_url":"https://example.org/contract_a.pdf","file_name":"contract_a.pdf","label_name":"Acme Records","artist_name":"The Samples","subtype":"exclusive","status":"active","effective_date":"2024-01-15"},{"contract_key":"CK-002","file_url":"https://example.org/contract_b.pdf","file_name":"contract_b.pdf","label_name":"Various Artists","artist_name":"","subtype":"compilation","status":"active","effective_date":"2024-02-20"},{"contract_key":"CK-003","file_url":"https://example.org/contract_c.pdf","file_name":"contract_c.pdf","label_name":"Indie House","artist_name":"Solo Artist","subtype":"non-exclusive","status":"pending","effective_date":""},{"contract_key":"","file_url":"https://example.org/contract_d.pdf","file_name":"contract_d.pdf","label_name":"Beta Music","artist_name":"Beta Band","subtype":"exclusive","status":"draft","effective_date":"2024-03-01"},{"contract_key":"CK-005","file_url":"","file_name":"contract_e.pdf","label_name":"Gamma Tunes","artist_name":"","subtype":"exclusive","status":"active","effective_date":"2024-04-10"}]},"catalog":{"headers":["contract_key","file_url","file_name","track_title","artist_name","isrc","release_date","genre"],"rows":[{"contract_key":"CK-001","file_url":"https://example.org/contract_a.pdf","file_name":"contract_a.pdf","track_title":"Sample Song One","artist_name":"The Samples","isrc":"US-ABC-24-00001","release_date":"2024-05-01","genre":"Rock"},{"contract_key":"CK-001","file_url":"https://example.org/contract_a.pdf","file_name":"contract_a.pdf","track_title":"Sample Song Two","artist_name":"The Samples","isrc":"US-ABC-24-00002","release_date":"2024-05-01","genre":"Rock"},{"contract_key":"CK-002","file_url":"https://example.org/contract_b.pdf","file_name":"contract_b.pdf","track_title":"Compilation Hit","artist_name":"","isrc":"","release_date":"2024-06-15","genre":"Pop"},{"contract_key":"CK-003","file_url":"https://example.org/contract_c.pdf","file_name":"contract_c.pdf","track_title":"","artist_name":"Solo Artist","isrc":"US-DEF-24-00003","release_date":"","genre":"Jazz"},{"contract_key":"CK-005","file_url":"","file_name":"contract_e.pdf","track_title":"Gamma Track","artist_name":"Gamma Star","isrc":"US-GHI-24-00004","release_date":"2024-07-20","genre":"Electronic"}]},"royalties":{"headers":["contract_key","file_url","file_name","period","gross_revenue","artist_share_pct","net_payable"],"rows":[{"contract_key":"CK-001","file_url":"https://example.org/contract_a.pdf","file_name":"contract_a.pdf","period":"2024-Q1","gross_revenue":"15000.00","artist_share_pct":"50","net_payable":"7500.00"},{"contract_key":"CK-001","file_url":"https://example.org/contract_a.pdf","file_name":"contract_a.pdf","period":"2024-Q2","gross_revenue":"18500.00","artist_share_pct":"50","net_payable":"9250.00"},{"contract_key":"CK-002","file_url":"https://example.org/contract_b.pdf","file_name":"contract_b.pdf","period":"2024-Q1","gross_revenue":"8000.00","artist_share_pct":"","net_payable":""},{"contract_key":"CK-003","file_url":"https://example.org/contract_c.pdf","file_name":"contract_c.pdf","period":"2024-Q2","gross_revenue":"","artist_share_pct":"40","net_payable":""}]}},"issues":[{"issue_id":"ISS-001","contract_key":"CK-002","file_url":"https://example.org/contract_b.pdf","file_name":"contract_b.pdf","sheet":"contracts","field":"artist_name","issue_type":"MISSING_REQUIRED","severity":"warning","message":"Compilation contract missing artist attribution"},{"issue_id":"ISS-002","contract_key":"CK-003","file_url":"https://example.org/contract_c.pdf","file_name":"contract_c.pdf","sheet":"contracts","field":"effective_date","issue_type":"MISSING_REQUIRED","severity":"blocking","message":"Contract missing effective date"},{"issue_id":"ISS-003","contract_key":"","file_url":"https://example.org/contract_d.pdf","file_name":"contract_d.pdf","sheet":"contracts","field":"contract_key","issue_type":"MISSING_REQUIRED","severity":"blocking","message":"Contract key is missing"},{"issue_id":"ISS-004","contract_key":"CK-005","file_url":"","file_name":"contract_e.pdf","sheet":"contracts","field":"file_url","issue_type":"MISSING_REQUIRED","severity":"warning","message":"File URL is missing"},{"issue_id":"ISS-005","contract_key":"CK-002","file_url":"https://example.org/contract_b.pdf","file_name":"contract_b.pdf","sheet":"catalog","field":"isrc","issue_type":"MISSING_REQUIRED","severity":"warning","message":"ISRC code missing for track"},{"issue_id":"ISS-006","contract_key":"CK-003","file_url":"https://example.org/contract_c.pdf","file_name":"contract_c.pdf","sheet":"catalog","field":"track_title","issue_type":"MISSING_REQUIRED","severity":"blocking","message":"Track title is missing"},{"issue_id":"ISS-007","contract_key":"CK-002","file_url":"https://example.org/contract_b.pdf","file_name":"contract_b.pdf","sheet":"royalties","field":"artist_share_pct","issue_type":"MISSING_REQUIRED","severity":"warning","message":"Artist share percentage missing"}],"field_actions":[{"action_id":"FA-001","contract_key":"CK-002","file_url":"https://example.org/contract_b.pdf","file_name":"contract_b.pdf","sheet":"contracts","field":"label_name","action":"REVIEW","triggered_by":"SF_R1_LABEL_NOT_ARTIST"},{"action_id":"FA-002","contract_key":"CK-001","file_url":"https://example.org/contract_a.pdf","file_name":"contract_a.pdf","sheet":"catalog","field":"artist_name","action":"VALIDATE","triggered_by":"SF_R2_ARTIST_REQUIRED"}],"contract_results":[{"contract_key":"CK-001","file_url":"https://example.org/contract_a.pdf","file_name":"contract_a.pdf","status":"ready","subtype":"exclusive","issue_count":0},{"contract_key":"CK-002","file_url":"https://example.org/contract_b.pdf","file_name":"contract_b.pdf","status":"needs_review","subtype":"compilation","issue_count":3},{"contract_key":"CK-003","file_url":"https://example.org/contract_c.pdf","file_name":"contract_c.pdf","status":"blocked","subtype":"non-exclusive","issue_count":2},{"contract_key":"","file_url":"https://example.org/contract_d.pdf","file_name":"contract_d.pdf","status":"blocked","subtype":"exclusive","issue_count":1},{"contract_key":"CK-005","file_url":"","file_name":"contract_e.pdf","status":"needs_review","subtype":"exclusive","issue_count":1}],"summary":{"total_contracts":5,"ready":1,"needs_review":2,"blocked":2,"total_issues":7,"blocking_issues":3,"warning_issues":4}};
    
    // ========== NOMENCLATURE PACK (D4) ==========
    // Maps internal tokens to human-readable labels
    const NOMENCLATURE = {
      labels: {
        'sf_packet': 'Preview Packet',
        'sf_summary': 'Summary',
        'sf_contract_results': 'Contract Results',
        'sf_issues': 'Issues',
        'sf_field_actions': 'Field Actions',
        'config_pack_base': 'Truth Config',
        'config_pack_patch': 'Proposed Changes',
        'standardized_dataset': 'Standardized Dataset',
        'expected_output': 'Reference Expected',
        'merged_dataset': 'Merged Dataset',
        'contract_key': 'Contract Key',
        'file_url': 'File URL',
        'file_name': 'File Name',
        'detected_subtype': 'Detected Subtype',
        'sf_contract_status': 'Status'
      },
      tooltips: {
        'Preview Packet': 'The output from running the semantic rules against your data. Contains issues, field actions, and contract statuses.',
        'Truth Config': 'The versioned baseline configuration containing all semantic rules. This is the source of truth.',
        'Proposed Changes': 'A patch file containing rule additions or modifications pending review.',
        'Standardized Dataset': 'Input data that has been normalized to a consistent format for processing.',
        'Reference Expected': 'Golden file outputs used to verify deterministic behavior.',
        'Merged Dataset': 'Combined and normalized data from multiple input sources.',
        'Contract Key': 'Primary identifier linking records across the system.',
        'File URL': 'Secondary identifier based on source file location.',
        'File Name': 'Tertiary identifier based on source file name.',
        'Identity Keys': 'The three-part join identity: Contract Key, File URL, and File Name. Used to match records deterministically.'
      }
    };
    
    // ========== MASTERLINE ARTIFACT REGISTRY (D1) ==========
    const DEFAULT_ARTIFACT_PATHS = {
      truth_config: '../../config/config_pack.base.json',
      proposed_changes: '../../config/config_pack.example.patch.json',
      reference_expected: '../../examples/expected_outputs/sf_packet.example.json',
      standardized_dataset: '../../examples/standardized_dataset.example.json',
      preview_packet: '../../out/sf_packet.preview.json'
    };
    
    const ARTIFACT_LABELS = {
      truth_config: 'Truth Config',
      proposed_changes: 'Proposed Changes',
      reference_expected: 'Reference Expected',
      standardized_dataset: 'Standardized Dataset',
      preview_packet: 'Preview Packet'
    };
    
    let artifactRegistry = {
      devMasterlineEnabled: true,
      bindings: {}
    };
    
    // Helper: Get human label for internal token
    function humanLabel(token) {
      return NOMENCLATURE.labels[token] || token;
    }
    
    // Helper: Get tooltip for a label
    function getTooltip(label) {
      return NOMENCLATURE.tooltips[label] || '';
    }
    
    // Helper: Create info icon with tooltip
    function infoIcon(label) {
      var tip = getTooltip(label);
      if (!tip) return '';
      return '<span class="info-icon" title="' + escapeHtml(tip) + '">&#9432;</span>';
    }
    
    // Load artifact registry from localStorage
    function loadArtifactRegistry() {
      try {
        var saved = localStorage.getItem(ARTIFACT_REGISTRY_KEY);
        if (saved) {
          var parsed = JSON.parse(saved);
          artifactRegistry = Object.assign({}, artifactRegistry, parsed);
        }
      } catch (e) {
        console.warn('Could not load artifact registry:', e);
      }
      // Ensure default bindings exist
      Object.keys(DEFAULT_ARTIFACT_PATHS).forEach(function(key) {
        if (!artifactRegistry.bindings[key]) {
          artifactRegistry.bindings[key] = {
            path: DEFAULT_ARTIFACT_PATHS[key],
            status: 'unknown',
            lastChecked: null,
            rebound: false
          };
        }
      });
    }
    
    // Save artifact registry to localStorage
    function saveArtifactRegistry() {
      try {
        localStorage.setItem(ARTIFACT_REGISTRY_KEY, JSON.stringify(artifactRegistry));
      } catch (e) {
        console.warn('Could not save artifact registry:', e);
      }
    }
    
    // Check if an artifact exists at its path
    async function checkArtifactStatus(key) {
      var binding = artifactRegistry.bindings[key];
      if (!binding) return 'missing';
      try {
        var response = await fetch(binding.path, { method: 'HEAD' });
        binding.status = response.ok ? 'loaded' : 'missing';
      } catch (e) {
        binding.status = 'missing';
      }
      binding.lastChecked = new Date().toISOString();
      return binding.status;
    }
    
    // Check all artifacts and update registry
    async function checkAllArtifacts() {
      var keys = Object.keys(artifactRegistry.bindings);
      await Promise.all(keys.map(function(key) {
        return checkArtifactStatus(key);
      }));
      saveArtifactRegistry();
      renderArtifactRegistryTable();
      renderWorkflowMap();
    }
    
    // Masterline autoload on boot
    async function masterlineAutoload() {
      if (!artifactRegistry.devMasterlineEnabled) return;
      
      await checkAllArtifacts();
      
      // If Preview Packet exists, load it into the main data
      var previewBinding = artifactRegistry.bindings.preview_packet;
      if (previewBinding && previewBinding.status === 'loaded') {
        try {
          var response = await fetch(previewBinding.path);
          if (response.ok) {
            var data = await response.json();
            if (data.sf_summary || data.sf_contract_results) {
              allData.contractResults = data.sf_contract_results || [];
              allData.issues = data.sf_issues || [];
              allData.fieldActions = data.sf_field_actions || [];
              allData.summary = data.sf_summary || {};
              allData.changeLog = data.changelog || [];
              dataLoaded = true;
              sessionState.status = 'loaded';
              sessionState.sourceType = 'masterline';
              sessionState.loadedAt = new Date().toISOString();
              currentArtifactPath = previewBinding.path;
              updateUIForDataState();
              renderSummary();
              renderAllTables();
              updateQueueCounts();
              updateSessionChip();
            }
          }
        } catch (e) {
          console.warn('Masterline: Could not load Preview Packet:', e);
        }
      }
      
      // Load Truth Config if exists
      var truthBinding = artifactRegistry.bindings.truth_config;
      if (truthBinding && truthBinding.status === 'loaded') {
        try {
          var response = await fetch(truthBinding.path);
          if (response.ok) {
            loadedBaseConfig = await response.json();
          }
        } catch (e) {
          console.warn('Masterline: Could not load Truth Config:', e);
        }
      }
      
      // Load Proposed Changes if exists
      var patchBinding = artifactRegistry.bindings.proposed_changes;
      if (patchBinding && patchBinding.status === 'loaded') {
        try {
          var response = await fetch(patchBinding.path);
          if (response.ok) {
            loadedPatch = await response.json();
          }
        } catch (e) {
          console.warn('Masterline: Could not load Proposed Changes:', e);
        }
      }
    }
    
    // Render artifact registry table in Admin panel
    function renderArtifactRegistryTable() {
      var container = document.getElementById('artifact-registry-table');
      if (!container) return;
      
      var rows = Object.keys(ARTIFACT_LABELS).map(function(key) {
        var binding = artifactRegistry.bindings[key] || {};
        var label = ARTIFACT_LABELS[key];
        var status = binding.status || 'unknown';
        var statusClass = status === 'loaded' ? 'status-loaded' : status === 'missing' ? 'status-missing' : 'status-unknown';
        var statusText = status === 'loaded' ? 'Loaded' : status === 'missing' ? 'Missing' : 'Unknown';
        var reboundBadge = binding.rebound ? ' <span class="rebound-badge">Rebound</span>' : '';
        var path = binding.path || DEFAULT_ARTIFACT_PATHS[key];
        
        return '<tr>' +
          '<td>' + label + ' ' + infoIcon(label) + '</td>' +
          '<td><span class="artifact-status ' + statusClass + '">' + statusText + '</span>' + reboundBadge + '</td>' +
          '<td class="artifact-path" title="' + escapeHtml(path) + '">' + escapeHtml(path.split('/').pop()) + '</td>' +
          '<td><button class="rebind-btn" onclick="rebindArtifact(\'' + key + '\')">Rebind</button></td>' +
          '</tr>';
      }).join('');
      
      container.innerHTML = '<table class="artifact-table">' +
        '<thead><tr><th>Artifact</th><th>Status</th><th>File</th><th>Action</th></tr></thead>' +
        '<tbody>' + rows + '</tbody></table>';
    }
    
    // Rebind artifact path
    function rebindArtifact(key) {
      var binding = artifactRegistry.bindings[key];
      var currentPath = binding ? binding.path : DEFAULT_ARTIFACT_PATHS[key];
      var newPath = prompt('Enter new path for ' + ARTIFACT_LABELS[key] + ':', currentPath);
      if (newPath && newPath !== currentPath) {
        artifactRegistry.bindings[key] = {
          path: newPath,
          status: 'unknown',
          lastChecked: null,
          rebound: true
        };
        saveArtifactRegistry();
        checkArtifactStatus(key).then(function() {
          saveArtifactRegistry();
          renderArtifactRegistryTable();
        });
      }
    }
    
    // Toggle Dev Masterline mode
    function toggleDevMasterline() {
      artifactRegistry.devMasterlineEnabled = !artifactRegistry.devMasterlineEnabled;
      saveArtifactRegistry();
      updateDevMasterlineUI();
      if (artifactRegistry.devMasterlineEnabled) {
        masterlineAutoload();
      }
    }
    
    // Update Dev Masterline toggle UI
    function updateDevMasterlineUI() {
      var toggle = document.getElementById('dev-masterline-toggle');
      var status = document.getElementById('dev-masterline-status');
      if (toggle) {
        toggle.checked = artifactRegistry.devMasterlineEnabled;
      }
      if (status) {
        status.textContent = artifactRegistry.devMasterlineEnabled ? 'ON' : 'OFF';
        status.className = 'masterline-status ' + (artifactRegistry.devMasterlineEnabled ? 'on' : 'off');
      }
    }
    
    // ========== WORKFLOW MAP (D2) ==========
    const WORKFLOW_STAGES = [
      {
        id: 'load',
        title: 'Data Source',
        desc: 'Add or switch data source. Load Preview Packet and reference data.',
        icon: 'ðŸ“',
        artifacts: ['preview_packet', 'reference_expected'],
        action: function() { openDataSourcePanel(); }
      },
      {
        id: 'config',
        title: 'Configuration',
        desc: 'Truth Config and Proposed Changes define semantic rules.',
        icon: 'âš™',
        artifacts: ['truth_config', 'proposed_changes'],
        action: function() { openConfigFlows(); }
      },
      {
        id: 'standardize',
        title: 'Standardize',
        desc: 'Normalize input data format (CSV/XLSX to merged dataset).',
        icon: 'ðŸ“‹',
        artifacts: ['standardized_dataset'],
        action: function() { if (currentMode === 'admin') openConfigFlows(); }
      },
      {
        id: 'preview',
        title: 'Preview',
        desc: 'Generated Preview Packet with issues and field actions.',
        icon: 'ðŸ‘',
        artifacts: ['preview_packet'],
        action: function() { navigateTo('triage'); }
      },
      {
        id: 'triage',
        title: 'Triage',
        desc: 'Review contracts by queue, filter by severity/status.',
        icon: 'ðŸ“Š',
        artifacts: [],
        action: function() { navigateTo('triage'); }
      },
      {
        id: 'patch',
        title: 'Patch Draft',
        desc: 'Build rule patches from selected issues and actions.',
        icon: 'âœ',
        artifacts: [],
        action: function() { navigateTo('patch'); }
      },
      {
        id: 'evidence',
        title: 'Evidence',
        desc: 'Paste validation and smoke test results as evidence.',
        icon: 'âœ“',
        artifacts: [],
        action: function() { showEvidenceStatus(); }
      },
      {
        id: 'export',
        title: 'PR Ready',
        desc: 'Export patch bundle and PR summary for review.',
        icon: 'ðŸ“¤',
        artifacts: [],
        action: function() { navigateTo('patch'); }
      }
    ];
    
    // ========== COMMENT (RFI) SYSTEM ==========
    var COMMENTS_STORAGE_KEY = 'orchestrate.comments.v1';
    
    var COMMENT_STATUSES = ['Open', 'ReviewerResponded', 'Resolved', 'ElevatedToPatchRequest', 'Closed'];
    var COMMENT_SCOPES = ['field', 'sheet', 'contract'];
    var COMMENT_ROLES = ['Analyst', 'Reviewer', 'Admin'];
    
    var commentsStore = {
      comments: [],
      loaded: false
    };
    
    function generateCommentId() {
      return 'CMT_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 6);
    }
    
    function loadComments() {
      try {
        var stored = localStorage.getItem(COMMENTS_STORAGE_KEY);
        if (stored) {
          var parsed = JSON.parse(stored);
          commentsStore.comments = Array.isArray(parsed.comments) ? parsed.comments : [];
        } else {
          commentsStore.comments = [];
        }
        commentsStore.loaded = true;
      } catch (e) {
        console.error('Failed to load comments:', e);
        commentsStore.comments = [];
        commentsStore.loaded = true;
      }
      return commentsStore.comments;
    }
    
    function saveComments() {
      try {
        var data = {
          version: '1.0.0',
          saved_at: new Date().toISOString(),
          comments: commentsStore.comments
        };
        localStorage.setItem(COMMENTS_STORAGE_KEY, JSON.stringify(data));
        return true;
      } catch (e) {
        console.error('Failed to save comments:', e);
        return false;
      }
    }
    
    function createComment(options) {
      var now = new Date().toISOString();
      var comment = {
        comment_id: generateCommentId(),
        created_at_utc: now,
        author: options.author || 'Unknown',
        author_role: options.author_role || currentMode || 'Analyst',
        record_identity: {
          contract_key: options.contract_key || null,
          file_url: options.file_url || null,
          file_name: options.file_name || null
        },
        scope: {
          level: options.scope_level || 'contract',
          sheet: options.sheet || null,
          field: options.field || null
        },
        message: options.message || '',
        status: 'Open',
        linked_patch_request_id: null,
        history: [
          {
            at_utc: now,
            actor: options.author || 'Unknown',
            role: options.author_role || currentMode || 'Analyst',
            action: 'Created',
            notes: null
          }
        ]
      };
      commentsStore.comments.push(comment);
      saveComments();
      return comment;
    }
    
    function getComment(commentId) {
      return commentsStore.comments.find(function(c) { return c.comment_id === commentId; }) || null;
    }
    
    function updateComment(commentId, updates, actor, actorRole) {
      var comment = getComment(commentId);
      if (!comment) return null;
      
      var now = new Date().toISOString();
      var changes = [];
      
      if (updates.message !== undefined && updates.message !== comment.message) {
        comment.message = updates.message;
        changes.push('message');
      }
      if (updates.status !== undefined && updates.status !== comment.status) {
        var oldStatus = comment.status;
        comment.status = updates.status;
        changes.push('status: ' + oldStatus + ' â†’ ' + updates.status);
      }
      if (updates.linked_patch_request_id !== undefined) {
        comment.linked_patch_request_id = updates.linked_patch_request_id;
        changes.push('linked to patch request');
      }
      
      if (changes.length > 0) {
        comment.history.push({
          at_utc: now,
          actor: actor || 'Unknown',
          role: actorRole || currentMode || 'Analyst',
          action: 'Updated',
          notes: changes.join('; ')
        });
        saveComments();
      }
      return comment;
    }
    
    function addCommentResponse(commentId, responseMessage, actor, actorRole) {
      var comment = getComment(commentId);
      if (!comment) return null;
      
      var now = new Date().toISOString();
      comment.history.push({
        at_utc: now,
        actor: actor || 'Unknown',
        role: actorRole || currentMode || 'Analyst',
        action: 'Responded',
        notes: responseMessage
      });
      
      if (actorRole === 'Reviewer' || actorRole === 'Admin') {
        comment.status = 'ReviewerResponded';
      }
      
      saveComments();
      return comment;
    }
    
    function resolveComment(commentId, actor, actorRole) {
      return updateComment(commentId, { status: 'Resolved' }, actor, actorRole);
    }
    
    function closeComment(commentId, actor, actorRole) {
      return updateComment(commentId, { status: 'Closed' }, actor, actorRole);
    }
    
    function elevateCommentToPatchRequest(commentId, patchRequestId, actor, actorRole) {
      var comment = getComment(commentId);
      if (!comment) return null;
      
      comment.status = 'ElevatedToPatchRequest';
      comment.linked_patch_request_id = patchRequestId;
      comment.history.push({
        at_utc: new Date().toISOString(),
        actor: actor || 'Unknown',
        role: actorRole || 'Reviewer',
        action: 'Elevated to Patch Request',
        notes: 'Linked to ' + patchRequestId
      });
      
      saveComments();
      return comment;
    }
    
    function deleteComment(commentId) {
      var idx = commentsStore.comments.findIndex(function(c) { return c.comment_id === commentId; });
      if (idx === -1) return false;
      commentsStore.comments.splice(idx, 1);
      saveComments();
      return true;
    }
    
    function getCommentsForRecord(contractKey, fileUrl, fileName) {
      return commentsStore.comments.filter(function(c) {
        var ri = c.record_identity;
        return (ri.contract_key === contractKey || (!ri.contract_key && !contractKey)) &&
               (ri.file_url === fileUrl || (!ri.file_url && !fileUrl)) &&
               (ri.file_name === fileName || (!ri.file_name && !fileName));
      });
    }
    
    function getCommentsByStatus(status) {
      return commentsStore.comments.filter(function(c) { return c.status === status; });
    }
    
    function getCommentsByTarget(targetType, targetId) {
      return commentsStore.comments.filter(function(c) {
        return c.target_type === targetType && c.target_id === targetId;
      });
    }
    
    function getOpenComments() {
      return commentsStore.comments.filter(function(c) {
        return c.status === 'Open' || c.status === 'ReviewerResponded';
      });
    }
    
    function getCommentCounts() {
      var counts = {
        total: commentsStore.comments.length,
        open: 0,
        reviewer_responded: 0,
        resolved: 0,
        elevated: 0,
        closed: 0
      };
      commentsStore.comments.forEach(function(c) {
        if (c.status === 'Open') counts.open++;
        else if (c.status === 'ReviewerResponded') counts.reviewer_responded++;
        else if (c.status === 'Resolved') counts.resolved++;
        else if (c.status === 'ElevatedToPatchRequest') counts.elevated++;
        else if (c.status === 'Closed') counts.closed++;
      });
      return counts;
    }
    
    function exportCommentsJSON() {
      return JSON.stringify({
        exported_at: new Date().toISOString(),
        count: commentsStore.comments.length,
        comments: commentsStore.comments.map(function(c) {
          return Object.assign({}, c);
        }).sort(function(a, b) {
          return a.created_at_utc.localeCompare(b.created_at_utc);
        })
      }, null, 2);
    }
    
    // Initialize comments on load
    loadComments();
    
    // ========== PATCH REQUEST SYSTEM ==========
    var PATCH_REQUESTS_STORAGE_KEY = 'orchestrate.patch_requests.v1';
    
    var PATCH_REQUEST_STATUSES = [
      'Draft',
      'Submitted',
      'Needs_Clarification',
      'Reviewer_Responded',
      'Reviewer_Approved',
      'Admin_Approved',
      'Sent_to_Kiwi',
      'Kiwi_Returned',
      'Applied',
      'Rejected',
      'Cancelled',
      'Admin_Hold'
    ];
    
    var PATCH_REQUEST_QUEUE_TABS = [
      { id: 'new', label: 'New', statuses: ['Submitted'] },
      { id: 'needs_review', label: 'Needs Review', statuses: ['Needs_Clarification', 'Reviewer_Responded'] },
      { id: 'approved', label: 'Approved', statuses: ['Reviewer_Approved', 'Admin_Approved'] },
      { id: 'sent_to_kiwi', label: 'Sent to Kiwi', statuses: ['Sent_to_Kiwi'] },
      { id: 'kiwi_returned', label: 'Kiwi Returned', statuses: ['Kiwi_Returned'] },
      { id: 'applied', label: 'Applied', statuses: ['Applied'] },
      { id: 'rejected', label: 'Rejected', statuses: ['Rejected', 'Cancelled'] }
    ];
    
    var PATCH_REQUEST_TARGETS = ['salesforce', 'qa_rules', 'resolver_rules', 'truth_config', 'proposed_changes'];
    
    var ROLE_PERMISSIONS = {
      'Analyst': {
        can: ['create_draft', 'edit_own_draft', 'submit_to_patch_queue', 'respond_to_clarification', 'cancel_own_draft_or_submitted'],
        cannot: ['reviewer_approve', 'admin_approve', 'send_to_kiwi', 'paste_kiwi_return', 'mark_applied', 'admin_hold']
      },
      'Verifier': {
        can: ['comment_rfi', 'request_clarification', 'edit_review_fields', 'reviewer_approve', 'reject', 'send_back_to_submitted_after_edits'],
        cannot: ['send_to_kiwi', 'paste_kiwi_return', 'mark_applied', 'admin_approve', 'edit_patch_payload_directly'],
        edit_allowlist: ['intent.when', 'intent.then', 'intent.because', 'target_scope', 'risk', 'review_notes', 'evidence.checklist_status', 'clarification_questions']
      },
      'Admin': {
        can: ['everything_verifier_can', 'admin_approve', 'send_to_kiwi', 'paste_kiwi_return', 'mark_applied', 'admin_hold', 'cancel_any', 'export_commit_pack']
      }
    };
    
    var STATUS_TRANSITIONS = [
      { from: 'Draft', to: 'Submitted', roles: ['Analyst'], action: 'submit_to_patch_queue', audit: 'PATCH_REQUEST_SUBMITTED' },
      { from: 'Submitted', to: 'Needs_Clarification', roles: ['Verifier', 'Admin'], action: 'request_clarification', audit: 'CLARIFICATION_REQUESTED' },
      { from: 'Needs_Clarification', to: 'Reviewer_Responded', roles: ['Analyst'], action: 'respond_to_clarification', audit: 'CLARIFICATION_RESPONDED' },
      { from: 'Reviewer_Responded', to: 'Reviewer_Approved', roles: ['Verifier'], action: 'reviewer_approve', audit: 'REVIEWER_APPROVED' },
      { from: 'Submitted', to: 'Reviewer_Approved', roles: ['Verifier'], action: 'reviewer_approve', audit: 'REVIEWER_APPROVED' },
      { from: 'Reviewer_Approved', to: 'Admin_Approved', roles: ['Admin'], action: 'admin_approve', audit: 'ADMIN_APPROVED' },
      { from: 'Admin_Approved', to: 'Sent_to_Kiwi', roles: ['Admin'], action: 'send_to_kiwi', audit: 'SENT_TO_KIWI' },
      { from: 'Sent_to_Kiwi', to: 'Kiwi_Returned', roles: ['Admin'], action: 'paste_kiwi_return', audit: 'KIWI_RETURN_INGESTED' },
      { from: 'Kiwi_Returned', to: 'Applied', roles: ['Admin'], action: 'mark_applied', audit: 'PATCH_APPLIED' },
      { from: 'Submitted', to: 'Rejected', roles: ['Verifier', 'Admin'], action: 'reject', audit: 'PATCH_REJECTED' },
      { from: 'Reviewer_Responded', to: 'Rejected', roles: ['Verifier', 'Admin'], action: 'reject', audit: 'PATCH_REJECTED' },
      { from: 'Draft', to: 'Cancelled', roles: ['Analyst', 'Admin'], action: 'cancel', audit: 'PATCH_CANCELLED' },
      { from: 'Submitted', to: 'Cancelled', roles: ['Analyst', 'Admin'], action: 'cancel', audit: 'PATCH_CANCELLED' },
      { from: 'Reviewer_Approved', to: 'Admin_Hold', roles: ['Admin'], action: 'admin_hold', audit: 'ADMIN_HOLD_SET' },
      { from: 'Admin_Hold', to: 'Admin_Approved', roles: ['Admin'], action: 'release_hold', audit: 'ADMIN_HOLD_RELEASED' }
    ];
    
    function canTransition(fromStatus, toStatus, role) {
      var transition = STATUS_TRANSITIONS.find(function(t) {
        return t.from === fromStatus && t.to === toStatus;
      });
      if (!transition) return false;
      if (role === 'Admin' && transition.roles.includes('Verifier')) return true;
      return transition.roles.includes(role);
    }
    
    function getAuditEventForTransition(fromStatus, toStatus) {
      var transition = STATUS_TRANSITIONS.find(function(t) {
        return t.from === fromStatus && t.to === toStatus;
      });
      return transition ? transition.audit : 'STATUS_CHANGED';
    }
    
    function getAvailableTransitions(currentStatus, role) {
      return STATUS_TRANSITIONS.filter(function(t) {
        if (t.from !== currentStatus) return false;
        if (role === 'Admin') return true;
        if (role === 'Verifier' && (t.roles.includes('Verifier') || t.roles.includes('Admin'))) return false;
        return t.roles.includes(role);
      }).map(function(t) { return t.to; });
    }
    
    function canEditField(role, fieldPath) {
      if (role === 'Admin') return true;
      if (role === 'Verifier') {
        return ROLE_PERMISSIONS.Verifier.edit_allowlist.includes(fieldPath);
      }
      return false;
    }
    
    var patchRequestsStore = {
      requests: [],
      loaded: false,
      selectedIds: []
    };
    
    function generatePatchRequestId() {
      return 'PR_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 6);
    }
    
    function loadPatchRequests() {
      try {
        var stored = localStorage.getItem(PATCH_REQUESTS_STORAGE_KEY);
        if (stored) {
          var parsed = JSON.parse(stored);
          patchRequestsStore.requests = Array.isArray(parsed.requests) ? parsed.requests : [];
        } else {
          patchRequestsStore.requests = [];
        }
        patchRequestsStore.loaded = true;
      } catch (e) {
        console.error('Failed to load patch requests:', e);
        patchRequestsStore.requests = [];
        patchRequestsStore.loaded = true;
      }
      return patchRequestsStore.requests;
    }
    
    function savePatchRequests() {
      try {
        var data = {
          version: '1.0.0',
          saved_at: new Date().toISOString(),
          requests: patchRequestsStore.requests
        };
        localStorage.setItem(PATCH_REQUESTS_STORAGE_KEY, JSON.stringify(data));
        return true;
      } catch (e) {
        console.error('Failed to save patch requests:', e);
        return false;
      }
    }
    
    var CONDITION_TYPES = [
      { value: 'SHOULD_BE_BLANK_BUT_POPULATED', label: 'Should be blank but has data' },
      { value: 'SHOULD_BE_PRESENT_BUT_MISSING', label: 'Should have data but is empty' },
      { value: 'INVALID_FORMAT', label: 'Invalid format/pattern' },
      { value: 'OUT_OF_RANGE', label: 'Value out of allowed range' },
      { value: 'MISMATCH_WITH_OTHER_FIELD', label: 'Mismatches another field' },
      { value: 'DUPLICATE', label: 'Duplicate value detected' },
      { value: 'OTHER', label: 'Other (specify)' }
    ];
    
    var ACTION_TYPES = [
      { value: 'REQUIRE_PRESENT', label: 'Require field to have a value' },
      { value: 'REQUIRE_BLANK', label: 'Require field to be blank' },
      { value: 'WARN_ONLY', label: 'Warn only (non-blocking)' },
      { value: 'NORMALIZE_VALUE', label: 'Normalize/standardize value' },
      { value: 'MAP_FIELD', label: 'Map to another field' },
      { value: 'BLOCK_SUBMISSION', label: 'Block submission' },
      { value: 'OTHER', label: 'Other (specify)' }
    ];
    
    function renderIntentPreview(intentStructured) {
      var whenText = '';
      var thenText = '';
      
      if (intentStructured.target_field) {
        whenText = 'Field "' + intentStructured.target_field + '"';
        var condition = CONDITION_TYPES.find(function(c) { return c.value === intentStructured.condition_type; });
        if (condition) {
          whenText += ' ' + condition.label.toLowerCase();
        }
        if (intentStructured.condition_type === 'OTHER' && intentStructured.condition_params && intentStructured.condition_params.custom) {
          whenText += ': ' + intentStructured.condition_params.custom;
        }
      }
      
      var action = ACTION_TYPES.find(function(a) { return a.value === intentStructured.action_type; });
      if (action) {
        thenText = action.label;
      }
      if (intentStructured.action_type === 'OTHER' && intentStructured.action_params && intentStructured.action_params.custom) {
        thenText += ': ' + intentStructured.action_params.custom;
      }
      
      return {
        when: whenText || 'WHEN: (not specified)',
        then: thenText || 'THEN: (not specified)',
        because: intentStructured.because || ''
      };
    }
    
    function createPatchRequest(options) {
      var now = new Date().toISOString();
      
      var intentStructured = {
        target_field: options.target_field || (options.sheet && options.field ? options.sheet + '.' + options.field : null),
        condition_type: options.condition_type || 'OTHER',
        condition_params: options.condition_params || (options.when ? { custom: options.when } : null),
        action_type: options.action_type || 'OTHER',
        action_params: options.action_params || (options.then ? { custom: options.then } : null),
        severity: options.severity || 'warning',
        risk: options.risk || 'low',
        target_artifact: options.target || 'proposed_changes',
        because: options.because || ''
      };
      
      var intentRendered = renderIntentPreview(intentStructured);
      if (options.because) {
        intentRendered.because = options.because;
      }
      
      var request = {
        request_id: generatePatchRequestId(),
        created_at_utc: now,
        updated_at_utc: now,
        submitted_at_utc: null,
        author: options.author || 'Unknown',
        author_role: options.author_role || currentMode || 'Analyst',
        assigned_to: null,
        status: options.status || 'Draft',
        record_identity: {
          contract_key: options.contract_key || null,
          file_url: options.file_url || null,
          file_name: options.file_name || null
        },
        target_scope: {
          target: options.target || 'proposed_changes',
          sheet: options.sheet || null,
          field: options.field || null
        },
        risk: options.risk || 'low',
        intent_structured: intentStructured,
        intent_rendered: intentRendered,
        proposed_change: {
          intent: intentRendered,
          rationale: options.rationale || ''
        },
        evidence: {
          observation: options.evidence_observation || '',
          expected_behavior: options.evidence_expected || '',
          rule_justification: options.evidence_justification || '',
          repro_steps: options.evidence_repro || '',
          preflight_results: null,
          checklist_status: {}
        },
        review_notes: '',
        clarification_questions: [],
        revisions: [],
        linked_comment_id: options.linked_comment_id || null,
        kiwi_return: null,
        audit_log: [
          {
            at_utc: now,
            actor: options.author || 'Unknown',
            role: options.author_role || currentMode || 'Analyst',
            event: 'PATCH_REQUEST_CREATED',
            details: null
          }
        ],
        history: [
          {
            at_utc: now,
            actor: options.author || 'Unknown',
            role: options.author_role || currentMode || 'Analyst',
            action: 'Created',
            from_status: null,
            to_status: 'Draft',
            notes: null
          }
        ]
      };
      patchRequestsStore.requests.push(request);
      savePatchRequests();
      return request;
    }
    
    function getPatchRequest(requestId) {
      return patchRequestsStore.requests.find(function(r) { return r.request_id === requestId; }) || null;
    }
    
    function updatePatchRequestStatus(requestId, newStatus, actor, actorRole, notes) {
      var request = getPatchRequest(requestId);
      if (!request) return null;
      if (!PATCH_REQUEST_STATUSES.includes(newStatus)) return null;
      
      var role = actorRole || currentMode || 'Analyst';
      if (!canTransition(request.status, newStatus, role)) {
        console.warn('Transition not allowed:', request.status, '->', newStatus, 'for role', role);
        return null;
      }
      
      var now = new Date().toISOString();
      var oldStatus = request.status;
      var auditEvent = getAuditEventForTransition(oldStatus, newStatus);
      
      request.status = newStatus;
      request.updated_at_utc = now;
      
      if (newStatus === 'Submitted' && !request.submitted_at_utc) {
        request.submitted_at_utc = now;
      }
      
      request.history.push({
        at_utc: now,
        actor: actor || 'Unknown',
        role: role,
        action: 'Status Changed',
        from_status: oldStatus,
        to_status: newStatus,
        notes: notes || null
      });
      
      if (!request.audit_log) request.audit_log = [];
      request.audit_log.push({
        at_utc: now,
        actor: actor || 'Unknown',
        role: role,
        event: auditEvent,
        details: notes || null
      });
      
      savePatchRequests();
      return request;
    }
    
    function updatePatchRequest(requestId, updates, actor, actorRole) {
      var request = getPatchRequest(requestId);
      if (!request) return null;
      
      var now = new Date().toISOString();
      var role = actorRole || currentMode || 'Analyst';
      var changes = [];
      var oldSnapshot = null;
      
      if (request.status !== 'Draft') {
        oldSnapshot = JSON.parse(JSON.stringify({
          proposed_change: request.proposed_change,
          target_scope: request.target_scope,
          evidence: request.evidence,
          review_notes: request.review_notes
        }));
      }
      
      if (updates.proposed_change) {
        if (updates.proposed_change.intent) {
          if (role === 'Verifier') {
            ['when', 'then', 'because'].forEach(function(field) {
              if (updates.proposed_change.intent[field] !== undefined && canEditField(role, 'intent.' + field)) {
                request.proposed_change.intent[field] = updates.proposed_change.intent[field];
                changes.push('intent.' + field + ' updated');
              }
            });
          } else {
            Object.assign(request.proposed_change.intent, updates.proposed_change.intent);
            changes.push('intent updated');
          }
        }
        if (updates.proposed_change.rationale !== undefined) {
          request.proposed_change.rationale = updates.proposed_change.rationale;
          changes.push('rationale updated');
        }
      }
      if (updates.target_scope && canEditField(role, 'target_scope')) {
        Object.assign(request.target_scope, updates.target_scope);
        changes.push('target updated');
      }
      if (updates.risk !== undefined && canEditField(role, 'risk')) {
        request.risk = updates.risk;
        changes.push('risk updated');
      }
      if (updates.review_notes !== undefined && canEditField(role, 'review_notes')) {
        request.review_notes = updates.review_notes;
        changes.push('review notes updated');
      }
      if (updates.evidence) {
        if (!request.evidence) request.evidence = {};
        Object.assign(request.evidence, updates.evidence);
        changes.push('evidence updated');
      }
      if (updates.clarification_questions) {
        request.clarification_questions = updates.clarification_questions;
        changes.push('clarification questions updated');
      }
      
      if (changes.length > 0) {
        request.updated_at_utc = now;
        
        if (oldSnapshot && request.status !== 'Draft') {
          if (!request.revisions) request.revisions = [];
          request.revisions.push({
            revision_id: 'REV_' + Date.now().toString(36),
            at_utc: now,
            actor: actor || 'Unknown',
            role: role,
            diff_summary: changes.join('; '),
            previous_snapshot: oldSnapshot
          });
        }
        
        request.history.push({
          at_utc: now,
          actor: actor || 'Unknown',
          role: role,
          action: 'Updated',
          from_status: request.status,
          to_status: request.status,
          notes: changes.join('; ')
        });
        
        if (!request.audit_log) request.audit_log = [];
        request.audit_log.push({
          at_utc: now,
          actor: actor || 'Unknown',
          role: role,
          event: 'PATCH_REQUEST_UPDATED',
          details: changes.join('; ')
        });
        
        savePatchRequests();
      }
      return request;
    }
    
    function submitPatchRequest(requestId, actor, actorRole) {
      var request = getPatchRequest(requestId);
      if (!request) return null;
      if (request.status !== 'Draft') return null;
      return updatePatchRequestStatus(requestId, 'Submitted', actor, actorRole, 'Submitted to patch queue');
    }
    
    function requestClarification(requestId, questions, actor, actorRole) {
      var request = getPatchRequest(requestId);
      if (!request) return null;
      if (request.status !== 'Submitted') return null;
      
      request.clarification_questions = questions || [];
      var result = updatePatchRequestStatus(requestId, 'Needs_Clarification', actor, actorRole, 'Clarification requested');
      return result;
    }
    
    function respondToClarification(requestId, response, actor, actorRole) {
      var request = getPatchRequest(requestId);
      if (!request) return null;
      if (request.status !== 'Needs_Clarification') return null;
      
      if (!request.clarification_questions) request.clarification_questions = [];
      request.clarification_questions.push({
        type: 'response',
        from: actor || 'Analyst',
        at_utc: new Date().toISOString(),
        text: response
      });
      
      return updatePatchRequestStatus(requestId, 'Reviewer_Responded', actor, actorRole, 'Clarification provided');
    }
    
    function reviewerApprove(requestId, actor, actorRole) {
      var request = getPatchRequest(requestId);
      if (!request) return null;
      if (!['Submitted', 'Reviewer_Responded'].includes(request.status)) return null;
      return updatePatchRequestStatus(requestId, 'Reviewer_Approved', actor, actorRole, 'Approved by reviewer');
    }
    
    function adminApprove(requestId, actor, actorRole) {
      var request = getPatchRequest(requestId);
      if (!request) return null;
      if (request.status !== 'Reviewer_Approved') return null;
      return updatePatchRequestStatus(requestId, 'Admin_Approved', actor, actorRole, 'Approved by admin');
    }
    
    function setAdminHold(requestId, reason, actor, actorRole) {
      var request = getPatchRequest(requestId);
      if (!request) return null;
      if (request.status !== 'Reviewer_Approved') return null;
      return updatePatchRequestStatus(requestId, 'Admin_Hold', actor, actorRole, reason || 'Placed on admin hold');
    }
    
    function releaseAdminHold(requestId, actor, actorRole) {
      var request = getPatchRequest(requestId);
      if (!request) return null;
      if (request.status !== 'Admin_Hold') return null;
      return updatePatchRequestStatus(requestId, 'Admin_Approved', actor, actorRole, 'Released from admin hold');
    }
    
    function deletePatchRequest(requestId) {
      var idx = patchRequestsStore.requests.findIndex(function(r) { return r.request_id === requestId; });
      if (idx === -1) return false;
      patchRequestsStore.requests.splice(idx, 1);
      savePatchRequests();
      return true;
    }
    
    // Batch selection
    function selectPatchRequest(requestId) {
      if (!patchRequestsStore.selectedIds.includes(requestId)) {
        patchRequestsStore.selectedIds.push(requestId);
      }
    }
    
    function deselectPatchRequest(requestId) {
      var idx = patchRequestsStore.selectedIds.indexOf(requestId);
      if (idx !== -1) {
        patchRequestsStore.selectedIds.splice(idx, 1);
      }
    }
    
    function togglePatchRequestSelection(requestId) {
      if (patchRequestsStore.selectedIds.includes(requestId)) {
        deselectPatchRequest(requestId);
      } else {
        selectPatchRequest(requestId);
      }
    }
    
    function clearPatchRequestSelection() {
      patchRequestsStore.selectedIds = [];
    }
    
    function getSelectedPatchRequests() {
      return patchRequestsStore.selectedIds.map(function(id) {
        return getPatchRequest(id);
      }).filter(function(r) { return r !== null; });
    }
    
    function selectAllInQueue(queueId) {
      var queue = PATCH_REQUEST_QUEUE_TABS.find(function(q) { return q.id === queueId; });
      if (!queue) return;
      patchRequestsStore.requests.forEach(function(r) {
        if (queue.statuses.includes(r.status)) {
          selectPatchRequest(r.request_id);
        }
      });
    }
    
    // Queue queries
    function getPatchRequestsByQueue(queueId) {
      var queue = PATCH_REQUEST_QUEUE_TABS.find(function(q) { return q.id === queueId; });
      if (!queue) return [];
      return patchRequestsStore.requests.filter(function(r) {
        return queue.statuses.includes(r.status);
      }).sort(function(a, b) {
        return b.updated_at_utc.localeCompare(a.updated_at_utc);
      });
    }
    
    function getPatchRequestsByStatus(status) {
      return patchRequestsStore.requests.filter(function(r) { return r.status === status; });
    }
    
    function getPatchRequestCounts() {
      var counts = { total: patchRequestsStore.requests.length };
      PATCH_REQUEST_QUEUE_TABS.forEach(function(queue) {
        counts[queue.id] = 0;
      });
      patchRequestsStore.requests.forEach(function(r) {
        PATCH_REQUEST_QUEUE_TABS.forEach(function(queue) {
          if (queue.statuses.includes(r.status)) {
            counts[queue.id]++;
          }
        });
      });
      return counts;
    }
    
    // Kiwi handshake functions
    function markSentToKiwi(requestIds, actor, actorRole) {
      var updated = [];
      requestIds.forEach(function(id) {
        var result = updatePatchRequestStatus(id, 'Sent_to_Kiwi', actor, actorRole, 'Exported for Kiwi processing');
        if (result) updated.push(result);
      });
      return updated;
    }
    
    function applyKiwiReturn(requestId, kiwiPayload, actor, actorRole) {
      var request = getPatchRequest(requestId);
      if (!request) return null;
      if (request.status !== 'Sent_to_Kiwi') return null;
      
      var now = new Date().toISOString();
      request.kiwi_return = {
        returned_at_utc: now,
        patch_payload_json: kiwiPayload.patch_payload_json || kiwiPayload,
        notes: kiwiPayload.notes || null,
        derived_target: kiwiPayload.derived_target || request.target_scope.target,
        proposed_version: kiwiPayload.proposed_version || null
      };
      request.status = 'Kiwi_Returned';
      request.updated_at_utc = now;
      request.history.push({
        at_utc: now,
        actor: actor || 'Admin',
        role: actorRole || 'Admin',
        action: 'Kiwi Return Applied',
        from_status: 'Sent_to_Kiwi',
        to_status: 'Kiwi_Returned',
        notes: 'Kiwi payload received'
      });
      
      if (!request.audit_log) request.audit_log = [];
      request.audit_log.push({
        at_utc: now,
        actor: actor || 'Admin',
        role: actorRole || 'Admin',
        event: 'KIWI_RETURN_INGESTED',
        details: 'Kiwi payload received'
      });
      
      savePatchRequests();
      return request;
    }
    
    function markApplied(requestIds, actor, actorRole) {
      var updated = [];
      requestIds.forEach(function(id) {
        var result = updatePatchRequestStatus(id, 'Applied', actor, actorRole, 'Patch applied to target artifact');
        if (result) updated.push(result);
      });
      return updated;
    }
    
    function markRejected(requestId, reason, actor, actorRole) {
      return updatePatchRequestStatus(requestId, 'Rejected', actor, actorRole, reason);
    }
    
    // Export functions
    function exportPatchRequestsForKiwi(requestIds) {
      var requests = requestIds.map(function(id) { return getPatchRequest(id); }).filter(function(r) { return r !== null; });
      return JSON.stringify({
        batch_id: 'BATCH_' + Date.now().toString(36),
        exported_at_utc: new Date().toISOString(),
        count: requests.length,
        requests: requests.map(function(r) {
          return {
            request_id: r.request_id,
            record_identity: r.record_identity,
            target_scope: r.target_scope,
            proposed_change: r.proposed_change,
            author: r.author,
            created_at_utc: r.created_at_utc
          };
        })
      }, null, 2);
    }
    
    function exportBatchCommitPack(requestIds) {
      var requests = requestIds.map(function(id) { return getPatchRequest(id); }).filter(function(r) { return r !== null && r.kiwi_return; });
      return JSON.stringify({
        batch_id: 'COMMIT_' + Date.now().toString(36),
        created_at_utc: new Date().toISOString(),
        count: requests.length,
        items: requests.map(function(r) {
          return {
            request_id: r.request_id,
            target: r.target_scope.target,
            patch_payload_json: r.kiwi_return.patch_payload_json,
            suggested_files: getSuggestedFilesForTarget(r.target_scope.target),
            changelog_entry: generateChangelogEntry(r),
            pr_summary_markdown: generatePRSummary(r)
          };
        })
      }, null, 2);
    }
    
    function getSuggestedFilesForTarget(target) {
      var fileMap = {
        'salesforce': ['config/sf_rules.json'],
        'qa_rules': ['config/qa_rules.json'],
        'resolver_rules': ['config/resolver_rules.json'],
        'truth_config': ['config/config_pack.base.json'],
        'proposed_changes': ['config/config_pack.patch.json']
      };
      return fileMap[target] || ['config/config_pack.patch.json'];
    }
    
    function generateChangelogEntry(request) {
      var intent = request.proposed_change.intent;
      return '- ' + (intent.then || 'Update') + ' when ' + (intent.when || 'condition met') + ' (' + request.request_id + ')';
    }
    
    function generatePRSummary(request) {
      var intent = request.proposed_change.intent;
      return '## Patch Request: ' + request.request_id + '\n\n' +
        '**When:** ' + (intent.when || 'N/A') + '\n' +
        '**Then:** ' + (intent.then || 'N/A') + '\n' +
        '**Because:** ' + (intent.because || 'N/A') + '\n\n' +
        '**Rationale:** ' + (request.proposed_change.rationale || 'N/A') + '\n';
    }
    
    // Initialize patch requests on load
    loadPatchRequests();
    
    // ========== PATCH CONSOLE UI ==========
    var currentPatchQueue = 'new';
    
    function switchPatchQueueTab(queueId) {
      currentPatchQueue = queueId;
      document.querySelectorAll('.queue-tab').forEach(function(tab) {
        tab.classList.toggle('active', tab.dataset.queue === queueId);
      });
      renderPatchConsoleTable();
    }
    
    function updatePatchQueueCounts() {
      var counts = getPatchRequestCounts();
      document.querySelectorAll('.queue-tab').forEach(function(tab) {
        var queueId = tab.dataset.queue;
        var countSpan = tab.querySelector('.queue-count');
        if (countSpan && counts[queueId] !== undefined) {
          countSpan.textContent = counts[queueId];
        }
      });
      var totalEl = document.getElementById('patch-total-count');
      if (totalEl) totalEl.textContent = counts.total;
      
      var selectedEl = document.getElementById('patch-selected-count');
      if (selectedEl) selectedEl.textContent = patchRequestsStore.selectedIds.length;
      
      var commentsEl = document.getElementById('comments-open-count');
      if (commentsEl) {
        var commentCounts = getCommentCounts();
        commentsEl.textContent = commentCounts.open + commentCounts.reviewer_responded;
      }
    }
    
    function renderPatchConsoleTable() {
      var tbody = document.getElementById('patch-console-tbody');
      if (!tbody) return;
      
      var requests = getPatchRequestsByQueue(currentPatchQueue);
      updatePatchQueueCounts();
      
      if (requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #888;">No patch requests in this queue</td></tr>';
        return;
      }
      
      tbody.innerHTML = requests.map(function(r) {
        var isSelected = patchRequestsStore.selectedIds.includes(r.request_id);
        var intent = r.proposed_change.intent;
        var intentSummary = (intent.then || 'No intent').substring(0, 40) + ((intent.then || '').length > 40 ? '...' : '');
        var statusClass = getStatusClass(r.status);
        var updatedDate = new Date(r.updated_at_utc).toLocaleDateString();
        
        return '<tr>' +
          '<td><input type="checkbox" ' + (isSelected ? 'checked' : '') + ' onchange="togglePatchRequestSelection(\'' + r.request_id + '\'); renderPatchConsoleTable();"></td>' +
          '<td style="font-family: monospace; font-size: 0.85em;">' + escapeHtml(r.request_id.substring(0, 12)) + '</td>' +
          '<td>' + escapeHtml(intentSummary) + '</td>' +
          '<td>' + escapeHtml(humanLabel(r.target_scope.target) || 'N/A') + '</td>' +
          '<td><span class="patch-status-chip ' + statusClass + '">' + escapeHtml(r.status) + '</span></td>' +
          '<td style="font-size: 0.85em;">' + updatedDate + '</td>' +
          '<td style="text-align: center;"><button class="toolbar-btn" style="padding: 4px 8px; font-size: 0.8em;" onclick="viewPatchRequestDetail(\'' + r.request_id + '\')">View</button></td>' +
          '</tr>';
      }).join('');
    }
    
    function getStatusClass(status) {
      var classMap = {
        'Draft': 'draft',
        'Submitted': 'submitted',
        'Needs_Clarification': 'submitted',
        'Reviewer_Responded': 'submitted',
        'Reviewer_Approved': 'approved',
        'Admin_Hold': 'submitted',
        'Admin_Approved': 'approved',
        'Sent_to_Kiwi': 'sent',
        'Kiwi_Returned': 'returned',
        'Applied': 'applied',
        'Rejected': 'rejected',
        'Cancelled': 'rejected'
      };
      return classMap[status] || 'draft';
    }
    
    function toggleSelectAllPatches(checked) {
      var requests = getPatchRequestsByQueue(currentPatchQueue);
      if (checked) {
        requests.forEach(function(r) { selectPatchRequest(r.request_id); });
      } else {
        requests.forEach(function(r) { deselectPatchRequest(r.request_id); });
      }
      renderPatchConsoleTable();
    }
    
    function selectAllCurrentQueue() {
      selectAllInQueue(currentPatchQueue);
      renderPatchConsoleTable();
    }
    
    function batchMarkSentToKiwi() {
      var selected = getSelectedPatchRequests();
      if (selected.length === 0) {
        showToast('No requests selected', 'warning');
        return;
      }
      
      var approvedOnly = selected.filter(function(r) {
        return r.status === 'Reviewer_Approved' || r.status === 'Admin_Approved';
      });
      
      if (approvedOnly.length === 0) {
        showToast('Selected requests must be Approved to send to Kiwi', 'warning');
        return;
      }
      
      var exportJson = exportPatchRequestsForKiwi(approvedOnly.map(function(r) { return r.request_id; }));
      navigator.clipboard.writeText(exportJson).then(function() {
        markSentToKiwi(approvedOnly.map(function(r) { return r.request_id; }), 'Admin', 'Admin');
        clearPatchRequestSelection();
        renderPatchConsoleTable();
        showToast('Exported ' + approvedOnly.length + ' requests to clipboard and marked as Sent to Kiwi', 'success');
      });
    }
    
    function openKiwiReturnInbox() {
      document.getElementById('kiwi-return-inbox-modal').style.display = 'flex';
      document.getElementById('kiwi-return-textarea').value = '';
      document.getElementById('kiwi-return-status').style.display = 'none';
    }
    
    function closeKiwiReturnInbox() {
      document.getElementById('kiwi-return-inbox-modal').style.display = 'none';
    }
    
    function processKiwiReturn() {
      var textarea = document.getElementById('kiwi-return-textarea');
      var statusEl = document.getElementById('kiwi-return-status');
      var text = textarea.value.trim();
      
      if (!text) {
        statusEl.textContent = 'Please paste Kiwi return JSON';
        statusEl.style.display = 'block';
        statusEl.style.background = '#ffebee';
        statusEl.style.color = '#c62828';
        return;
      }
      
      try {
        var data = JSON.parse(text);
        var items = data.items || data.requests || (Array.isArray(data) ? data : [data]);
        var matched = 0;
        var notFound = 0;
        
        items.forEach(function(item) {
          var requestId = item.request_id;
          if (requestId) {
            var result = applyKiwiReturn(requestId, item, 'Admin', 'Admin');
            if (result) matched++;
            else notFound++;
          }
        });
        
        statusEl.textContent = 'Processed: ' + matched + ' matched, ' + notFound + ' not found';
        statusEl.style.display = 'block';
        statusEl.style.background = matched > 0 ? '#e8f5e9' : '#fff3e0';
        statusEl.style.color = matched > 0 ? '#2e7d32' : '#e65100';
        
        if (matched > 0) {
          renderPatchConsoleTable();
          setTimeout(function() { closeKiwiReturnInbox(); }, 1500);
        }
      } catch (e) {
        statusEl.textContent = 'Invalid JSON: ' + e.message;
        statusEl.style.display = 'block';
        statusEl.style.background = '#ffebee';
        statusEl.style.color = '#c62828';
      }
    }
    
    function batchMarkApplied() {
      var selected = getSelectedPatchRequests();
      if (selected.length === 0) {
        showToast('No requests selected', 'warning');
        return;
      }
      
      var returnedOnly = selected.filter(function(r) { return r.status === 'Kiwi_Returned'; });
      if (returnedOnly.length === 0) {
        showToast('Selected requests must be in Kiwi Returned status', 'warning');
        return;
      }
      
      markApplied(returnedOnly.map(function(r) { return r.request_id; }), 'Admin', 'Admin');
      clearPatchRequestSelection();
      renderPatchConsoleTable();
      showToast('Marked ' + returnedOnly.length + ' requests as Applied', 'success');
    }
    
    function batchCopyCommitPack() {
      var selected = getSelectedPatchRequests();
      if (selected.length === 0) {
        showToast('No requests selected', 'warning');
        return;
      }
      
      var returnedOnly = selected.filter(function(r) { return r.status === 'Kiwi_Returned' && r.kiwi_return; });
      if (returnedOnly.length === 0) {
        showToast('Selected requests must have Kiwi returns', 'warning');
        return;
      }
      
      var commitPack = exportBatchCommitPack(returnedOnly.map(function(r) { return r.request_id; }));
      navigator.clipboard.writeText(commitPack).then(function() {
        showToast('Copied commit pack for ' + returnedOnly.length + ' requests', 'success');
      });
    }
    
    var currentPatchDetailId = null;
    
    function viewPatchRequestDetail(requestId) {
      var request = getPatchRequest(requestId);
      if (!request) return;
      
      currentPatchDetailId = requestId;
      var intent = request.proposed_change.intent;
      var statusClass = getStatusClass(request.status);
      
      var html = '';
      
      // Status and ID header
      html += '<div style="margin-bottom: 20px;">' +
        '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">' +
        '<span class="patch-status-chip ' + statusClass + '" style="font-size: 0.85em;">' + escapeHtml(request.status) + '</span>' +
        '<span style="font-family: monospace; font-size: 0.8em; color: #666;">' + escapeHtml(request.request_id) + '</span>' +
        '</div>' +
        '<div style="font-size: 0.85em; color: #666;">Created: ' + new Date(request.created_at_utc).toLocaleString() + '</div>' +
        '</div>';
      
      // Plain-English Intent section
      html += '<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">' +
        '<h4 style="margin: 0 0 12px 0; font-size: 0.9em; text-transform: uppercase; color: #333;">Plain-English Intent</h4>' +
        '<div style="margin-bottom: 10px;">' +
        '<span style="color: #1976d2; font-weight: 600;">WHEN:</span> ' + escapeHtml(intent.when || 'N/A') +
        '</div>' +
        '<div style="margin-bottom: 10px;">' +
        '<span style="color: #388e3c; font-weight: 600;">THEN:</span> ' + escapeHtml(intent.then || 'N/A') +
        '</div>' +
        '<div>' +
        '<span style="color: #e65100; font-weight: 600;">BECAUSE:</span> ' + escapeHtml(intent.because || 'N/A') +
        '</div>' +
        '</div>';
      
      // Target Artifact section
      html += '<div style="margin-bottom: 20px;">' +
        '<h4 style="margin: 0 0 10px 0; font-size: 0.9em; text-transform: uppercase; color: #333;">Target Artifact</h4>' +
        '<table style="width: 100%; font-size: 0.9em;">' +
        '<tr><td style="padding: 4px 0; color: #666; width: 100px;">Type</td><td>' + escapeHtml(humanLabel(request.target_scope.target) || 'N/A') + '</td></tr>' +
        '<tr><td style="padding: 4px 0; color: #666;">Target ID</td><td style="font-family: monospace;">' + escapeHtml(request.target_scope.target_id || 'N/A') + '</td></tr>' +
        '</table>' +
        '</div>';
      
      // Rationale
      if (request.proposed_change.rationale) {
        html += '<div style="margin-bottom: 20px;">' +
          '<h4 style="margin: 0 0 10px 0; font-size: 0.9em; text-transform: uppercase; color: #333;">Rationale</h4>' +
          '<p style="margin: 0; font-size: 0.9em; color: #555;">' + escapeHtml(request.proposed_change.rationale) + '</p>' +
          '</div>';
      }
      
      // Kiwi Payload section (if sent or returned)
      if (request.status === 'Sent_to_Kiwi' || request.status === 'Kiwi_Returned' || request.status === 'Applied') {
        html += '<div style="margin-bottom: 20px; border-top: 1px solid #e0e0e0; padding-top: 15px;">' +
          '<h4 style="margin: 0 0 10px 0; font-size: 0.9em; text-transform: uppercase; color: #7b1fa2;">Kiwi Integration</h4>';
        
        if (request.kiwi_sent_at_utc) {
          html += '<div style="font-size: 0.85em; margin-bottom: 8px;"><strong>Sent to Kiwi:</strong> ' + new Date(request.kiwi_sent_at_utc).toLocaleString() + '</div>';
        }
        
        if (request.kiwi_return) {
          html += '<div style="font-size: 0.85em; margin-bottom: 8px;"><strong>Returned:</strong> ' + new Date(request.kiwi_returned_at_utc).toLocaleString() + '</div>' +
            '<div style="margin-top: 10px;">' +
            '<details style="background: #f9f9f9; padding: 10px; border-radius: 6px;">' +
            '<summary style="cursor: pointer; font-weight: 500; font-size: 0.9em;">View Kiwi Return Payload</summary>' +
            '<pre style="margin: 10px 0 0 0; font-size: 0.8em; overflow-x: auto; white-space: pre-wrap;">' + escapeHtml(JSON.stringify(request.kiwi_return, null, 2)) + '</pre>' +
            '</details>' +
            '</div>';
        }
        
        html += '</div>';
      }
      
      // Apply Checklist (for Kiwi_Returned status)
      if (request.status === 'Kiwi_Returned') {
        html += '<div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">' +
          '<h4 style="margin: 0 0 12px 0; font-size: 0.9em; text-transform: uppercase; color: #2e7d32;">Apply Checklist</h4>' +
          '<label style="display: flex; align-items: center; gap: 8px; font-size: 0.9em; margin-bottom: 8px;">' +
          '<input type="checkbox" id="apply-check-1"> Kiwi return payload validated' +
          '</label>' +
          '<label style="display: flex; align-items: center; gap: 8px; font-size: 0.9em; margin-bottom: 8px;">' +
          '<input type="checkbox" id="apply-check-2"> Changes copied to config pack' +
          '</label>' +
          '<label style="display: flex; align-items: center; gap: 8px; font-size: 0.9em;">' +
          '<input type="checkbox" id="apply-check-3"> Smoke test passed' +
          '</label>' +
          '</div>';
      }
      
      // Clarification questions section (if any)
      if (request.clarification_questions && request.clarification_questions.length > 0) {
        html += '<div style="margin-bottom: 20px; border-top: 1px solid #e0e0e0; padding-top: 15px;">' +
          '<h4 style="margin: 0 0 10px 0; font-size: 0.9em; text-transform: uppercase; color: #e65100;">Clarification Thread</h4>';
        request.clarification_questions.forEach(function(q) {
          if (typeof q === 'string') {
            html += '<div style="background: #fff3e0; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em;">' + escapeHtml(q) + '</div>';
          } else if (q.type === 'response') {
            html += '<div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em;">' +
              '<strong>' + escapeHtml(q.from || 'Analyst') + ':</strong> ' + escapeHtml(q.text) + '</div>';
          } else {
            html += '<div style="background: #fff3e0; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em;">' + escapeHtml(q.text || q) + '</div>';
          }
        });
        html += '</div>';
      }
      
      // Review notes section (editable for Verifier/Admin)
      if ((currentMode === 'Verifier' || currentMode === 'Admin') && 
          ['Submitted', 'Needs_Clarification', 'Reviewer_Responded'].includes(request.status)) {
        html += '<div style="margin-bottom: 20px; border-top: 1px solid #e0e0e0; padding-top: 15px;">' +
          '<h4 style="margin: 0 0 10px 0; font-size: 0.9em; text-transform: uppercase; color: #1565c0;">Review Notes (Verifier)</h4>' +
          '<textarea id="pr-review-notes" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; resize: vertical; min-height: 60px;" placeholder="Add review notes...">' + escapeHtml(request.review_notes || '') + '</textarea>' +
          '</div>';
      }
      
      // Revisions section
      if (request.revisions && request.revisions.length > 0) {
        html += '<div style="margin-bottom: 20px; border-top: 1px solid #e0e0e0; padding-top: 15px;">' +
          '<details>' +
          '<summary style="cursor: pointer; font-weight: 600; font-size: 0.9em; color: #333;">Revisions (' + request.revisions.length + ')</summary>' +
          '<div style="margin-top: 10px; font-size: 0.85em;">';
        request.revisions.forEach(function(rev) {
          html += '<div style="background: #f9f9f9; padding: 8px; border-radius: 4px; margin-bottom: 6px;">' +
            '<div style="color: #666;">' + new Date(rev.at_utc).toLocaleString() + ' by ' + escapeHtml(rev.actor) + ' (' + escapeHtml(rev.role) + ')</div>' +
            '<div style="color: #333;">' + escapeHtml(rev.diff_summary) + '</div>' +
            '</div>';
        });
        html += '</div></details></div>';
      }
      
      document.getElementById('patch-detail-title').textContent = 'Patch Request';
      document.getElementById('patch-detail-content').innerHTML = html;
      
      // Footer actions based on status and role
      var role = currentMode || 'Analyst';
      var footerHtml = '<div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">';
      
      // Analyst actions
      if (role === 'Analyst') {
        if (request.status === 'Draft') {
          footerHtml += '<button class="toolbar-btn" onclick="submitPatchForReview(\'' + requestId + '\')" style="background: #1976d2;" title="Submit this patch request for review">Submit for Review</button>';
        } else if (request.status === 'Needs_Clarification') {
          footerHtml += '<button class="toolbar-btn" onclick="openClarificationResponseModal(\'' + requestId + '\')" style="background: #e65100;" title="Respond to clarification request">Respond to Clarification</button>';
        }
        if (['Draft', 'Submitted'].includes(request.status)) {
          footerHtml += '<button class="toolbar-btn" onclick="cancelPatchRequest(\'' + requestId + '\')" style="background: #c62828;" title="Cancel this patch request">Cancel</button>';
        }
      }
      
      // Verifier actions
      if (role === 'Verifier' || role === 'Admin') {
        if (request.status === 'Submitted') {
          footerHtml += '<button class="toolbar-btn" onclick="openClarificationModal(\'' + requestId + '\')" style="background: #e65100;" title="Request more information from the analyst">Request Clarification</button>';
          footerHtml += '<button class="toolbar-btn" onclick="approveAsReviewer(\'' + requestId + '\')" style="background: #388e3c;" title="Approve this patch request">Approve</button>';
          footerHtml += '<button class="toolbar-btn" onclick="rejectPatchRequest(\'' + requestId + '\')" style="background: #c62828;" title="Reject this patch request">Reject</button>';
        } else if (request.status === 'Reviewer_Responded') {
          footerHtml += '<button class="toolbar-btn" onclick="approveAsReviewer(\'' + requestId + '\')" style="background: #388e3c;" title="Approve this patch request">Approve</button>';
          footerHtml += '<button class="toolbar-btn" onclick="rejectPatchRequest(\'' + requestId + '\')" style="background: #c62828;" title="Reject this patch request">Reject</button>';
        }
      }
      
      // Admin-only actions
      if (role === 'Admin') {
        if (request.status === 'Reviewer_Approved') {
          footerHtml += '<button class="toolbar-btn" onclick="adminApprovePatch(\'' + requestId + '\')" style="background: #1565c0;" title="Give admin approval">Admin Approve</button>';
          footerHtml += '<button class="toolbar-btn" onclick="setAdminHoldPatch(\'' + requestId + '\')" style="background: #f57c00;" title="Put on hold for review">Admin Hold</button>';
        } else if (request.status === 'Admin_Hold') {
          footerHtml += '<button class="toolbar-btn" onclick="releaseAdminHoldPatch(\'' + requestId + '\')" style="background: #1565c0;" title="Release from admin hold">Release Hold</button>';
        } else if (request.status === 'Admin_Approved') {
          footerHtml += '<button class="toolbar-btn" onclick="exportToKiwi(\'' + requestId + '\')" style="background: #7b1fa2;" title="Export to Kiwi and mark as sent">Export to Kiwi</button>';
        } else if (request.status === 'Sent_to_Kiwi') {
          footerHtml += '<button class="toolbar-btn" onclick="openPasteKiwiReturnModal(\'' + requestId + '\')" style="background: #7b1fa2;" title="Paste Kiwi return payload">Paste Kiwi Return</button>';
        } else if (request.status === 'Kiwi_Returned') {
          footerHtml += '<button class="toolbar-btn" onclick="copyCommitPack(\'' + requestId + '\')" title="Copy commit pack to clipboard">Copy Commit Pack</button>';
          footerHtml += '<button class="toolbar-btn" onclick="markSingleApplied(\'' + requestId + '\')" style="background: #388e3c;" title="Mark as applied">Mark Applied</button>';
        }
      }
      
      footerHtml += '<button class="toolbar-btn" onclick="closePatchDetailDrawer()">Close</button>';
      footerHtml += '</div>';
      document.getElementById('patch-detail-footer').innerHTML = footerHtml;
      
      document.getElementById('patch-detail-drawer').classList.add('active');
    }
    
    function closePatchDetailDrawer() {
      document.getElementById('patch-detail-drawer').classList.remove('active');
      currentPatchDetailId = null;
    }
    
    function submitPatchForReview(requestId) {
      var author = currentMode.charAt(0).toUpperCase() + currentMode.slice(1);
      submitForReview(requestId, author, author);
      closePatchDetailDrawer();
      renderPatchConsoleTable();
      showToast('Patch request submitted for review', 'success');
    }
    
    function copyPatchForKiwi(requestId) {
      var exportJson = exportPatchRequestsForKiwi([requestId]);
      navigator.clipboard.writeText(exportJson).then(function() {
        showToast('Copied patch request to clipboard for Kiwi', 'success');
      });
    }
    
    function copyCommitPack(requestId) {
      var commitPack = exportBatchCommitPack([requestId]);
      navigator.clipboard.writeText(commitPack).then(function() {
        showToast('Commit pack copied to clipboard', 'success');
      });
    }
    
    function markSingleApplied(requestId) {
      var author = currentMode || 'Admin';
      markApplied([requestId], author, author);
      closePatchDetailDrawer();
      renderPatchConsoleTable();
      showToast('Marked as Applied', 'success');
    }
    
    function cancelPatchRequest(requestId) {
      var author = currentMode || 'Analyst';
      var result = updatePatchRequestStatus(requestId, 'Cancelled', author, author, 'Cancelled by ' + author);
      if (result) {
        closePatchDetailDrawer();
        renderPatchConsoleTable();
        showToast('Patch request cancelled', 'success');
      } else {
        showToast('Failed to cancel patch request', 'error');
      }
    }
    
    function approveAsReviewer(requestId) {
      var author = currentMode || 'Verifier';
      var reviewNotes = document.getElementById('pr-review-notes')?.value || '';
      
      var request = getPatchRequest(requestId);
      if (reviewNotes && request) {
        updatePatchRequest(requestId, { review_notes: reviewNotes }, author, author);
      }
      
      var result = reviewerApprove(requestId, author, author);
      if (result) {
        closePatchDetailDrawer();
        renderPatchConsoleTable();
        showToast('Patch request approved by reviewer', 'success');
      } else {
        showToast('Failed to approve patch request', 'error');
      }
    }
    
    function rejectPatchRequest(requestId) {
      var reason = prompt('Enter rejection reason:');
      if (!reason) return;
      
      var author = currentMode || 'Verifier';
      var result = markRejected(requestId, reason, author, author);
      if (result) {
        closePatchDetailDrawer();
        renderPatchConsoleTable();
        showToast('Patch request rejected', 'success');
      } else {
        showToast('Failed to reject patch request', 'error');
      }
    }
    
    function openClarificationModal(requestId) {
      var questions = prompt('Enter clarification questions:');
      if (!questions) return;
      
      var author = currentMode || 'Verifier';
      var result = requestClarification(requestId, [questions], author, author);
      if (result) {
        closePatchDetailDrawer();
        renderPatchConsoleTable();
        showToast('Clarification requested', 'success');
      } else {
        showToast('Failed to request clarification', 'error');
      }
    }
    
    function openClarificationResponseModal(requestId) {
      var response = prompt('Enter your response to the clarification request:');
      if (!response) return;
      
      var author = currentMode || 'Analyst';
      var result = respondToClarification(requestId, response, author, author);
      if (result) {
        closePatchDetailDrawer();
        renderPatchConsoleTable();
        showToast('Clarification response submitted', 'success');
      } else {
        showToast('Failed to submit response', 'error');
      }
    }
    
    function adminApprovePatch(requestId) {
      var author = currentMode || 'Admin';
      var result = adminApprove(requestId, author, author);
      if (result) {
        closePatchDetailDrawer();
        renderPatchConsoleTable();
        showToast('Admin approval granted', 'success');
      } else {
        showToast('Failed to grant admin approval', 'error');
      }
    }
    
    function setAdminHoldPatch(requestId) {
      var reason = prompt('Enter reason for admin hold:') || 'Placed on hold for further review';
      var author = currentMode || 'Admin';
      var result = setAdminHold(requestId, reason, author, author);
      if (result) {
        closePatchDetailDrawer();
        renderPatchConsoleTable();
        showToast('Placed on admin hold', 'success');
      } else {
        showToast('Failed to set admin hold', 'error');
      }
    }
    
    function releaseAdminHoldPatch(requestId) {
      var author = currentMode || 'Admin';
      var result = releaseAdminHold(requestId, author, author);
      if (result) {
        closePatchDetailDrawer();
        renderPatchConsoleTable();
        showToast('Released from admin hold', 'success');
      } else {
        showToast('Failed to release admin hold', 'error');
      }
    }
    
    function exportToKiwi(requestId) {
      var author = currentMode || 'Admin';
      var exportJson = exportPatchRequestsForKiwi([requestId]);
      navigator.clipboard.writeText(exportJson).then(function() {
        markSentToKiwi([requestId], author, author);
        closePatchDetailDrawer();
        renderPatchConsoleTable();
        showToast('Exported to Kiwi and copied to clipboard', 'success');
      });
    }
    
    function openPasteKiwiReturnModal(requestId) {
      var payloadStr = prompt('Paste Kiwi return JSON payload:');
      if (!payloadStr) return;
      
      try {
        var payload = JSON.parse(payloadStr);
        var author = currentMode || 'Admin';
        var result = applyKiwiReturn(requestId, payload, author, author);
        if (result) {
          closePatchDetailDrawer();
          renderPatchConsoleTable();
          showToast('Kiwi return applied', 'success');
        } else {
          showToast('Failed to apply Kiwi return', 'error');
        }
      } catch (e) {
        showToast('Invalid JSON payload', 'error');
      }
    }
    
    // Initialize patch console when admin view loads
    function initPatchConsole() {
      renderPatchConsoleTable();
      updatePatchQueueCounts();
    }
    
    // ========== COMMENT UI FUNCTIONS ==========
    function openAddCommentModal(targetType, targetId) {
      document.getElementById('comment-target-type').value = targetType;
      document.getElementById('comment-target-id').value = targetId;
      document.getElementById('comment-target-display').textContent = targetType + ': ' + targetId;
      document.getElementById('comment-content-input').value = '';
      document.getElementById('add-comment-modal').style.display = 'flex';
    }
    
    function closeAddCommentModal() {
      document.getElementById('add-comment-modal').style.display = 'none';
    }
    
    function submitNewComment() {
      var targetType = document.getElementById('comment-target-type').value;
      var targetId = document.getElementById('comment-target-id').value;
      var content = document.getElementById('comment-content-input').value.trim();
      
      if (!content) {
        showToast('Please enter a comment', 'warning');
        return;
      }
      
      var author = currentMode.charAt(0).toUpperCase() + currentMode.slice(1);
      createComment(targetType, targetId, content, author, author);
      closeAddCommentModal();
      showToast('Comment added', 'success');
      
      // Refresh the drawer if it's a record comment
      if (targetType === 'record') {
        renderRecordDrawer();
      }
      updatePatchQueueCounts();
    }
    
    function resolveCommentById(commentId) {
      var author = currentMode.charAt(0).toUpperCase() + currentMode.slice(1);
      resolveComment(commentId, author, author);
      renderRecordDrawer();
      updatePatchQueueCounts();
      showToast('Comment resolved', 'success');
    }
    
    function elevateCommentToPatchRequest(commentId) {
      var comment = getComment(commentId);
      if (!comment) return;
      
      document.getElementById('elevate-comment-id').value = commentId;
      document.getElementById('elevate-comment-preview').innerHTML = 
        '<strong>Original Comment:</strong> ' + escapeHtml(comment.content) + 
        '<br><span style="font-size: 0.85em; color: #666;">Target: ' + comment.target_type + ' / ' + escapeHtml(comment.target_id) + '</span>';
      document.getElementById('elevate-intent-when').value = '';
      document.getElementById('elevate-intent-then').value = '';
      document.getElementById('elevate-intent-because').value = '';
      document.getElementById('elevate-to-patch-modal').style.display = 'flex';
    }
    
    function closeElevateToPatchModal() {
      document.getElementById('elevate-to-patch-modal').style.display = 'none';
    }
    
    function submitElevateToPatch() {
      var commentId = document.getElementById('elevate-comment-id').value;
      var comment = getComment(commentId);
      if (!comment) return;
      
      var intentWhen = document.getElementById('elevate-intent-when').value.trim();
      var intentThen = document.getElementById('elevate-intent-then').value.trim();
      var intentBecause = document.getElementById('elevate-intent-because').value.trim();
      
      if (!intentThen) {
        showToast('Please fill in the THEN (action) field', 'warning');
        return;
      }
      
      var author = currentMode.charAt(0).toUpperCase() + currentMode.slice(1);
      
      var patchRequest = createPatchRequest({
        target: comment.target_type,
        contract_key: comment.record_identity.contract_key,
        file_url: comment.record_identity.file_url,
        file_name: comment.record_identity.file_name,
        when: intentWhen || 'N/A',
        then: intentThen,
        because: intentBecause || comment.content,
        rationale: 'Elevated from comment: ' + comment.content,
        author: author,
        author_role: author,
        linked_comment_id: commentId
      });
      elevateToRequest(commentId, patchRequest.request_id, author, author);
      
      closeElevateToPatchModal();
      renderRecordDrawer();
      renderPatchConsoleTable();
      showToast('Created Patch Request from comment', 'success');
    }
    
    // ========== STANDARDIZER (D3) ==========
    let standardizerResult = {
      mergedDataset: null,
      issues: [],
      changeLog: [],
      currentTab: 'summary'
    };
    
    // Infer CSV delimiter
    function inferDelimiter(csvText) {
      var firstLine = csvText.split('\n')[0] || '';
      var counts = { ',': 0, '\t': 0, ';': 0, '|': 0 };
      for (var i = 0; i < firstLine.length; i++) {
        if (counts.hasOwnProperty(firstLine[i])) counts[firstLine[i]]++;
      }
      var best = ',';
      var max = 0;
      Object.keys(counts).forEach(function(d) {
        if (counts[d] > max) { max = counts[d]; best = d; }
      });
      return best;
    }
    
    // Parse CSV to array of objects
    function parseCSV(csvText, delimiter) {
      delimiter = delimiter || inferDelimiter(csvText);
      var lines = csvText.trim().split('\n');
      if (lines.length < 2) return { headers: [], rows: [], delimiter: delimiter };
      
      var headers = lines[0].split(delimiter).map(function(h) { return h.trim().replace(/^"|"$/g, ''); });
      var rows = [];
      for (var i = 1; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;
        var values = line.split(delimiter).map(function(v) { return v.trim().replace(/^"|"$/g, ''); });
        var row = {};
        headers.forEach(function(h, idx) {
          row[h] = values[idx] !== undefined ? values[idx] : null;
        });
        rows.push(row);
      }
      return { headers: headers, rows: rows, delimiter: delimiter };
    }
    
    // Normalize header name
    function normalizeHeader(header) {
      return header
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_+|_+$/g, '');
    }
    
    // Standard canonical headers
    var CANONICAL_HEADERS = ['contract_key', 'file_url', 'file_name', 'sheet', 'field', 'value', 'status', 'subtype'];
    
    // Run the standardizer
    function runStandardizer() {
      var csvInput = document.getElementById('standardizer-csv-input');
      var csvText = csvInput.value.trim();
      
      if (!csvText) {
        showStandardizerStatus('Please enter or upload CSV data.', 'error');
        return;
      }
      
      var parsed = parseCSV(csvText);
      if (parsed.rows.length === 0) {
        showStandardizerStatus('No data rows found in CSV.', 'error');
        return;
      }
      
      var issues = [];
      var changeLog = [];
      var headerMap = {};
      var normalizedHeaders = [];
      var missingAnchors = [];
      
      // Normalize headers
      parsed.headers.forEach(function(original) {
        var normalized = normalizeHeader(original);
        if (normalized !== original.toLowerCase()) {
          changeLog.push({ type: 'header_renamed', original: original, normalized: normalized });
        }
        headerMap[original] = normalized;
        normalizedHeaders.push(normalized);
      });
      
      // Check for canonical headers
      CANONICAL_HEADERS.forEach(function(anchor) {
        var found = normalizedHeaders.some(function(h) { return h === anchor || h.includes(anchor); });
        if (!found && (anchor === 'contract_key' || anchor === 'file_url' || anchor === 'file_name')) {
          issues.push({
            type: 'missing_required_anchor',
            severity: 'blocking',
            anchor: anchor,
            message: 'Required anchor header "' + anchor + '" not found in input.'
          });
          missingAnchors.push(anchor);
        }
      });
      
      // Check for ambiguous columns
      var normalizedCounts = {};
      normalizedHeaders.forEach(function(h) {
        normalizedCounts[h] = (normalizedCounts[h] || 0) + 1;
      });
      Object.keys(normalizedCounts).forEach(function(h) {
        if (normalizedCounts[h] > 1) {
          issues.push({
            type: 'ambiguous_columns',
            severity: 'warning',
            header: h,
            count: normalizedCounts[h],
            message: 'Header "' + h + '" appears ' + normalizedCounts[h] + ' times after normalization.'
          });
        }
      });
      
      // Build normalized rows
      var normalizedRows = parsed.rows.map(function(row, idx) {
        var newRow = { _row_index: idx };
        parsed.headers.forEach(function(original) {
          var normalized = headerMap[original];
          newRow[normalized] = row[original] !== '' ? row[original] : null;
        });
        return newRow;
      });
      
      // Sort rows deterministically by canonical keys
      normalizedRows.sort(function(a, b) {
        var keys = ['contract_key', 'file_url', 'file_name', 'sheet', 'field'];
        for (var i = 0; i < keys.length; i++) {
          var k = keys[i];
          var av = (a[k] || '').toString();
          var bv = (b[k] || '').toString();
          if (av < bv) return -1;
          if (av > bv) return 1;
        }
        return 0;
      });
      
      // Build merged dataset
      var mergedDataset = {
        version: '1.0.0',
        generated_at: new Date().toISOString(),
        source: 'standardizer',
        delimiter_detected: parsed.delimiter,
        schema: {
          original_headers: parsed.headers,
          normalized_headers: normalizedHeaders,
          header_mapping: headerMap
        },
        data: {
          rows: normalizedRows,
          row_count: normalizedRows.length
        }
      };
      
      standardizerResult.mergedDataset = mergedDataset;
      standardizerResult.issues = issues;
      standardizerResult.changeLog = changeLog;
      
      var hasBlocking = issues.some(function(i) { return i.severity === 'blocking'; });
      var status = hasBlocking ? 'Completed with blocking issues' : 'Completed successfully';
      var statusType = hasBlocking ? 'warning' : 'success';
      showStandardizerStatus(status + ': ' + normalizedRows.length + ' rows, ' + issues.length + ' issues.', statusType);
      
      document.getElementById('standardizer-output').style.display = 'block';
      showStandardizerTab('summary');
    }
    
    function showStandardizerStatus(message, type) {
      var el = document.getElementById('standardizer-status');
      el.textContent = message;
      el.style.display = 'block';
      el.style.background = type === 'error' ? '#ffebee' : type === 'warning' ? '#fff3e0' : '#e8f5e9';
      el.style.color = type === 'error' ? '#c62828' : type === 'warning' ? '#e65100' : '#2e7d32';
    }
    
    function showStandardizerTab(tab) {
      standardizerResult.currentTab = tab;
      document.querySelectorAll('[data-std-tab]').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.stdTab === tab);
      });
      
      var content = document.getElementById('standardizer-tab-content');
      var ds = standardizerResult.mergedDataset;
      var issues = standardizerResult.issues;
      var log = standardizerResult.changeLog;
      
      if (tab === 'summary') {
        content.innerHTML = '<div class="json-header">Summary</div>' +
          '<div>Rows: ' + (ds ? ds.data.row_count : 0) + '</div>' +
          '<div>Original Headers: ' + (ds ? ds.schema.original_headers.length : 0) + '</div>' +
          '<div>Issues: ' + issues.length + ' (' + issues.filter(function(i){return i.severity==='blocking';}).length + ' blocking)</div>' +
          '<div>Changes: ' + log.length + '</div>';
      } else if (tab === 'dataset') {
        content.innerHTML = '<div class="json-header">Internal JSON (advanced)</div><pre>' + 
          (ds ? escapeHtml(JSON.stringify(ds, null, 2)) : 'No data') + '</pre>';
      } else if (tab === 'issues') {
        content.innerHTML = '<div class="json-header">Standardization Issues</div><pre>' + 
          escapeHtml(JSON.stringify(issues, null, 2)) + '</pre>';
      } else if (tab === 'changelog') {
        content.innerHTML = '<div class="json-header">Change Log</div><pre>' + 
          escapeHtml(JSON.stringify(log, null, 2)) + '</pre>';
      }
    }
    
    function generateSampleCSV() {
      var sample = 'Contract Key,File Name,File URL,Sheet,Field,Value,Status\n' +
        'CK001,a.pdf,https://example.org/a.pdf,Sheet1,title,Sample Title,ready\n' +
        'CK002,b.pdf,https://example.org/b.pdf,Sheet1,title,Another Title,needs_review\n' +
        'CK003,c.xlsx,https://example.org/c.xlsx,Data,amount,1500.00,ready\n';
      document.getElementById('standardizer-csv-input').value = sample;
      showStandardizerStatus('Sample CSV generated. Click "Run Standardizer" to process.', 'success');
    }
    
    function clearStandardizer() {
      document.getElementById('standardizer-csv-input').value = '';
      document.getElementById('standardizer-status').style.display = 'none';
      document.getElementById('standardizer-output').style.display = 'none';
      document.getElementById('standardizer-drop-text').textContent = 'Drop CSV here or click to browse';
      standardizerResult = { mergedDataset: null, issues: [], changeLog: [], currentTab: 'summary' };
    }
    
    function copyStandardizerOutput(type) {
      var text = '';
      if (type === 'dataset' && standardizerResult.mergedDataset) {
        text = JSON.stringify(standardizerResult.mergedDataset, null, 2);
      } else if (type === 'issues') {
        text = JSON.stringify(standardizerResult.issues, null, 2);
      }
      navigator.clipboard.writeText(text).then(function() {
        showToast('Copied to clipboard!', 'success');
      });
    }
    
    // Setup standardizer drop zone
    function setupStandardizerDropZone() {
      var dropZone = document.getElementById('standardizer-drop-zone');
      var fileInput = document.getElementById('standardizer-file-input');
      if (!dropZone || !fileInput) return;
      
      dropZone.addEventListener('click', function() { fileInput.click(); });
      dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#1976d2';
        dropZone.style.background = '#e3f2fd';
      });
      dropZone.addEventListener('dragleave', function() {
        dropZone.style.borderColor = '#ccc';
        dropZone.style.background = '#fafafa';
      });
      dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#ccc';
        dropZone.style.background = '#fafafa';
        var file = e.dataTransfer.files[0];
        if (file) handleStandardizerFile(file);
      });
      fileInput.addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (file) handleStandardizerFile(file);
      });
    }
    
    function handleStandardizerFile(file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('standardizer-csv-input').value = e.target.result;
        document.getElementById('standardizer-drop-text').textContent = file.name;
        showStandardizerStatus('File loaded: ' + file.name + '. Click "Run Standardizer" to process.', 'success');
      };
      reader.readAsText(file);
    }

    function renderWorkflowMap() {
      var container = document.getElementById('workflow-map');
      if (!container) return;
      
      var html = WORKFLOW_STAGES.map(function(stage, idx) {
        var artifactChips = stage.artifacts.map(function(artifactKey) {
          var binding = artifactRegistry.bindings[artifactKey];
          var status = binding ? binding.status : 'unknown';
          var statusClass = status === 'loaded' ? '' : status === 'missing' ? 'missing' : 'unknown';
          var label = ARTIFACT_LABELS[artifactKey] || artifactKey;
          var statusIcon = status === 'loaded' ? 'âœ“' : status === 'missing' ? 'âœ—' : '?';
          return '<span class="workflow-artifact ' + statusClass + '">' + statusIcon + ' ' + label + '</span>';
        }).join('');
        
        var connector = idx < WORKFLOW_STAGES.length - 1 ? '<div class="workflow-connector"></div>' : '';
        
        return '<div class="workflow-node" onclick="WORKFLOW_STAGES[' + idx + '].action()">' +
          '<div class="workflow-node-icon">' + stage.icon + '</div>' +
          '<div class="workflow-node-content">' +
            '<div class="workflow-node-title">' + stage.title + '</div>' +
            '<div class="workflow-node-desc">' + stage.desc + '</div>' +
            (artifactChips ? '<div class="workflow-node-artifacts">' + artifactChips + '</div>' : '') +
          '</div>' +
        '</div>' + connector;
      }).join('');
      
      container.innerHTML = html;
    }
    
    function updateSessionChip() {
      const chip = document.getElementById('session-chip');
      const chipText = document.getElementById('session-chip-text');
      const meta = document.getElementById('session-meta');
      const previewStatus = document.getElementById('preview-status');
      const triageInfo = document.getElementById('triage-session-info');
      
      chip.className = 'session-chip ' + sessionState.status;
      
      if (sessionState.status === 'loaded') {
        chipText.textContent = 'Loaded';
        const sourceLabel = sessionState.sourceType === 'paste' ? 'paste' : 
                           sessionState.sourceType === 'drop' ? sessionState.fileName || 'file' : 
                           sessionState.sourceType;
        meta.textContent = `via ${sourceLabel} at ${new Date(sessionState.loadedAt).toLocaleTimeString()}`;
        if (previewStatus) {
          previewStatus.textContent = 'Loaded';
          previewStatus.className = 'loader-section-status loaded';
        }
        if (triageInfo) {
          triageInfo.innerHTML = `<strong>Source:</strong> ${sourceLabel} (memory) | <strong>Loaded:</strong> ${new Date(sessionState.loadedAt).toLocaleString()}`;
        }
      } else if (sessionState.status === 'fallback') {
        chipText.textContent = 'Fallback';
        meta.textContent = 'using example data';
        if (previewStatus) {
          previewStatus.textContent = 'Example';
          previewStatus.className = 'loader-section-status loaded';
        }
        if (triageInfo) {
          triageInfo.innerHTML = `<strong>Source:</strong> example (fallback) | Using bundled sample data`;
        }
      } else {
        chipText.textContent = 'Not Loaded';
        meta.textContent = '';
        if (previewStatus) {
          previewStatus.textContent = 'Not Loaded';
          previewStatus.className = 'loader-section-status empty';
        }
        if (triageInfo) {
          triageInfo.innerHTML = `<strong>Source:</strong> none | Click <em>Data Source</em> to begin`;
        }
      }
    }
    
    function loadFromData(data, sourceType, fileName) {
      if (!data || (!data.sf_summary && !data.sf_contract_results && !data.sf_issues && !data.sf_field_actions)) {
        throw new Error('Invalid data format - expected Preview Packet structure');
      }
      
      sessionState.status = 'loaded';
      sessionState.sourceType = sourceType;
      sessionState.loadedAt = Date.now();
      sessionState.previewData = data;
      sessionState.fileName = fileName || null;
      
      allData.contractResults = sortByJoinTriplet(data.sf_contract_results || []);
      allData.issues = sortBySeverityFirst(data.sf_issues || [], ['sheet', 'field', 'issue_type']);
      allData.fieldActions = sortBySeverityFirst(data.sf_field_actions || [], ['sheet', 'field', 'action']);
      allData.changeLog = sortBySeverityFirst(data.sf_change_log || [], ['sheet', 'field', 'notes']);
      allData.summary = data.sf_summary || {};
      
      renderSummary(data.sf_summary || {});
      populateSubtypeDropdown();
      renderAllTables();
      
      dataLoaded = true;
      currentArtifactPath = fileName || sourceType;
      updateUIForDataState();
      updateSessionChip();
      
      // Detect unknown columns for Admin (uses current dataset with sheet awareness)
      if (typeof detectUnknownColumns === 'function') {
        var sheetName = sessionState.fileName || sourceType || 'imported_data';
        detectUnknownColumns(allData.contractResults, sheetName);
      }
      
      // Persist to localStorage if enabled
      const rememberChecked = document.getElementById('remember-session')?.checked;
      if (rememberChecked) {
        try {
          localStorage.setItem(STORAGE_KEY_SESSION, JSON.stringify({
            status: sessionState.status,
            sourceType: sessionState.sourceType,
            loadedAt: sessionState.loadedAt,
            fileName: sessionState.fileName,
            previewData: data,
            rememberEnabled: true
          }));
        } catch (e) {
          console.warn('Could not save to localStorage:', e);
        }
      } else {
        // Clear any existing session if user unchecked remember
        try {
          localStorage.removeItem(STORAGE_KEY_SESSION);
        } catch (e) {}
      }
      
      closeDataSourceDrawer();
      showWizardStatus('data-source-status', 'Data loaded successfully!', 'success');
    }
    
    function resetSession() {
      sessionState.status = 'not-loaded';
      sessionState.sourceType = null;
      sessionState.loadedAt = null;
      sessionState.previewData = null;
      sessionState.expectedData = null;
      sessionState.fileName = null;
      
      dataLoaded = false;
      currentArtifactPath = '';
      currentDataset = null;
      
      // Reset workbook (v1.4.3)
      resetWorkbook();
      
      allData.contractResults = [];
      allData.issues = [];
      allData.fieldActions = [];
      allData.changeLog = [];
      allData.summary = {};
      
      // Clear only app-namespaced localStorage keys (keep patch draft)
      try {
        localStorage.removeItem(STORAGE_KEY_SESSION);
        localStorage.removeItem('orchestrate.dataset.v1');
        localStorage.removeItem('orchestrate.pdf_attachments.v1');
      } catch (e) {}
      
      updateUIForDataState();
      updateSessionChip();
      renderAllTables();
      
      // Reset modal fields (if they exist)
      const previewPaste = document.getElementById('preview-paste-area');
      const expectedPaste = document.getElementById('expected-paste-area');
      const previewDropFile = document.getElementById('preview-drop-file');
      const expectedDropFile = document.getElementById('expected-drop-file');
      const previewDropLoad = document.getElementById('preview-drop-load');
      const expectedDropLoad = document.getElementById('expected-drop-load');
      const previewStatus = document.getElementById('preview-status');
      const expectedStatus = document.getElementById('expected-status');
      
      if (previewPaste) previewPaste.value = '';
      if (expectedPaste) expectedPaste.value = '';
      if (previewDropFile) previewDropFile.textContent = '';
      if (expectedDropFile) expectedDropFile.textContent = '';
      if (previewDropLoad) previewDropLoad.disabled = true;
      if (expectedDropLoad) expectedDropLoad.disabled = true;
      if (previewStatus) {
        previewStatus.textContent = 'Not Loaded';
        previewStatus.className = 'loader-section-status empty';
      }
      if (expectedStatus) {
        expectedStatus.textContent = 'Not Loaded';
        expectedStatus.className = 'loader-section-status empty';
      }
      
      // Navigate to loader after reset
      navigateTo('loader');
      showWizardStatus('data-source-status', 'Session reset. Patch draft preserved.', 'info');
    }
    
    function restoreSessionFromStorage() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY_SESSION);
        if (stored) {
          const session = JSON.parse(stored);
          // Only restore if rememberEnabled was true when saved (opt-in check)
          if (session.previewData && session.rememberEnabled) {
            // Set checkbox to match saved preference
            const rememberCheckbox = document.getElementById('remember-session');
            if (rememberCheckbox) rememberCheckbox.checked = true;
            
            // Load data without re-saving to localStorage
            sessionState.status = 'loaded';
            sessionState.sourceType = session.sourceType;
            sessionState.loadedAt = session.loadedAt;
            sessionState.previewData = session.previewData;
            sessionState.fileName = session.fileName;
            
            const data = session.previewData;
            allData.contractResults = sortByJoinTriplet(data.sf_contract_results || []);
            allData.issues = sortBySeverityFirst(data.sf_issues || [], ['sheet', 'field', 'issue_type']);
            allData.fieldActions = sortBySeverityFirst(data.sf_field_actions || [], ['sheet', 'field', 'action']);
            allData.changeLog = sortBySeverityFirst(data.sf_change_log || [], ['sheet', 'field', 'notes']);
            allData.summary = data.sf_summary || {};
            
            renderSummary(data.sf_summary || {});
            populateSubtypeDropdown();
            renderAllTables();
            
            dataLoaded = true;
            currentArtifactPath = session.fileName || session.sourceType;
            updateUIForDataState();
            updateSessionChip();
            return true;
          }
        }
      } catch (e) {
        console.warn('Could not restore session:', e);
      }
      return false;
    }
    
    function setupLoaderHandlers() {
      // Tab switching within loader sections
      document.querySelectorAll('.loader-tabs').forEach(tabContainer => {
        tabContainer.addEventListener('click', e => {
          const tab = e.target.closest('.loader-tab');
          if (!tab) return;
          const panelId = tab.dataset.panel;
          
          tabContainer.querySelectorAll('.loader-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          const section = tabContainer.closest('.loader-section');
          if (section) {
            section.querySelectorAll('.loader-panel').forEach(p => p.classList.remove('active'));
          }
          document.getElementById(panelId)?.classList.add('active');
        });
      });
      
      // Preview paste load (guard with null check - may not exist)
      var previewPasteBtn = document.getElementById('preview-paste-load');
      if (previewPasteBtn) {
        previewPasteBtn.addEventListener('click', function() {
          var text = document.getElementById('preview-paste-area').value.trim();
          if (!text) {
            showWizardStatus('data-source-status', 'Please paste JSON first', 'error');
            return;
          }
          try {
            var data = JSON.parse(text);
            loadFromData(data, 'paste', null);
          } catch (e) {
            showWizardStatus('data-source-status', 'Invalid JSON: ' + e.message, 'error');
          }
        });
      }
      
      // Preview drop zone (guard with null check - may not exist)
      var previewDropZone = document.getElementById('preview-drop-zone');
      var previewFileInput = document.getElementById('preview-file-input');
      var previewFileData = null;
      
      if (previewDropZone && previewFileInput) {
        var previewFileData = null;
        
        previewDropZone.addEventListener('click', function() { previewFileInput.click(); });
        previewDropZone.addEventListener('dragover', function(e) {
          e.preventDefault();
          previewDropZone.classList.add('drag-over');
        });
        previewDropZone.addEventListener('dragleave', function() {
          previewDropZone.classList.remove('drag-over');
        });
        previewDropZone.addEventListener('drop', function(e) {
          e.preventDefault();
          previewDropZone.classList.remove('drag-over');
          var file = e.dataTransfer.files[0];
          if (file) handlePreviewFile(file);
        });
        previewFileInput.addEventListener('change', function(e) {
          var file = e.target.files[0];
          if (file) handlePreviewFile(file);
        });
        
        function handlePreviewFile(file) {
          var reader = new FileReader();
          reader.onload = function(e) {
            try {
              previewFileData = JSON.parse(e.target.result);
              var fileEl = document.getElementById('preview-drop-file');
              if (fileEl) fileEl.textContent = file.name;
              previewDropZone.classList.add('has-file');
              var loadBtn = document.getElementById('preview-drop-load');
              if (loadBtn) loadBtn.disabled = false;
              sessionState.fileName = file.name;
            } catch (err) {
              showWizardStatus('data-source-status', 'Invalid JSON file: ' + err.message, 'error');
            }
          };
          reader.readAsText(file);
        }
        
        var previewLoadBtn = document.getElementById('preview-drop-load');
        if (previewLoadBtn) {
          previewLoadBtn.addEventListener('click', function() {
            if (previewFileData) {
              loadFromData(previewFileData, 'drop', sessionState.fileName);
            }
          });
        }
      }
      
      // Expected paste load (guard all with null checks)
      var expectedPasteBtn = document.getElementById('expected-paste-load');
      if (expectedPasteBtn) {
        expectedPasteBtn.addEventListener('click', function() {
          var textarea = document.getElementById('expected-paste-area');
          var text = textarea ? textarea.value.trim() : '';
          if (!text) {
            showWizardStatus('data-source-status', 'Please paste expected JSON first', 'error');
            return;
          }
          try {
            var data = JSON.parse(text);
            sessionState.expectedData = data;
            var statusEl = document.getElementById('expected-status');
            if (statusEl) {
              statusEl.textContent = 'Loaded';
              statusEl.className = 'loader-section-status loaded';
            }
            showWizardStatus('data-source-status', 'Expected data loaded for comparison', 'success');
          } catch (e) {
            showWizardStatus('data-source-status', 'Invalid JSON: ' + e.message, 'error');
          }
        });
      }
      
      // Expected drop zone (guard all with null checks)
      var expectedDropZone = document.getElementById('expected-drop-zone');
      var expectedFileInput = document.getElementById('expected-file-input');
      
      if (expectedDropZone && expectedFileInput) {
        var expectedFileData = null;
        
        expectedDropZone.addEventListener('click', function() { expectedFileInput.click(); });
        expectedDropZone.addEventListener('dragover', function(e) {
          e.preventDefault();
          expectedDropZone.classList.add('drag-over');
        });
        expectedDropZone.addEventListener('dragleave', function() {
          expectedDropZone.classList.remove('drag-over');
        });
        expectedDropZone.addEventListener('drop', function(e) {
          e.preventDefault();
          expectedDropZone.classList.remove('drag-over');
          var file = e.dataTransfer.files[0];
          if (file) handleExpectedFile(file);
        });
        expectedFileInput.addEventListener('change', function(e) {
          var file = e.target.files[0];
          if (file) handleExpectedFile(file);
        });
        
        function handleExpectedFile(file) {
          var reader = new FileReader();
          reader.onload = function(e) {
            try {
              expectedFileData = JSON.parse(e.target.result);
              var fileEl = document.getElementById('expected-drop-file');
              if (fileEl) fileEl.textContent = file.name;
              expectedDropZone.classList.add('has-file');
              var loadBtn = document.getElementById('expected-drop-load');
              if (loadBtn) loadBtn.disabled = false;
            } catch (err) {
              showWizardStatus('data-source-status', 'Invalid JSON file: ' + err.message, 'error');
            }
          };
          reader.readAsText(file);
        }
        
        var expectedLoadBtn = document.getElementById('expected-drop-load');
        if (expectedLoadBtn) {
          expectedLoadBtn.addEventListener('click', function() {
            if (expectedFileData) {
              sessionState.expectedData = expectedFileData;
              var statusEl = document.getElementById('expected-status');
              if (statusEl) {
                statusEl.textContent = 'Loaded';
                statusEl.className = 'loader-section-status loaded';
              }
              showWizardStatus('data-source-status', 'Expected data loaded for comparison', 'success');
            }
          });
        }
      }
      
      // Path hint preset buttons
      document.querySelectorAll('#preview-path .wizard-preset-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var input = document.getElementById('preview-path-input');
          if (input) input.value = btn.dataset.path;
        });
      });
      
      // Reset session button (guard with null check)
      var resetBtn = document.getElementById('reset-session-btn');
      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          if (confirm('Reset session? This clears loaded artifacts but keeps your patch draft.')) {
            resetSession();
          }
        });
      }
    }

    // ========== APP SESSION STATE MACHINE (V1.2.8) ==========
    var currentPage = 'loader';
    
    function getAppSessionState() {
      // Returns current session state for route guard checks
      // Use dataLoaded as primary check - simpler and more reliable than bundle check
      return {
        active_dataset_id: localStorage.getItem(STORAGE_KEY_ACTIVE_DATASET) || null,
        data_loaded: dataLoaded,
        current_page: currentPage,
        current_mode: currentMode
      };
    }
    
    function checkRouteRequirements(page) {
      // Check if route requirements are met
      // Use dataLoaded instead of bundle presence (more reliable)
      var requirements = {
        'triage': { needsData: true },
        'patch': { needsData: true },
        'review': { needsData: true },
        'admin': { needsData: false },
        'loader': { needsData: false }
      };
      
      var pageReqs = requirements[page] || { needsData: false };
      
      if (pageReqs.needsData && !dataLoaded) {
        return { valid: false, missing: 'data_loaded' };
      }
      return { valid: true };
    }
    
    function updateDebugHUD() {
      var hud = document.getElementById('debug-hud');
      if (!hud) return;
      var state = getAppSessionState();
      hud.innerHTML = 'Route: ' + currentPage + ' | Data: ' + (dataLoaded ? 'Yes' : 'No') + ' | Mode: ' + currentMode;
    }
    
    function pageRequiresDataset(page) {
      return ['triage', 'patch', 'review'].includes(page);
    }

    function navigateTo(page, options) {
      options = options || {};
      // Loader is now a drawer, not a page - redirect loader requests to triage
      if (page === 'loader') page = 'triage';
      var pages = ['triage', 'grid', 'patch', 'review', 'admin', 'row'];
      // Handle row/:id routes
      if (page.startsWith('row/')) {
        var rowId = page.split('/')[1];
        openRowReviewDrawer(rowId);
        return;
      }
      if (!pages.includes(page)) page = dataLoaded ? 'grid' : 'triage';
      
      console.log('[Navigate] Attempting navigation to: ' + page + ', dataLoaded: ' + dataLoaded);
      
      // For pages needing data, we still show the page but with empty state
      // No hard redirect - triage handles its own empty state with "Load Data" CTA
      
      // Parse admin tab from route (e.g., admin/standardizer -> tab=standardizer)
      var adminTab = null;
      if (page.startsWith('admin/')) {
        var parts = page.split('/');
        page = 'admin';
        adminTab = parts[1] || 'governance';
      }
      
      // RBAC route guards with toast notification
      if (page === 'admin' && currentMode !== 'admin') {
        console.log('[Navigate] Admin page requires admin mode, redirecting to triage');
        showToast('Admin only - switch to Admin role to access this page', 'warning');
        page = 'triage'; // Redirect to triage instead of returning
        adminTab = null;
      }
      if (page === 'review' && currentMode !== 'reviewer' && currentMode !== 'admin') {
        console.log('[Navigate] Review page requires reviewer/admin mode');
        showToast('Reviewer access required', 'warning');
        page = 'triage';
      }
      
      // Update current page tracking
      currentPage = page;
      
      // Clear all pages first - MUST reset both class AND inline style
      document.querySelectorAll('.page').forEach(function(p) { 
        p.classList.remove('active'); 
        p.style.display = 'none';  // Reset inline style to ensure CSS takes over
      });
      document.querySelectorAll('.page-content').forEach(function(p) { p.style.display = 'none'; });
      document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
      
      var pageEl = document.getElementById('page-' + page);
      var navEl = document.querySelector('.nav-item[data-page="' + page + '"]');
      
      console.log('[Navigate] Showing page element: page-' + page + ', found: ' + (pageEl ? 'yes' : 'no'));
      
      if (pageEl) {
        pageEl.classList.add('active');
        pageEl.style.display = 'block';
      }
      if (navEl) navEl.classList.add('active');
      
      // Show empty queue message on triage if no data loaded
      var emptyMsg = document.getElementById('empty-queue-message');
      if (emptyMsg) {
        if (page === 'triage' && !dataLoaded) {
          emptyMsg.classList.remove('hidden');
        } else {
          emptyMsg.classList.add('hidden');
        }
      }
      
      // Update debug HUD
      updateDebugHUD();
      
      // DEV-ONLY: Assert no admin sections render inside triage
      if (page === 'triage') {
        var triageEl = document.getElementById('page-triage');
        if (triageEl) {
          var adminSectionsInTriage = triageEl.querySelectorAll('[data-admin-section="true"]');
          if (adminSectionsInTriage.length > 0) {
            console.error('[DEV ASSERTION FAILED] Found ' + adminSectionsInTriage.length + ' admin sections inside triage page!');
          }
        }
      }
      
      // If navigating to admin with a specific tab, switch to it
      if (page === 'admin' && adminTab) {
        switchAdminTab(adminTab);
      }
      
      // If navigating to grid, initialize grid
      if (page === 'grid') {
        setTimeout(function() { initGrid(); }, 0);
      }
      
      // Update hash (include tab for admin deep-links, preserve grid query params)
      if (page === 'admin' && adminTab && adminTab !== 'governance') {
        window.location.hash = '#/admin/' + adminTab;
      } else if (page === 'grid' && options.queryParams) {
        window.location.hash = '#/grid?' + options.queryParams;
      } else {
        window.location.hash = '#/' + page;
      }
    }
    
    // Navigate to grid with filter (for Triage alert lens)
    function navigateToGridFiltered(filter, sheet) {
      var params = [];
      if (filter && filter !== 'all') params.push('f=' + encodeURIComponent(filter));
      if (sheet) params.push('sheet=' + encodeURIComponent(sheet));
      navigateTo('grid', { queryParams: params.join('&') });
    }
    
    function recoverNavigation() {
      var currentHash = window.location.hash.replace('#/', '') || (dataLoaded ? 'grid' : 'triage');
      // Loader is now a drawer, redirect appropriately
      if (currentHash === 'loader') currentHash = dataLoaded ? 'grid' : 'triage';
      // Handle grid query params
      if (currentHash.startsWith('grid?')) {
        var queryPart = currentHash.split('?')[1];
        gridState.filter = 'all';
        gridState.sheet = '';
        gridState.search = '';
        if (queryPart) {
          var params = new URLSearchParams(queryPart);
          gridState.filter = params.get('f') || 'all';
          gridState.sheet = params.get('sheet') || '';
          gridState.search = params.get('q') || '';
        }
        currentHash = 'grid';
      }
      console.log('[RecoverNav] Recovering to: ' + currentHash);
      navigateTo(currentHash);
      return true;
    }

    function setMode(mode) {
      const modes = ['analyst', 'reviewer', 'admin'];
      if (!modes.includes(mode)) mode = 'analyst';
      currentMode = mode;
      
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      const modeBtn = document.querySelector(`.mode-btn[data-mode="${mode}"]`);
      if (modeBtn) modeBtn.classList.add('active');
      
      // Toggle nav visibility based on mode using CSS classes
      const appLayout = document.querySelector('.app-layout');
      if (appLayout) {
        appLayout.classList.remove('mode-analyst', 'mode-reviewer', 'mode-admin');
        appLayout.classList.add(`mode-${mode}`);
      }
      
      // If downgrading from admin mode, teardown admin state
      if (mode !== 'admin') {
        teardownAdminState();
      }
      
      // If on admin page but not admin mode, redirect to triage
      if (window.location.hash.includes('admin') && mode !== 'admin') {
        showToast('Role changed - returning to Triage', 'info');
        navigateTo('triage');
      }
      // If on review page but not reviewer or admin mode, redirect to triage
      if (window.location.hash.includes('review') && mode === 'analyst') {
        showToast('Role changed - returning to Triage', 'info');
        navigateTo('triage');
      }
      
      applyModeVisibility(mode);
      localStorage.setItem('viewer_mode_v10', mode);
    }

    function applyModeVisibility(mode) {
      const revElements = document.querySelectorAll('[data-mode-reviewer]');
      const anlElements = document.querySelectorAll('[data-mode-analyst]');
      const admElements = document.querySelectorAll('[data-mode-admin]');
      
      revElements.forEach(el => {
        el.classList.toggle('mode-hidden', mode !== 'reviewer' && mode !== 'admin');
      });
      anlElements.forEach(el => {
        el.classList.toggle('mode-hidden', mode !== 'analyst');
      });
      admElements.forEach(el => {
        el.classList.toggle('mode-hidden', mode !== 'admin');
      });
    }

    // Admin Console Tab Switching
    var currentAdminTab = 'governance';
    function switchAdminTab(tabName) {
      const tabs = ['governance', 'config', 'inspector', 'standardizer', 'patch-console', 'evidence', 'unknown-cols'];
      if (!tabs.includes(tabName)) tabName = 'governance';
      currentAdminTab = tabName;
      
      // Hide all tab panels
      document.querySelectorAll('.admin-tab-panel').forEach(panel => {
        panel.style.display = 'none';
      });
      
      // Show selected tab panel
      const targetPanel = document.getElementById('admin-tab-' + tabName);
      if (targetPanel) {
        targetPanel.style.display = 'block';
      }
      
      // Update tab button styles
      document.querySelectorAll('.admin-tab').forEach(btn => {
        if (btn.dataset.adminTab === tabName) {
          btn.style.background = '#1976d2';
          btn.style.color = 'white';
          btn.style.fontWeight = '600';
        } else {
          btn.style.background = '#f5f5f5';
          btn.style.color = '#666';
          btn.style.fontWeight = 'normal';
        }
      });
      
      console.log('[Admin] Switched to tab:', tabName);
    }

    // Teardown admin state when leaving admin mode
    function teardownAdminState() {
      // Reset admin tab to default
      currentAdminTab = 'governance';
      // Clear any admin-specific temp state
      console.log('[Admin] Tearing down admin state');
    }

    function updateUIForDataState() {
      const emptyQueueMsg = document.getElementById('empty-queue-message');
      const topToolbar = document.getElementById('top-toolbar');
      
      if (dataLoaded) {
        if (emptyQueueMsg) emptyQueueMsg.classList.add('hidden');
        if (topToolbar) topToolbar.style.display = 'flex';
      } else {
        if (emptyQueueMsg) emptyQueueMsg.classList.remove('hidden');
        if (topToolbar) topToolbar.style.display = 'none';
      }
      
      // Update session chip (handles status display)
      updateSessionChip();
      // Update queue counts
      updateQueueCounts();
      
      // Update data status chip in sidebar (v1.4.5)
      var dataStatusChip = document.getElementById('data-status-chip');
      if (dataStatusChip) {
        if (dataLoaded && allData.contractResults && allData.contractResults.length > 0) {
          dataStatusChip.textContent = allData.contractResults.length;
          dataStatusChip.classList.add('has-items');
        } else {
          dataStatusChip.textContent = '--';
          dataStatusChip.classList.remove('has-items');
        }
      }
    }

    function updateQueueCounts() {
      const results = allData.contractResults || [];
      const counts = {
        todo: 0,
        needs_review: 0,
        flagged: 0,
        blocked: 0,
        finalized: 0
      };
      
      results.forEach(r => {
        const status = (r.sf_contract_status || '').toLowerCase();
        if (status === 'needs_review') counts.needs_review++;
        else if (status === 'blocked') counts.blocked++;
        else if (status === 'ready') counts.finalized++;
        else counts.todo++;
      });
      
      // Total unfinished = todo + needs_review (the main work queue)
      counts.todo = results.length - counts.finalized;
      
      // Update count badges
      Object.entries(counts).forEach(([queue, count]) => {
        const el = document.getElementById(`queue-count-${queue}`);
        if (el) {
          el.textContent = count;
          el.classList.toggle('has-items', count > 0);
          el.classList.toggle('blocking', queue === 'blocked' && count > 0);
        }
      });
    }

    // Feature Flags (V1 defaults)
    var FEATURE_FLAGS = {
      connectors_enabled: false  // V1: offline-first, no connectors
    };
    
    // Data Source Panel - unified entry point (v1.5.0)
    // Always opens right-side panel (never modal) - per spec
    function openDataSourcePanel() {
      openDataSourceDrawer();
    }
    
    // Data Sources Drawer functions (now Upload Library)
    function openDataSourceDrawer() {
      document.getElementById('data-source-drawer').classList.add('active');
      renderUploadLibrary();
      updateDataSourceDrawerState();
    }
    
    function closeDataSourceDrawer() {
      document.getElementById('data-source-drawer').classList.remove('active');
    }
    
    // Update Data Source drawer to show current state
    function updateDataSourceDrawerState() {
      var drawer = document.getElementById('data-source-drawer');
      if (!drawer) return;
      
      var headerEl = drawer.querySelector('.drawer-header h3');
      var emptySection = document.getElementById('data-source-empty-section');
      var activeSection = document.getElementById('data-source-active-section');
      var uploadSection = document.getElementById('data-source-upload-section');
      var searchSection = document.getElementById('data-source-search-section');
      var libraryHeader = document.getElementById('data-source-library-header');
      var uploadLibrary = getUploadLibrary();
      var count = uploadLibrary ? uploadLibrary.length : 0;
      var hasData = dataLoaded && sessionState.status === 'loaded';
      
      // Update header
      if (headerEl) {
        headerEl.textContent = 'Data Source';
      }
      
      // Show empty section when no data
      if (emptySection) {
        emptySection.style.display = hasData ? 'none' : 'block';
      }
      
      // Show active dataset section when data loaded
      if (activeSection) {
        if (hasData) {
          activeSection.style.display = 'block';
          var nameEl = document.getElementById('active-dataset-name');
          var metaEl = document.getElementById('active-dataset-meta');
          if (nameEl) {
            nameEl.textContent = sessionState.fileName || sessionState.sourceType || 'Loaded Dataset';
          }
          if (metaEl) {
            var rowCount = allData.contractResults ? allData.contractResults.length : 0;
            var loadedAt = sessionState.loadedAt ? new Date(sessionState.loadedAt).toLocaleString() : 'â€”';
            metaEl.innerHTML = '<strong>' + rowCount + '</strong> records | Loaded: ' + loadedAt;
          }
        } else {
          activeSection.style.display = 'none';
        }
      }
      
      // Show upload section when active dataset exists
      if (uploadSection) {
        uploadSection.style.display = hasData ? 'block' : 'none';
      }
      
      // Show search section when active dataset exists
      if (searchSection) {
        searchSection.style.display = hasData ? 'block' : 'none';
      }
      
      // Show library header only when there are saved datasets (excluding active)
      if (libraryHeader) {
        libraryHeader.style.display = count > 0 ? 'block' : 'none';
      }
      
      // Close disconnect menu
      var disconnectMenu = document.getElementById('disconnect-menu');
      if (disconnectMenu) disconnectMenu.style.display = 'none';
    }
    
    // Toggle disconnect menu on ACTIVE badge click
    function toggleDisconnectMenu(event) {
      event.stopPropagation();
      var menu = document.getElementById('disconnect-menu');
      if (menu) {
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    // Data Source panel search stub - show "coming soon" toast
    var dataSourceSearchDebounce = null;
    function showDataSourceSearchToast() {
      if (dataSourceSearchDebounce) return;
      dataSourceSearchDebounce = setTimeout(function() {
        dataSourceSearchDebounce = null;
      }, 1500);
      showToast('Search coming soon (V2)', 'info');
    }
    
    // Disconnect active dataset (move to Saved)
    function disconnectActiveDataset() {
      var menu = document.getElementById('disconnect-menu');
      if (menu) menu.style.display = 'none';
      
      // Save current dataset to library before clearing
      if (dataLoaded && sessionState.status === 'loaded') {
        saveCurrentDatasetToLibrary();
      }
      
      // Clear active dataset
      dataLoaded = false;
      sessionState.status = 'not_loaded';
      sessionState.fileName = null;
      sessionState.loadedAt = null;
      sessionState.sourceType = null;
      allData = { contractResults: [], fieldActions: [], issues: [], summary: {} };
      workbook = { sheets: {}, order: [] };
      localStorage.removeItem('activeDatasetId');
      
      // Update UI
      updateDataSourceDrawerState();
      renderUploadLibrary();
      updateSessionUI();
      updateQueueCounts();
      showToast('Dataset disconnected', 'info');
    }
    
    // Save current dataset to upload library
    function saveCurrentDatasetToLibrary() {
      var library = getUploadLibrary();
      var entry = {
        id: 'ds_' + Date.now(),
        name: sessionState.fileName || 'Dataset',
        type: sessionState.sourceType || 'unknown',
        recordCount: allData.contractResults ? allData.contractResults.length : 0,
        savedAt: new Date().toISOString(),
        data: JSON.stringify(allData)
      };
      library.push(entry);
      localStorage.setItem('upload_library_v1', JSON.stringify(library));
    }
    
    // Handle file upload from drawer
    function handleDrawerFileUpload(input) {
      var file = input.files[0];
      if (!file) return;
      
      var ext = file.name.split('.').pop().toLowerCase();
      if (ext !== 'csv' && ext !== 'xlsx') {
        showToast('Unsupported file type. Use CSV or XLSX.', 'error');
        return;
      }
      
      // If active dataset exists, rotate it to Saved
      if (dataLoaded && sessionState.status === 'loaded') {
        saveCurrentDatasetToLibrary();
        showToast('Previous dataset moved to Saved', 'info');
      }
      
      // Process the file
      if (ext === 'csv') {
        processCSVFile(file);
      } else if (ext === 'xlsx') {
        processXLSXFile(file);
      }
      
      input.value = ''; // Reset input
    }
    
    // Process CSV file from drawer upload
    function processCSVFile(file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var text = e.target.result;
        var parsed = parseCSV(text);
        
        // parseCSV returns { headers: [], rows: [], delimiter: '' }
        if (!parsed || !parsed.rows || parsed.rows.length === 0) {
          showToast('Failed to parse CSV file or no data rows found', 'error');
          return;
        }
        
        var headers = parsed.headers;
        var records = parsed.rows; // Already in object format
        
        // Create a workbook-compatible structure
        var sheetName = file.name.replace(/\.(csv|xlsx)$/i, '');
        
        // Clear any cached version of this sheet to treat re-import as fresh
        clearCachedDataset(sheetName);
        
        // Load into workbook (fresh state)
        window.workbookState = window.workbookState || { sheets: {}, sheetOrder: [], activeSheet: null };
        window.workbookState.sheets[sheetName] = {
          name: sheetName,
          headers: headers,
          rows: records
        };
        if (window.workbookState.sheetOrder.indexOf(sheetName) < 0) {
          window.workbookState.sheetOrder.push(sheetName);
        }
        window.workbookState.activeSheet = sheetName;
        
        console.log('[Loader] CSV file loaded: ' + sheetName + ', ' + records.length + ' rows');
        
        // Update state
        dataLoaded = true;
        sessionState.status = 'loaded';
        sessionState.loadedAt = new Date().toISOString();
        sessionState.source = 'file:' + file.name;
        
        updateUIForDataState();
        closeDataDrawer();
        showToast('CSV loaded: ' + records.length + ' records', 'success');
        navigateTo('grid');
      };
      reader.onerror = function() {
        showToast('Failed to read file', 'error');
      };
      reader.readAsText(file);
    }
    
    // Clear cached dataset by name to ensure fresh import
    function clearCachedDataset(sheetName) {
      // Remove from workbook if exists
      if (window.workbookState && window.workbookState.sheets && window.workbookState.sheets[sheetName]) {
        delete window.workbookState.sheets[sheetName];
        var idx = window.workbookState.sheetOrder.indexOf(sheetName);
        if (idx >= 0) window.workbookState.sheetOrder.splice(idx, 1);
        console.log('[Loader] Cleared cached dataset: ' + sheetName);
      }
      
      // Remove from upload library localStorage
      try {
        var library = JSON.parse(localStorage.getItem('upload_library_v1') || '[]');
        var filtered = library.filter(function(ds) { return ds.name !== sheetName; });
        if (filtered.length !== library.length) {
          localStorage.setItem('upload_library_v1', JSON.stringify(filtered));
          console.log('[Loader] Removed from upload library: ' + sheetName);
        }
      } catch (err) {
        console.warn('[Loader] Could not clear upload library cache', err);
      }
    }
    
    // Placeholder XLSX processing (V2 full implementation)
    function processXLSXFile(file) {
      showToast('XLSX support coming soon. Use CSV for now.', 'info');
    }
    
    // Close disconnect menu when clicking elsewhere
    document.addEventListener('click', function(e) {
      var menu = document.getElementById('disconnect-menu');
      if (menu && menu.style.display !== 'none') {
        var badge = document.getElementById('active-badge');
        if (!badge || !badge.contains(e.target)) {
          menu.style.display = 'none';
        }
      }
    });
    
    // Get stored datasets from localStorage
    function getUploadLibrary() {
      try {
        var stored = localStorage.getItem('upload_library_v1');
        return stored ? JSON.parse(stored) : [];
      } catch (e) {
        return [];
      }
    }
    
    // Loader Modal functions
    var loaderModalTriggerEl = null;
    
    function openLoaderModal() {
      loaderModalTriggerEl = document.activeElement;
      hideLoaderError(); // Clear any previous errors
      document.getElementById('loader-modal-overlay').classList.add('active');
      document.body.style.overflow = 'hidden';
      document.addEventListener('keydown', loaderModalKeyHandler);
      var closeBtn = document.getElementById('loader-modal-close-btn');
      if (closeBtn) closeBtn.focus();
    }
    
    function closeLoaderModal(event) {
      if (event && event.target && event.target.id !== 'loader-modal-overlay') return;
      document.getElementById('loader-modal-overlay').classList.remove('active');
      document.body.style.overflow = '';
      document.removeEventListener('keydown', loaderModalKeyHandler);
      if (loaderModalTriggerEl && loaderModalTriggerEl.focus) {
        loaderModalTriggerEl.focus();
      }
      loaderModalTriggerEl = null;
    }
    
    function loaderModalKeyHandler(e) {
      if (e.key === 'Escape') {
        closeLoaderModal();
      }
      if (e.key === 'Tab') {
        var modal = document.getElementById('loader-modal');
        var focusables = modal.querySelectorAll('button, input, select, textarea, a[href]');
        if (focusables.length === 0) return;
        var first = focusables[0];
        var last = focusables[focusables.length - 1];
        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }
    }
    
    // v1.4.5: Legacy alias removed - use openLoaderModal() directly
    function openLoaderDrawer() { openLoaderModal(); }
    
    // v1.4.5: Stub admin functions to prevent console errors
    function inspectJSON(type) {
      console.log('[Admin] inspectJSON called for:', type);
      showToast('Inspector: ' + type + ' (not yet implemented)', 'info');
    }
    
    function loadAdminConfig() {
      console.log('[Admin] loadAdminConfig called');
      showToast('Load Config (not yet implemented)', 'info');
    }
    
    function copyInspectorJSON() {
      console.log('[Admin] copyInspectorJSON called');
      showToast('Copy JSON (not yet implemented)', 'info');
    }
    function closeLoaderDrawer() { closeLoaderModal(); }
    
    // ============================================================
    // GRID FUNCTIONS (v1.4.3)
    // ============================================================
    var currentDataset = null;
    var gridState = {
      filter: 'all',
      sheet: '',
      search: '',
      visibleColumns: [],
      allColumns: []
    };
    
    function getGridDataset() {
      // Priority: workbook > allData > localStorage cache
      if (workbook.order.length > 0) {
        // Build dataset from workbook
        var records = [];
        workbook.order.forEach(function(sheetName) {
          var sheet = workbook.sheets[sheetName];
          if (sheet && sheet.rows) {
            sheet.rows.forEach(function(row) {
              var r = Object.assign({}, row);
              r.sheet = sheetName;
              records.push(r);
            });
          }
        });
        currentDataset = { sf_contract_results: records };
        console.log('[Grid] Dataset from workbook:', workbook.order.length, 'sheets,', records.length, 'records');
        return currentDataset;
      }
      
      if (currentDataset) return currentDataset;
      
      var cached = localStorage.getItem('sample_dataset');
      if (cached) {
        try { currentDataset = JSON.parse(cached); } catch(e) {}
      }
      if (!currentDataset && window.allData && window.allData.contractResults) {
        currentDataset = { sf_contract_results: window.allData.contractResults };
      }
      return currentDataset;
    }

    function initGrid() {
      // Parse query params from URL
      var hash = window.location.hash;
      var queryMatch = hash.match(/\?(.+)$/);
      if (queryMatch) {
        var params = new URLSearchParams(queryMatch[1]);
        gridState.filter = params.get('f') || 'all';
        gridState.sheet = params.get('sheet') || '';
        gridState.search = params.get('q') || '';
      }
      
      // Apply state to UI
      var searchInput = document.getElementById('grid-search');
      if (searchInput) searchInput.value = gridState.search;
      
      var sheetSelector = document.getElementById('grid-sheet-selector');
      if (sheetSelector) sheetSelector.value = gridState.sheet;
      
      updateGridFilterChips();
      populateGridSheetSelector();
      renderGrid();
    }

    function populateGridSheetSelector() {
      var selector = document.getElementById('grid-sheet-selector');
      if (!selector) return;
      
      selector.innerHTML = '<option value="">All Sheets</option>';
      var sheets = [];
      
      // Priority: workbook.order > dataset extraction
      if (workbook.order.length > 0) {
        sheets = workbook.order.slice();
      } else {
        var ds = getGridDataset();
        if (ds && ds.sf_contract_results) {
          var sheetSet = new Set();
          ds.sf_contract_results.forEach(function(r) {
            if (r.sheet) sheetSet.add(r.sheet);
          });
          sheets = Array.from(sheetSet).sort();
        }
      }
      
      // Sort deterministically
      sheets.sort().forEach(function(sheet) {
        var opt = document.createElement('option');
        opt.value = sheet;
        opt.textContent = sheet;
        if (sheet === gridState.sheet) opt.selected = true;
        selector.appendChild(opt);
      });
      
      // Attach change handler
      selector.onchange = function() {
        gridState.sheet = selector.value;
        updateGridURL();
        renderGrid();
      };
    }

    function setGridFilter(filter) {
      gridState.filter = filter;
      updateGridFilterChips();
      updateGridURL();
      renderGrid();
    }

    function updateGridFilterChips() {
      var chips = document.querySelectorAll('#grid-status-chips .filter-chip');
      chips.forEach(function(chip) {
        if (chip.dataset.filter === gridState.filter) {
          chip.classList.add('active');
        } else {
          chip.classList.remove('active');
        }
      });
    }

    function updateGridURL() {
      var params = [];
      if (gridState.filter && gridState.filter !== 'all') params.push('f=' + encodeURIComponent(gridState.filter));
      if (gridState.sheet) params.push('sheet=' + encodeURIComponent(gridState.sheet));
      if (gridState.search) params.push('q=' + encodeURIComponent(gridState.search));
      
      var newHash = '#/grid' + (params.length > 0 ? '?' + params.join('&') : '');
      if (window.location.hash !== newHash) {
        history.replaceState(null, '', newHash);
      }
    }

    function renderGrid() {
      // v1.4.4: Improved empty state handling
      if (!dataLoaded) {
        document.getElementById('grid-tbody').innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #666;">' +
          '<div style="margin-bottom: 10px;">No data loaded</div>' +
          '<button class="top-toolbar-btn" onclick="openDataSourcePanel()">Add Data Source</button>' +
          '</td></tr>';
        document.getElementById('grid-row-count').textContent = '0 records';
        return;
      }
      
      var ds = getGridDataset();
      if (!ds) {
        // Workbook exists but getGridDataset returned null
        var sheetName = workbook.activeSheet || 'unknown';
        document.getElementById('grid-tbody').innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #666;">' +
          '<div style="font-weight: 600; margin-bottom: 5px;">0 rows in sheet: ' + escapeHtml(sheetName) + '</div>' +
          '<div style="font-size: 0.85em; color: #888;">The selected sheet has no data rows.</div>' +
          '</td></tr>';
        document.getElementById('grid-row-count').textContent = '0 records in ' + sheetName;
        return;
      }
      var records = ds.sf_contract_results || [];
      
      // Apply filters: sheet -> status -> search
      var filtered = records;
      
      // Sheet filter
      if (gridState.sheet) {
        filtered = filtered.filter(function(r) { return r.sheet === gridState.sheet; });
      }
      
      // Status filter
      if (gridState.filter && gridState.filter !== 'all') {
        filtered = filtered.filter(function(r) {
          var status = (r.status || '').toLowerCase().replace(/\s+/g, '_');
          return status === gridState.filter;
        });
      }
      
      // Search filter
      if (gridState.search) {
        var searchLower = gridState.search.toLowerCase();
        filtered = filtered.filter(function(r) {
          return Object.values(r).some(function(v) {
            return String(v).toLowerCase().includes(searchLower);
          });
        });
      }
      
      // Deterministic sorting: severity -> identity triplet -> original index
      // Assign stable indices first
      filtered.forEach(function(r, i) { 
        if (r._originalIdx === undefined) {
          r._originalIdx = records.indexOf(r);
        }
      });
      
      filtered.sort(function(a, b) {
        // Severity order: blocking > warning > info
        var sevOrder = { blocking: 0, warning: 1, info: 2 };
        var sevA = sevOrder[(a.severity || 'info').toLowerCase()] || 2;
        var sevB = sevOrder[(b.severity || 'info').toLowerCase()] || 2;
        if (sevA !== sevB) return sevA - sevB;
        
        // Identity triplet
        var ckA = String(a.contract_key || '');
        var ckB = String(b.contract_key || '');
        if (ckA !== ckB) return ckA.localeCompare(ckB);
        
        var fuA = String(a.file_url || '');
        var fuB = String(b.file_url || '');
        if (fuA !== fuB) return fuA.localeCompare(fuB);
        
        var fnA = String(a.file_name || '');
        var fnB = String(b.file_name || '');
        if (fnA !== fnB) return fnA.localeCompare(fnB);
        
        // Fallback to stable original row index
        return (a._originalIdx || 0) - (b._originalIdx || 0);
      });
      
      // Determine columns from workbook sheet or fallback to defaults (v1.4.3 GRID-01)
      var columns = ['contract_key', 'file_name', 'file_url', 'status', 'subtype'];
      var activeSheetName = gridState.sheet || workbook.activeSheet;
      
      if (activeSheetName && workbook.sheets[activeSheetName]) {
        // Use headers from the active sheet
        columns = workbook.sheets[activeSheetName].headers.filter(function(h) {
          return h && h !== '_row_index';
        });
        console.log('[Grid] Using columns from sheet:', activeSheetName, columns.length, 'columns');
      } else if (filtered.length > 0) {
        // Extract columns from first record
        var sampleRow = filtered[0];
        columns = Object.keys(sampleRow).filter(function(k) {
          return k !== '_row_index' && k !== '_originalIdx' && k !== 'sheet';
        });
      }
      
      // Always update visible columns
      gridState.visibleColumns = columns.slice();
      gridState.allColumns = columns.slice();
      
      // Render header
      var headerRow = document.getElementById('grid-header-row');
      headerRow.innerHTML = '<th class="row-index">#</th>' + 
        gridState.visibleColumns.map(function(col) {
          return '<th>' + col.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); }) + '</th>';
        }).join('');
      
      // Render body with virtualization for large datasets
      var tbody = document.getElementById('grid-tbody');
      var VIRTUALIZE_THRESHOLD = 2000;
      var BATCH_SIZE = 100;
      
      if (filtered.length === 0) {
        cleanupGridVirtualization();
        tbody.innerHTML = '<tr><td colspan="' + (gridState.visibleColumns.length + 1) + '" style="text-align: center; padding: 40px; color: #666;">No records match filters</td></tr>';
      } else if (filtered.length > VIRTUALIZE_THRESHOLD) {
        // Virtualized rendering: render first batch and add scroll listener
        renderGridBatch(filtered, 0, BATCH_SIZE, gridState.visibleColumns, true);
        console.log('[Grid] Virtualized render enabled for ' + filtered.length + ' rows');
      } else {
        // Cleanup virtualization when not needed
        cleanupGridVirtualization();
        tbody.innerHTML = filtered.map(function(r, idx) {
          var statusClass = 'status-' + (r.status || '').toLowerCase().replace(/\s+/g, '_');
          return '<tr class="clickable" onclick="openRowReviewDrawer(\'' + (r.contract_key || idx) + '\')">' +
            '<td class="row-index">' + (idx + 1) + '</td>' +
            gridState.visibleColumns.map(function(col) {
              var val = r[col];
              if (val === null || val === undefined) val = '';
              if (typeof val === 'object') val = JSON.stringify(val);
              var cellClass = col === 'status' ? statusClass : '';
              return '<td class="' + cellClass + ' truncated" title="' + String(val).replace(/"/g, '&quot;') + '">' + String(val) + '</td>';
            }).join('') +
            '</tr>';
        }).join('');
      }
      
      // Update footer
      document.getElementById('grid-row-count').textContent = filtered.length + ' of ' + records.length + ' records';
      
      var filterInfo = [];
      if (gridState.sheet) filterInfo.push('Sheet: ' + gridState.sheet);
      if (gridState.filter !== 'all') filterInfo.push('Status: ' + gridState.filter);
      if (gridState.search) filterInfo.push('Search: "' + gridState.search + '"');
      document.getElementById('grid-filter-info').textContent = filterInfo.join(' | ');
      
      // Update per-sheet mini stats
      updateGridSheetStats(records, filtered);
    }
    
    function updateGridSheetStats(allRecords, filtered) {
      // Compute stats for visible/filtered records
      var rowCount = filtered.length;
      var readyCount = 0, reviewCount = 0, blockedCount = 0;
      
      // Use filtered set for counts to match current view
      filtered.forEach(function(r) {
        var status = (r.status || '').toLowerCase().replace(/\s+/g, '_');
        if (status === 'ready') readyCount++;
        else if (status === 'needs_review') reviewCount++;
        else if (status === 'blocked') blockedCount++;
      });
      
      // For total context, also compute from sheet-level (unfiltered by status/search)
      var sheetTotal = gridState.sheet ? 
        allRecords.filter(function(r) { return r.sheet === gridState.sheet; }).length : 
        allRecords.length;
      
      document.querySelector('#grid-stat-rows .stat-value').textContent = rowCount + ' / ' + sheetTotal;
      document.querySelector('#grid-stat-ready .stat-value').textContent = readyCount;
      document.querySelector('#grid-stat-review .stat-value').textContent = reviewCount;
      document.querySelector('#grid-stat-blocked .stat-value').textContent = blockedCount;
      
      // Unknown columns count (admin only - already gated by CSS admin-only-content)
      var unknownCount = getUnknownColumnsCount(gridState.sheet);
      document.querySelector('#grid-stat-unknown .stat-value').textContent = unknownCount;
    }
    
    function getUnknownColumnsCount(sheetName) {
      var unknownCols = JSON.parse(localStorage.getItem('unknown_columns') || '{}');
      if (sheetName && unknownCols[sheetName]) {
        return unknownCols[sheetName].length;
      }
      var total = 0;
      Object.keys(unknownCols).forEach(function(sheet) {
        total += (unknownCols[sheet] || []).length;
      });
      return total;
    }

    function toggleColumnMenu() {
      var menu = document.getElementById('grid-column-menu');
      if (menu.style.display === 'none') {
        // Build checkboxes
        var container = document.getElementById('grid-column-checkboxes');
        container.innerHTML = gridState.allColumns.map(function(col) {
          var checked = gridState.visibleColumns.includes(col) ? 'checked' : '';
          return '<label style="display: block; margin: 4px 0; cursor: pointer;"><input type="checkbox" ' + checked + ' onchange="toggleGridColumn(\'' + col + '\', this.checked)"> ' + 
            col.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); }) + '</label>';
        }).join('');
        menu.style.display = 'block';
      } else {
        menu.style.display = 'none';
      }
    }

    function toggleGridColumn(col, visible) {
      if (visible && !gridState.visibleColumns.includes(col)) {
        gridState.visibleColumns.push(col);
      } else if (!visible) {
        gridState.visibleColumns = gridState.visibleColumns.filter(function(c) { return c !== col; });
      }
      renderGrid();
    }

    // Single Row Review state
    var srrState = {
      currentRecord: null,
      currentRowId: null,
      docPage: 1,
      docTotalPages: 1,
      zoom: 1,
      patchDraft: { observation: '', expected: '', justification: '', repro: '', changes: [], status: 'Draft' }
    };
    
    // V2: Replace with real schema map from config/schema.json
    // Canonical field order for Field Inspector (schema_order_with_fallback)
    var SRR_SCHEMA_ORDER = [
      'contract_key',
      'file_name',
      'file_url',
      'subtype',
      'status',
      'notes',
      'artist',
      'label'
    ];

    function openRowReviewDrawer(rowId) {
      // Find record by contract_key or index
      var record = null;
      var ds = getGridDataset();
      if (ds && ds.sf_contract_results) {
        record = ds.sf_contract_results.find(function(r) {
          return String(r.contract_key) === String(rowId);
        });
        if (!record) {
          var idx = parseInt(rowId, 10);
          if (!isNaN(idx) && idx >= 0 && idx < ds.sf_contract_results.length) {
            record = ds.sf_contract_results[idx];
          }
        }
      }
      
      if (!record) {
        showToast('Record not found: ' + rowId, 'warning');
        return;
      }
      
      // Store in state and navigate to Single Row Review page
      srrState.currentRecord = record;
      srrState.currentRowId = rowId;
      
      // Navigate to page and render
      navigateTo('row');
      renderSingleRowReview(record, rowId);
      
      // Update URL
      history.pushState(null, '', '#/row/' + rowId);
    }
    
    function renderSingleRowReview(record, rowId) {
      // Update top bar
      document.getElementById('srr-record-id').textContent = record.contract_key || rowId || 'â€”';
      var stateBadge = document.getElementById('srr-state-badge');
      var status = (record.status || 'unknown').toLowerCase().replace(/\s+/g, '_');
      stateBadge.textContent = record.status || 'Unknown';
      stateBadge.className = 'srr-state-badge ' + status;
      
      // Render Field Inspector
      renderSrrFields(record);
      
      // Clear Evidence Pack textareas (or load from draft)
      document.getElementById('srr-observation').value = srrState.patchDraft.observation || '';
      document.getElementById('srr-expected').value = srrState.patchDraft.expected || '';
      document.getElementById('srr-justification').value = srrState.patchDraft.justification || '';
      document.getElementById('srr-repro').value = srrState.patchDraft.repro || '';
      
      // Render patch changes list
      renderSrrPatchList();
    }
    
    function renderSrrFields(record) {
      var container = document.getElementById('srr-field-list');
      if (!record) {
        container.innerHTML = '<div class="srr-empty-state">No fields loaded</div>';
        document.getElementById('srr-field-count').textContent = '0 fields';
        return;
      }
      
      // Canonical field ordering: schema order (primary), alphabetical fallback (secondary)
      var allKeys = Object.keys(record).filter(function(k) {
        return !k.startsWith('_');
      });
      
      // Partition into schema-ordered and unknown fields
      var schemaKeys = [];
      var unknownKeys = [];
      allKeys.forEach(function(k) {
        if (SRR_SCHEMA_ORDER.indexOf(k) >= 0) {
          schemaKeys.push(k);
        } else {
          unknownKeys.push(k);
        }
      });
      
      // Sort schema keys by schema order, unknown keys alphabetically
      schemaKeys.sort(function(a, b) {
        return SRR_SCHEMA_ORDER.indexOf(a) - SRR_SCHEMA_ORDER.indexOf(b);
      });
      unknownKeys.sort();
      
      // Final order: schema fields first, then unknown fields
      var keys = schemaKeys.concat(unknownKeys);
      
      document.getElementById('srr-field-count').textContent = keys.length + ' fields';
      
      var html = keys.map(function(key, idx) {
        var val = record[key];
        if (val === null || val === undefined) val = '';
        if (typeof val === 'object') val = JSON.stringify(val);
        var displayVal = String(val).substring(0, 30) + (String(val).length > 30 ? '...' : '');
        
        // Determine indicators (stub logic)
        var indicators = '<span class="srr-indicator system" title="System-derived">S</span>';
        if (key === 'status' || key === 'notes') {
          indicators = '<span class="srr-indicator delta" title="User-modified">Î”</span>';
        }
        
        return '<div class="srr-field-item" data-field="' + key + '" onclick="srrSelectField(\'' + key + '\')">' +
          '<div class="srr-field-name">' + key + '</div>' +
          '<div class="srr-field-value" title="' + String(val).replace(/"/g, '&quot;') + '">' + displayVal + '</div>' +
          '<div class="srr-field-indicators">' + indicators + '</div>' +
        '</div>';
      }).join('');
      
      container.innerHTML = html || '<div class="srr-empty-state">No fields loaded</div>';
    }
    
    function srrSelectField(fieldKey) {
      // Highlight selected field
      document.querySelectorAll('.srr-field-item').forEach(function(el) {
        el.classList.remove('active');
      });
      var selected = document.querySelector('.srr-field-item[data-field="' + fieldKey + '"]');
      if (selected) selected.classList.add('active');
      
      srrState.selectedField = fieldKey;
      
      // Update document viewer highlight placeholder
      srrUpdateViewerHighlight(fieldKey);
      
      // Update evidence anchors list
      srrUpdateAnchorList(fieldKey);
      
      console.log('[SRR] Selected field: ' + fieldKey);
    }
    
    function srrUpdateViewerHighlight(fieldKey) {
      var docFrame = document.getElementById('srr-doc-frame');
      
      // Remove existing overlays
      docFrame.querySelectorAll('.srr-anchor-overlay').forEach(function(el) { el.remove(); });
      
      // If no field selected, show default state
      if (!fieldKey) {
        docFrame.innerHTML = '<div style="text-align: center;">' +
          '<div style="font-size: 3em; margin-bottom: 10px;">ðŸ“„</div>' +
          '<div>No document attached</div>' +
          '<div style="font-size: 0.85em; color: #999; margin-top: 8px;">PDF viewer stub â€” attach documents via Data Source</div>' +
        '</div>';
        return;
      }
      
      // Show highlight placeholder for selected field
      docFrame.innerHTML = '<div style="text-align: center;">' +
        '<div style="font-size: 2.5em; margin-bottom: 10px;">ðŸ”</div>' +
        '<div style="font-weight: 600; color: #1565c0;">Viewing: ' + fieldKey + '</div>' +
        '<div style="font-size: 0.85em; color: #666; margin-top: 8px;">Evidence anchor would appear here</div>' +
        '<div style="margin-top: 16px; padding: 12px; background: rgba(21, 101, 192, 0.1); border: 2px dashed #1565c0; border-radius: 8px;">' +
          '<div style="font-size: 0.8em; color: #1565c0;">ðŸ“Ž Anchor Placeholder</div>' +
          '<div style="font-size: 0.75em; color: #666; margin-top: 4px;">Page 1, Bbox: [0.2, 0.3, 0.6, 0.1]</div>' +
        '</div>' +
      '</div>';
    }
    
    function srrUpdateAnchorList(fieldKey) {
      var container = document.getElementById('srr-anchor-list');
      
      if (!fieldKey) {
        container.innerHTML = '<div style="font-size: 0.8em; font-weight: 600; color: #666; margin-bottom: 8px;">Evidence Anchors</div>' +
          '<div class="srr-empty-state" style="padding: 10px;">No anchors defined</div>';
        return;
      }
      
      // Stub anchor for selected field
      container.innerHTML = '<div style="font-size: 0.8em; font-weight: 600; color: #666; margin-bottom: 8px;">Evidence Anchors for: ' + fieldKey + '</div>' +
        '<div class="srr-anchor-item" onclick="srrJumpToAnchor(\'' + fieldKey + '\', 0)">' +
          '<div style="font-weight: 500;">' + fieldKey + ' â€” Source</div>' +
          '<div style="font-size: 0.75em; color: #888;">Page 1 â€¢ Click to highlight</div>' +
        '</div>';
    }
    
    function srrJumpToAnchor(fieldKey, anchorIdx) {
      console.log('[SRR] Jumping to anchor: ' + fieldKey + ', index: ' + anchorIdx);
      showToast('Anchor navigation: ' + fieldKey, 'info');
    }
    
    function renderSrrPatchList() {
      var container = document.getElementById('srr-patch-list');
      var changes = srrState.patchDraft.changes || [];
      var patchStatus = srrState.patchDraft.status || 'Draft';
      
      if (changes.length === 0) {
        container.innerHTML = '<div class="srr-empty-state" style="padding: 12px;">No changes proposed yet</div>';
        return;
      }
      
      // Status-based badge styling
      var statusBadge = patchStatus === 'Submitted' 
        ? '<span class="srr-patch-status submitted">Submitted</span>'
        : '<span class="srr-patch-status draft">Draft</span>';
      
      var html = '<div class="srr-patch-header">Patches ' + statusBadge + '</div>';
      html += changes.map(function(c, idx) {
        return '<div class="srr-patch-item">' +
          '<div class="srr-patch-path">' + (c.path || 'field') + '</div>' +
          '<div class="srr-patch-change">' +
            '<span class="srr-patch-before">' + (c.before || 'â€”') + '</span>' +
            '<span>â†’</span>' +
            '<span class="srr-patch-after">' + (c.after || 'â€”') + '</span>' +
          '</div>' +
        '</div>';
      }).join('');
      
      container.innerHTML = html;
    }
    
    // Document Viewer stubs
    function srrPrevPage() {
      if (srrState.docPage > 1) {
        srrState.docPage--;
        document.getElementById('srr-doc-page').textContent = 'Page ' + srrState.docPage + ' of ' + srrState.docTotalPages;
      }
    }
    
    function srrNextPage() {
      if (srrState.docPage < srrState.docTotalPages) {
        srrState.docPage++;
        document.getElementById('srr-doc-page').textContent = 'Page ' + srrState.docPage + ' of ' + srrState.docTotalPages;
      }
    }
    
    function srrZoomIn() {
      srrState.zoom = Math.min(srrState.zoom + 0.25, 3);
      console.log('[SRR] Zoom: ' + (srrState.zoom * 100) + '%');
    }
    
    function srrZoomOut() {
      srrState.zoom = Math.max(srrState.zoom - 0.25, 0.5);
      console.log('[SRR] Zoom: ' + (srrState.zoom * 100) + '%');
    }
    
    // Patch actions
    function srrSaveDraft() {
      srrState.patchDraft.observation = document.getElementById('srr-observation').value;
      srrState.patchDraft.expected = document.getElementById('srr-expected').value;
      srrState.patchDraft.justification = document.getElementById('srr-justification').value;
      srrState.patchDraft.repro = document.getElementById('srr-repro').value;
      
      // Emit audit event (stub)
      console.log('[SRR] PATCH_DRAFTED:', srrState.patchDraft);
      showToast('Patch Draft saved', 'success');
    }
    
    function srrSubmitPatchRequest() {
      // Save current values
      srrSaveDraft();
      
      // Validate Evidence Pack has content
      if (!srrState.patchDraft.observation && !srrState.patchDraft.expected) {
        showToast('Please fill in Observation and Expected blocks', 'warning');
        return;
      }
      
      // Set patch status to Submitted (does NOT affect Review State)
      srrState.patchDraft.status = 'Submitted';
      renderSrrPatchList();
      
      // Emit audit events (stub)
      console.log('[SRR] PATCH_SUBMITTED:', srrState.patchDraft);
      console.log('[SRR] REVIEW_REQUESTED: patch_id=' + (srrState.currentRowId || 'new'));
      
      showToast('Patch Request submitted â€” sent to Verifier Review', 'success');
    }
    
    function showAuditLogForRecord() {
      showToast('Audit Log view coming soon', 'info');
      console.log('[SRR] Opening audit log for record: ' + srrState.currentRowId);
    }

    // Attach Grid event listeners
    document.addEventListener('DOMContentLoaded', function() {
      var gridSearch = document.getElementById('grid-search');
      if (gridSearch) {
        gridSearch.addEventListener('input', function() {
          gridState.search = gridSearch.value;
          updateGridURL();
          renderGrid();
        });
      }
    });
    var gridVirtualState = { data: [], rendered: 0, columns: [], active: false };
    
    function cleanupGridVirtualization() {
      var container = document.querySelector('.grid-table-container');
      if (container) {
        container.removeEventListener('scroll', gridLazyLoadHandler);
      }
      gridVirtualState.active = false;
    }
    
    function renderGridBatch(data, startIdx, batchSize, columns, isFirst) {
      var tbody = document.getElementById('grid-tbody');
      if (isFirst) {
        cleanupGridVirtualization();
        tbody.innerHTML = '';
        gridVirtualState = { data: data, rendered: 0, columns: columns, active: true };
        // Add scroll listener for lazy loading
        var container = document.querySelector('.grid-table-container');
        if (container) {
          container.addEventListener('scroll', gridLazyLoadHandler);
        }
      }
      
      var endIdx = Math.min(startIdx + batchSize, data.length);
      var fragment = document.createDocumentFragment();
      
      for (var idx = startIdx; idx < endIdx; idx++) {
        var r = data[idx];
        var tr = document.createElement('tr');
        tr.className = 'clickable';
        tr.onclick = (function(ck, i) { return function() { openRowReviewDrawer(ck || i); }; })(r.contract_key, idx);
        
        var statusClass = 'status-' + (r.status || '').toLowerCase().replace(/\s+/g, '_');
        tr.innerHTML = '<td class="row-index">' + (idx + 1) + '</td>' +
          columns.map(function(col) {
            var val = r[col];
            if (val === null || val === undefined) val = '';
            if (typeof val === 'object') val = JSON.stringify(val);
            var cellClass = col === 'status' ? statusClass : '';
            return '<td class="' + cellClass + ' truncated" title="' + String(val).replace(/"/g, '&quot;') + '">' + String(val) + '</td>';
          }).join('');
        
        fragment.appendChild(tr);
      }
      
      tbody.appendChild(fragment);
      gridVirtualState.rendered = endIdx;
    }
    
    function gridLazyLoadHandler() {
      var container = document.querySelector('.grid-table-container');
      if (!container || gridVirtualState.rendered >= gridVirtualState.data.length) return;
      
      var scrollTop = container.scrollTop;
      var scrollHeight = container.scrollHeight;
      var clientHeight = container.clientHeight;
      
      // Load more when near bottom (within 200px)
      if (scrollTop + clientHeight >= scrollHeight - 200) {
        renderGridBatch(gridVirtualState.data, gridVirtualState.rendered, 100, gridVirtualState.columns, false);
      }
    }
    
    // ============================================================
    // END GRID FUNCTIONS
    
    // ============================================================
    // UNKNOWN COLUMNS FUNCTIONS (v1.4.4)
    // ============================================================
    
    var CANONICAL_FIELDS = ['contract_key', 'file_name', 'file_url', 'status', 'subtype', 'severity', 'sheet', 'notes'];
    
    function detectUnknownColumns(records, sheetName) {
      if (!records || records.length === 0) return [];
      
      var unknownCols = [];
      var seenCols = new Set();
      
      records.forEach(function(record) {
        Object.keys(record).forEach(function(key) {
          if (seenCols.has(key)) return;
          seenCols.add(key);
          
          var normalized = normalizeColumnName(key);
          if (!CANONICAL_FIELDS.includes(normalized) && !key.startsWith('_')) {
            var sampleValues = [];
            var nonEmptyCount = 0;
            
            records.slice(0, 20).forEach(function(r) {
              var val = r[key];
              if (val !== null && val !== undefined && val !== '') {
                nonEmptyCount++;
                if (sampleValues.length < 3) sampleValues.push(String(val).substring(0, 50));
              }
            });
            
            unknownCols.push({
              original_name: key,
              normalized_name: normalized,
              sample_values: sampleValues,
              count_nonempty: nonEmptyCount,
              suggested_canonical: null,
              decision: null
            });
          }
        });
      });
      
      // Store in localStorage
      var stored = JSON.parse(localStorage.getItem('unknown_columns') || '{}');
      stored[sheetName || '_default'] = unknownCols;
      localStorage.setItem('unknown_columns', JSON.stringify(stored));
      
      return unknownCols;
    }
    
    function normalizeColumnName(name) {
      return String(name).toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
    }
    
    function refreshUnknownColumnsTable() {
      var tbody = document.getElementById('unknown-cols-tbody');
      var stored = JSON.parse(localStorage.getItem('unknown_columns') || '{}');
      var decisions = JSON.parse(localStorage.getItem('unknown_columns_decisions') || '{}');
      
      var allCols = [];
      Object.keys(stored).forEach(function(sheet) {
        (stored[sheet] || []).forEach(function(col) {
          col.sheet = sheet;
          col.decision = decisions[sheet + '::' + col.original_name] || null;
          allCols.push(col);
        });
      });
      
      if (allCols.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #888;">No unknown columns detected</td></tr>';
        return;
      }
      
      tbody.innerHTML = allCols.map(function(col) {
        var key = col.sheet + '::' + col.original_name;
        var actionHtml = '<select onchange="setUnknownColumnDecision(\'' + key.replace(/'/g, "\\'") + '\', this.value)" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc;">' +
          '<option value=""' + (!col.decision ? ' selected' : '') + '>-- Select --</option>' +
          '<option value="add_global"' + (col.decision === 'add_global' ? ' selected' : '') + '>Add to Global Standard</option>' +
          '<option value="source_specific"' + (col.decision === 'source_specific' ? ' selected' : '') + '>Mark Source-Specific</option>' +
          '<option value="ignore"' + (col.decision === 'ignore' ? ' selected' : '') + '>Ignore</option>' +
          '</select>';
        
        return '<tr>' +
          '<td style="padding: 8px; border-bottom: 1px solid #eee;">' + col.sheet + '</td>' +
          '<td style="padding: 8px; border-bottom: 1px solid #eee; font-family: monospace;">' + col.original_name + '</td>' +
          '<td style="padding: 8px; border-bottom: 1px solid #eee; font-family: monospace; color: #666;">' + col.normalized_name + '</td>' +
          '<td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 0.85em; color: #888;">' + col.sample_values.join(', ') + '</td>' +
          '<td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">' + col.count_nonempty + '</td>' +
          '<td style="padding: 8px; border-bottom: 1px solid #eee;">' + actionHtml + '</td>' +
          '</tr>';
      }).join('');
      
      updateUnknownColumnsDecisionsDisplay();
    }
    
    function setUnknownColumnDecision(key, decision) {
      var decisions = JSON.parse(localStorage.getItem('unknown_columns_decisions') || '{}');
      if (decision) {
        decisions[key] = decision;
      } else {
        delete decisions[key];
      }
      localStorage.setItem('unknown_columns_decisions', JSON.stringify(decisions));
      updateUnknownColumnsDecisionsDisplay();
    }
    
    function updateUnknownColumnsDecisionsDisplay() {
      var container = document.getElementById('unknown-cols-decisions');
      var decisions = JSON.parse(localStorage.getItem('unknown_columns_decisions') || '{}');
      var keys = Object.keys(decisions);
      
      if (keys.length === 0) {
        container.innerHTML = '<em style="color: #888;">No decisions made yet.</em>';
        return;
      }
      
      var html = keys.map(function(key) {
        var parts = key.split('::');
        return '<div style="margin-bottom: 4px;"><span style="color: #1976d2;">' + parts[0] + '</span>.<span style="color: #333;">' + parts[1] + '</span> â†’ <span style="color: #2e7d32;">' + decisions[key] + '</span></div>';
      }).join('');
      
      container.innerHTML = html;
    }
    
    function exportUnknownColumnsRequest() {
      var decisions = JSON.parse(localStorage.getItem('unknown_columns_decisions') || '{}');
      var stored = JSON.parse(localStorage.getItem('unknown_columns') || '{}');
      
      var requests = [];
      Object.keys(decisions).forEach(function(key) {
        var parts = key.split('::');
        var sheet = parts[0];
        var colName = parts[1];
        var decision = decisions[key];
        
        var colData = null;
        if (stored[sheet]) {
          colData = stored[sheet].find(function(c) { return c.original_name === colName; });
        }
        
        requests.push({
          request_id: 'SUR_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8),
          timestamp_utc: new Date().toISOString(),
          sheet: sheet,
          canonical_field_name: colData ? colData.normalized_name : normalizeColumnName(colName),
          source_aliases: [colName],
          classification: decision,
          source_tag_optional: decision === 'source_specific' ? sheet : null
        });
      });
      
      var artifact = {
        type: 'standard_update_request',
        version: '1.0',
        generated_at: new Date().toISOString(),
        requests: requests
      };
      
      var json = JSON.stringify(artifact, null, 2);
      navigator.clipboard.writeText(json).then(function() {
        showToast('Standard update request copied to clipboard (' + requests.length + ' items)');
      });
      
      localStorage.setItem('last_standard_update_request', json);
    }
    
    function clearUnknownColumnsDecisions() {
      if (confirm('Clear all pending decisions?')) {
        localStorage.removeItem('unknown_columns_decisions');
        refreshUnknownColumnsTable();
        showToast('Decisions cleared');
      }
    }
    
    // ============================================================
    // END UNKNOWN COLUMNS FUNCTIONS
    // ============================================================
    // ============================================================

    // v1.4.5: updateLoaderModalUI removed - logic moved to updateUIForDataState()
    
    function setupLoaderModalEvents() {
      var fileInput = document.getElementById('loader-drawer-file');
      if (fileInput) {
        fileInput.addEventListener('change', function(e) {
          var file = e.target.files[0];
          if (file) {
            handleFileImport(file);
          }
        });
      }
      
      // Drop zone
      var dropzone = document.getElementById('loader-drawer-dropzone');
      if (dropzone) {
        dropzone.addEventListener('dragover', function(e) {
          e.preventDefault();
          dropzone.classList.add('drag-over');
        });
        dropzone.addEventListener('dragleave', function() {
          dropzone.classList.remove('drag-over');
        });
        dropzone.addEventListener('drop', function(e) {
          e.preventDefault();
          dropzone.classList.remove('drag-over');
          var file = e.dataTransfer.files[0];
          if (file) {
            handleFileImport(file);
          }
        });
      }
      
      // Sample button
      var sampleBtn = document.getElementById('btn-load-sample-drawer');
      if (sampleBtn) {
        sampleBtn.addEventListener('click', function() {
          loadSampleDataset({ autoRedirect: false });
          closeLoaderModal();
          navigateTo('grid');
        });
      }
    }
    
    // v1.4.4: Unified file import handler with validation
    function handleFileImport(file) {
      hideLoaderError();
      
      // Check file extension
      var ext = (file.name.split('.').pop() || '').toLowerCase();
      
      if (ext === 'xlsx' || ext === 'xls') {
        showLoaderError('XLSX files are not yet supported. Please convert to CSV and try again.');
        return;
      }
      
      if (ext !== 'csv') {
        showLoaderError('Unsupported file type: .' + ext + '. Please use a CSV file.');
        return;
      }
      
      // Handle CSV import with post-load navigation
      handleCSVImport(file, function() {
        // Validate workbook state before closing modal
        if (!validateWorkbookState()) {
          showLoaderError('Import completed but no data was loaded. Please check the file format.');
          return;
        }
        closeLoaderModal();
        navigateTo('grid');
      });
    }
    
    function showLoaderError(message) {
      var errorEl = document.getElementById('loader-error-display');
      var msgEl = document.getElementById('loader-error-message');
      if (errorEl && msgEl) {
        msgEl.textContent = message;
        errorEl.style.display = 'block';
      }
      console.error('[Loader] Error:', message);
    }
    
    function hideLoaderError() {
      var errorEl = document.getElementById('loader-error-display');
      if (errorEl) errorEl.style.display = 'none';
    }
    
    function validateWorkbookState() {
      // v1.4.4 FIX-01: Validate workbook invariants with specific error messages
      if (!workbook.order || workbook.order.length === 0) {
        console.error('[Loader] Validation failed: workbook.order is empty');
        showLoaderError('No sheets detected in file. Please check the file format.');
        return false;
      }
      if (!workbook.activeSheet || !workbook.sheets[workbook.activeSheet]) {
        console.error('[Loader] Validation failed: activeSheet not in sheets');
        showLoaderError('Active sheet not set correctly. Internal error - please try again.');
        return false;
      }
      var sheet = workbook.sheets[workbook.activeSheet];
      if (!sheet.headers || !Array.isArray(sheet.headers)) {
        console.error('[Loader] Validation failed: headers missing or invalid');
        showLoaderError('No headers detected in file. Please ensure the first row contains column headers.');
        return false;
      }
      if (sheet.headers.length === 0) {
        console.error('[Loader] Validation failed: headers array is empty');
        showLoaderError('Empty header row detected. Please ensure the first row contains column headers.');
        return false;
      }
      // Ensure rows array exists (can be empty but must exist)
      if (!Array.isArray(sheet.rows)) {
        sheet.rows = [];
      }
      console.log('[Loader] Validation passed: order=' + workbook.order.length + ', activeSheet=' + workbook.activeSheet + ', headers=' + sheet.headers.length + ', rows=' + sheet.rows.length);
      return true;
    }
    
    // Demo mode flag
    var DEMO_MODE_KEY = 'orchestrate.demo_mode';
    function isDemoMode() {
      var stored = localStorage.getItem(DEMO_MODE_KEY);
      return stored === null ? true : stored === 'true'; // Default to true
    }
    
    function setDemoMode(enabled) {
      localStorage.setItem(DEMO_MODE_KEY, enabled ? 'true' : 'false');
    }
    
    // Record Drawer functions
    let currentRecordIndex = -1;
    let filteredContracts = [];
    
    function openRecordDrawer(contractKey, index, contracts) {
      filteredContracts = contracts || allData.contractResults || [];
      currentRecordIndex = index >= 0 ? index : filteredContracts.findIndex(c => 
        (c.contract_key || c.file_name) === contractKey
      );
      
      if (currentRecordIndex < 0) return;
      renderRecordDrawer();
      document.getElementById('record-drawer').classList.add('active');
    }
    
    function closeRecordDrawer() {
      document.getElementById('record-drawer').classList.remove('active');
    }
    
    function navigateRecord(direction) {
      const newIndex = currentRecordIndex + direction;
      if (newIndex >= 0 && newIndex < filteredContracts.length) {
        currentRecordIndex = newIndex;
        renderRecordDrawer();
      }
    }
    
    function renderRecordDrawer() {
      const contract = filteredContracts[currentRecordIndex];
      if (!contract) return;
      
      const titleEl = document.getElementById('record-drawer-title');
      const contentEl = document.getElementById('record-drawer-content');
      const posEl = document.getElementById('record-drawer-position');
      const prevBtn = document.getElementById('record-drawer-prev');
      const nextBtn = document.getElementById('record-drawer-next');
      
      const key = contract.contract_key || contract.file_name || 'Unknown';
      titleEl.textContent = key;
      posEl.textContent = `${currentRecordIndex + 1} / ${filteredContracts.length}`;
      prevBtn.disabled = currentRecordIndex <= 0;
      nextBtn.disabled = currentRecordIndex >= filteredContracts.length - 1;
      
      // Find related issues and field actions
      const joinKey = getJoinKey(contract);
      const issues = (allData.issues || []).filter(i => getJoinKey(i) === joinKey);
      const actions = (allData.fieldActions || []).filter(a => getJoinKey(a) === joinKey);
      
      const statusColor = {
        'ready': '#4caf50',
        'needs_review': '#ff9800',
        'blocked': '#f44336'
      }[contract.sf_contract_status?.toLowerCase()] || '#757575';
      
      let html = `
        <div style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 500;">
              ${contract.sf_contract_status || 'unknown'}
            </span>
            ${contract.detected_subtype ? `<span style="background: #e0e0e0; padding: 4px 10px; border-radius: 10px; font-size: 0.8em;">${typeof contract.detected_subtype === 'object' ? contract.detected_subtype.value : contract.detected_subtype}</span>` : ''}
          </div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <h4 style="margin: 0 0 10px 0; color: #333; font-size: 0.9em; text-transform: uppercase;">Identity</h4>
          <table style="width: 100%; font-size: 0.9em; border-collapse: collapse;">
            <tr><td style="padding: 6px 0; color: #666; width: 100px;">Contract Key</td><td style="padding: 6px 0;">${contract.contract_key || '(none)'}</td></tr>
            <tr><td style="padding: 6px 0; color: #666;">File Name</td><td style="padding: 6px 0;">${contract.file_name || '(none)'}</td></tr>
            <tr><td style="padding: 6px 0; color: #666;">File URL</td><td style="padding: 6px 0; word-break: break-all;">${contract.file_url || '(none)'}</td></tr>
          </table>
        </div>
      `;
      
      if (issues.length > 0) {
        html += `
          <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #333; font-size: 0.9em; text-transform: uppercase;">Issues (${issues.length})</h4>
            <div style="display: flex; flex-direction: column; gap: 8px;">
        `;
        issues.forEach(issue => {
          const sevColor = { blocking: '#f44336', warning: '#ff9800', info: '#2196f3' }[issue.severity] || '#757575';
          html += `
            <div style="background: #f5f5f5; padding: 10px; border-radius: 6px; border-left: 3px solid ${sevColor};">
              <div style="font-weight: 500; margin-bottom: 4px;">${issue.issue_type || 'Unknown Issue'}</div>
              <div style="font-size: 0.85em; color: #666;">${issue.sheet || ''} ${issue.field ? '/ ' + issue.field : ''}</div>
              ${issue.details ? `<div style="font-size: 0.85em; margin-top: 6px;">${issue.details}</div>` : ''}
            </div>
          `;
        });
        html += '</div></div>';
      }
      
      if (actions.length > 0) {
        html += `
          <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #333; font-size: 0.9em; text-transform: uppercase;">Field Actions (${actions.length})</h4>
            <div style="display: flex; flex-direction: column; gap: 6px;">
        `;
        actions.forEach(action => {
          html += `
            <div style="background: #e3f2fd; padding: 8px 10px; border-radius: 4px; font-size: 0.85em;">
              <strong>${action.action || 'action'}</strong>: ${action.sheet || ''}/${action.field || ''} ${action.proposed_value ? '= ' + action.proposed_value : ''}
              ${action.reason_text ? `<div style="color: #666; margin-top: 4px;">${action.reason_text}</div>` : ''}
            </div>
          `;
        });
        html += '</div></div>';
      }
      
      if (issues.length === 0 && actions.length === 0) {
        html += `<p style="color: #999; font-style: italic;">No issues or field actions for this contract.</p>`;
      }
      
      // Comments section
      const recordComments = getCommentsByTarget('record', key);
      html += `
        <div style="margin-bottom: 20px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="margin: 0; color: #333; font-size: 0.9em; text-transform: uppercase;">Comments (${recordComments.length})</h4>
            <button class="toolbar-btn" style="padding: 4px 10px; font-size: 0.8em;" onclick="openAddCommentModal('record', '${escapeHtml(key)}')">+ Add Comment</button>
          </div>
      `;
      
      if (recordComments.length > 0) {
        html += '<div style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto;">';
        recordComments.forEach(c => {
          const statusColors = {
            'Open': { bg: '#e3f2fd', border: '#1976d2' },
            'ReviewerResponded': { bg: '#fff3e0', border: '#e65100' },
            'Resolved': { bg: '#e8f5e9', border: '#388e3c' },
            'ElevatedToPatchRequest': { bg: '#ede7f6', border: '#5e35b1' },
            'Closed': { bg: '#f5f5f5', border: '#757575' }
          }[c.status] || { bg: '#f5f5f5', border: '#757575' };
          
          const date = new Date(c.created_at_utc).toLocaleDateString();
          var elevateBtn = c.status === 'Resolved' ? '<button class="toolbar-btn" style="padding: 2px 8px; font-size: 0.75em;" onclick="elevateCommentToPatchRequest(\'' + c.comment_id + '\')">Elevate to Patch</button>' : '';
          var resolveBtn = c.status === 'Open' ? '<button class="toolbar-btn" style="padding: 2px 8px; font-size: 0.75em;" onclick="resolveCommentById(\'' + c.comment_id + '\')">Resolve</button>' : '';
          html += '<div style="background: ' + statusColors.bg + '; padding: 10px; border-radius: 6px; border-left: 3px solid ' + statusColors.border + ';">' +
            '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">' +
            '<span style="font-weight: 500; font-size: 0.85em;">' + c.status + '</span>' +
            '<span style="font-size: 0.75em; color: #666;">' + date + '</span>' +
            '</div>' +
            '<div style="font-size: 0.9em;">' + escapeHtml(c.content) + '</div>' +
            '<div style="margin-top: 8px; display: flex; gap: 6px;">' + elevateBtn + resolveBtn + '</div>' +
            '</div>';
        });
        html += '</div>';
      } else {
        html += '<p style="color: #999; font-style: italic; font-size: 0.85em;">No comments for this record.</p>';
      }
      html += '</div>';
      
      contentEl.innerHTML = html;
    }
    
    function showEvidenceStatus() {
      // Navigate to patch studio to show preflight status
      navigateTo('patch');
      const preflightToggle = document.getElementById('preflight-toggle');
      if (preflightToggle) preflightToggle.click();
    }
    
    // Settings Management
    function loadUserSettings() {
      try {
        const saved = localStorage.getItem(SETTINGS_STORAGE_KEY);
        if (saved) {
          userSettings = { ...DEFAULT_SETTINGS, ...JSON.parse(saved) };
        }
      } catch (e) {
        console.warn('Failed to load user settings:', e);
      }
    }
    
    function saveUserSettings() {
      try {
        localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(userSettings));
      } catch (e) {
        console.warn('Failed to save user settings:', e);
      }
    }
    
    function checkFirstRun() {
      const dismissed = localStorage.getItem(FIRST_RUN_DISMISSED_KEY);
      const banner = document.getElementById('first-run-banner');
      
      // Show banner if: not configured AND not dismissed
      if (!userSettings.configured && !dismissed && banner) {
        banner.style.display = 'flex';
      }
    }
    
    function dismissFirstRunBanner() {
      const banner = document.getElementById('first-run-banner');
      if (banner) banner.style.display = 'none';
      localStorage.setItem(FIRST_RUN_DISMISSED_KEY, 'true');
    }
    
    async function autoSetupRepoMasters() {
      // Auto-load Repo Masters (dev baseline) when present
      if (!userSettings.use_repo_masters) return;
      
      try {
        const response = await fetch(RELATIVE_PRIMARY);
        if (response.ok) {
          const data = await response.json();
          if (data.sf_summary || data.sf_contract_results) {
            allData.contractResults = data.sf_contract_results || [];
            allData.issues = data.sf_issues || [];
            allData.fieldActions = data.sf_field_actions || [];
            allData.summary = data.sf_summary || {};
            allData.changeLog = data.changelog || [];
            dataLoaded = true;
            sessionState = { status: 'loaded', sourceType: 'fetch', loadedAt: new Date().toISOString() };
            currentArtifactPath = RELATIVE_PRIMARY;
            updateUIForDataState();
            renderSummary();
            renderAllTables();
            updateQueueCounts();
          }
        }
      } catch (e) {
        // Silently fail - user can manually load data
      }
    }
    
    let currentWizardStep = 0;
    const WIZARD_STEPS = [
      { id: 'WELCOME', title: 'Welcome' },
      { id: 'DATA_SOURCES', title: 'Data Sources' },
      { id: 'WORKFLOW_DEFAULTS', title: 'Workflow Defaults' },
      { id: 'DONE', title: 'Finish' }
    ];
    
    function openConfigureWizard() {
      currentWizardStep = 0;
      document.getElementById('configure-wizard-modal').classList.add('active');
      renderConfigureWizardStep(0);
    }
    
    function closeConfigureWizard() {
      document.getElementById('configure-wizard-modal').classList.remove('active');
    }
    
    // Config Flows Panel
    let currentConfigFlowStage = 'data_sources';
    let currentConfigFlowTab = 'plain-english';
    let masterEditMode = false;
    let masterDraft = {};
    let sessionConfig = {};
    let configHistory = [];
    
    const CONFIG_FLOW_STAGES = {
      data_sources: {
        title: 'Data Sources',
        desc: 'Configure where Preview and Reference packets are loaded from.',
        plainEnglish: `<p>This stage controls how data enters the system.</p>
          <p style="margin-top: 10px;"><strong>What it does:</strong> Defines the primary and comparison data sources for your session.</p>
          <ul style="margin: 10px 0 0 20px;">
            <li><strong>Repo Masters</strong> - Auto-load from repository (recommended for dev)</li>
            <li><strong>Paste JSON</strong> - Manual paste of Preview Packet data</li>
            <li><strong>Drag & Drop</strong> - Upload a file directly</li>
            <li><strong>Local Path Hint</strong> - Reference files by path</li>
          </ul>`
      },
      dataset_mapping: {
        title: 'Dataset Mapping',
        desc: 'Define how input sheets map to semantic entities.',
        plainEnglish: '<p>Maps incoming data columns to semantic fields. Ensures consistent naming across sources.</p>'
      },
      standardization: {
        title: 'Standardization',
        desc: 'Normalize data formats and values.',
        plainEnglish: '<p>Applies formatting rules to ensure data consistency (dates, currencies, text casing).</p>'
      },
      ruleset: {
        title: 'Ruleset',
        desc: 'WHEN/THEN rules that determine field actions and issues.',
        plainEnglish: '<p>The heart of semantic governance. Rules define:</p><ul style="margin: 10px 0 0 20px;"><li>When a condition is met (WHEN)</li><li>What action to take (THEN)</li><li>Severity level (info, warning, blocking)</li></ul>'
      },
      validation_gates: {
        title: 'Validation Gates',
        desc: 'Preflight checks before data can proceed.',
        plainEnglish: '<p>Evidence gates that must pass before publishing:</p><ul style="margin: 10px 0 0 20px;"><li>Validation: Schema and format checks</li><li>Conflicts: No duplicate or conflicting rules</li><li>Smoke Baseline: Expected output matches</li></ul>'
      },
      patch_generation: {
        title: 'Patch Generation',
        desc: 'Configure how patches are built from field actions.',
        plainEnglish: '<p>Controls how proposed fixes are packaged into patch format for review.</p>'
      },
      smoke_baselines: {
        title: 'Smoke Baselines',
        desc: 'Reference outputs for determinism checks.',
        plainEnglish: '<p>Golden files that define expected outputs. Used to verify changes don\'t break existing behavior.</p>'
      },
      export: {
        title: 'Export / PR Summary',
        desc: 'Bundle outputs for pull request review.',
        plainEnglish: '<p>Generate exportable bundles with:</p><ul style="margin: 10px 0 0 20px;"><li>Patch file</li><li>Changelog entry</li><li>Evidence summary</li><li>PR description template</li></ul>'
      }
    };
    
    function openConfigFlows() {
      if (currentMode !== 'admin') {
        alert('Config Flows requires Admin mode.');
        return;
      }
      document.getElementById('config-flows-drawer').classList.add('active');
      selectConfigFlowStage('data_sources');
    }
    
    function closeConfigFlows() {
      document.getElementById('config-flows-drawer').classList.remove('active');
      masterEditMode = false;
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    function getMasterConfig(stage) {
      if (sessionConfig[stage]) return sessionConfig[stage];
      const defaults = {
        data_sources: { stage: 'data_sources', version: '1.0.0', sources: ['sf_packet.preview.json'] },
        field_mapping: { stage: 'field_mapping', version: '1.0.0', mappings: [] },
        rules_engine: { stage: 'rules_engine', version: '1.0.0', rules: [] },
        qa_checks: { stage: 'qa_checks', version: '1.0.0', checks: [] },
        resolution: { stage: 'resolution', version: '1.0.0', strategy: 'auto' },
        enrichment: { stage: 'enrichment', version: '1.0.0', enrichers: [] },
        approval: { stage: 'approval', version: '1.0.0', workflow: 'standard' },
        export: { stage: 'export', version: '1.0.0', format: 'json' }
      };
      return defaults[stage] || { stage, version: '1.0.0' };
    }
    
    function enterMasterEditMode() {
      masterEditMode = true;
      renderConfigFlowTabContent();
    }
    
    function cancelMasterEdit() {
      masterEditMode = false;
      renderConfigFlowTabContent();
    }
    
    function validateMasterConfig() {
      const textarea = document.getElementById('master-edit-area');
      const msgEl = document.getElementById('master-validation-msg');
      if (!textarea || !msgEl) return;
      
      try {
        JSON.parse(textarea.value);
        msgEl.style.display = 'block';
        msgEl.style.background = '#e8f5e9';
        msgEl.style.color = '#2e7d32';
        msgEl.textContent = 'Valid JSON configuration';
        return true;
      } catch (e) {
        msgEl.style.display = 'block';
        msgEl.style.background = '#ffebee';
        msgEl.style.color = '#c62828';
        msgEl.textContent = 'Invalid JSON: ' + e.message;
        return false;
      }
    }
    
    function saveMasterDraft() {
      const textarea = document.getElementById('master-edit-area');
      if (!textarea) return;
      
      if (!validateMasterConfig()) return;
      
      masterDraft[currentConfigFlowStage] = textarea.value;
      masterEditMode = false;
      renderConfigFlowTabContent();
      showToast('Draft saved for ' + CONFIG_FLOW_STAGES[currentConfigFlowStage]?.title);
    }
    
    function publishMasterConfig() {
      const stage = currentConfigFlowStage;
      const draftJson = masterDraft[stage];
      
      if (!draftJson) {
        showToast('No changes to publish', 'warning');
        return;
      }
      
      try {
        const config = JSON.parse(draftJson);
        const previousConfig = sessionConfig[stage] ? JSON.stringify(sessionConfig[stage]) : null;
        
        sessionConfig[stage] = config;
        configHistory.push({
          stage,
          timestamp: new Date().toISOString(),
          action: 'publish',
          previousValue: previousConfig,
          newValue: draftJson
        });
        
        delete masterDraft[stage];
        masterEditMode = false;
        renderConfigFlowTabContent();
        showToast('Published to session: ' + CONFIG_FLOW_STAGES[stage]?.title);
        refreshSessionFromConfig();
      } catch (e) {
        showToast('Failed to publish: ' + e.message, 'error');
      }
    }
    
    function revertMasterConfig() {
      delete masterDraft[currentConfigFlowStage];
      masterEditMode = false;
      renderConfigFlowTabContent();
      showToast('Reverted changes');
    }
    
    function refreshSessionFromConfig() {
      console.log('Session config updated:', sessionConfig);
      
      var configChip = document.getElementById('config-status-chip');
      if (configChip) {
        var customCount = Object.keys(sessionConfig).length;
        if (customCount > 0) {
          configChip.textContent = customCount + ' custom config(s)';
          configChip.style.background = '#e3f2fd';
          configChip.style.color = '#1565c0';
          configChip.style.display = 'inline-block';
        } else {
          configChip.style.display = 'none';
        }
      }
    }
    
    function showToast(message, type) {
      type = type || 'success';
      var existing = document.querySelector('.config-toast');
      if (existing) existing.remove();
      
      var toast = document.createElement('div');
      toast.className = 'config-toast';
      var bgColor = '#2e7d32';
      if (type === 'error') bgColor = '#c62828';
      else if (type === 'warning') bgColor = '#f57c00';
      toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: ' + bgColor + '; color: white; border-radius: 6px; font-size: 0.9em; z-index: 10001; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(function() { toast.remove(); }, 3000);
    }
    
    // Global Search Stub (V2)
    function handleGlobalSearchKeydown(event) {
      if (event.key === 'Enter') {
        var query = event.target.value.trim();
        if (query) {
          showToast('Search coming soon (V2)', 'info');
        }
      }
    }
    
    // Global keyboard shortcut for search
    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        var searchInput = document.getElementById('global-search-input');
        if (searchInput) {
          searchInput.focus();
          searchInput.select();
        }
      }
    });
    
    function selectConfigFlowStage(stage) {
      masterEditMode = false;
      currentConfigFlowStage = stage;
      
      // Update rail selection
      document.querySelectorAll('.rail-item').forEach(item => {
        item.classList.toggle('active', item.dataset.stage === stage);
      });
      
      // Update header
      const stageConfig = CONFIG_FLOW_STAGES[stage] || {};
      document.getElementById('config-flow-stage-title').textContent = stageConfig.title || stage;
      document.getElementById('config-flow-stage-desc').textContent = stageConfig.desc || '';
      
      // Render current tab content
      renderConfigFlowTabContent();
    }
    
    function selectConfigFlowTab(tab) {
      currentConfigFlowTab = tab;
      
      // Update tab selection
      document.querySelectorAll('.stage-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });
      
      renderConfigFlowTabContent();
    }
    
    function renderConfigFlowTabContent() {
      const container = document.getElementById('config-flow-tab-content');
      const stageConfig = CONFIG_FLOW_STAGES[currentConfigFlowStage] || {};
      let html = '';
      
      if (currentConfigFlowTab === 'plain-english') {
        html = `<div style="padding: 15px; background: #f5f5f5; border-radius: 6px;">${stageConfig.plainEnglish || '<p>No documentation available.</p>'}</div>`;
      } else if (currentConfigFlowTab === 'payload') {
        const effectiveConfig = getMasterConfig(currentConfigFlowStage);
        const isCustom = sessionConfig[currentConfigFlowStage] !== undefined;
        html = `<div style="padding: 15px; background: #263238; color: #eceff1; border-radius: 6px; font-family: monospace; font-size: 0.85em;">
          <div style="margin-bottom: 10px; color: #78909c;">// Effective config (resolved view)</div>
          <pre style="margin: 0; white-space: pre-wrap;">${escapeHtml(JSON.stringify(effectiveConfig, null, 2))}</pre>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 8px;">
          <span style="background: ${isCustom ? '#e3f2fd' : '#e8f5e9'}; color: ${isCustom ? '#1565c0' : '#2e7d32'}; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">${isCustom ? 'CUSTOM' : 'MASTER'}</span>
          ${!isCustom ? '<span style="background: #fff3e0; color: #e65100; padding: 4px 8px; border-radius: 4px; font-size: 0.75em;">DEFAULT</span>' : ''}
        </div>`;
      } else if (currentConfigFlowTab === 'master') {
        const masterConfig = getMasterConfig(currentConfigFlowStage);
        const configJson = JSON.stringify(masterConfig, null, 2);
        const hasChanges = masterDraft[currentConfigFlowStage] !== undefined;
        const draftJson = hasChanges ? masterDraft[currentConfigFlowStage] : configJson;
        
        if (masterEditMode) {
          html = `<div style="margin-bottom: 10px;">
            <div id="master-validation-msg" style="display: none; padding: 8px 12px; border-radius: 4px; margin-bottom: 10px;"></div>
            <textarea id="master-edit-area" style="width: 100%; height: 200px; font-family: monospace; font-size: 0.85em; background: #263238; color: #eceff1; border: 2px solid #5c6bc0; border-radius: 6px; padding: 15px; resize: vertical;">${escapeHtml(draftJson)}</textarea>
          </div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="modal-btn modal-btn-secondary" onclick="validateMasterConfig()">Validate</button>
            <button class="modal-btn modal-btn-primary" onclick="saveMasterDraft()">Save Draft</button>
            <button class="modal-btn" style="background: #7c4dff; color: white;" onclick="publishMasterConfig()">Publish to Session</button>
            <button class="modal-btn" style="margin-left: auto;" onclick="cancelMasterEdit()">Cancel</button>
          </div>`;
        } else {
          html = `<div style="padding: 15px; background: #263238; color: #eceff1; border-radius: 6px; font-family: monospace; font-size: 0.85em; min-height: 150px;">
            <div style="margin-bottom: 10px; color: #78909c;">// Master config ${hasChanges ? '(unsaved changes)' : ''}</div>
            <pre style="margin: 0; white-space: pre-wrap;">${escapeHtml(hasChanges ? draftJson : configJson)}</pre>
          </div>
          <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="modal-btn modal-btn-secondary" onclick="enterMasterEditMode()">Edit</button>
            <button class="modal-btn modal-btn-primary" onclick="publishMasterConfig()" ${hasChanges ? '' : 'disabled'}>Publish to Session</button>
            <button class="modal-btn" style="margin-left: auto;" onclick="revertMasterConfig()" ${hasChanges ? '' : 'disabled'}>Revert</button>
          </div>`;
        }
      } else if (currentConfigFlowTab === 'diff') {
        const hasChanges = masterDraft[currentConfigFlowStage] !== undefined;
        if (hasChanges) {
          const masterConfig = getMasterConfig(currentConfigFlowStage);
          const currentJson = JSON.stringify(masterConfig, null, 2);
          const draftJson = masterDraft[currentConfigFlowStage];
          html = `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <div style="font-weight: 600; margin-bottom: 8px; color: #666;">Current (Published)</div>
              <div style="padding: 12px; background: #263238; color: #eceff1; border-radius: 6px; font-family: monospace; font-size: 0.8em; max-height: 200px; overflow: auto;">
                <pre style="margin: 0; white-space: pre-wrap;">${escapeHtml(currentJson)}</pre>
              </div>
            </div>
            <div>
              <div style="font-weight: 600; margin-bottom: 8px; color: #5c6bc0;">Draft (Pending)</div>
              <div style="padding: 12px; background: #1a237e; color: #eceff1; border-radius: 6px; font-family: monospace; font-size: 0.8em; max-height: 200px; overflow: auto; border: 2px solid #5c6bc0;">
                <pre style="margin: 0; white-space: pre-wrap;">${escapeHtml(draftJson)}</pre>
              </div>
            </div>
          </div>
          <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="modal-btn" style="background: #7c4dff; color: white;" onclick="publishMasterConfig()">Publish Changes</button>
            <button class="modal-btn" onclick="revertMasterConfig()">Discard</button>
          </div>`;
        } else {
          html = `<div style="padding: 20px; text-align: center; color: #666;">
            <p>No differences detected.</p>
            <p style="font-size: 0.85em; margin-top: 10px;">Master and Effective Payload are identical.</p>
          </div>`;
        }
      } else if (currentConfigFlowTab === 'history') {
        const stageHistory = configHistory.filter(h => h.stage === currentConfigFlowStage);
        if (stageHistory.length > 0) {
          const historyItems = stageHistory.slice().reverse().map(h => `
            <div style="padding: 12px; background: #f5f5f5; border-radius: 6px; margin-bottom: 8px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                <span style="font-weight: 600; color: #333;">${h.action === 'publish' ? 'Published' : h.action}</span>
                <span style="font-size: 0.8em; color: #666;">${new Date(h.timestamp).toLocaleString()}</span>
              </div>
              <div style="font-size: 0.85em; color: #666;">Configuration updated</div>
            </div>
          `).join('');
          html = `<div style="max-height: 300px; overflow-y: auto;">${historyItems}</div>`;
        } else {
          html = `<div style="padding: 20px; text-align: center; color: #666;">
            <p>No history entries.</p>
            <p style="font-size: 0.85em; margin-top: 10px;">Changes will be recorded here when you edit and publish.</p>
          </div>`;
        }
      }
      
      container.innerHTML = html;
    }
    
    function wizardBack() {
      if (currentWizardStep > 0) {
        currentWizardStep--;
        renderConfigureWizardStep(currentWizardStep);
      }
    }
    
    function wizardNext() {
      saveWizardStepData(currentWizardStep);
      
      if (currentWizardStep < WIZARD_STEPS.length - 1) {
        currentWizardStep++;
        renderConfigureWizardStep(currentWizardStep);
      } else {
        // Finish wizard
        userSettings.configured = true;
        saveUserSettings();
        closeConfigureWizard();
        dismissFirstRunBanner();
        
        // Apply settings immediately
        if (userSettings.use_repo_masters && !dataLoaded) {
          autoSetupRepoMasters();
        }
      }
    }
    
    function saveWizardStepData(step) {
      if (step === 0) {
        userSettings.use_repo_masters = document.getElementById('wiz-use-repo-masters')?.checked ?? true;
      } else if (step === 1) {
        userSettings.preferred_load_method = document.getElementById('wiz-load-method')?.value || 'Repo Masters';
        userSettings.local_data_root = document.getElementById('wiz-local-path')?.value || '';
      } else if (step === 2) {
        const checkboxes = document.querySelectorAll('.wiz-queue-checkbox:checked');
        userSettings.default_queues = Array.from(checkboxes).map(cb => cb.value);
        userSettings.compare_mode_default = document.getElementById('wiz-compare-default')?.checked ?? true;
      }
    }
    
    function renderConfigureWizardStep(step) {
      const titleEl = document.getElementById('wizard-step-title');
      const contentEl = document.getElementById('wizard-step-content');
      const backBtn = document.getElementById('wizard-back');
      const nextBtn = document.getElementById('wizard-next');
      
      // Update progress dots
      document.querySelectorAll('.wizard-step-dot').forEach((dot, i) => {
        dot.classList.toggle('active', i === step);
        dot.classList.toggle('completed', i < step);
      });
      
      titleEl.textContent = WIZARD_STEPS[step].title;
      backBtn.style.display = step === 0 ? 'none' : 'inline-block';
      nextBtn.textContent = step === WIZARD_STEPS.length - 1 ? 'Finish' : 'Next';
      
      let html = '';
      
      if (step === 0) {
        html = `
          <p style="margin-bottom: 20px; color: #555;">We'll set up where your files live and what you want to see first.</p>
          <div class="wizard-toggle">
            <input type="checkbox" id="wiz-use-repo-masters" ${userSettings.use_repo_masters ? 'checked' : ''}>
            <div class="wizard-toggle-label">
              <strong>Use Repo Masters</strong>
              <small>Recommended for dev/testing. Auto-loads preview data from the repository.</small>
            </div>
          </div>
        `;
      } else if (step === 1) {
        html = `
          <p style="margin-bottom: 20px; color: #555;">Choose how you'll load your Preview and Reference packets.</p>
          <div class="wizard-form-group">
            <label>Default Load Method</label>
            <select id="wiz-load-method" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
              <option value="Repo Masters" ${userSettings.preferred_load_method === 'Repo Masters' ? 'selected' : ''}>Repo Masters</option>
              <option value="Paste JSON" ${userSettings.preferred_load_method === 'Paste JSON' ? 'selected' : ''}>Paste JSON</option>
              <option value="Drag & Drop" ${userSettings.preferred_load_method === 'Drag & Drop' ? 'selected' : ''}>Drag & Drop</option>
              <option value="Local Path Hint" ${userSettings.preferred_load_method === 'Local Path Hint' ? 'selected' : ''}>Local Path Hint</option>
            </select>
          </div>
          <div class="wizard-form-group">
            <label>Local Folder (optional)</label>
            <input type="text" id="wiz-local-path" value="${userSettings.local_data_root}" placeholder="e.g., out/" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            <div class="hint">Used only for path hints; nothing uploads or syncs.</div>
          </div>
        `;
      } else if (step === 2) {
        const queues = ['To Do', 'Needs Review', 'Flagged', 'Blocked', 'Finalized'];
        html = `
          <p style="margin-bottom: 20px; color: #555;">Pick what queues and panels you want visible by default.</p>
          <div class="wizard-form-group">
            <label>Queues to Show</label>
            <div class="wizard-multi-select">
              ${queues.map(q => `
                <label>
                  <input type="checkbox" class="wiz-queue-checkbox" value="${q}" ${userSettings.default_queues.includes(q) ? 'checked' : ''}>
                  ${q}
                </label>
              `).join('')}
            </div>
          </div>
          <div class="wizard-toggle" style="margin-top: 15px;">
            <input type="checkbox" id="wiz-compare-default" ${userSettings.compare_mode_default ? 'checked' : ''}>
            <div class="wizard-toggle-label">
              <strong>Enable Compare View by Default</strong>
              <small>Show comparison panel when loading data.</small>
            </div>
          </div>
        `;
      } else if (step === 3) {
        html = `
          <div style="text-align: center; padding: 20px 0;">
            <div style="font-size: 3em; margin-bottom: 15px;">&#10004;</div>
            <h3 style="margin: 0 0 10px; color: #4caf50;">You're All Set!</h3>
            <p style="color: #666;">You can change these anytime in Admin &rarr; Settings.</p>
            <div style="background: #f5f5f5; border-radius: 8px; padding: 15px; margin-top: 20px; text-align: left;">
              <div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">Your settings:</div>
              <ul style="margin: 0; padding-left: 20px; font-size: 0.9em;">
                <li>Load method: <strong>${userSettings.preferred_load_method}</strong></li>
                <li>Auto-load repo masters: <strong>${userSettings.use_repo_masters ? 'Yes' : 'No'}</strong></li>
                <li>Default queues: <strong>${userSettings.default_queues.join(', ') || 'All'}</strong></li>
              </ul>
            </div>
          </div>
        `;
      }
      
      contentEl.innerHTML = html;
    }
    
    // Note: Primary resetSession is defined earlier. This is a legacy duplicate kept for reference.
    // The main resetSession() navigates to loader after clearing data.

    // Modal functions
    function openRulesetModal() {
      document.getElementById('ruleset-modal').classList.add('active');
    }
    function closeRulesetModal() {
      document.getElementById('ruleset-modal').classList.remove('active');
    }
    function openCompareModal() {
      document.getElementById('compare-modal').classList.add('active');
    }
    function closeCompareModal() {
      document.getElementById('compare-modal').classList.remove('active');
    }
    function openRunModal() {
      document.getElementById('run-modal').classList.add('active');
    }
    function closeRunModal() {
      document.getElementById('run-modal').classList.remove('active');
    }

    function setActiveQueue(queue) {
      document.querySelectorAll('.nav-item.queue-item').forEach(item => {
        if (item.dataset.queue === queue) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
      // Optionally filter the triage table by queue status
      if (typeof filterTriageByQueue === 'function') {
        filterTriageByQueue(queue);
      }
    }
    
    function initRouter() {
      document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const page = item.dataset.page;
          const queue = item.dataset.queue;
          console.log('[Router] Click on nav-item, page:', page, 'queue:', queue);
          navigateTo(page);
          if (queue) {
            setActiveQueue(queue);
          }
        });
      });
      
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          setMode(btn.dataset.mode);
        });
      });
      
      window.addEventListener('hashchange', () => {
        const hash = window.location.hash.replace('#/', '') || 'triage';
        // Prevent duplicate navigation if we're already on this page
        if (currentPage !== hash) {
          console.log('[Router] Hashchange to:', hash);
          navigateTo(hash);
        }
      });
      
      // Load user settings and check for first run
      loadUserSettings();
      checkFirstRun();
      
      // Setup loader modal events
      setupLoaderModalEvents();
      
      let savedMode = localStorage.getItem('viewer_mode_v10');
      // Convert legacy 'operator' mode to 'analyst'
      if (savedMode === 'operator') savedMode = 'analyst';
      if (savedMode) setMode(savedMode);
      else setMode('analyst');
      
      // Default route is always triage
      const hash = window.location.hash.replace('#/', '') || 'triage';
      navigateTo(hash === 'loader' ? 'triage' : hash);
      
      // Auto-setup repo masters if enabled
      if (userSettings.use_repo_masters && !dataLoaded) {
        autoSetupRepoMasters();
      }
      
    }

    function getRecordHash(record) {
      const sorted = sortObjectKeys(record);
      return JSON.stringify(sorted);
    }

    function getJoinKey(record) {
      const identity = getJoinIdentity(record);
      return `${identity.contract_key || ''}|${identity.file_url || ''}|${identity.file_name || ''}`;
    }

    function getRowKey(record, type) {
      const jk = getJoinKey(record);
      if (type === 'contractResults') {
        return jk;
      } else if (type === 'issues') {
        return `${jk}|${record.sheet || ''}|${record.field || ''}|${record.issue_type || ''}`;
      } else if (type === 'fieldActions') {
        return `${jk}|${record.sheet || ''}|${record.field || ''}|${record.action || ''}`;
      }
      return jk;
    }

    function computeRowChanges(primaryArr, compareArr, type) {
      const changes = {};
      const primaryMap = new Map();
      const compareMap = new Map();
      
      primaryArr.forEach(r => {
        const key = getRowKey(r, type);
        primaryMap.set(key, { record: r, hash: getRecordHash(r) });
      });
      
      compareArr.forEach(r => {
        const key = getRowKey(r, type);
        compareMap.set(key, { record: r, hash: getRecordHash(r) });
      });
      
      primaryMap.forEach((val, key) => {
        if (!compareMap.has(key)) {
          changes[key] = 'added';
        } else if (val.hash !== compareMap.get(key).hash) {
          changes[key] = 'changed';
        }
      });
      
      compareMap.forEach((val, key) => {
        if (!primaryMap.has(key)) {
          changes[key] = 'removed';
        }
      });
      
      return changes;
    }

    function computeDeltaStats(primary, compare) {
      const pSum = primary.sf_summary || {};
      const cSum = compare.sf_summary || {};
      
      return {
        contracts: (pSum.contracts || 0) - (cSum.contracts || 0),
        ready: (pSum.ready || 0) - (cSum.ready || 0),
        needsReview: (pSum.needs_review || 0) - (cSum.needs_review || 0),
        blocked: (pSum.blocked || 0) - (cSum.blocked || 0),
        issues: {
          added: Object.values(rowChanges.issues).filter(v => v === 'added').length,
          changed: Object.values(rowChanges.issues).filter(v => v === 'changed').length,
          removed: Object.values(rowChanges.issues).filter(v => v === 'removed').length
        },
        actions: {
          added: Object.values(rowChanges.fieldActions).filter(v => v === 'added').length,
          changed: Object.values(rowChanges.fieldActions).filter(v => v === 'changed').length,
          removed: Object.values(rowChanges.fieldActions).filter(v => v === 'removed').length
        }
      };
    }

    function renderDeltaSummary() {
      const container = document.getElementById('delta-container');
      if (!deltaStats) {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'block';
      
      const formatDelta = (val) => val > 0 ? `+${val}` : val.toString();
      const getClass = (val) => val > 0 ? 'positive' : val < 0 ? 'negative' : 'neutral';
      
      container.innerHTML = `
        <h2>Delta Summary (vs. Previous)</h2>
        <div class="compare-actions">
          <button class="compare-btn" id="copy-delta-summary">Copy Delta Summary (Markdown)</button>
        </div>
        <div class="compare-legend">
          <span class="compare-legend-item"><span class="compare-legend-dot added"></span> Added</span>
          <span class="compare-legend-item"><span class="compare-legend-dot changed"></span> Changed</span>
          <span class="compare-legend-item"><span class="compare-legend-dot removed"></span> Removed</span>
        </div>
        <div class="delta-summary">
          <div class="delta-card ${getClass(deltaStats.contracts)}">
            <div class="delta-value ${getClass(deltaStats.contracts)}">${formatDelta(deltaStats.contracts)}</div>
            <div class="delta-label">Contracts</div>
          </div>
          <div class="delta-card ${getClass(deltaStats.ready)}">
            <div class="delta-value ${getClass(deltaStats.ready)}">${formatDelta(deltaStats.ready)}</div>
            <div class="delta-label">Ready</div>
          </div>
          <div class="delta-card ${getClass(deltaStats.needsReview)}">
            <div class="delta-value ${getClass(deltaStats.needsReview)}">${formatDelta(deltaStats.needsReview)}</div>
            <div class="delta-label">Needs Review</div>
          </div>
          <div class="delta-card ${getClass(deltaStats.blocked)}">
            <div class="delta-value ${getClass(deltaStats.blocked)}">${formatDelta(deltaStats.blocked)}</div>
            <div class="delta-label">Blocked</div>
          </div>
          <div class="delta-card ${deltaStats.issues.added > 0 ? 'positive' : 'neutral'}">
            <div class="delta-value ${deltaStats.issues.added > 0 ? 'positive' : 'neutral'}">+${deltaStats.issues.added}</div>
            <div class="delta-label">Issues Added</div>
          </div>
          <div class="delta-card ${deltaStats.issues.changed > 0 ? 'neutral' : 'neutral'}">
            <div class="delta-value neutral">${deltaStats.issues.changed}</div>
            <div class="delta-label">Issues Changed</div>
          </div>
          <div class="delta-card ${deltaStats.issues.removed > 0 ? 'negative' : 'neutral'}">
            <div class="delta-value ${deltaStats.issues.removed > 0 ? 'negative' : 'neutral'}">${deltaStats.issues.removed > 0 ? '-' : ''}${deltaStats.issues.removed}</div>
            <div class="delta-label">Issues Removed</div>
          </div>
          <div class="delta-card ${deltaStats.actions.added > 0 ? 'positive' : 'neutral'}">
            <div class="delta-value ${deltaStats.actions.added > 0 ? 'positive' : 'neutral'}">+${deltaStats.actions.added}</div>
            <div class="delta-label">Actions Added</div>
          </div>
          <div class="delta-card ${deltaStats.actions.removed > 0 ? 'negative' : 'neutral'}">
            <div class="delta-value ${deltaStats.actions.removed > 0 ? 'negative' : 'neutral'}">${deltaStats.actions.removed > 0 ? '-' : ''}${deltaStats.actions.removed}</div>
            <div class="delta-label">Actions Removed</div>
          </div>
        </div>
      `;
      
      document.getElementById('copy-delta-summary')?.addEventListener('click', async () => {
        const md = generateDeltaMarkdown();
        const success = await copyToClipboard(md);
        const btn = document.getElementById('copy-delta-summary');
        const orig = btn.textContent;
        btn.textContent = success ? 'Copied!' : 'Failed';
        setTimeout(() => btn.textContent = orig, 1500);
      });
    }

    function generateDeltaMarkdown() {
      if (!deltaStats) return '# No comparison data\n';
      
      const formatDelta = (val) => val > 0 ? `+${val}` : val.toString();
      
      let md = `# Delta Summary\n\n`;
      md += `## Contract Status Changes\n\n`;
      md += `| Metric | Delta |\n`;
      md += `|--------|-------|\n`;
      md += `| Contracts | ${formatDelta(deltaStats.contracts)} |\n`;
      md += `| Ready | ${formatDelta(deltaStats.ready)} |\n`;
      md += `| Needs Review | ${formatDelta(deltaStats.needsReview)} |\n`;
      md += `| Blocked | ${formatDelta(deltaStats.blocked)} |\n`;
      md += `\n## Row-Level Changes\n\n`;
      md += `| Type | Added | Changed | Removed |\n`;
      md += `|------|-------|---------|----------|\n`;
      md += `| Issues | ${deltaStats.issues.added} | ${deltaStats.issues.changed} | ${deltaStats.issues.removed} |\n`;
      md += `| Field Actions | ${deltaStats.actions.added} | ${deltaStats.actions.changed} | ${deltaStats.actions.removed} |\n`;
      
      return md;
    }

    function normCmp(v) {
      if (v === null || v === undefined) return '';
      return String(v).trim().toLowerCase();
    }

    function isNullOrEmpty(v) {
      return v === null || v === undefined || String(v).trim() === '';
    }

    function normalizeToNull(v) {
      if (v === undefined || (typeof v === 'string' && v.trim() === '')) return null;
      return v;
    }

    function compareNullsLast(aVal, bVal) {
      const aEmpty = isNullOrEmpty(aVal);
      const bEmpty = isNullOrEmpty(bVal);
      if (aEmpty && bEmpty) return 0;
      if (aEmpty) return 1;
      if (bEmpty) return -1;
      return normCmp(aVal).localeCompare(normCmp(bVal));
    }

    function sortByJoinTriplet(arr, extraKeys = []) {
      return [...arr].sort((a, b) => {
        const ck = compareNullsLast(a.contract_key, b.contract_key);
        if (ck !== 0) return ck;
        const fu = compareNullsLast(a.file_url, b.file_url);
        if (fu !== 0) return fu;
        const fn = compareNullsLast(a.file_name, b.file_name);
        if (fn !== 0) return fn;
        for (const key of extraKeys) {
          const cmp = normCmp(a[key]).localeCompare(normCmp(b[key]));
          if (cmp !== 0) return cmp;
        }
        return 0;
      });
    }

    function sortBySeverityFirst(arr, extraKeys = []) {
      const sevOrder = { blocking: 0, warning: 1, info: 2 };
      return [...arr].sort((a, b) => {
        const aOrd = sevOrder[a.severity] ?? 3;
        const bOrd = sevOrder[b.severity] ?? 3;
        if (aOrd !== bOrd) return aOrd - bOrd;
        const ck = compareNullsLast(a.contract_key, b.contract_key);
        if (ck !== 0) return ck;
        const fu = compareNullsLast(a.file_url, b.file_url);
        if (fu !== 0) return fu;
        const fn = compareNullsLast(a.file_name, b.file_name);
        if (fn !== 0) return fn;
        for (const key of extraKeys) {
          const cmp = compareNullsLast(a[key], b[key]);
          if (cmp !== 0) return cmp;
        }
        return 0;
      });
    }

    function getJoinIdentity(record) {
      return {
        contract_key: normalizeToNull(record.contract_key),
        file_url: normalizeToNull(record.file_url),
        file_name: normalizeToNull(record.file_name)
      };
    }

    function joinIdentityEquals(a, b) {
      if (!a || !b) return false;
      const eq = (x, y) => {
        const nx = normalizeToNull(x);
        const ny = normalizeToNull(y);
        if (nx === null && ny === null) return true;
        if (nx === null || ny === null) return false;
        return nx === ny;
      };
      return eq(a.contract_key, b.contract_key) && eq(a.file_url, b.file_url) && eq(a.file_name, b.file_name);
    }

    function getPrimaryKey(identity) {
      if (identity.contract_key !== null) return 'contract_key';
      if (identity.file_url !== null) return 'file_url';
      if (identity.file_name !== null) return 'file_name';
      return null;
    }

    function formatJoinIdentityPill(identity) {
      const primary = getPrimaryKey(identity);
      const format = (key, label, val) => {
        const v = val ?? 'null';
        if (key === primary) return `<span class="identity-primary">${label}=${v}</span>`;
        return `<span class="identity-fallback">${label}=${v}</span>`;
      };
      return `${format('contract_key', 'ck', identity.contract_key)} | ${format('file_url', 'fu', identity.file_url)} | ${format('file_name', 'fn', identity.file_name)}`;
    }

    function formatJoinIdentityText(identity) {
      const ck = identity.contract_key ?? 'null';
      const fu = identity.file_url ?? 'null';
      const fn = identity.file_name ?? 'null';
      const primary = getPrimaryKey(identity);
      return `ck=${ck} | fu=${fu} | fn=${fn} (PRIMARY: ${primary || 'none'})`;
    }

    function getRelatedRecords(identity, dataArray) {
      return dataArray.filter(r => joinIdentityEquals(getJoinIdentity(r), identity));
    }

    function formatValue(v) {
      if (v === null || v === undefined) return '<span class="null-value">null</span>';
      if (typeof v === 'object') return JSON.stringify(v);
      return String(v);
    }

    function matchesSearch(row, search) {
      if (!search) return true;
      const lowerSearch = search.toLowerCase();
      return Object.values(row).some(v => {
        if (v === null || v === undefined) return false;
        return String(v).toLowerCase().includes(lowerSearch);
      });
    }

    function filterData(data, type) {
      return data.filter(row => {
        if (!matchesSearch(row, activeFilters.search)) return false;
        if (type === 'issues' || type === 'fieldActions') {
          if (!activeFilters.severities.includes(row.severity)) return false;
        }
        if (type === 'contractResults') {
          const status = (row.sf_contract_status || '').toLowerCase();
          if (!activeFilters.statuses.includes(status)) return false;
          if (activeFilters.subtype && row.detected_subtype !== activeFilters.subtype) return false;
        }
        return true;
      });
    }

    function renderSummary(summary) {
      summary = summary || allData.summary || {};
      const container = document.getElementById('summary-container');
      container.innerHTML = `
        <h2>Summary</h2>
        <div class="summary">
          <div class="summary-card contracts clickable" title="View all records" onclick="navigateToGridFiltered('all')"><div class="count">${summary.contracts || 0}</div><div class="label">Contracts</div></div>
          <div class="summary-card ready clickable" title="View ready records" onclick="navigateToGridFiltered('ready')"><div class="count">${summary.ready || 0}</div><div class="label">Ready</div></div>
          <div class="summary-card needs-review clickable" title="View records needing review" onclick="navigateToGridFiltered('needs_review')"><div class="count">${summary.needs_review || 0}</div><div class="label">Needs Review</div></div>
          <div class="summary-card blocked clickable" title="View blocked records" onclick="navigateToGridFiltered('blocked')"><div class="count">${summary.blocked || 0}</div><div class="label">Blocked</div></div>
        </div>
      `;
    }

    function renderTable(containerId, title, data, columns, type) {
      const container = document.getElementById(containerId);
      const filtered = filterData(data, type);
      
      if (!data || data.length === 0) {
        container.innerHTML = `<h2>${title}</h2><div class="info">No data</div>`;
        return;
      }
      
      const headers = columns.map(c => {
        var tooltip = getTooltip(humanLabel(c.key)) || getTooltip(c.label);
        var icon = tooltip ? ' <span class="info-icon" title="' + escapeHtml(tooltip) + '">&#9432;</span>' : '';
        return '<th>' + c.label + icon + '</th>';
      }).join('');
      const changes = rowChanges[type] || {};
      
      const rows = filtered.map((row, idx) => {
        const cells = columns.map(c => {
          let val = formatValue(row[c.key]);
          let cls = '';
          if (c.key === 'severity') cls = `severity-${row.severity}`;
          if (c.key === 'sf_contract_status') cls = `status-${(row.sf_contract_status || '').toLowerCase()}`;
          return `<td class="${cls}">${val}</td>`;
        }).join('');
        const rowKey = getRowKey(row, type);
        const changeType = changes[rowKey];
        const rowClass = changeType ? `row-${changeType}` : '';
        return `<tr data-type="${type}" data-idx="${data.indexOf(row)}" data-source="primary" class="${rowClass}">${cells}</tr>`;
      }).join('');
      
      let removedRows = '';
      if (compareData && Object.keys(changes).length > 0) {
        const removedKeys = Object.entries(changes)
          .filter(([k, v]) => v === 'removed')
          .map(([k]) => k);
        
        if (removedKeys.length > 0) {
          const compareArr = getCompareArray(type);
          const removedRecords = compareArr.filter(r => removedKeys.includes(getRowKey(r, type)));
          
          removedRows = removedRecords.map((row, idx) => {
            const cells = columns.map(c => {
              let val = formatValue(row[c.key]);
              let cls = '';
              if (c.key === 'severity') cls = `severity-${row.severity}`;
              if (c.key === 'sf_contract_status') cls = `status-${(row.sf_contract_status || '').toLowerCase()}`;
              return `<td class="${cls}">${val}</td>`;
            }).join('');
            return `<tr data-type="${type}" data-idx="${idx}" data-source="compare" class="row-removed">${cells}</tr>`;
          }).join('');
        }
      }
      
      const totalCount = data.length + (removedRows ? Object.values(changes).filter(v => v === 'removed').length : 0);
      
      container.innerHTML = `
        <h2>${title} (${filtered.length + (removedRows ? Object.values(changes).filter(v => v === 'removed').length : 0)}/${totalCount})</h2>
        <div class="table-container">
          <table><thead><tr>${headers}</tr></thead><tbody>${rows}${removedRows}</tbody></table>
        </div>
      `;
      
      container.querySelectorAll('tbody tr').forEach(tr => {
        if (tr.dataset.source === 'compare') return;
        tr.addEventListener('click', () => openDrawerFromType(type, parseInt(tr.dataset.idx)));
      });
    }

    function getCompareArray(type) {
      if (!compareData) return [];
      if (type === 'contractResults') return compareData.sf_contract_results || [];
      if (type === 'issues') return compareData.sf_issues || [];
      if (type === 'fieldActions') return compareData.sf_field_actions || [];
      return [];
    }

    function renderAllTables() {
      renderTable('contract-results-container', 'Contract Results', allData.contractResults, [
        { key: 'contract_key', label: 'Contract Key' },
        { key: 'file_name', label: 'File Name' },
        { key: 'file_url', label: 'File URL' },
        { key: 'detected_subtype', label: 'Subtype' },
        { key: 'sf_contract_status', label: 'Status' },
        { key: 'notes', label: 'Notes' }
      ], 'contractResults');
      
      renderTable('issues-container', 'Issues', allData.issues, [
        { key: 'severity', label: 'Severity' },
        { key: 'contract_key', label: 'Contract Key' },
        { key: 'file_name', label: 'File Name' },
        { key: 'sheet', label: 'Sheet' },
        { key: 'field', label: 'Field' },
        { key: 'issue_type', label: 'Issue Type' },
        { key: 'details', label: 'Details' }
      ], 'issues');
      
      renderTable('field-actions-container', 'Field Actions', allData.fieldActions, [
        { key: 'severity', label: 'Severity' },
        { key: 'contract_key', label: 'Contract Key' },
        { key: 'file_name', label: 'File Name' },
        { key: 'sheet', label: 'Sheet' },
        { key: 'field', label: 'Field' },
        { key: 'action', label: 'Action' },
        { key: 'proposed_value', label: 'Proposed Value' },
        { key: 'reason_text', label: 'Reason' }
      ], 'fieldActions');
    }

    function populateSubtypeDropdown() {
      const subtypes = [...new Set(allData.contractResults.map(r => r.detected_subtype).filter(Boolean))].sort();
      const select = document.getElementById('filter-subtype');
      select.innerHTML = '<option value="">All Subtypes</option>' + 
        subtypes.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function renderDrawerTab(tab) {
      const body = document.getElementById('drawer-body');
      const identity = currentSelection.joinIdentity;
      if (!identity) return;

      let content = '';
      let jsonData = null;

      if (tab === 'contract') {
        const contract = currentSelection.contractIdx !== null 
          ? allData.contractResults[currentSelection.contractIdx]
          : allData.contractResults.find(r => joinIdentityEquals(getJoinIdentity(r), identity));
        if (contract) {
          jsonData = contract;
          content = `<div class="json-header">Internal JSON (advanced)</div><pre class="drawer-json">${JSON.stringify(contract, null, 2)}</pre>`;
        } else {
          content = '<div class="drawer-empty">No contract record found for this join identity.</div>';
        }
      } else if (tab === 'issues') {
        const related = sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']);
        jsonData = related;
        if (related.length === 0) {
          content = '<div class="drawer-empty">No related issues for this join identity.</div>';
        } else {
          content = renderSelectionControls('issues', related.length) + renderDrawerTable(related, [
            { key: 'severity', label: 'Severity' },
            { key: 'sheet', label: 'Sheet' },
            { key: 'field', label: 'Field' },
            { key: 'issue_type', label: 'Type' },
            { key: 'details', label: 'Details' }
          ], 'issues');
        }
      } else if (tab === 'actions') {
        const related = sortBySeverityFirst(getRelatedRecords(identity, allData.fieldActions), ['sheet', 'field', 'action']);
        jsonData = related;
        if (related.length === 0) {
          content = '<div class="drawer-empty">No related field actions for this join identity.</div>';
        } else {
          content = renderSelectionControls('actions', related.length) + renderDrawerTable(related, [
            { key: 'severity', label: 'Severity' },
            { key: 'sheet', label: 'Sheet' },
            { key: 'field', label: 'Field' },
            { key: 'action', label: 'Action' },
            { key: 'proposed_value', label: 'Value' },
            { key: 'reason_text', label: 'Reason' }
          ], 'actions');
        }
      } else if (tab === 'changelog') {
        const related = sortBySeverityFirst(getRelatedRecords(identity, allData.changeLog), ['sheet', 'field', 'notes']);
        jsonData = related;
        if (related.length === 0) {
          content = '<div class="drawer-empty">No related change log entries for this join identity.</div>';
        } else {
          content = renderSelectionControls('changelog', related.length) + renderDrawerTable(related, [
            { key: 'severity', label: 'Severity' },
            { key: 'sheet', label: 'Sheet' },
            { key: 'field', label: 'Field' },
            { key: 'notes', label: 'Notes' }
          ], 'changelog');
        }
      }

      body.innerHTML = content;
      body.dataset.json = JSON.stringify(jsonData, null, 2);
      body.dataset.tabType = tab;
      body.dataset.records = JSON.stringify(jsonData);
    }

    function getRecordKey(record) {
      const ck = normalizeToNull(record.contract_key) ?? '';
      const fu = normalizeToNull(record.file_url) ?? '';
      const fn = normalizeToNull(record.file_name) ?? '';
      const sh = record.sheet ?? '';
      const fi = record.field ?? '';
      const ty = record.issue_type ?? record.action ?? record.notes ?? '';
      return `${ck}|${fu}|${fn}|${sh}|${fi}|${ty}`;
    }

    function renderDrawerTable(data, columns, tabType) {
      const selectionSet = selectedRecords[tabType];
      const headers = (tabType ? '<th></th>' : '') + columns.map(c => `<th>${c.label}</th>`).join('');
      const rows = data.map((row, idx) => {
        const key = getRecordKey(row);
        const checked = selectionSet?.has(key) ? 'checked' : '';
        const checkbox = tabType ? `<td><input type="checkbox" data-key="${key}" data-idx="${idx}" ${checked}></td>` : '';
        const cells = columns.map(c => {
          let val = formatValue(row[c.key]);
          let cls = '';
          if (c.key === 'severity') cls = `severity-${row.severity}`;
          return `<td class="${cls}">${val}</td>`;
        }).join('');
        return `<tr>${checkbox}${cells}</tr>`;
      }).join('');
      return `<table class="drawer-table"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderSelectionControls(tabType, totalCount) {
      const selectedCount = selectedRecords[tabType]?.size || 0;
      return `
        <div class="selection-controls">
          <button class="selection-btn" data-action="select-all" data-tab="${tabType}">Select All</button>
          <button class="selection-btn" data-action="clear" data-tab="${tabType}">Clear</button>
          <button class="selection-btn" data-action="add-to-patch" data-tab="${tabType}" style="background: #2e7d32; color: white; border-color: #2e7d32;">Add Selected to Patch</button>
          <span class="selection-count">${selectedCount} of ${totalCount} selected</span>
        </div>
      `;
    }

    function updateTabCounts(identity) {
      const issuesCount = getRelatedRecords(identity, allData.issues).length;
      const actionsCount = getRelatedRecords(identity, allData.fieldActions).length;
      const changelogCount = getRelatedRecords(identity, allData.changeLog).length;
      document.getElementById('issues-count').textContent = issuesCount;
      document.getElementById('actions-count').textContent = actionsCount;
      document.getElementById('changelog-count').textContent = changelogCount;
    }

    function openDrawerFromType(type, idx) {
      const dataMap = { contractResults: allData.contractResults, issues: allData.issues, fieldActions: allData.fieldActions };
      const record = dataMap[type]?.[idx];
      if (!record) return;
      
      // For contract results, use the new Record Drawer for a cleaner experience
      if (type === 'contractResults') {
        openRecordDrawer(record.contract_key || record.file_name, idx, allData.contractResults);
        return;
      }

      const identity = getJoinIdentity(record);
      currentSelection.joinIdentity = identity;
      currentSelection.sourceType = type;

      const matchingContracts = allData.contractResults.filter(r => joinIdentityEquals(getJoinIdentity(r), identity));
      if (type === 'contractResults') {
        currentSelection.contractIdx = idx;
      } else {
        const contractIdx = allData.contractResults.findIndex(r => joinIdentityEquals(getJoinIdentity(r), identity));
        currentSelection.contractIdx = contractIdx >= 0 ? contractIdx : null;
      }
      currentSelection.activeTab = 'contract';

      document.getElementById('identity-pill').innerHTML = formatJoinIdentityPill(identity);
      updateTabCounts(identity);

      const warning = document.getElementById('drawer-warning');
      if (matchingContracts.length > 1) {
        warning.textContent = `Warning: ${matchingContracts.length} contracts share this join identity. Showing first match deterministically.`;
        warning.style.display = 'block';
      } else {
        warning.style.display = 'none';
      }

      document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.drawer-tab[data-tab="contract"]').classList.add('active');

      renderDrawerTab('contract');

      document.getElementById('drawer').classList.add('active');
      document.getElementById('drawer-overlay').classList.add('active');

      saveSelection();
    }

    function openDrawer(idx) {
      openDrawerFromType('contractResults', idx);
    }

    function closeDrawer() {
      document.getElementById('drawer').classList.remove('active');
      document.getElementById('drawer-overlay').classList.remove('active');
      currentSelection.joinIdentity = null;
      clearSelection();
    }

    function saveSelection() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(currentSelection));
      } catch (e) {}
    }

    function clearSelection() {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {}
    }

    function restoreSelection() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return;
        const sel = JSON.parse(stored);
        if (!sel.joinIdentity) return;

        let contractIdx = sel.contractIdx;
        if (contractIdx !== null && contractIdx !== undefined) {
          const storedRecord = allData.contractResults[contractIdx];
          if (!storedRecord || !joinIdentityEquals(getJoinIdentity(storedRecord), sel.joinIdentity)) {
            contractIdx = allData.contractResults.findIndex(r => joinIdentityEquals(getJoinIdentity(r), sel.joinIdentity));
          }
        } else {
          contractIdx = allData.contractResults.findIndex(r => joinIdentityEquals(getJoinIdentity(r), sel.joinIdentity));
        }

        if (contractIdx < 0) {
          clearSelection();
          return;
        }

        const validTabs = ['contract', 'issues', 'actions', 'changelog'];
        if (!validTabs.includes(sel.activeTab)) {
          sel.activeTab = 'contract';
        }

        sel.contractIdx = contractIdx;
        currentSelection = sel;
        document.getElementById('identity-pill').innerHTML = formatJoinIdentityPill(sel.joinIdentity);
        updateTabCounts(sel.joinIdentity);

        document.querySelectorAll('.drawer-tab').forEach(t => {
          t.classList.toggle('active', t.dataset.tab === sel.activeTab);
        });

        renderDrawerTab(sel.activeTab);

        document.getElementById('drawer').classList.add('active');
        document.getElementById('drawer-overlay').classList.add('active');
      } catch (e) {
        clearSelection();
      }
    }

    function openCommandModal(cmdKey) {
      const cmd = commands.commands?.[cmdKey];
      const desc = commands.descriptions?.[cmdKey] || '';
      if (!cmd) return;
      
      document.getElementById('modal-title').textContent = cmdKey.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      document.getElementById('modal-description').textContent = desc;
      document.getElementById('modal-command').textContent = cmd;
      document.getElementById('modal-status').style.display = 'none';
      updateRunButton();
      document.getElementById('command-modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('command-modal').classList.remove('active');
    }

    function updateRunButton() {
      const confirmChecked = document.getElementById('confirm-run').checked;
      const runBtn = document.getElementById('modal-run');
      runBtn.disabled = !confirmChecked;
      runBtn.textContent = confirmChecked ? 'Run Command' : 'Run (Confirm Required)';
    }

    function showModalStatus(message, type) {
      const status = document.getElementById('modal-status');
      status.textContent = message;
      status.className = 'modal-status ' + type;
      status.style.display = 'block';
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        return true;
      }
    }

    async function loadCommands() {
      try {
        const resp = await fetch(COMMANDS_PATH);
        if (resp.ok) {
          commands = await resp.json();
        }
      } catch (e) {
        console.warn('Could not load run_commands.json');
      }
    }

    async function loadData() {
      const errorContainer = document.getElementById('error-container');
      const sourceInfo = document.getElementById('source-info');
      
      // First try to restore from localStorage
      if (restoreSessionFromStorage()) {
        sourceInfo.textContent = `Data source: ${sessionState.sourceType} (restored from browser)`;
        restoreSelection();
        return;
      }
      
      let data = null;
      let source = '';
      let isFallback = false;
      
      try {
        const resp = await fetch(RELATIVE_PRIMARY);
        if (resp.ok) {
          data = await resp.json();
          source = PRIMARY_PATH;
        }
      } catch (e) {}
      
      if (!data) {
        try {
          const resp = await fetch(RELATIVE_FALLBACK);
          if (resp.ok) {
            data = await resp.json();
            source = FALLBACK_PATH + ' (fallback)';
            isFallback = true;
          }
        } catch (e) {}
      }
      
      if (!data) {
        // No data available - show error and stay in welcome state
        const errorContainer = document.getElementById('error-container');
        if (errorContainer) {
          errorContainer.innerHTML = `<div class="info">No records loaded yet. Click "Data Sources" to load your Preview Packet.</div>`;
        }
        updateSessionChip();
        return;
      }
      
      if (sourceInfo) sourceInfo.textContent = `Data source: ${source}`;
      
      renderSummary(data.sf_summary || {});
      
      allData.contractResults = sortByJoinTriplet(data.sf_contract_results || []);
      allData.issues = sortBySeverityFirst(data.sf_issues || [], ['sheet', 'field', 'issue_type']);
      allData.fieldActions = sortBySeverityFirst(data.sf_field_actions || [], ['sheet', 'field', 'action']);
      allData.changeLog = sortBySeverityFirst(data.sf_change_log || [], ['sheet', 'field', 'notes']);
      allData.summary = data.sf_summary || {};
      
      // Set session state based on source
      sessionState.status = isFallback ? 'fallback' : 'loaded';
      sessionState.sourceType = isFallback ? 'example' : 'fetch';
      sessionState.loadedAt = Date.now();
      sessionState.previewData = data;
      
      // Set data loaded state
      dataLoaded = true;
      currentArtifactPath = source;
      updateUIForDataState();
      updateSessionChip();
      
      populateSubtypeDropdown();
      renderAllTables();
      populateTargetFieldDropdown();
      restoreSelection();
    }

    // Legacy toolbar handler (Run page was removed, but keep for safety)
    const legacyToolbar = document.getElementById('toolbar');
    if (legacyToolbar) {
      legacyToolbar.addEventListener('click', async e => {
        const btn = e.target.closest('.toolbar-btn');
        if (btn) {
          const cmdKey = btn.dataset.cmd;
          const cmd = commands.commands?.[cmdKey];
          if (cmd) {
            const success = await copyToClipboard(cmd);
            openCommandModal(cmdKey);
            showModalStatus(success ? 'Command copied to clipboard!' : 'Could not auto-copy', success ? 'success' : 'error');
          }
        }
      });
    }

    document.getElementById('modal-close')?.addEventListener('click', closeModal);
    document.getElementById('modal-cancel')?.addEventListener('click', closeModal);
    document.getElementById('command-modal')?.addEventListener('click', e => {
      if (e.target.id === 'command-modal') closeModal();
    });

    document.getElementById('modal-copy')?.addEventListener('click', async () => {
      const cmd = document.getElementById('modal-command')?.textContent;
      if (cmd) {
        const success = await copyToClipboard(cmd);
        showModalStatus(success ? 'Copied to clipboard!' : 'Copy failed', success ? 'success' : 'error');
      }
    });

    document.getElementById('modal-run')?.addEventListener('click', () => {
      showModalStatus('Execution is not available in browser environment. Please run the copied command in your terminal.', 'info');
    });

    document.getElementById('confirm-run')?.addEventListener('change', updateRunButton);

    document.getElementById('drawer-close')?.addEventListener('click', closeDrawer);
    document.getElementById('drawer-overlay')?.addEventListener('click', closeDrawer);

    document.getElementById('drawer-tabs')?.addEventListener('click', e => {
      const tab = e.target.closest('.drawer-tab');
      if (!tab) return;
      const tabName = tab.dataset.tab;
      currentSelection.activeTab = tabName;
      document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      const patchStudioPanel = document.getElementById('patch-studio-panel');
      const drawerBody = document.getElementById('drawer-body');
      const actionsDefault = document.getElementById('drawer-actions-default');
      const actionsPatchStudio = document.getElementById('drawer-actions-patch-studio');
      
      if (tabName === 'patch-studio') {
        patchStudioPanel.style.display = 'flex';
        patchStudioPanel.style.flexDirection = 'column';
        drawerBody.style.display = 'none';
        if (actionsDefault) actionsDefault.style.display = 'none';
        if (actionsPatchStudio) actionsPatchStudio.style.display = 'block';
        populatePatchStudioFromContext();
      } else {
        patchStudioPanel.style.display = 'none';
        drawerBody.style.display = 'block';
        if (actionsDefault) actionsDefault.style.display = 'block';
        if (actionsPatchStudio) actionsPatchStudio.style.display = 'none';
        renderDrawerTab(tabName);
      }
      saveSelection();
    });
    
    document.querySelectorAll('.patch-studio-sub-tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        const subtab = this.dataset.subtab;
        document.querySelectorAll('.patch-studio-sub-tab').forEach(function(t) {
          t.style.background = '#263238';
          t.style.color = '#aaa';
          t.classList.remove('active');
        });
        this.style.background = '#1a1a2e';
        this.style.color = 'white';
        this.classList.add('active');
        
        document.querySelectorAll('.patch-studio-sub-panel').forEach(function(panel) {
          panel.style.display = 'none';
        });
        document.getElementById('subtab-' + subtab).style.display = 'block';
      });
    });
    
    function populatePatchStudioFromContext() {
      const identity = currentSelection.joinIdentity;
      if (!identity) return;
      
      const issues = getRelatedRecords(identity, allData.issues);
      if (issues.length > 0) {
        const firstIssue = issues[0];
        var targetFieldSel = document.getElementById('ps-target-field');
        if (targetFieldSel) {
          var fieldVal = (firstIssue.sheet || '') + '.' + (firstIssue.field || '');
          var opt = targetFieldSel.querySelector('option[value="' + fieldVal + '"]');
          if (opt) {
            targetFieldSel.value = fieldVal;
          }
        }
      }
    }
    
    function populateTargetFieldDropdown() {
      var select = document.getElementById('ps-target-field');
      if (!select || !allData) return;
      
      select.innerHTML = '<option value="">-- Select field --</option>';
      var fields = new Set();
      
      // Primary source: use field_index from bundle (computed from sheet_packets)
      var bundle = getCurrentBundle();
      if (bundle && bundle.field_index) {
        bundle.field_index.forEach(function(entry) {
          fields.add(entry.full_path);
        });
      }
      
      // Fallback: also add fields from issues and field_actions
      if (allData.issues) {
        allData.issues.forEach(function(issue) {
          if (issue.sheet && issue.field) {
            fields.add(issue.sheet + '.' + issue.field);
          }
        });
      }
      if (allData.fieldActions) {
        allData.fieldActions.forEach(function(action) {
          if (action.sheet && action.field) {
            fields.add(action.sheet + '.' + action.field);
          }
        });
      }
      
      Array.from(fields).sort().forEach(function(f) {
        var opt = document.createElement('option');
        opt.value = f;
        opt.textContent = f;
        select.appendChild(opt);
      });
      
      var otherOpt = document.createElement('option');
      otherOpt.value = 'OTHER';
      otherOpt.textContent = 'Other (type manually)';
      select.appendChild(otherOpt);
    }
    
    function updateIntentPreview() {
      var targetField = document.getElementById('ps-target-field')?.value || '';
      var conditionType = document.getElementById('ps-condition-type')?.value || '';
      var conditionOther = document.getElementById('ps-condition-other')?.value || '';
      var actionType = document.getElementById('ps-action-type')?.value || '';
      var actionOther = document.getElementById('ps-action-other')?.value || '';
      var because = document.getElementById('ps-intent-because')?.value || '';
      
      var whenText = '';
      if (targetField && targetField !== 'OTHER') {
        whenText = 'Field "' + targetField + '"';
      } else if (targetField === 'OTHER') {
        whenText = 'Field (custom)';
      }
      if (conditionType) {
        var cond = CONDITION_TYPES.find(function(c) { return c.value === conditionType; });
        if (cond) {
          whenText += ' ' + cond.label.toLowerCase();
        }
      }
      if (conditionType === 'OTHER' && conditionOther) {
        whenText += ': ' + conditionOther;
      }
      
      var thenText = '';
      if (actionType) {
        var act = ACTION_TYPES.find(function(a) { return a.value === actionType; });
        if (act) {
          thenText = act.label;
        }
      }
      if (actionType === 'OTHER' && actionOther) {
        thenText += ': ' + actionOther;
      }
      
      document.getElementById('preview-when').textContent = whenText || '(select field and condition)';
      document.getElementById('preview-then').textContent = thenText || '(select action)';
      document.getElementById('preview-because').textContent = because || '(enter comment)';
    }
    
    document.getElementById('ps-condition-type')?.addEventListener('change', function(e) {
      var wrap = document.getElementById('ps-condition-other-wrap');
      if (e.target.value === 'OTHER') {
        wrap.style.display = 'block';
      } else {
        wrap.style.display = 'none';
      }
      updateIntentPreview();
    });
    
    document.getElementById('ps-action-type')?.addEventListener('change', function(e) {
      var wrap = document.getElementById('ps-action-other-wrap');
      if (e.target.value === 'OTHER') {
        wrap.style.display = 'block';
      } else {
        wrap.style.display = 'none';
      }
      updateIntentPreview();
    });
    
    document.getElementById('ps-target-field')?.addEventListener('change', updateIntentPreview);
    document.getElementById('ps-condition-other')?.addEventListener('input', updateIntentPreview);
    document.getElementById('ps-action-other')?.addEventListener('input', updateIntentPreview);
    document.getElementById('ps-intent-because')?.addEventListener('input', updateIntentPreview);
    
    function getPatchStudioDraft() {
      var targetField = document.getElementById('ps-target-field')?.value || '';
      var conditionType = document.getElementById('ps-condition-type')?.value || '';
      var conditionOther = document.getElementById('ps-condition-other')?.value || '';
      var actionType = document.getElementById('ps-action-type')?.value || '';
      var actionOther = document.getElementById('ps-action-other')?.value || '';
      var because = document.getElementById('ps-intent-because')?.value || '';
      
      var intentStructured = {
        target_field: targetField !== 'OTHER' ? targetField : null,
        condition_type: conditionType || 'OTHER',
        condition_params: conditionType === 'OTHER' && conditionOther ? { custom: conditionOther } : null,
        action_type: actionType || 'OTHER',
        action_params: actionType === 'OTHER' && actionOther ? { custom: actionOther } : null,
        because: because
      };
      
      return {
        intent_structured: intentStructured,
        target: document.getElementById('ps-target')?.value || 'proposed_changes',
        risk: document.getElementById('ps-risk')?.value || 'low',
        rationale: document.getElementById('ps-rationale')?.value || '',
        evidence: {
          observation: document.getElementById('ps-evidence-observation')?.value || '',
          expected_behavior: document.getElementById('ps-evidence-expected')?.value || '',
          rule_justification: document.getElementById('ps-evidence-justification')?.value || '',
          repro_steps: document.getElementById('ps-evidence-repro')?.value || ''
        }
      };
    }
    
    function clearPatchStudioForm() {
      document.getElementById('ps-target-field').value = '';
      document.getElementById('ps-condition-type').value = '';
      document.getElementById('ps-condition-other').value = '';
      document.getElementById('ps-condition-other-wrap').style.display = 'none';
      document.getElementById('ps-action-type').value = '';
      document.getElementById('ps-action-other').value = '';
      document.getElementById('ps-action-other-wrap').style.display = 'none';
      document.getElementById('ps-intent-because').value = '';
      document.getElementById('ps-target').value = 'proposed_changes';
      document.getElementById('ps-risk').value = 'low';
      document.getElementById('ps-rationale').value = '';
      document.getElementById('ps-evidence-observation').value = '';
      document.getElementById('ps-evidence-expected').value = '';
      document.getElementById('ps-evidence-justification').value = '';
      document.getElementById('ps-evidence-repro').value = '';
      updateIntentPreview();
    }
    
    function validatePatchStudioForm() {
      var targetField = document.getElementById('ps-target-field')?.value || '';
      var conditionType = document.getElementById('ps-condition-type')?.value || '';
      var conditionOther = document.getElementById('ps-condition-other')?.value || '';
      var actionType = document.getElementById('ps-action-type')?.value || '';
      var actionOther = document.getElementById('ps-action-other')?.value || '';
      var because = document.getElementById('ps-intent-because')?.value || '';
      
      var errors = [];
      if (!targetField) errors.push('Target Field is required');
      if (!conditionType) errors.push('Condition Type is required');
      if (conditionType === 'OTHER' && !conditionOther) errors.push('Please describe the condition');
      if (!actionType) errors.push('Action Type is required');
      if (actionType === 'OTHER' && !actionOther) errors.push('Please describe the action');
      if (!because) errors.push('Comment (plain English) is required');
      if (because.length > 500) errors.push('Comment must be 500 characters or less');
      
      return errors;
    }
    
    document.getElementById('ps-submit-to-queue')?.addEventListener('click', function() {
      var errors = validatePatchStudioForm();
      if (errors.length > 0) {
        showToast(errors[0], 'warning');
        return;
      }
      
      const draft = getPatchStudioDraft();
      const identity = currentSelection.joinIdentity || {};
      const author = 'Analyst';
      
      var request = createPatchRequest({
        author: author,
        author_role: currentMode || 'Analyst',
        status: 'Draft',
        contract_key: identity.contract_key || null,
        file_url: identity.file_url || null,
        file_name: identity.file_name || null,
        target: draft.target,
        target_field: draft.intent_structured.target_field,
        condition_type: draft.intent_structured.condition_type,
        condition_params: draft.intent_structured.condition_params,
        action_type: draft.intent_structured.action_type,
        action_params: draft.intent_structured.action_params,
        because: draft.intent_structured.because,
        rationale: draft.rationale,
        risk: draft.risk,
        evidence_observation: draft.evidence.observation,
        evidence_expected: draft.evidence.expected_behavior,
        evidence_justification: draft.evidence.rule_justification,
        evidence_repro: draft.evidence.repro_steps
      });
      
      var submittedRequest = submitPatchRequest(request.request_id, author, currentMode || 'Analyst');
      
      if (submittedRequest) {
        showToast('Patch request submitted to queue: ' + request.request_id, 'success');
        clearPatchStudioForm();
        updatePatchQueueCounts();
        
        document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
        document.querySelector('.drawer-tab[data-tab="contract"]')?.classList.add('active');
        document.getElementById('patch-studio-panel').style.display = 'none';
        document.getElementById('drawer-body').style.display = 'block';
        document.getElementById('drawer-actions-default').style.display = 'block';
        document.getElementById('drawer-actions-patch-studio').style.display = 'none';
        renderDrawerTab('contract');
      } else {
        showToast('Failed to submit patch request', 'error');
      }
    });
    
    document.getElementById('ps-copy-draft')?.addEventListener('click', async function() {
      const draft = getPatchStudioDraft();
      const json = JSON.stringify(draft, null, 2);
      const success = await copyToClipboard(json);
      showToast(success ? 'Draft copied to clipboard' : 'Failed to copy', success ? 'success' : 'error');
    });
    
    document.getElementById('ps-save-local')?.addEventListener('click', function() {
      const draft = getPatchStudioDraft();
      localStorage.setItem('orchestrate.patch_studio.draft', JSON.stringify(draft));
      showToast('Draft saved locally', 'success');
    });
    
    document.getElementById('ps-run-preflight')?.addEventListener('click', function() {
      runPreflightChecks();
    });
    
    document.getElementById('ps-copy-preflight')?.addEventListener('click', async function() {
      const report = generatePreflightReport();
      const success = await copyToClipboard(JSON.stringify(report, null, 2));
      showToast(success ? 'Preflight report copied' : 'Failed to copy', success ? 'success' : 'error');
    });
    
    function runPreflightChecks() {
      const draft = getPatchStudioDraft();
      const checks = [];
      
      if (draft.intent.when && draft.intent.then) {
        checks.push({ status: 'PASS', message: 'Intent fields populated' });
      } else {
        checks.push({ status: 'FAIL', message: 'Intent fields incomplete (WHEN and THEN required)' });
      }
      
      if (draft.evidence.observation || draft.evidence.expected_behavior) {
        checks.push({ status: 'PASS', message: 'Evidence pack has content' });
      } else {
        checks.push({ status: 'WARN', message: 'Evidence pack incomplete' });
      }
      
      checks.push({ status: 'INFO', message: 'Target: ' + humanLabel(draft.target) });
      checks.push({ status: 'INFO', message: 'Risk level: ' + draft.risk });
      
      const container = document.getElementById('ps-preflight-checks');
      container.innerHTML = checks.map(function(check) {
        var badgeClass = check.status === 'PASS' ? 'background: #e8f5e9; color: #2e7d32;' :
                         check.status === 'FAIL' ? 'background: #ffebee; color: #c62828;' :
                         check.status === 'WARN' ? 'background: #fff3e0; color: #e65100;' :
                         'background: #e3f2fd; color: #1565c0;';
        return '<div class="preflight-check" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f5f5f5; border-radius: 6px;">' +
          '<span class="preflight-badge" style="padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600; ' + badgeClass + '">' + check.status + '</span>' +
          '<span style="font-size: 0.9em;">' + escapeHtml(check.message) + '</span>' +
          '</div>';
      }).join('');
    }
    
    function generatePreflightReport() {
      const draft = getPatchStudioDraft();
      return {
        generated_at: new Date().toISOString(),
        intent_complete: !!(draft.intent.when && draft.intent.then),
        evidence_complete: !!(draft.evidence.observation && draft.evidence.expected_behavior),
        target: draft.target,
        risk: draft.risk,
        draft_snapshot: draft
      };
    }
    
    function copyEvidenceBlock(block) {
      var value = '';
      switch(block) {
        case 'observation': value = document.getElementById('ps-evidence-observation')?.value || ''; break;
        case 'expected': value = document.getElementById('ps-evidence-expected')?.value || ''; break;
        case 'justification': value = document.getElementById('ps-evidence-justification')?.value || ''; break;
        case 'repro': value = document.getElementById('ps-evidence-repro')?.value || ''; break;
      }
      copyToClipboard(value).then(function(success) {
        showToast(success ? 'Evidence block copied' : 'Failed to copy', success ? 'success' : 'error');
      });
    }

    document.getElementById('drawer-copy')?.addEventListener('click', async () => {
      const rawJson = document.getElementById('drawer-body').dataset.json || '{}';
      const parsed = JSON.parse(rawJson);
      const sorted = sortObjectKeys(parsed);
      const json = JSON.stringify(sorted, null, 2);
      const success = await copyToClipboard(json);
      const btn = document.getElementById('drawer-copy');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('identity-copy')?.addEventListener('click', async () => {
      const identity = currentSelection.joinIdentity;
      if (!identity) return;
      const text = formatJoinIdentityText(identity);
      const success = await copyToClipboard(text);
      const btn = document.getElementById('identity-copy');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    function sortObjectKeys(obj) {
      if (obj === null || typeof obj !== 'object') return obj;
      if (Array.isArray(obj)) return obj.map(sortObjectKeys);
      return Object.keys(obj).sort().reduce((acc, key) => {
        acc[key] = sortObjectKeys(obj[key]);
        return acc;
      }, {});
    }

    function generatePRSummary() {
      const identity = currentSelection.joinIdentity;
      if (!identity) return '';
      const contract = currentSelection.contractIdx !== null 
        ? allData.contractResults[currentSelection.contractIdx] : null;
      const issues = sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']);
      const actions = sortBySeverityFirst(getRelatedRecords(identity, allData.fieldActions), ['sheet', 'field', 'action']);
      const primary = getPrimaryKey(identity);
      const primaryVal = identity[primary] || 'unknown';

      let md = `# PR: Fix issues for ${primary}=${primaryVal}\n\n`;
      md += `## WHY\n`;
      md += `This record has ${issues.length} issue(s) and ${actions.length} pending action(s) that need resolution.\n\n`;
      md += `## Affected Artifacts\n`;
      md += `- **Join Identity**: ${formatJoinIdentityText(identity)}\n`;
      md += `- **Contract Status**: ${contract?.sf_contract_status || 'unknown'}\n`;
      md += `- **Detected Subtype**: ${contract?.detected_subtype || 'unknown'}\n`;
      if (issues.length > 0) {
        md += `- **Issues**: ${issues.map(i => i.issue_type).join(', ')}\n`;
      }
      md += `\n## Smoke Status\nunknown (run \`bash scripts/replit_smoke.sh\` to verify)\n`;
      return md;
    }

    function generatePatchSkeleton() {
      const identity = currentSelection.joinIdentity;
      if (!identity) return '{}';
      const issues = sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']);
      const primary = getPrimaryKey(identity);
      const primaryVal = (identity[primary] || 'unknown').replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
      const patch = {
        base_version: "0.1.0",
        changes: issues.map((issue, idx) => ({
          op: "add_rule",
          rule_id: `NEW_RULE_${primaryVal}_${idx + 1}`,
          description: `Fix: ${issue.issue_type} on ${issue.field || 'unknown'}`,
          when: { sheet: issue.sheet || "", field: issue.field || "", operator: "EXISTS", value: null },
          then: { action: "REQUIRE_PRESENT", sheet: issue.sheet || "", field: issue.field || "", severity: issue.severity || "warning" }
        }))
      };
      return JSON.stringify(sortObjectKeys(patch), null, 2);
    }

    function generateRuleDraft() {
      const identity = currentSelection.joinIdentity;
      if (!identity) return '';
      const issues = sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']);
      const primary = getPrimaryKey(identity);
      
      let draft = `# Rule Draft\n\n`;
      if (issues.length === 0) {
        draft += `No issues found for this join identity.\n`;
      } else {
        issues.forEach((issue, idx) => {
          draft += `## Rule ${idx + 1}\n\n`;
          draft += `**WHEN**\n`;
          draft += `- Sheet: ${issue.sheet || 'any'}\n`;
          draft += `- Field: ${issue.field || 'any'}\n`;
          draft += `- Condition: ${issue.issue_type || 'unknown'}\n\n`;
          draft += `**THEN**\n`;
          draft += `- Action: REQUIRE_PRESENT\n`;
          draft += `- Severity: ${issue.severity || 'warning'}\n\n`;
          draft += `**BECAUSE**\n`;
          draft += `- ${issue.details || 'Issue detected during validation'}\n`;
          draft += `- Primary key: ${primary}=${identity[primary]}\n\n`;
        });
      }
      return draft;
    }

    document.getElementById('copy-pr-summary')?.addEventListener('click', async () => {
      const text = generatePRSummaryWithEvidence();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-pr-summary');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-rule-draft')?.addEventListener('click', async () => {
      const text = generateRuleDraft();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-rule-draft');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('filter-search')?.addEventListener('input', e => {
      activeFilters.search = e.target.value;
      renderAllTables();
    });

    document.getElementById('severity-chips')?.addEventListener('click', e => {
      const chip = e.target.closest('.filter-chip');
      if (!chip) return;
      const sev = chip.dataset.severity;
      const idx = activeFilters.severities.indexOf(sev);
      if (idx >= 0) {
        activeFilters.severities.splice(idx, 1);
        chip.classList.add('inactive');
      } else {
        activeFilters.severities.push(sev);
        chip.classList.remove('inactive');
      }
      renderAllTables();
    });

    document.getElementById('status-chips')?.addEventListener('click', e => {
      const chip = e.target.closest('.filter-chip');
      if (!chip) return;
      const status = chip.dataset.status;
      const idx = activeFilters.statuses.indexOf(status);
      if (idx >= 0) {
        activeFilters.statuses.splice(idx, 1);
        chip.classList.add('inactive');
      } else {
        activeFilters.statuses.push(status);
        chip.classList.remove('inactive');
      }
      renderAllTables();
    });

    document.getElementById('filter-subtype')?.addEventListener('change', e => {
      activeFilters.subtype = e.target.value;
      renderAllTables();
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeModal();
        closeDrawer();
      }
    });

    document.getElementById('drawer-body')?.addEventListener('change', e => {
      if (e.target.type !== 'checkbox') return;
      const key = e.target.dataset.key;
      const tabType = document.getElementById('drawer-body').dataset.tabType;
      if (!tabType || tabType === 'contract') return;
      
      const selectionSet = selectedRecords[tabType];
      if (!selectionSet) return;
      
      if (e.target.checked) {
        selectionSet.add(key);
      } else {
        selectionSet.delete(key);
      }
      updateSelectionCount(tabType);
    });

    document.getElementById('drawer-body')?.addEventListener('click', e => {
      const btn = e.target.closest('.selection-btn');
      if (!btn) return;
      
      const action = btn.dataset.action;
      const tabType = btn.dataset.tab;
      const records = JSON.parse(document.getElementById('drawer-body').dataset.records || '[]');
      
      if (action === 'select-all') {
        records.forEach(r => selectedRecords[tabType].add(getRecordKey(r)));
        renderDrawerTab(currentSelection.activeTab);
      } else if (action === 'clear') {
        selectedRecords[tabType].clear();
        renderDrawerTab(currentSelection.activeTab);
      } else if (action === 'add-to-patch') {
        addSelectedToPatch(tabType);
      }
    });

    function updateSelectionCount(tabType) {
      const countEl = document.querySelector(`.selection-count`);
      if (countEl) {
        const records = JSON.parse(document.getElementById('drawer-body').dataset.records || '[]');
        countEl.textContent = `${selectedRecords[tabType]?.size || 0} of ${records.length} selected`;
      }
    }

    function addSelectedToPatch(tabType) {
      const records = JSON.parse(document.getElementById('drawer-body').dataset.records || '[]');
      const selectionSet = selectedRecords[tabType];
      const selected = records.filter(r => selectionSet.has(getRecordKey(r)));
      
      selected.forEach(record => {
        const key = getRecordKey(record);
        const exists = patchDraft.changes.some(c => c._key === key);
        if (!exists) {
          patchDraft.changes.push({
            _key: key,
            _source: tabType,
            record: record
          });
        }
      });
      
      renderPatchChanges();
      savePatchDraft();
      document.getElementById('patch-studio').classList.add('active');
    }

    function renderPatchChanges() {
      const list = document.getElementById('patch-changes-list');
      const count = document.getElementById('patch-changes-count');
      count.textContent = patchDraft.changes.length;
      
      if (patchDraft.changes.length === 0) {
        list.innerHTML = '<div class="patch-empty">No changes added. Select issues/actions in the Workbench tabs and add them here.</div>';
        return;
      }
      
      const sorted = sortBySeverityFirst([...patchDraft.changes].map(c => c.record), ['sheet', 'field']);
      const sortedChanges = sorted.map(r => patchDraft.changes.find(c => c._key === getRecordKey(r)));
      
      list.innerHTML = sortedChanges.map((change, idx) => {
        const r = change.record;
        const typeLabel = change._source === 'issues' ? 'Issue' : change._source === 'actions' ? 'Action' : 'Log';
        const desc = r.issue_type || r.action || r.notes || 'unknown';
        return `
          <div class="patch-change-item" data-idx="${idx}">
            <div class="patch-change-info">
              <strong>${typeLabel}:</strong> ${desc}<br>
              <small>${r.sheet || '-'} / ${r.field || '-'} (${r.severity || 'info'})</small>
            </div>
            <button class="patch-change-remove" data-key="${change._key}">&times;</button>
          </div>
        `;
      }).join('');
    }

    document.getElementById('patch-changes-list')?.addEventListener('click', e => {
      const btn = e.target.closest('.patch-change-remove');
      if (!btn) return;
      const key = btn.dataset.key;
      patchDraft.changes = patchDraft.changes.filter(c => c._key !== key);
      renderPatchChanges();
      savePatchDraft();
    });

    document.getElementById('clear-patch-changes')?.addEventListener('click', () => {
      patchDraft.changes = [];
      renderPatchChanges();
      savePatchDraft();
    });

    document.getElementById('switch-to-patch-studio-tab')?.addEventListener('click', () => {
      var patchStudioTab = document.querySelector('.drawer-tab[data-tab="patch-studio"]');
      if (patchStudioTab) {
        patchStudioTab.click();
      }
    });

    document.getElementById('patch-base-version')?.addEventListener('input', e => {
      patchDraft.baseVersion = e.target.value;
      savePatchDraft();
    });

    document.getElementById('patch-author')?.addEventListener('input', e => {
      patchDraft.author = e.target.value;
      savePatchDraft();
    });

    document.getElementById('patch-rationale')?.addEventListener('input', e => {
      patchDraft.rationale = e.target.value;
      savePatchDraft();
    });

    function generateGroupedRules() {
      const changes = patchDraft.changes;
      if (changes.length === 0) return '';
      
      const sorted = sortBySeverityFirst(changes.map(c => c.record), ['sheet', 'field']);
      const groups = new Map();
      
      sorted.forEach(record => {
        const whenKey = `${record.sheet || ''}|${record.field || ''}`;
        if (!groups.has(whenKey)) {
          groups.set(whenKey, []);
        }
        groups.get(whenKey).push(record);
      });
      
      let draft = `# Grouped Rule Draft\n\n`;
      let ruleNum = 1;
      
      groups.forEach((records, whenKey) => {
        const [sheet, field] = whenKey.split('|');
        draft += `## Rule ${ruleNum}\n\n`;
        draft += `**WHEN**\n`;
        draft += `- Sheet: ${sheet || 'any'}\n`;
        draft += `- Field: ${field || 'any'}\n\n`;
        draft += `**THEN**\n`;
        records.forEach(r => {
          const actionType = r.issue_type || r.action || 'REQUIRE_PRESENT';
          draft += `- ${actionType} (${r.severity || 'warning'})\n`;
        });
        draft += `\n**BECAUSE**\n`;
        records.forEach(r => {
          draft += `- ${r.details || r.reason_text || r.notes || 'Issue detected'}\n`;
        });
        draft += `\n`;
        ruleNum++;
      });
      
      return draft;
    }

    function getRuleIdPrefix(record) {
      const identity = getJoinIdentity(record);
      const primary = getPrimaryKey(identity);
      const primaryVal = identity[primary] || 'unknown';
      return String(primaryVal).replace(/[^a-zA-Z0-9]/g, '_').substring(0, 15);
    }

    function generateRuleMapping() {
      const changes = patchDraft.changes;
      if (changes.length === 0) return '[]';
      
      const sorted = sortBySeverityFirst(changes.map(c => c.record), ['sheet', 'field']);
      
      const rules = sorted.map((record, idx) => ({
        op: 'add_rule',
        rule_id: `RULE_${getRuleIdPrefix(record)}_${idx + 1}`,
        description: `Fix: ${record.issue_type || record.action || 'unknown'} on ${record.field || 'unknown'}`,
        when: {
          sheet: record.sheet || '',
          field: record.field || '',
          operator: 'EXISTS',
          value: null
        },
        then: {
          action: record.action || 'REQUIRE_PRESENT',
          sheet: record.sheet || '',
          field: record.field || '',
          severity: record.severity || 'warning'
        }
      }));
      
      return JSON.stringify(sortObjectKeys(rules), null, 2);
    }

    function generateFullPatchDraft() {
      const baseVersion = document.getElementById('patch-base-version').value || null;
      const author = document.getElementById('patch-author').value || null;
      const rationale = document.getElementById('patch-rationale').value || null;
      
      const changes = patchDraft.changes;
      const sorted = sortBySeverityFirst(changes.map(c => c.record), ['sheet', 'field']);
      
      const changesArray = sorted.map((record, idx) => ({
        op: 'add_rule',
        rule_id: `RULE_${getRuleIdPrefix(record)}_${idx + 1}`,
        description: `Fix: ${record.issue_type || record.action || 'unknown'} on ${record.field || 'unknown'}`,
        when: {
          sheet: record.sheet || '',
          field: record.field || '',
          operator: 'EXISTS',
          value: null
        },
        then: {
          action: record.action || 'REQUIRE_PRESENT',
          sheet: record.sheet || '',
          field: record.field || '',
          severity: record.severity || 'warning'
        }
      }));
      
      const patch = {
        base_version: baseVersion,
        author: author,
        rationale: rationale,
        changes: changesArray
      };
      
      return JSON.stringify(sortObjectKeys(patch), null, 2);
    }

    document.getElementById('copy-full-patch')?.addEventListener('click', async () => {
      const text = generateFullPatchDraft();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-full-patch');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-rule-mapping')?.addEventListener('click', async () => {
      const text = generateRuleMapping();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-rule-mapping');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-grouped-rules')?.addEventListener('click', async () => {
      const text = generateGroupedRules();
      const success = await copyToClipboard(text);
      const btn = document.getElementById('copy-grouped-rules');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-smoke-baseline')?.addEventListener('click', async () => {
      const cmd = commands.commands?.smoke_baseline || 'bash scripts/replit_smoke.sh';
      const success = await copyToClipboard(cmd);
      const btn = document.getElementById('copy-smoke-baseline');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-smoke-edge')?.addEventListener('click', async () => {
      const cmd = commands.commands?.smoke_edge || 'bash scripts/replit_smoke.sh edge';
      const success = await copyToClipboard(cmd);
      const btn = document.getElementById('copy-smoke-edge');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('copy-evidence-template')?.addEventListener('click', async () => {
      const identity = currentSelection.joinIdentity;
      const primary = identity ? getPrimaryKey(identity) : null;
      const primaryVal = identity?.[primary] || 'unknown';
      
      const template = `# Evidence for Patch

## Commit
- **SHA**: <COMMIT_SHA>
- **Branch**: main

## Verification
- [ ] Smoke baseline passed
- [ ] Smoke edge passed
- [ ] Manual review completed

## Artifacts
- **Join Identity**: ${identity ? formatJoinIdentityText(identity) : 'N/A'}
- **Primary Key**: ${primary || 'N/A'}=${primaryVal}
- **Patch File SHA256**: <SHA256_HASH>

## Notes
Add any additional notes here.
`;
      const success = await copyToClipboard(template);
      const btn = document.getElementById('copy-evidence-template');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    var patchStudioTabs = document.querySelector('.patch-studio-tabs');
    if (patchStudioTabs) {
      patchStudioTabs.addEventListener('click', function(e) {
        var tab = e.target.closest('.patch-studio-tab');
        if (!tab) return;
        var panelName = tab.dataset.panel;
        document.querySelectorAll('.patch-studio-tab').forEach(function(t) { t.classList.remove('active'); });
        tab.classList.add('active');
        document.querySelectorAll('.patch-studio-panel').forEach(function(p) { p.classList.remove('active'); });
        var panelEl = document.getElementById('panel-' + panelName);
        if (panelEl) panelEl.classList.add('active');
        if (panelName === 'preflight') renderPreflightChecklist();
      });
    }

    function parseBaseVersion(input) {
      const trimmed = input.trim();
      if (!trimmed) return { parsed: null, status: 'pending' };
      if (trimmed.startsWith('{')) {
        try {
          const json = JSON.parse(trimmed);
          if (json.version) return { parsed: { version: json.version }, status: 'pass' };
          return { parsed: null, status: 'warn', message: 'No version field found in JSON' };
        } catch (e) {
          return { parsed: null, status: 'warn', message: 'Invalid JSON, storing as raw text' };
        }
      }
      const versionMatch = trimmed.match(/^(\d+\.\d+\.\d+)$/);
      if (versionMatch) return { parsed: { version: versionMatch[1] }, status: 'pass' };
      return { parsed: { version: trimmed }, status: 'warn', message: 'Non-standard version format' };
    }

    function parseValidation(input) {
      const trimmed = input.trim();
      if (!trimmed) return { parsed: null, status: 'pending' };
      const result = { status: 'unknown', baseVersion: null, patchBaseVersion: null, changesCount: null, conflicts: [] };
      if (trimmed.toLowerCase().includes('ok:') || trimmed.toLowerCase().includes('valid')) {
        result.status = 'ok';
      } else if (trimmed.toLowerCase().includes('error') || trimmed.toLowerCase().includes('fail')) {
        result.status = 'error';
      }
      const bvMatch = trimmed.match(/base\.version[:\s]+([0-9.]+)/i);
      if (bvMatch) result.baseVersion = bvMatch[1];
      const pbvMatch = trimmed.match(/patch\.base_version[:\s]+([0-9.]+)/i);
      if (pbvMatch) result.patchBaseVersion = pbvMatch[1];
      const ccMatch = trimmed.match(/changes_count[:\s]+(\d+)/i);
      if (ccMatch) result.changesCount = parseInt(ccMatch[1]);
      const conflictMatches = [...trimmed.matchAll(/conflict[:\s]*(.*?)(?:\n|$)/gi)];
      result.conflicts = conflictMatches.map(m => m[1].trim()).filter(Boolean);
      if (result.status === 'ok') return { parsed: result, status: 'pass' };
      if (result.status === 'error') return { parsed: result, status: 'fail' };
      return { parsed: result, status: 'warn', message: 'Could not determine validation status' };
    }

    function parseConflict(input) {
      const trimmed = input.trim().toLowerCase();
      if (!trimmed) return { parsed: null, status: 'pending' };
      if (trimmed === 'reviewed') return { parsed: { reviewed: true }, status: 'warn', message: 'Manual review confirmed' };
      if (trimmed.includes('no conflict') || trimmed.includes('0 conflicts')) {
        return { parsed: { conflicts: [], count: 0 }, status: 'pass' };
      }
      const conflictLines = input.trim().split('\n').filter(l => l.trim() && !l.toLowerCase().includes('no conflict'));
      if (conflictLines.length > 0) {
        return { parsed: { conflicts: conflictLines, count: conflictLines.length }, status: 'fail', message: `${conflictLines.length} conflict(s) found` };
      }
      return { parsed: { reviewed: true }, status: 'warn', message: 'Content stored for manual review' };
    }

    function parseSmoke(input) {
      const trimmed = input.trim();
      if (!trimmed) return { parsed: null, status: 'pending' };
      if (trimmed.toLowerCase().includes('ok:') || trimmed.toLowerCase().includes('matches expected')) {
        return { parsed: { pass: true }, status: 'pass' };
      }
      if (trimmed.toLowerCase().includes('fail') || trimmed.toLowerCase().includes('error') || trimmed.toLowerCase().includes('mismatch')) {
        return { parsed: { pass: false }, status: 'fail' };
      }
      return { parsed: { raw: trimmed }, status: 'warn', message: 'Could not determine pass/fail' };
    }

    function renderPreflightChecklist() {
      const steps = [
        { id: 1, title: 'Base Version Check', key: 'baseVersion', desc: getStepDescription('baseVersion') },
        { id: 2, title: 'Validation Report', key: 'validation', desc: getStepDescription('validation') },
        { id: 3, title: 'Conflict Check', key: 'conflict', desc: getStepDescription('conflict') },
        { id: 4, title: 'Smoke Evidence', key: 'smoke', desc: getStepDescription('smoke') }
      ];
      const html = steps.map(step => {
        const status = getStepStatus(step.key);
        return `
          <div class="preflight-step">
            <div class="preflight-step-num ${status}">${step.id}</div>
            <div class="preflight-step-info">
              <div class="preflight-step-title">${step.title}</div>
              <div class="preflight-step-status">${step.desc}</div>
            </div>
            <span class="preflight-step-chip ${status}">${status}</span>
          </div>
        `;
      }).join('');
      document.getElementById('preflight-checklist').innerHTML = html;
    }

    function getStepStatus(key) {
      if (key === 'smoke') {
        const baseline = preflightEvidence.smokeBaseline.status;
        if (baseline === 'pass') return 'pass';
        if (baseline === 'fail') return 'fail';
        if (baseline === 'warn') return 'warn';
        return 'pending';
      }
      return preflightEvidence[key]?.status || 'pending';
    }

    function getStepDescription(key) {
      const ev = preflightEvidence;
      if (key === 'baseVersion') {
        if (ev.baseVersion.parsed?.version) return `Version: ${ev.baseVersion.parsed.version}`;
        if (ev.baseVersion.status === 'warn') return ev.baseVersion.message || 'Needs review';
        return 'Not provided';
      }
      if (key === 'validation') {
        if (ev.validation.parsed) {
          const p = ev.validation.parsed;
          if (p.status === 'ok') return `Valid (base: ${p.baseVersion || '?'}, changes: ${p.changesCount || '?'})`;
          if (p.status === 'error') return 'Validation failed';
        }
        if (ev.validation.status === 'warn') return ev.validation.message || 'Needs review';
        return 'Not provided';
      }
      if (key === 'conflict') {
        if (ev.conflict.parsed?.count === 0) return 'No conflicts';
        if (ev.conflict.parsed?.count > 0) return `${ev.conflict.parsed.count} conflict(s)`;
        if (ev.conflict.parsed?.reviewed) return 'Manual review confirmed';
        return 'Not provided';
      }
      if (key === 'smoke') {
        const parts = [];
        if (ev.smokeBaseline.parsed?.pass === true) parts.push('Baseline: PASS');
        else if (ev.smokeBaseline.parsed?.pass === false) parts.push('Baseline: FAIL');
        else if (ev.smokeBaseline.status === 'warn') parts.push('Baseline: Review');
        if (ev.smokeEdge.parsed?.pass === true) parts.push('Edge: PASS');
        else if (ev.smokeEdge.parsed?.pass === false) parts.push('Edge: FAIL');
        else if (ev.smokeEdge.status === 'warn') parts.push('Edge: Review');
        return parts.length > 0 ? parts.join(', ') : 'Not provided';
      }
      return 'Unknown';
    }

    function renderPreflightResult(containerId, evidence) {
      const container = document.getElementById(containerId);
      if (!evidence.parsed && evidence.status === 'pending') {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'block';
      container.className = `preflight-result ${evidence.status}`;
      let html = '';
      if (evidence.message) {
        html += `<div style="margin-bottom:6px;"><em>${evidence.message}</em></div>`;
      }
      if (evidence.parsed) {
        const entries = Object.entries(evidence.parsed).filter(([k, v]) => v !== null && k !== 'conflicts');
        entries.sort((a, b) => a[0].localeCompare(b[0]));
        entries.forEach(([key, val]) => {
          html += `<div class="preflight-result-row"><span class="preflight-result-key">${key}:</span><span class="preflight-result-val">${val}</span></div>`;
        });
        if (evidence.parsed.conflicts && evidence.parsed.conflicts.length > 0) {
          html += `<table class="preflight-conflicts-table"><thead><tr><th>#</th><th>Conflict</th></tr></thead><tbody>`;
          evidence.parsed.conflicts.forEach((c, i) => {
            html += `<tr><td>${i + 1}</td><td>${c}</td></tr>`;
          });
          html += `</tbody></table>`;
        }
      }
      container.innerHTML = html || '<em>Parsed successfully</em>';
    }

    function handlePreflightParse(type) {
      if (type === 'base-version') {
        const input = document.getElementById('preflight-base-version').value;
        const result = parseBaseVersion(input);
        preflightEvidence.baseVersion = { raw: input, ...result };
        renderPreflightResult('preflight-base-result', preflightEvidence.baseVersion);
      } else if (type === 'validation') {
        const input = document.getElementById('preflight-validation-input').value;
        const result = parseValidation(input);
        preflightEvidence.validation = { raw: input, ...result };
        renderPreflightResult('preflight-validation-result', preflightEvidence.validation);
      } else if (type === 'conflict') {
        const input = document.getElementById('preflight-conflict-input').value;
        const result = parseConflict(input);
        preflightEvidence.conflict = { raw: input, ...result };
        renderPreflightResult('preflight-conflict-result', preflightEvidence.conflict);
      } else if (type === 'smoke-baseline') {
        const input = document.getElementById('preflight-smoke-baseline-input').value;
        const result = parseSmoke(input);
        preflightEvidence.smokeBaseline = { raw: input, ...result };
        updateSmokeResult();
      } else if (type === 'smoke-edge') {
        const input = document.getElementById('preflight-smoke-edge-input').value;
        const result = parseSmoke(input);
        preflightEvidence.smokeEdge = { raw: input, ...result };
        updateSmokeResult();
      }
      renderPreflightChecklist();
      savePreflightEvidence();
    }

    function updateSmokeResult() {
      const container = document.getElementById('preflight-smoke-result');
      const baseline = preflightEvidence.smokeBaseline;
      const edge = preflightEvidence.smokeEdge;
      const sha = document.getElementById('preflight-sha256').value;
      preflightEvidence.sha256 = sha;
      if (baseline.status === 'pending' && edge.status === 'pending') {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'block';
      const overallStatus = (baseline.status === 'fail' || edge.status === 'fail') ? 'fail' :
        (baseline.status === 'pass' && (edge.status === 'pass' || edge.status === 'pending')) ? 'pass' : 'warn';
      container.className = `preflight-result ${overallStatus}`;
      let html = '';
      html += `<div class="preflight-result-row"><span class="preflight-result-key">Baseline:</span><span class="preflight-result-val">${baseline.parsed?.pass === true ? 'PASS' : baseline.parsed?.pass === false ? 'FAIL' : baseline.status}</span></div>`;
      if (edge.status !== 'pending') {
        html += `<div class="preflight-result-row"><span class="preflight-result-key">Edge:</span><span class="preflight-result-val">${edge.parsed?.pass === true ? 'PASS' : edge.parsed?.pass === false ? 'FAIL' : edge.status}</span></div>`;
      }
      if (sha) {
        html += `<div class="preflight-result-row"><span class="preflight-result-key">SHA256:</span><span class="preflight-result-val" style="word-break:break-all;">${sha}</span></div>`;
      }
      container.innerHTML = html;
    }

    function handlePreflightClear(type) {
      if (type === 'base-version') {
        document.getElementById('preflight-base-version').value = '';
        preflightEvidence.baseVersion = { raw: '', parsed: null, status: 'pending' };
        document.getElementById('preflight-base-result').style.display = 'none';
      } else if (type === 'validation') {
        document.getElementById('preflight-validation-input').value = '';
        preflightEvidence.validation = { raw: '', parsed: null, status: 'pending' };
        document.getElementById('preflight-validation-result').style.display = 'none';
      } else if (type === 'conflict') {
        document.getElementById('preflight-conflict-input').value = '';
        preflightEvidence.conflict = { raw: '', parsed: null, status: 'pending' };
        document.getElementById('preflight-conflict-result').style.display = 'none';
      } else if (type === 'smoke-baseline') {
        document.getElementById('preflight-smoke-baseline-input').value = '';
        preflightEvidence.smokeBaseline = { raw: '', parsed: null, status: 'pending' };
        updateSmokeResult();
      } else if (type === 'smoke-edge') {
        document.getElementById('preflight-smoke-edge-input').value = '';
        preflightEvidence.smokeEdge = { raw: '', parsed: null, status: 'pending' };
        updateSmokeResult();
      }
      renderPreflightChecklist();
      savePreflightEvidence();
    }

    document.getElementById('panel-preflight')?.addEventListener('click', e => {
      const parseBtn = e.target.closest('.preflight-parse-btn');
      if (parseBtn) {
        handlePreflightParse(parseBtn.dataset.parse);
        return;
      }
      const clearBtn = e.target.closest('.preflight-clear-btn');
      if (clearBtn) {
        handlePreflightClear(clearBtn.dataset.clear);
        return;
      }
    });

    document.getElementById('preflight-sha256')?.addEventListener('input', () => {
      preflightEvidence.sha256 = document.getElementById('preflight-sha256').value;
      updateSmokeResult();
      savePreflightEvidence();
    });

    document.getElementById('preflight-reset')?.addEventListener('click', () => {
      preflightEvidence = {
        baseVersion: { raw: '', parsed: null, status: 'pending' },
        validation: { raw: '', parsed: null, status: 'pending' },
        conflict: { raw: '', parsed: null, status: 'pending' },
        smokeBaseline: { raw: '', parsed: null, status: 'pending' },
        smokeEdge: { raw: '', parsed: null, status: 'pending' },
        sha256: ''
      };
      document.getElementById('preflight-base-version').value = '';
      document.getElementById('preflight-validation-input').value = '';
      document.getElementById('preflight-conflict-input').value = '';
      document.getElementById('preflight-smoke-baseline-input').value = '';
      document.getElementById('preflight-smoke-edge-input').value = '';
      document.getElementById('preflight-sha256').value = '';
      document.getElementById('preflight-base-result').style.display = 'none';
      document.getElementById('preflight-validation-result').style.display = 'none';
      document.getElementById('preflight-conflict-result').style.display = 'none';
      document.getElementById('preflight-smoke-result').style.display = 'none';
      renderPreflightChecklist();
      savePreflightEvidence();
    });

    function savePreflightEvidence() {
      try {
        localStorage.setItem(PREFLIGHT_STORAGE_KEY, JSON.stringify(preflightEvidence));
      } catch (e) {}
    }

    function restorePreflightEvidence() {
      try {
        const stored = localStorage.getItem(PREFLIGHT_STORAGE_KEY);
        if (!stored) return;
        preflightEvidence = JSON.parse(stored);
        document.getElementById('preflight-base-version').value = preflightEvidence.baseVersion?.raw || '';
        document.getElementById('preflight-validation-input').value = preflightEvidence.validation?.raw || '';
        document.getElementById('preflight-conflict-input').value = preflightEvidence.conflict?.raw || '';
        document.getElementById('preflight-smoke-baseline-input').value = preflightEvidence.smokeBaseline?.raw || '';
        document.getElementById('preflight-smoke-edge-input').value = preflightEvidence.smokeEdge?.raw || '';
        document.getElementById('preflight-sha256').value = preflightEvidence.sha256 || '';
        if (preflightEvidence.baseVersion?.status !== 'pending') renderPreflightResult('preflight-base-result', preflightEvidence.baseVersion);
        if (preflightEvidence.validation?.status !== 'pending') renderPreflightResult('preflight-validation-result', preflightEvidence.validation);
        if (preflightEvidence.conflict?.status !== 'pending') renderPreflightResult('preflight-conflict-result', preflightEvidence.conflict);
        if (preflightEvidence.smokeBaseline?.status !== 'pending' || preflightEvidence.smokeEdge?.status !== 'pending') updateSmokeResult();
      } catch (e) {}
    }

    function savePatchDraft() {
      try {
        const toSave = { ...patchDraft, changes: patchDraft.changes.map(c => ({ _key: c._key, _source: c._source, record: c.record })) };
        localStorage.setItem(PATCH_STORAGE_KEY, JSON.stringify(toSave));
      } catch (e) {}
    }

    function restorePatchDraft() {
      try {
        const stored = localStorage.getItem(PATCH_STORAGE_KEY);
        if (!stored) return;
        const data = JSON.parse(stored);
        patchDraft.baseVersion = data.baseVersion || '0.1.0';
        patchDraft.author = data.author || '';
        patchDraft.rationale = data.rationale || '';
        patchDraft.changes = data.changes || [];
        document.getElementById('patch-base-version').value = patchDraft.baseVersion;
        document.getElementById('patch-author').value = patchDraft.author;
        document.getElementById('patch-rationale').value = patchDraft.rationale;
        renderPatchChanges();
      } catch (e) {}
    }

    function generatePRSummaryWithEvidence() {
      const identity = currentSelection.joinIdentity;
      const contract = currentSelection.contractIdx !== null 
        ? allData.contractResults[currentSelection.contractIdx] : null;
      const issues = identity ? sortBySeverityFirst(getRelatedRecords(identity, allData.issues), ['sheet', 'field', 'issue_type']) : [];
      const actions = identity ? sortBySeverityFirst(getRelatedRecords(identity, allData.fieldActions), ['sheet', 'field', 'action']) : [];
      const primary = identity ? getPrimaryKey(identity) : null;
      const primaryVal = identity?.[primary] || 'unknown';

      const ev = preflightEvidence;
      const baseVer = ev.baseVersion.parsed?.version || document.getElementById('patch-base-version').value || 'unknown';
      const patchBaseVer = ev.validation.parsed?.patchBaseVersion || document.getElementById('patch-base-version').value || 'unknown';
      const smokeBaselineStatus = ev.smokeBaseline.parsed?.pass === true ? 'PASS' : ev.smokeBaseline.parsed?.pass === false ? 'FAIL' : 'unknown';
      const smokeEdgeStatus = ev.smokeEdge.parsed?.pass === true ? 'PASS' : ev.smokeEdge.parsed?.pass === false ? 'FAIL' : ev.smokeEdge.status === 'pending' ? 'N/A' : 'unknown';
      const sha256 = ev.sha256 || '<SHA256_HASH>';

      let md = `# PR: Fix issues for ${primary || 'unknown'}=${primaryVal}\n\n`;
      md += `## WHY\n`;
      if (identity) {
        md += `This record has ${issues.length} issue(s) and ${actions.length} pending action(s) that need resolution.\n\n`;
      } else {
        md += `Patch draft with ${patchDraft.changes.length} change(s).\n\n`;
      }
      md += `## Affected Artifacts\n`;
      if (identity) {
        md += `- **Join Identity**: ${formatJoinIdentityText(identity)}\n`;
        md += `- **Contract Status**: ${contract?.sf_contract_status || 'unknown'}\n`;
        md += `- **Detected Subtype**: ${contract?.detected_subtype || 'unknown'}\n`;
        if (issues.length > 0) {
          md += `- **Issues**: ${issues.map(i => i.issue_type).join(', ')}\n`;
        }
      }
      md += `\n## Evidence\n`;
      md += `- **base.version**: ${baseVer}\n`;
      md += `- **patch.base_version**: ${patchBaseVer}\n`;
      md += `- **Smoke Baseline**: ${smokeBaselineStatus}\n`;
      md += `- **Smoke Edge**: ${smokeEdgeStatus}\n`;
      md += `- **SHA256**: ${sha256}\n`;
      return md;
    }

    document.getElementById('stream-panel-toggle')?.addEventListener('click', () => {
      const body = document.getElementById('stream-panel-body');
      const btn = document.getElementById('stream-panel-toggle');
      if (body && btn) {
        body.classList.toggle('active');
        btn.textContent = body.classList.contains('active') ? 'Hide' : 'Show';
        if (body.classList.contains('active')) {
          renderRecordStateSummary();
          renderSessionTimeline();
        }
      }
    });

    function deriveRecordState(record) {
      const joinKey = getJoinKey(record);
      const recordIssues = allData.issues.filter(i => getJoinKey(i) === joinKey);
      
      const hasBlocking = recordIssues.some(i => i.severity === 'blocking');
      const hasWarning = recordIssues.some(i => i.severity === 'warning');
      const hasInfo = recordIssues.some(i => i.severity === 'info');
      const hasMissingData = recordIssues.some(i => 
        i.issue_type === 'missing_data' || 
        i.issue_type === 'join_failure' ||
        i.issue_type === 'missing_required'
      );
      
      if (hasBlocking) return 'BLOCKED';
      if (hasMissingData && hasWarning) return 'WAITING';
      if (hasWarning) return 'PARTIAL';
      return 'CONSOLIDATED';
    }

    function computeRecordStates() {
      const states = { CONSOLIDATED: 0, PARTIAL: 0, WAITING: 0, BLOCKED: 0 };
      allData.contractResults.forEach(record => {
        const state = deriveRecordState(record);
        states[state]++;
      });
      return states;
    }

    function renderRecordStateSummary() {
      const container = document.getElementById('record-state-summary');
      const states = computeRecordStates();
      
      container.innerHTML = `
        <div class="record-state-card consolidated">
          <div class="count">${states.CONSOLIDATED}</div>
          <div class="label">Consolidated</div>
        </div>
        <div class="record-state-card partial">
          <div class="count">${states.PARTIAL}</div>
          <div class="label">Partial</div>
        </div>
        <div class="record-state-card waiting">
          <div class="count">${states.WAITING}</div>
          <div class="label">Waiting</div>
        </div>
        <div class="record-state-card blocked">
          <div class="count">${states.BLOCKED}</div>
          <div class="label">Blocked</div>
        </div>
      `;
    }

    function simulateSessions() {
      const total = allData.contractResults.length;
      if (total === 0) return [];
      
      const sessionCount = Math.min(3, Math.ceil(total / 2));
      const sessions = [];
      
      for (let i = 0; i < sessionCount; i++) {
        const isLast = i === sessionCount - 1;
        const consolidatedPct = 0.3 + (i * 0.25);
        const partialPct = 0.3 - (i * 0.1);
        const waitingPct = 0.2 - (i * 0.08);
        const blockedPct = 1 - consolidatedPct - partialPct - waitingPct;
        
        const sessionRecords = Math.ceil(total / sessionCount);
        
        sessions.push({
          index: i + 1,
          name: `Session ${i + 1}`,
          timestamp: `T+${i * 30}min`,
          records: sessionRecords,
          states: {
            CONSOLIDATED: Math.round(sessionRecords * consolidatedPct),
            PARTIAL: Math.round(sessionRecords * partialPct),
            WAITING: Math.round(sessionRecords * waitingPct),
            BLOCKED: Math.max(0, sessionRecords - Math.round(sessionRecords * consolidatedPct) - Math.round(sessionRecords * partialPct) - Math.round(sessionRecords * waitingPct))
          },
          reconsolidated: i > 0 ? Math.round(sessionRecords * 0.1) : 0
        });
      }
      
      return sessions;
    }

    function renderSessionTimeline() {
      const container = document.getElementById('session-timeline');
      const sessions = simulateSessions();
      
      if (sessions.length === 0) {
        container.innerHTML = '<div class="stream-concept"><p>No data loaded. Load an artifact to see simulated sessions.</p></div>';
        return;
      }
      
      container.innerHTML = sessions.map(s => `
        <div class="session-card">
          <div class="session-card-header">
            <span class="session-card-title">${s.name}</span>
            <span class="session-card-idx">${s.timestamp}</span>
          </div>
          <div class="session-card-stats">
            <div><span>Records:</span><span>${s.records}</span></div>
            <div><span class="state-chip consolidated">CONS</span><span>${s.states.CONSOLIDATED}</span></div>
            <div><span class="state-chip partial">PART</span><span>${s.states.PARTIAL}</span></div>
            <div><span class="state-chip waiting">WAIT</span><span>${s.states.WAITING}</span></div>
            <div><span class="state-chip blocked">BLCK</span><span>${s.states.BLOCKED}</span></div>
            ${s.reconsolidated > 0 ? `<div style="color: #2e7d32; font-weight: 500;"><span>Reconsolidated:</span><span>+${s.reconsolidated}</span></div>` : ''}
          </div>
        </div>
      `).join('');
    }

    function generateStreamSemanticsMarkdown() {
      const states = computeRecordStates();
      const sessions = simulateSessions();
      const total = Object.values(states).reduce((a, b) => a + b, 0);
      
      let md = `# Stream Semantics Model\n\n`;
      md += `## Overview\n\n`;
      md += `This document describes the conceptual streaming model for continuous data processing.\n\n`;
      
      md += `## Never-Stop Flow (Open Faucet Model)\n\n`;
      md += `Records flow continuously through the pipeline:\n`;
      md += `- **CONSOLIDATED** records pass through immediately\n`;
      md += `- **PARTIAL** records are usable but flagged for completion\n`;
      md += `- **WAITING** records are held until missing data arrives\n`;
      md += `- **BLOCKED** records require manual intervention\n\n`;
      md += `This prevents backlogs by isolating issues rather than stopping the entire pipeline.\n\n`;
      
      md += `## Current State Distribution\n\n`;
      md += `| State | Count | Percentage |\n`;
      md += `|-------|-------|------------|\n`;
      md += `| CONSOLIDATED | ${states.CONSOLIDATED} | ${total > 0 ? Math.round(states.CONSOLIDATED / total * 100) : 0}% |\n`;
      md += `| PARTIAL | ${states.PARTIAL} | ${total > 0 ? Math.round(states.PARTIAL / total * 100) : 0}% |\n`;
      md += `| WAITING | ${states.WAITING} | ${total > 0 ? Math.round(states.WAITING / total * 100) : 0}% |\n`;
      md += `| BLOCKED | ${states.BLOCKED} | ${total > 0 ? Math.round(states.BLOCKED / total * 100) : 0}% |\n`;
      md += `| **Total** | ${total} | 100% |\n\n`;
      
      md += `## Reconsolidation Rules\n\n`;
      md += `| From State | Condition | To State |\n`;
      md += `|------------|-----------|----------|\n`;
      md += `| PARTIAL | Warnings resolved | CONSOLIDATED |\n`;
      md += `| WAITING | Missing data arrives | PARTIAL or CONSOLIDATED |\n`;
      md += `| BLOCKED | Manual fix + re-submit | CONSOLIDATED |\n`;
      md += `| CONSOLIDATED | New blocking issue | BLOCKED |\n\n`;
      
      if (sessions.length > 0) {
        md += `## Simulated Session Timeline\n\n`;
        md += `| Session | Timestamp | Records | Consolidated | Partial | Waiting | Blocked | Reconsolidated |\n`;
        md += `|---------|-----------|---------|--------------|---------|---------|---------|----------------|\n`;
        sessions.forEach(s => {
          md += `| ${s.name} | ${s.timestamp} | ${s.records} | ${s.states.CONSOLIDATED} | ${s.states.PARTIAL} | ${s.states.WAITING} | ${s.states.BLOCKED} | ${s.reconsolidated > 0 ? '+' + s.reconsolidated : '-'} |\n`;
        });
        md += `\n`;
      }
      
      md += `## Key Benefits\n\n`;
      md += `1. **No Backlogs**: Problems don't stop the entire pipeline\n`;
      md += `2. **Async Resolution**: Issues are resolved in parallel\n`;
      md += `3. **Deterministic States**: State transitions are rule-based and auditable\n`;
      md += `4. **Visibility**: Operators can see exactly where records are in the flow\n`;
      
      return md;
    }

    document.getElementById('copy-stream-semantics')?.addEventListener('click', async () => {
      const md = generateStreamSemanticsMarkdown();
      const success = await copyToClipboard(md);
      const btn = document.getElementById('copy-stream-semantics');
      if (btn) {
        const orig = btn.textContent;
        btn.textContent = success ? 'Copied!' : 'Failed';
        setTimeout(() => btn.textContent = orig, 1500);
      }
    });

    document.getElementById('simulate-sessions')?.addEventListener('click', () => {
      renderRecordStateSummary();
      renderSessionTimeline();
    });

    document.getElementById('config-inspector-toggle')?.addEventListener('click', () => {
      const body = document.getElementById('config-inspector-body');
      const btn = document.getElementById('config-inspector-toggle');
      if (body && btn) {
        body.classList.toggle('active');
        btn.textContent = body.classList.contains('active') ? 'Hide' : 'Show';
      }
    });

    async function loadConfigFile(path) {
      const relativePath = path.startsWith('../../') ? path : `../../${path}`;
      const resp = await fetch(relativePath);
      if (!resp.ok) throw new Error(`Failed to load ${path}`);
      return await resp.json();
    }

    function sortChangesArray(changes) {
      const sevOrder = { blocking: 0, warning: 1, info: 2 };
      return [...changes].sort((a, b) => {
        const targetCmp = (a.target || '').localeCompare(b.target || '');
        if (targetCmp !== 0) return targetCmp;
        const actionCmp = (a.action || '').localeCompare(b.action || '');
        if (actionCmp !== 0) return actionCmp;
        const ruleIdA = a.rule?.rule_id || a.rule_id || null;
        const ruleIdB = b.rule?.rule_id || b.rule_id || null;
        if (ruleIdA === null && ruleIdB !== null) return 1;
        if (ruleIdA !== null && ruleIdB === null) return -1;
        if (ruleIdA !== null && ruleIdB !== null) {
          const ruleIdCmp = ruleIdA.localeCompare(ruleIdB);
          if (ruleIdCmp !== 0) return ruleIdCmp;
        }
        const whenSheetA = a.rule?.when?.sheet || '';
        const whenSheetB = b.rule?.when?.sheet || '';
        const whenSheetCmp = whenSheetA.localeCompare(whenSheetB);
        if (whenSheetCmp !== 0) return whenSheetCmp;
        const whenFieldA = a.rule?.when?.field || '';
        const whenFieldB = b.rule?.when?.field || '';
        const whenFieldCmp = whenFieldA.localeCompare(whenFieldB);
        if (whenFieldCmp !== 0) return whenFieldCmp;
        const thenArrA = a.rule?.then || [];
        const thenArrB = b.rule?.then || [];
        const minLen = Math.min(thenArrA.length, thenArrB.length);
        for (let i = 0; i < minLen; i++) {
          const thenA = thenArrA[i] || {};
          const thenB = thenArrB[i] || {};
          const sevA = sevOrder[thenA.severity] ?? 3;
          const sevB = sevOrder[thenB.severity] ?? 3;
          if (sevA !== sevB) return sevA - sevB;
          const thenSheetCmp = (thenA.sheet || '').localeCompare(thenB.sheet || '');
          if (thenSheetCmp !== 0) return thenSheetCmp;
          const thenFieldCmp = (thenA.field || '').localeCompare(thenB.field || '');
          if (thenFieldCmp !== 0) return thenFieldCmp;
        }
        return thenArrA.length - thenArrB.length;
      });
    }

    function computeRulesetDelta(baseConfig, patch) {
      const delta = {
        salesforce_rules: { added: 0, deprecated: 0 },
        qa_rules: { added: 0, deprecated: 0 },
        resolver_rules: { added: 0, deprecated: 0 }
      };
      
      (patch.changes || []).forEach(change => {
        const target = change.target;
        if (!delta[target]) return;
        if (change.action === 'add_rule') delta[target].added++;
        if (change.action === 'deprecate_rule') delta[target].deprecated++;
      });
      
      return delta;
    }

    function renderPatchSummary(baseConfig, patch) {
      const container = document.getElementById('patch-summary');
      const baseVersion = baseConfig.version || '(unknown)';
      const patchBaseVersion = patch.base_version || '(unknown)';
      configVersionMatch = baseVersion === patchBaseVersion;
      const chipClass = configVersionMatch ? 'match' : 'mismatch';
      const chipText = configVersionMatch ? 'MATCH' : 'MISMATCH';
      
      container.innerHTML = `
        <div class="patch-summary-header">
          <h4>Patch Summary</h4>
          <span class="version-chip ${chipClass}">${chipText}</span>
        </div>
        <div class="patch-summary-grid">
          <div class="patch-summary-item">
            <label>base.version</label>
            <div class="value">${baseVersion}</div>
          </div>
          <div class="patch-summary-item">
            <label>patch.base_version</label>
            <div class="value">${patchBaseVersion}</div>
          </div>
          <div class="patch-summary-item">
            <label>Author</label>
            <div class="value">${patch.author || '(not set)'}</div>
          </div>
          <div class="patch-summary-item">
            <label>Rationale</label>
            <div class="value">${patch.rationale || '(not set)'}</div>
          </div>
          <div class="patch-summary-item">
            <label>Changes Count</label>
            <div class="value">${(patch.changes || []).length}</div>
          </div>
        </div>
      `;
      
      updatePreflightFromLoadedConfig(baseVersion, patchBaseVersion, configVersionMatch);
    }

    function updatePreflightFromLoadedConfig(baseVersion, patchBaseVersion, isMatch) {
      preflightEvidence.baseVersion.raw = `base.version: ${baseVersion}, patch.base_version: ${patchBaseVersion}`;
      preflightEvidence.baseVersion.parsed = {
        version: baseVersion,
        patchBaseVersion: patchBaseVersion,
        match: isMatch
      };
      preflightEvidence.baseVersion.status = isMatch ? 'pass' : 'fail';
      
      preflightEvidence.validation.parsed = preflightEvidence.validation.parsed || {};
      preflightEvidence.validation.parsed.baseVersion = baseVersion;
      preflightEvidence.validation.parsed.patchBaseVersion = patchBaseVersion;
      
      savePreflightEvidence();
    }

    function renderRulesetDelta(delta) {
      const container = document.getElementById('ruleset-delta');
      const targets = ['salesforce_rules', 'qa_rules', 'resolver_rules'];
      
      let cardsHtml = '';
      targets.forEach(t => {
        const d = delta[t] || { added: 0, deprecated: 0 };
        cardsHtml += `
          <div class="ruleset-count-card">
            <div class="count added">+${d.added}</div>
            <div class="label">${t.replace('_rules', '')} Added</div>
          </div>
          <div class="ruleset-count-card">
            <div class="count deprecated">-${d.deprecated}</div>
            <div class="label">${t.replace('_rules', '')} Deprecated</div>
          </div>
        `;
      });
      
      container.innerHTML = `
        <h4>Ruleset Delta</h4>
        <div class="ruleset-delta-counts">${cardsHtml}</div>
      `;
    }

    function renderChangesTable(changes) {
      const container = document.getElementById('changes-table');
      const sorted = sortChangesArray(changes);
      
      let rowsHtml = sorted.map(change => {
        const action = change.action || '';
        const target = change.target || '';
        const ruleId = change.rule?.rule_id || change.rule_id || '';
        const when = change.rule?.when || {};
        const whenStr = when.sheet && when.field ? `${when.sheet}.${when.field} ${when.operator || ''} ${JSON.stringify(when.value || '')}` : (change.reason || '');
        const then = change.rule?.then || [];
        const thenStr = then.map(t => `${t.action || ''} ${t.sheet || ''}.${t.field || ''}`).join('; ') || '';
        const severity = then[0]?.severity || '';
        
        return `
          <tr>
            <td><span class="action-chip ${action}">${action}</span></td>
            <td>${target}</td>
            <td>${ruleId || '<span class="null-value">null</span>'}</td>
            <td style="font-size: 0.8em; font-family: monospace;">${whenStr}</td>
            <td style="font-size: 0.8em; font-family: monospace;">${thenStr}</td>
            <td><span class="severity-${severity}">${severity}</span></td>
          </tr>
        `;
      }).join('');
      
      container.innerHTML = `
        <thead><tr>
          <th>Action</th>
          <th>Target</th>
          <th>Rule ID</th>
          <th>When</th>
          <th>Then</th>
          <th>Severity</th>
        </tr></thead>
        <tbody>${rowsHtml}</tbody>
      `;
    }

    function generateRulesetDeltaMarkdown() {
      if (!loadedBaseConfig || !loadedPatch) return '# No config loaded\n';
      
      const baseVersion = loadedBaseConfig.version || '(unknown)';
      const patchBaseVersion = loadedPatch.base_version || '(unknown)';
      const delta = computeRulesetDelta(loadedBaseConfig, loadedPatch);
      const sorted = sortChangesArray(loadedPatch.changes || []);
      
      let md = `# Ruleset Delta\n\n`;
      md += `## Summary\n\n`;
      md += `| Field | Value |\n`;
      md += `|-------|-------|\n`;
      md += `| base.version | ${baseVersion} |\n`;
      md += `| patch.base_version | ${patchBaseVersion} |\n`;
      md += `| Version Match | ${configVersionMatch ? 'YES' : 'NO'} |\n`;
      md += `| Author | ${loadedPatch.author || '(not set)'} |\n`;
      md += `| Changes Count | ${(loadedPatch.changes || []).length} |\n`;
      md += `\n## Rule Counts by Target\n\n`;
      md += `| Target | Added | Deprecated |\n`;
      md += `|--------|-------|------------|\n`;
      ['salesforce_rules', 'qa_rules', 'resolver_rules'].forEach(t => {
        const d = delta[t] || { added: 0, deprecated: 0 };
        md += `| ${t} | +${d.added} | -${d.deprecated} |\n`;
      });
      md += `\n## Changes Detail\n\n`;
      md += `| Action | Target | Rule ID | Severity |\n`;
      md += `|--------|--------|---------|----------|\n`;
      sorted.forEach(change => {
        const action = change.action || '';
        const target = change.target || '';
        const ruleId = change.rule?.rule_id || change.rule_id || '(null)';
        const severity = change.rule?.then?.[0]?.severity || '';
        md += `| ${action} | ${target} | ${ruleId} | ${severity} |\n`;
      });
      md += `\n## Rationale\n\n${loadedPatch.rationale || '(not set)'}\n`;
      
      return md;
    }

    async function loadConfigWithPatch() {
      const basePath = document.getElementById('base-config-path').value.trim();
      const patchPath = document.getElementById('patch-path').value.trim();
      const statusEl = document.getElementById('config-status');
      const resultsEl = document.getElementById('config-results');
      
      if (!basePath) {
        statusEl.style.display = 'block';
        statusEl.className = 'config-inspector-status error';
        statusEl.textContent = 'Base config path is required.';
        return;
      }
      
      try {
        statusEl.style.display = 'block';
        statusEl.className = 'config-inspector-status info';
        statusEl.textContent = 'Loading base config...';
        
        loadedBaseConfig = await loadConfigFile(basePath);
        
        if (patchPath) {
          statusEl.textContent = 'Loading patch...';
          loadedPatch = await loadConfigFile(patchPath);
        } else {
          loadedPatch = { base_version: loadedBaseConfig.version, changes: [], author: '', rationale: '' };
        }
        
        renderPatchSummary(loadedBaseConfig, loadedPatch);
        const delta = computeRulesetDelta(loadedBaseConfig, loadedPatch);
        renderRulesetDelta(delta);
        renderChangesTable(loadedPatch.changes || []);
        
        resultsEl.style.display = 'block';
        statusEl.className = 'config-inspector-status success';
        statusEl.textContent = `Loaded: ${basePath} + ${patchPath || '(no patch)'}`;
        
      } catch (e) {
        statusEl.className = 'config-inspector-status error';
        statusEl.textContent = `Error: ${e.message}`;
        resultsEl.style.display = 'none';
      }
    }

    document.getElementById('load-config')?.addEventListener('click', loadConfigWithPatch);
    
    document.getElementById('clear-config')?.addEventListener('click', () => {
      loadedBaseConfig = null;
      loadedPatch = null;
      configVersionMatch = null;
      document.getElementById('config-results').style.display = 'none';
      document.getElementById('config-status').style.display = 'none';
    });

    document.getElementById('copy-ruleset-delta')?.addEventListener('click', async () => {
      const md = generateRulesetDeltaMarkdown();
      const success = await copyToClipboard(md);
      const btn = document.getElementById('copy-ruleset-delta');
      const orig = btn.textContent;
      btn.textContent = success ? 'Copied!' : 'Failed';
      setTimeout(() => btn.textContent = orig, 1500);
    });

    document.getElementById('session-loader-toggle')?.addEventListener('click', () => {
      const body = document.getElementById('session-loader-body');
      const btn = document.getElementById('session-loader-toggle');
      body.classList.toggle('active');
      btn.textContent = body.classList.contains('active') ? 'Hide' : 'Show';
    });

    async function loadArtifact(path) {
      const relativePath = path.startsWith('../../') ? path : `../../${path}`;
      const resp = await fetch(relativePath);
      if (!resp.ok) throw new Error(`Failed to load ${path}`);
      return await resp.json();
    }

    async function loadDataWithComparison(primaryPath, comparePath) {
      const statusEl = document.getElementById('session-status');
      const errorContainer = document.getElementById('error-container');
      const sourceInfo = document.getElementById('source-info');
      
      try {
        statusEl.style.display = 'block';
        statusEl.className = 'session-loader-status info';
        statusEl.textContent = 'Loading primary artifact...';
        
        const primaryData = await loadArtifact(primaryPath);
        
        renderSummary(primaryData.sf_summary || {});
        allData.contractResults = sortByJoinTriplet(primaryData.sf_contract_results || []);
        allData.issues = sortBySeverityFirst(primaryData.sf_issues || [], ['sheet', 'field', 'issue_type']);
        allData.fieldActions = sortBySeverityFirst(primaryData.sf_field_actions || [], ['sheet', 'field', 'action']);
        allData.changeLog = sortBySeverityFirst(primaryData.sf_change_log || [], ['sheet', 'field', 'notes']);
        
        sourceInfo.textContent = `Primary: ${primaryPath}`;
        
        if (comparePath && comparePath.trim()) {
          statusEl.textContent = 'Loading comparison artifact...';
          try {
            compareData = await loadArtifact(comparePath);
            
            const compareContractResults = sortByJoinTriplet(compareData.sf_contract_results || []);
            const compareIssues = sortBySeverityFirst(compareData.sf_issues || [], ['sheet', 'field', 'issue_type']);
            const compareFieldActions = sortBySeverityFirst(compareData.sf_field_actions || [], ['sheet', 'field', 'action']);
            
            rowChanges.contractResults = computeRowChanges(allData.contractResults, compareContractResults, 'contractResults');
            rowChanges.issues = computeRowChanges(allData.issues, compareIssues, 'issues');
            rowChanges.fieldActions = computeRowChanges(allData.fieldActions, compareFieldActions, 'fieldActions');
            
            deltaStats = computeDeltaStats(primaryData, compareData);
            
            sourceInfo.textContent = `Primary: ${primaryPath} | Compare: ${comparePath}`;
            statusEl.className = 'session-loader-status success';
            statusEl.textContent = `Loaded with comparison. Found ${Object.keys(rowChanges.issues).length + Object.keys(rowChanges.fieldActions).length} row-level changes.`;
          } catch (e) {
            statusEl.className = 'session-loader-status error';
            statusEl.textContent = `Comparison file not found: ${comparePath}. Showing primary only.`;
            compareData = null;
            rowChanges = { contractResults: {}, issues: {}, fieldActions: {} };
            deltaStats = null;
          }
        } else {
          compareData = null;
          rowChanges = { contractResults: {}, issues: {}, fieldActions: {} };
          deltaStats = null;
          statusEl.className = 'session-loader-status success';
          statusEl.textContent = 'Loaded primary artifact (no comparison).';
        }
        
        populateSubtypeDropdown();
        renderDeltaSummary();
        renderAllTables();
        restoreSelection();
        
        errorContainer.innerHTML = '';
      } catch (e) {
        statusEl.className = 'session-loader-status error';
        statusEl.textContent = `Error: ${e.message}`;
        errorContainer.innerHTML = `<div class="error">Could not load artifact: ${e.message}</div>`;
      }
    }

    document.getElementById('load-session')?.addEventListener('click', () => {
      const primaryPath = document.getElementById('primary-path').value.trim() || 'out/sf_packet.preview.json';
      const comparePath = document.getElementById('compare-path').value.trim();
      loadDataWithComparison(primaryPath, comparePath);
    });

    document.getElementById('clear-compare')?.addEventListener('click', () => {
      document.getElementById('compare-path').value = '';
      compareData = null;
      rowChanges = { contractResults: {}, issues: {}, fieldActions: {} };
      deltaStats = null;
      renderDeltaSummary();
      renderAllTables();
      document.getElementById('session-status').style.display = 'none';
      document.getElementById('source-info').textContent = `Data source: ${document.getElementById('primary-path').value || 'out/sf_packet.preview.json'}`;
    });

    // ========== DATASET BUNDLE (V1.2.6) ==========
    // DatasetBundleDraft: internal model for multi-sheet dataset with computed field_index
    // TODO: Align exact schema keys once Kiwi returns
    
    function createDatasetBundle(dataset, source) {
      var sheets = dataset.sheets || {};
      var sheetNames = Object.keys(sheets);
      
      var bundle = {
        dataset_id: dataset.dataset_id || ('ds_' + Date.now()),
        dataset_revision: 1,
        created_at_utc: new Date().toISOString(),
        source: {
          dataset_type: source?.type || 'unknown',
          source_file_name: source?.filename || 'unknown'
        },
        sheet_packets: sheetNames.map(function(name) {
          var sheet = sheets[name];
          return {
            packet_version: 'DatasetPacketV1',
            sheet_name: name,
            header_map: (sheet.headers || []).reduce(function(acc, h, i) { acc[h] = i; return acc; }, {}),
            rows: sheet.rows || []
          };
        }),
        field_index: [],
        audit_log: [
          { event: 'bundle_created', timestamp: new Date().toISOString(), source: source?.type || 'unknown' }
        ]
      };
      
      // Compute field_index from sheet_packets
      bundle.field_index = computeFieldIndex(bundle.sheet_packets);
      
      return bundle;
    }
    
    function computeFieldIndex(sheetPackets) {
      var index = [];
      (sheetPackets || []).forEach(function(packet) {
        var headers = Object.keys(packet.header_map || {});
        headers.forEach(function(field) {
          index.push({
            sheet: packet.sheet_name,
            field: field,
            full_path: packet.sheet_name + '.' + field
          });
        });
      });
      return index;
    }
    
    function getCurrentBundle() {
      if (!dataLoaded || !allData) return null;
      
      var source = { type: 'loaded', filename: currentArtifactPath || 'unknown' };
      var dataset = {
        dataset_id: localStorage.getItem(STORAGE_KEY_ACTIVE_DATASET) || 'current',
        sheets: allData.sheets || {}
      };
      
      return createDatasetBundle(dataset, source);
    }
    
    function copyBundleJSON() {
      var bundle = getCurrentBundle();
      if (!bundle) {
        showToast('No dataset loaded', 'error');
        return;
      }
      
      var json = JSON.stringify(bundle, null, 2);
      navigator.clipboard.writeText(json).then(function() {
        showToast('Bundle JSON copied to clipboard', 'success');
      }).catch(function(err) {
        console.error('Failed to copy:', err);
        showToast('Failed to copy to clipboard', 'error');
      });
    }
    
    // ========== PACKAGER (V1.2.6) ==========
    // Consumes DatasetBundle and generates stable record_id index
    
    function generateRecordId(datasetId, sheetName, rowNumber, stableColumns) {
      // Generate stable record_id: dataset_id + sheet_name + row_number + optional stable columns
      var base = datasetId + '|' + sheetName + '|' + rowNumber;
      if (stableColumns && stableColumns.contract_key) {
        base += '|' + stableColumns.contract_key;
      }
      return base;
    }
    
    function packageBundle(bundle) {
      if (!bundle || !bundle.sheet_packets) return null;
      
      var recordIndex = [];
      var queueRecords = { todo: [], needs_review: [] };
      
      bundle.sheet_packets.forEach(function(packet) {
        (packet.rows || []).forEach(function(row, idx) {
          var recordId = generateRecordId(
            bundle.dataset_id,
            packet.sheet_name,
            idx,
            { contract_key: row.contract_key }
          );
          
          var record = {
            record_id: recordId,
            dataset_id: bundle.dataset_id,
            sheet_name: packet.sheet_name,
            row_number: idx,
            contract_key: row.contract_key || '',
            file_url: row.file_url || '',
            file_name: row.file_name || '',
            status: 'needs_review',
            data: row
          };
          
          recordIndex.push(record);
          
          // Route to queue: if has issues -> Needs Review, else -> To Do
          if (row._has_issue) {
            queueRecords.needs_review.push(record);
          } else {
            queueRecords.todo.push(record);
          }
        });
      });
      
      return {
        dataset_id: bundle.dataset_id,
        dataset_revision: bundle.dataset_revision,
        record_count: recordIndex.length,
        record_index: recordIndex,
        queue_distribution: {
          todo: queueRecords.todo.length,
          needs_review: queueRecords.needs_review.length
        },
        packaged_at: new Date().toISOString()
      };
    }
    
    function repackageCurrentDataset() {
      var bundle = getCurrentBundle();
      if (!bundle) {
        showToast('No dataset to package', 'error');
        return null;
      }
      
      var packageResult = packageBundle(bundle);
      
      // Update allData.contractResults with stable record_ids
      allData.contractResults = packageResult.record_index.map(function(rec) {
        return {
          record_id: rec.record_id,
          contract_key: rec.contract_key,
          file_url: rec.file_url,
          file_name: rec.file_name,
          status: rec.status,
          sheet_name: rec.sheet_name,
          row_number: rec.row_number
        };
      });
      
      // Re-render tables
      renderAllTables();
      updateQueueCounts();
      
      showToast('Dataset packaged with ' + packageResult.record_count + ' records', 'success');
      return packageResult;
    }
    
    // ========== UPLOAD LIBRARY (V1.2.6) ==========
    function getUploadLibrary() {
      try {
        var stored = localStorage.getItem(STORAGE_KEY_LIBRARY);
        return stored ? JSON.parse(stored) : [];
      } catch (e) {
        return [];
      }
    }
    
    function saveUploadLibrary(library) {
      try {
        localStorage.setItem(STORAGE_KEY_LIBRARY, JSON.stringify(library));
      } catch (e) {
        console.error('Failed to save upload library:', e);
      }
    }
    
    function saveToUploadLibrary(dataset, filename, source) {
      var library = getUploadLibrary();
      var existingIndex = library.findIndex(function(d) { return d.dataset_id === dataset.dataset_id; });
      
      var entry = {
        dataset_id: dataset.dataset_id || ('ds_' + Date.now()),
        filename: filename || 'Untitled',
        source: source || 'unknown',
        revision: existingIndex >= 0 ? (library[existingIndex].revision + 1) : 1,
        created_at: new Date().toISOString(),
        sheet_count: Object.keys(dataset.sheets || {}).length,
        row_count: Object.values(dataset.sheets || {}).reduce(function(acc, s) { return acc + (s.rows?.length || 0); }, 0)
      };
      
      if (existingIndex >= 0) {
        library[existingIndex] = entry;
      } else {
        library.unshift(entry);
      }
      
      saveUploadLibrary(library);
      localStorage.setItem(STORAGE_KEY_ACTIVE_DATASET, entry.dataset_id);
      return entry;
    }
    
    function renderUploadLibrary() {
      var listEl = document.getElementById('upload-library-list');
      if (!listEl) return;
      
      var library = getUploadLibrary();
      var activeId = localStorage.getItem(STORAGE_KEY_ACTIVE_DATASET);
      
      if (library.length === 0) {
        listEl.innerHTML = '<div class="upload-library-empty" style="text-align: center; padding: 40px 20px; color: #888; background: #f5f5f5; border-radius: 8px; border: 2px dashed #ddd;">' +
          '<div style="font-size: 2em; margin-bottom: 10px;">ðŸ“</div>' +
          '<p style="margin: 0 0 15px;">No datasets saved yet.</p>' +
          '<button class="modal-btn modal-btn-primary" onclick="closeDataSourceDrawer(); navigateTo(\'loader\');">Go to Loader</button>' +
          '</div>';
        return;
      }
      
      var html = library.map(function(entry) {
        var isActive = entry.dataset_id === activeId;
        var dateStr = new Date(entry.created_at).toLocaleDateString();
        return '<div class="upload-library-item" style="background: ' + (isActive ? '#e3f2fd' : 'white') + '; border: 1px solid ' + (isActive ? '#1976d2' : '#e0e0e0') + '; border-radius: 8px; padding: 15px;">' +
          '<div style="display: flex; justify-content: space-between; align-items: flex-start;">' +
            '<div>' +
              '<div style="font-weight: 600; margin-bottom: 4px;">' + entry.filename + (isActive ? ' <span style="color: #1976d2; font-size: 0.8em;">(Active)</span>' : '') + '</div>' +
              '<div style="font-size: 0.85em; color: #666;">' +
                'ID: ' + entry.dataset_id + ' | Rev ' + entry.revision + ' | ' + dateStr +
              '</div>' +
              '<div style="font-size: 0.85em; color: #888; margin-top: 4px;">' +
                entry.sheet_count + ' sheets, ' + entry.row_count + ' rows | Source: ' + entry.source +
              '</div>' +
            '</div>' +
            '<div style="display: flex; gap: 8px;">' +
              (isActive ? '' : '<button class="modal-btn modal-btn-primary" style="padding: 6px 12px; font-size: 0.85em;" onclick="activateDataset(\'' + entry.dataset_id + '\')">Activate</button>') +
              '<button class="modal-btn modal-btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick="duplicateDataset(\'' + entry.dataset_id + '\')">Duplicate</button>' +
              (isActive ? 
                '<button class="modal-btn" style="padding: 6px 12px; font-size: 0.85em; background: #e0e0e0; color: #999; cursor: not-allowed;" disabled title="Disconnect first.">Delete</button>' :
                '<button class="modal-btn" style="padding: 6px 12px; font-size: 0.85em; background: #ffebee; color: #c62828;" onclick="deleteDataset(\'' + entry.dataset_id + '\')">Delete</button>') +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');
      
      listEl.innerHTML = html;
    }
    
    function activateDataset(datasetId) {
      try {
        var stored = localStorage.getItem(STORAGE_KEY_DATASET);
        var dataset = stored ? JSON.parse(stored) : null;
        
        if (!dataset || dataset.dataset_id !== datasetId) {
          showToast('Dataset not found in cache. Please reload from Loader.', 'error');
          return;
        }
        
        allData = {
          contractResults: dataset.contract_results || [],
          issues: dataset.issues || [],
          fieldActions: dataset.field_actions || [],
          changeLog: [],
          summary: dataset.summary || {},
          sheets: dataset.sheets || {}
        };
        
        localStorage.setItem(STORAGE_KEY_ACTIVE_DATASET, datasetId);
        dataLoaded = true;
        currentArtifactPath = datasetId;
        updateUIForDataState();
        updateSessionChip();
        populateSubtypeDropdown();
        renderAllTables();
        populateTargetFieldDropdown();
        renderUploadLibrary();
        
        showToast('Dataset activated: ' + datasetId, 'success');
      } catch (e) {
        console.error('Failed to activate dataset:', e);
        showToast('Failed to activate dataset', 'error');
      }
    }
    
    function duplicateDataset(datasetId) {
      var library = getUploadLibrary();
      var entry = library.find(function(d) { return d.dataset_id === datasetId; });
      if (!entry) return;
      
      var newEntry = Object.assign({}, entry, {
        dataset_id: 'ds_' + Date.now(),
        revision: 1,
        created_at: new Date().toISOString(),
        filename: entry.filename + ' (copy)'
      });
      
      library.unshift(newEntry);
      saveUploadLibrary(library);
      renderUploadLibrary();
      showToast('Duplicated as new dataset', 'success');
    }
    
    function deleteDataset(datasetId) {
      if (!confirm('Delete this dataset from the library?')) return;
      
      var library = getUploadLibrary();
      library = library.filter(function(d) { return d.dataset_id !== datasetId; });
      saveUploadLibrary(library);
      
      var activeId = localStorage.getItem(STORAGE_KEY_ACTIVE_DATASET);
      if (activeId === datasetId) {
        localStorage.removeItem(STORAGE_KEY_ACTIVE_DATASET);
      }
      
      renderUploadLibrary();
      showToast('Dataset deleted', 'success');
    }
    
    // ========== LOADER HANDLERS (v1.4.3) ==========
    function loadSampleDataset(options) {
      options = options || {};
      try {
        // Reset workbook and populate from sample dataset sheets (v1.4.3 INGEST-01)
        resetWorkbook();
        
        if (SAMPLE_DATASET.sheets) {
          Object.keys(SAMPLE_DATASET.sheets).forEach(function(sheetName) {
            var sheet = SAMPLE_DATASET.sheets[sheetName];
            addSheet(sheetName, sheet.headers || [], sheet.rows || [], {});
          });
        }
        
        // Transform sample dataset to match expected format
        allData = {
          contractResults: SAMPLE_DATASET.contract_results || [],
          issues: SAMPLE_DATASET.issues || [],
          fieldActions: SAMPLE_DATASET.field_actions || [],
          changeLog: [],
          summary: SAMPLE_DATASET.summary || {},
          sheets: SAMPLE_DATASET.sheets || {}
        };
        
        // Save to localStorage
        localStorage.setItem(STORAGE_KEY_DATASET, JSON.stringify(SAMPLE_DATASET));
        
        // Save to upload library
        saveToUploadLibrary(SAMPLE_DATASET, 'Sample Dataset', 'sample');
        
        dataLoaded = true;
        currentArtifactPath = 'sample_v1';
        currentDataset = null; // Reset cache
        updateUIForDataState();
        updateSessionChip();
        populateSubtypeDropdown();
        populateGridSheetSelector();
        renderAllTables();
        renderGrid();
        populateTargetFieldDropdown();
        updateLoaderPageUI();
        
        console.log('[Loader] Sample dataset loaded:', workbook.order.length, 'sheets');
        showToast('Sample dataset loaded successfully', 'success');
        
        // Auto-redirect after loading (v1.4.4) - always go to grid after load
        if (options.autoRedirect !== false) {
          setTimeout(function() {
            navigateTo('grid');
          }, 300);
        }
      } catch (e) {
        console.error('Failed to load sample dataset:', e);
        showToast('Failed to load sample dataset', 'error');
      }
    }
    
    // Handle CSV import with standardization (v1.4.3 INGEST-02: preserve ALL columns)
    function handleCSVImport(file, callback) {
      var reader = new FileReader();
      reader.onload = function(e) {
        try {
          var csvText = e.target.result;
          var parsed = parseCSV(csvText);
          
          if (!parsed.rows || parsed.rows.length === 0) {
            showToast('No data rows found in CSV', 'error');
            return;
          }
          
          // Sheet name from file (single sheet for CSV)
          var sheetName = file.name.replace(/\.[^.]+$/, '') || 'Sheet1';
          
          // Reset and populate workbook (v1.4.3 INGEST-01)
          resetWorkbook();
          
          // Normalize headers while preserving originals
          var normalizedHeaders = parsed.headers.map(normalizeHeader);
          var headerMap = {};
          parsed.headers.forEach(function(h, i) { headerMap[h] = normalizedHeaders[i]; });
          
          // Detect unknown columns
          var unknownColumns = [];
          normalizedHeaders.forEach(function(nh, i) {
            if (!CANONICAL_HEADERS.includes(nh)) {
              unknownColumns.push({
                original: parsed.headers[i],
                normalized: nh,
                samples: parsed.rows.slice(0, 3).map(function(r) { return r[parsed.headers[i]]; }).filter(Boolean)
              });
            }
          });
          
          // Build rows with ALL columns preserved
          var normalizedRows = parsed.rows.map(function(row, idx) {
            var newRow = { _row_index: idx };
            parsed.headers.forEach(function(original) {
              var normalized = headerMap[original];
              newRow[normalized] = row[original] !== '' ? row[original] : null;
            });
            // Ensure required fields have defaults
            if (!newRow.contract_key) newRow.contract_key = 'ROW_' + (idx + 1);
            if (!newRow.status) newRow.status = 'needs_review';
            return newRow;
          });
          
          // Add sheet to workbook
          addSheet(sheetName, normalizedHeaders, normalizedRows, {
            originalHeaders: parsed.headers,
            headerMap: headerMap,
            unknownColumns: unknownColumns,
            delimiter: parsed.delimiter
          });
          
          // Also populate allData for legacy compatibility
          allData = {
            contractResults: normalizedRows.map(function(r) {
              var row = Object.assign({}, r);
              row.sheet = sheetName;
              return row;
            }),
            issues: [],
            fieldActions: [],
            changeLog: [],
            summary: {
              total_contracts: normalizedRows.length,
              ready: 0,
              needs_review: normalizedRows.length,
              blocked: 0
            }
          };
          
          // Detect unknown columns for Admin UI
          if (unknownColumns.length > 0) {
            var unknownColsStorage = JSON.parse(localStorage.getItem('unknown_columns') || '{}');
            unknownColsStorage[sheetName] = unknownColumns.map(function(uc) {
              return {
                original: uc.original,
                normalized: uc.normalized,
                samples: uc.samples,
                nonEmptyCount: normalizedRows.filter(function(r) { return r[uc.normalized]; }).length
              };
            });
            localStorage.setItem('unknown_columns', JSON.stringify(unknownColsStorage));
          }
          
          // Save to localStorage
          localStorage.setItem(STORAGE_KEY_DATASET, JSON.stringify({
            workbook: workbook,
            allData: allData
          }));
          saveToUploadLibrary({ workbook: workbook }, file.name, 'csv');
          
          dataLoaded = true;
          currentArtifactPath = file.name;
          currentDataset = null; // Reset cache
          updateUIForDataState();
          updateSessionChip();
          populateSubtypeDropdown();
          populateGridSheetSelector();
          renderAllTables();
          renderGrid();
          
          console.log('[Loader] CSV imported:', sheetName, 'headers:', normalizedHeaders.length, 'rows:', normalizedRows.length, 'unknown:', unknownColumns.length);
          showToast('CSV imported: ' + parsed.rows.length + ' rows, ' + unknownColumns.length + ' unknown columns', 'success');
          
          if (callback) callback();
        } catch (err) {
          console.error('CSV import error:', err);
          showToast('Failed to import CSV: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
    }
    
    // ========== LOADER PAGE UI (V1.2.7) ==========
    
    function updateLoaderPageUI() {
      var continuePanel = document.getElementById('loader-continue-panel');
      var importPanel = document.getElementById('loader-import-panel');
      var samplePanel = document.getElementById('loader-sample-panel');
      var activeDatasetInfo = document.getElementById('loader-active-dataset-info');
      
      console.log('[LoaderUI] Updating, dataLoaded: ' + dataLoaded);
      
      if (dataLoaded) {
        // Show Continue panel, hide Import/Sample panels
        if (continuePanel) {
          continuePanel.style.display = 'block';
          if (activeDatasetInfo) {
            var contractCount = (allData.contractResults || []).length;
            var sheetCount = Object.keys(allData.sheets || {}).length;
            activeDatasetInfo.innerHTML = '<strong>' + (currentArtifactPath || 'Dataset') + '</strong> | ' + 
              sheetCount + ' sheets, ' + contractCount + ' records';
          }
        }
        if (importPanel) importPanel.style.display = 'none';
        if (samplePanel) samplePanel.style.display = 'none';
      } else {
        // Show Import (primary) + Sample (secondary), hide Continue
        if (continuePanel) continuePanel.style.display = 'none';
        if (importPanel) importPanel.style.display = 'block';
        if (samplePanel) samplePanel.style.display = 'block';
      }
    }
    
    function initLoaderPage() {
      // Toggle collapsible actions
      var toggleBtn = document.getElementById('loader-toggle-actions');
      var actionsContent = document.getElementById('loader-actions-content');
      var toggleIcon = document.getElementById('loader-toggle-icon');
      
      if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
          var isOpen = actionsContent.style.display !== 'none';
          actionsContent.style.display = isOpen ? 'none' : 'block';
          toggleIcon.innerHTML = isOpen ? '&#9660;' : '&#9650;';
        });
      }
      
      // Continue to Triage button
      var continueBtn = document.getElementById('btn-continue-triage');
      if (continueBtn) {
        continueBtn.addEventListener('click', function() {
          navigateTo('triage');
        });
      }
      
      // Primary Import CSV button
      var importBtnPrimary = document.getElementById('btn-import-csv-primary');
      var fileInputPrimary = document.getElementById('file-import-csv-primary');
      if (importBtnPrimary && fileInputPrimary) {
        importBtnPrimary.addEventListener('click', function() {
          fileInputPrimary.click();
        });
        fileInputPrimary.addEventListener('change', function(e) {
          if (e.target.files && e.target.files[0]) {
            importCSVFile(e.target.files[0]);
          }
        });
      }
      
      // Secondary Sample Dataset button
      var sampleBtn = document.getElementById('btn-load-sample-secondary');
      if (sampleBtn) {
        sampleBtn.addEventListener('click', function() {
          loadSampleDataset({ autoRedirect: true });
        });
      }
    }
    
    function seedSampleDatasetOnFirstRun() {
      // Check if sample dataset is already in library
      var library = JSON.parse(localStorage.getItem(STORAGE_KEY_LIBRARY) || '[]');
      var hasSample = library.some(function(entry) {
        return entry.dataset_id === 'ds-sample';
      });
      
      if (!hasSample) {
        console.log('[FirstRun] Seeding sample dataset into cache');
        // Seed sample dataset into library
        var entry = {
          dataset_id: 'ds-sample',
          filename: 'Sample Dataset',
          source: 'sample',
          revision: 1,
          created_at: new Date().toISOString(),
          dataset: SAMPLE_DATASET
        };
        library.push(entry);
        localStorage.setItem(STORAGE_KEY_LIBRARY, JSON.stringify(library));
      }
      
      // Check if no active dataset - auto-activate sample on first run
      var activeDataset = localStorage.getItem(STORAGE_KEY_ACTIVE_DATASET);
      var hasStoredData = localStorage.getItem(STORAGE_KEY_DATASET);
      
      if (!activeDataset && !hasStoredData && !dataLoaded) {
        console.log('[FirstRun] No active dataset, auto-activating sample dataset');
        // Auto-load sample dataset but don't redirect yet (let user click Continue)
        loadSampleDataset({ autoRedirect: false });
      }
    }
    
    function updateLoaderSummary() {
      // Legacy function - now handled by updateLoaderPageUI
      updateLoaderPageUI();
    }
    
    function importCSVFile(file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        try {
          var text = e.target.result;
          var parsed = parseCSV(text);
          var sheetName = file.name.replace(/\.[^/.]+$/, '').toLowerCase().replace(/[^a-z0-9_]/g, '_');
          
          var dataset = {
            dataset_id: 'import_' + Date.now(),
            version: '1.0.0',
            created_at: new Date().toISOString(),
            description: 'Imported from ' + file.name,
            sheets: {},
            issues: [],
            field_actions: [],
            contract_results: [],
            summary: {}
          };
          dataset.sheets[sheetName] = parsed;
          
          // Generate contract_results from rows if contract_key exists
          if (parsed.headers.includes('contract_key')) {
            parsed.rows.forEach(function(row, idx) {
              dataset.contract_results.push({
                contract_key: row.contract_key || '',
                file_url: row.file_url || '',
                file_name: row.file_name || '',
                status: 'needs_review',
                subtype: row.subtype || 'unknown',
                issue_count: 0
              });
            });
          }
          
          allData = {
            contractResults: dataset.contract_results,
            issues: dataset.issues,
            fieldActions: dataset.field_actions,
            changeLog: [],
            summary: dataset.summary,
            sheets: dataset.sheets
          };
          
          localStorage.setItem(STORAGE_KEY_DATASET, JSON.stringify(dataset));
          
          // Save to upload library
          saveToUploadLibrary(dataset, file.name, 'csv');
          
          dataLoaded = true;
          currentArtifactPath = file.name;
          updateUIForDataState();
          updateSessionChip();
          populateSubtypeDropdown();
          renderAllTables();
          populateTargetFieldDropdown();
          updateLoaderPageUI();
          
          showToast('Imported ' + parsed.rows.length + ' rows from ' + file.name, 'success');
          
          // Auto-redirect after CSV import (v1.2.7) - use intended route if stored
          setTimeout(function() {
            var nextRoute = sessionStorage.getItem('kiwi_next_route') || 'triage';
            sessionStorage.removeItem('kiwi_next_route');
            navigateTo(nextRoute);
          }, 300);
        } catch (err) {
          console.error('CSV import error:', err);
          showToast('Failed to import CSV: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
    }
    
    function attachPDFFile(file) {
      try {
        var attachments = JSON.parse(localStorage.getItem(STORAGE_KEY_PDF_ATTACHMENTS) || '[]');
        
        var attachment = {
          pdf_artifact_id: 'pdf_' + Date.now(),
          file_name: file.name,
          file_size_bytes: file.size,
          added_at_utc: new Date().toISOString(),
          local_object_url: URL.createObjectURL(file)
        };
        
        attachments.push(attachment);
        localStorage.setItem(STORAGE_KEY_PDF_ATTACHMENTS, JSON.stringify(attachments));
        
        renderPDFAttachmentsList();
        showToast('PDF attached: ' + file.name, 'success');
      } catch (err) {
        console.error('PDF attach error:', err);
        showToast('Failed to attach PDF: ' + err.message, 'error');
      }
    }
    
    function renderPDFAttachmentsList() {
      var listEl = document.getElementById('pdf-attachments-list');
      if (!listEl) return;
      
      var attachments = JSON.parse(localStorage.getItem(STORAGE_KEY_PDF_ATTACHMENTS) || '[]');
      
      if (attachments.length === 0) {
        listEl.innerHTML = '';
        return;
      }
      
      listEl.innerHTML = '<div style="margin-top: 8px;"><strong>Attached:</strong></div>' +
        attachments.map(function(a) {
          return '<div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">' +
            '<span>ðŸ“„ ' + escapeHtml(a.file_name) + '</span>' +
            '<span style="color: #999; font-size: 0.8em;">(' + Math.round(a.file_size_bytes / 1024) + ' KB)</span>' +
            '</div>';
        }).join('');
    }
    
    function resetDemoState() {
      var keysToRemove = [
        STORAGE_KEY_DATASET,
        STORAGE_KEY_PDF_ATTACHMENTS,
        STORAGE_KEY_SESSION,
        STORAGE_KEY_LIBRARY,
        STORAGE_KEY_ACTIVE_DATASET,
        'orchestrate.comments.v1',
        'orchestrate.patch_requests.v1'
      ];
      
      keysToRemove.forEach(function(key) {
        localStorage.removeItem(key);
      });
      
      allData = { contractResults: [], issues: [], fieldActions: [], changeLog: [], summary: {}, sheets: {} };
      dataLoaded = false;
      currentArtifactPath = null;
      
      updateUIForDataState();
      updateSessionChip();
      renderAllTables();
      populateTargetFieldDropdown();
      updateLoaderSummary();
      renderPDFAttachmentsList();
      updatePatchQueueCounts();
      
      // Navigate to loader after reset
      navigateTo('loader');
      showToast('Demo state reset', 'success');
    }
    
    function rebuildFieldIndex() {
      populateTargetFieldDropdown();
      showToast('Field index rebuilt', 'success');
    }
    
    // Loader button event listeners
    document.getElementById('btn-load-sample')?.addEventListener('click', loadSampleDataset);
    document.getElementById('btn-import-csv')?.addEventListener('click', function() {
      document.getElementById('file-import-csv')?.click();
    });
    document.getElementById('file-import-csv')?.addEventListener('change', function(e) {
      var file = e.target.files?.[0];
      if (file) importCSVFile(file);
      e.target.value = '';
    });
    document.getElementById('btn-attach-pdf')?.addEventListener('click', function() {
      document.getElementById('file-attach-pdf')?.click();
    });
    document.getElementById('file-attach-pdf')?.addEventListener('change', function(e) {
      var file = e.target.files?.[0];
      if (file) attachPDFFile(file);
      e.target.value = '';
    });
    document.getElementById('btn-open-spreadsheet')?.addEventListener('click', function() {
      navigateTo('grid');
    });
    document.getElementById('btn-reset-demo-state')?.addEventListener('click', resetDemoState);
    document.getElementById('btn-rebuild-field-index')?.addEventListener('click', rebuildFieldIndex);
    
    // Initialize loader state on page load (v1.2.7)
    seedSampleDatasetOnFirstRun();
    initLoaderPage();
    renderPDFAttachmentsList();
    updateLoaderPageUI();
    
    // Welcome hero and top toolbar event listeners
    document.getElementById('welcome-load-data')?.addEventListener('click', openDataSourcePanel);
    document.getElementById('btn-data-source')?.addEventListener('click', openDataSourcePanel);
    document.getElementById('btn-configure')?.addEventListener('click', openConfigureWizard);
    document.getElementById('btn-ruleset')?.addEventListener('click', openRulesetModal);
    document.getElementById('btn-compare')?.addEventListener('click', openCompareModal);
    document.getElementById('btn-run')?.addEventListener('click', openRunModal);
    
    // Configure wizard modal events
    document.getElementById('configure-wizard-modal')?.addEventListener('click', e => {
      if (e.target.id === 'configure-wizard-modal') closeConfigureWizard();
    });

    // Data source drawer events
    document.getElementById('data-source-drawer')?.addEventListener('click', e => {
      if (e.target.id === 'data-source-drawer') closeDataSourceDrawer();
    });
    
    // Record drawer events
    document.getElementById('record-drawer')?.addEventListener('click', e => {
      if (e.target.id === 'record-drawer') closeRecordDrawer();
    });
    
    // Patch detail drawer events
    document.getElementById('patch-detail-drawer')?.addEventListener('click', e => {
      if (e.target.id === 'patch-detail-drawer') closePatchDetailDrawer();
    });
    
    // Config Flows drawer events
    document.getElementById('config-flows-drawer')?.addEventListener('click', e => {
      if (e.target.id === 'config-flows-drawer') closeConfigFlows();
    });
    document.querySelectorAll('#data-source-drawer .wizard-preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#data-source-drawer .wizard-preset-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('wizard-artifact-path').value = btn.dataset.path;
      });
    });
    document.getElementById('wizard-load-artifact')?.addEventListener('click', async () => {
      const path = document.getElementById('wizard-artifact-path').value.trim();
      if (!path) {
        showWizardStatus('data-source-status', 'Please enter an artifact path', 'error');
        return;
      }
      const relativePath = '../../' + path;
      try {
        const response = await fetch(relativePath);
        if (!response.ok) throw new Error('File not found');
        const data = await response.json();
        if (data.sf_summary || data.sf_contract_results || data.sf_issues || data.sf_field_actions) {
          allData.contractResults = data.sf_contract_results || [];
          allData.issues = data.sf_issues || [];
          allData.fieldActions = data.sf_field_actions || [];
          allData.summary = data.sf_summary || {};
          allData.changeLog = data.sf_changelog || [];
          dataLoaded = true;
          currentArtifactPath = path;
          updateUIForDataState();
          renderAllTables();
          closeDataSourceDrawer();
          navigateTo('grid');
          showWizardStatus('data-source-status', 'Data loaded successfully!', 'success');
        } else {
          throw new Error('Invalid data format - expected Preview Packet structure');
        }
      } catch (e) {
        showWizardStatus('data-source-status', 'Failed to load: ' + e.message, 'error');
      }
    });

    // Ruleset modal events
    document.getElementById('ruleset-modal')?.addEventListener('click', e => {
      if (e.target.id === 'ruleset-modal') closeRulesetModal();
    });
    document.getElementById('wizard-load-ruleset')?.addEventListener('click', async () => {
      const basePath = document.getElementById('wizard-base-config').value.trim();
      const patchPath = document.getElementById('wizard-patch-config').value.trim();
      if (!basePath) {
        showWizardStatus('ruleset-status', 'Please enter a base config path', 'error');
        return;
      }
      try {
        // Use existing config loading logic
        document.getElementById('base-config-path').value = basePath;
        document.getElementById('patch-path').value = patchPath;
        await loadConfigAndPatch();
        closeRulesetModal();
        showWizardStatus('ruleset-status', 'Ruleset loaded!', 'success');
      } catch (e) {
        showWizardStatus('ruleset-status', 'Failed to load ruleset: ' + e.message, 'error');
      }
    });

    // Compare modal events
    document.getElementById('compare-modal')?.addEventListener('click', e => {
      if (e.target.id === 'compare-modal') closeCompareModal();
    });
    document.querySelectorAll('#compare-modal .wizard-preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#compare-modal .wizard-preset-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('wizard-compare-path').value = btn.dataset.compare || '';
      });
    });
    document.getElementById('wizard-load-compare')?.addEventListener('click', async () => {
      const comparePath = document.getElementById('wizard-compare-path').value.trim();
      if (!comparePath) {
        compareData = null;
        rowChanges = { contractResults: {}, issues: {}, fieldActions: {} };
        deltaStats = null;
        renderDeltaSummary();
        renderAllTables();
        closeCompareModal();
        return;
      }
      const relativePath = '../../' + comparePath;
      try {
        const response = await fetch(relativePath);
        if (!response.ok) throw new Error('File not found');
        compareData = await response.json();
        rowChanges.contractResults = computeRowChanges(allData.contractResults, compareData.sf_contract_results || [], 'contractResults');
        rowChanges.issues = computeRowChanges(allData.issues, compareData.sf_issues || [], 'issues');
        rowChanges.fieldActions = computeRowChanges(allData.fieldActions, compareData.sf_field_actions || [], 'fieldActions');
        deltaStats = computeDeltaStats({ sf_summary: allData.summary }, compareData);
        renderDeltaSummary();
        renderAllTables();
        closeCompareModal();
      } catch (e) {
        showWizardStatus('compare-status', 'Failed to load comparison: ' + e.message, 'error');
      }
    });

    // Run modal events
    document.getElementById('run-modal')?.addEventListener('click', e => {
      if (e.target.id === 'run-modal') closeRunModal();
    });
    document.querySelectorAll('#run-modal .toolbar-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const cmdKey = btn.dataset.cmd;
        if (commands[cmdKey]) {
          const cmd = commands[cmdKey];
          document.getElementById('modal-title').textContent = cmd.label || cmdKey;
          document.getElementById('modal-description').textContent = cmd.description || '';
          document.getElementById('modal-command').textContent = cmd.command;
          document.getElementById('command-modal').classList.add('active');
        }
      });
    });

    function showWizardStatus(id, message, type) {
      const status = document.getElementById(id);
      if (status) {
        status.textContent = message;
        status.className = 'modal-status ' + type;
        status.style.display = 'block';
        setTimeout(() => { status.style.display = 'none'; }, 3000);
      }
    }

    initRouter();
    loadCommands();
    setupLoaderHandlers();
    
    // Initialize Masterline Artifact Registry
    loadArtifactRegistry();
    updateDevMasterlineUI();
    renderArtifactRegistryTable();
    renderWorkflowMap();
    setupStandardizerDropZone();
    initPatchConsole();
    
    // If Dev Masterline is enabled, auto-load artifacts instead of default loadData
    if (artifactRegistry.devMasterlineEnabled) {
      masterlineAutoload();
    } else {
      loadData();
    }
    
    restorePreflightEvidence();
    restorePatchDraft();
    updateUIForDataState();
    updateSessionChip();
  </script>
</body>
</html>
