{
  "mode": "build",
  "status": "kiwi_alignment_confirmed",
  "summary": {
    "primary_issue": "Loader modal failure is caused by a legacy DOM-style toggle function (updateLoaderModalUI) dereferencing a missing node and crashing the app.",
    "root_cause": "Mixed paradigms: legacy drawer/DOM manipulation paths still exist alongside a newer portal-based modal approach.",
    "impact": [
      "Loader appears unmapped/no-op because JS crashes before render.",
      "Router navigation triggers the same crash, masking Grid binding and post-load flows."
    ],
    "kiwi_confidence": "High â€” error signatures, call paths, and crash behavior are consistent and repeatable."
  },
  "decisions_locked": {
    "modal_strategy": "portal_only",
    "legacy_dom_toggles": "removed",
    "loader_route": "disallowed",
    "file_support": {
      "csv": "supported",
      "xlsx": "explicitly_blocked"
    }
  },
  "implementation_plan": {
    "phase_1_crash_removal": {
      "actions": [
        "Delete updateLoaderModalUI() and remove all invocations.",
        "Remove openLoaderDrawer() or refactor it to delegate directly to uiStore.openLoaderModal().",
        "Ensure navigateTo() and initRouter() do not reference loader UI logic."
      ],
      "goal": "Eliminate null.style crash and stop router from triggering loader code paths."
    },
    "phase_2_modal_canonicalization": {
      "actions": [
        "Add a single <div id=\"modal-root\"></div> after the main app root in index.html.",
        "Standardize all portals to target 'modal-root' only.",
        "Implement LoaderModal as a pure createPortal overlay with fixed positioning and backdrop."
      ],
      "goal": "Make Loader route-agnostic, stable across navigation, and visually reliable."
    },
    "phase_3_entrypoint_wiring": {
      "actions": [
        "Bind all 'Load Data' CTAs (Triage, Topbar) to uiStore.openLoaderModal().",
        "Render <LoaderModal /> once at a stable shell (App or Triage shell)."
      ],
      "goal": "Single deterministic open path for Loader."
    },
    "phase_4_data_commit_and_navigation": {
      "actions": [
        "On CSV success: datasetStore.set({ columns, rows, activeSheet }).",
        "Then uiStore.set({ isLoaderOpen: false }).",
        "Then navigate('#/grid').",
        "Block .xlsx with inline error and no navigation."
      ],
      "goal": "State-first, route-second flow with no race conditions."
    },
    "phase_5_grid_and_admin_hardening": {
      "actions": [
        "Align Grid selectors exactly with datasetStore keys.",
        "Add explicit empty-state messaging when rows/columns are missing.",
        "Remove or stub undefined admin handlers (inspectJSON, loadAdminConfig) to reduce console noise."
      ],
      "goal": "Prevent silent failures and surface real regressions clearly."
    }
  },
  "constraints_reaffirmed": {
    "offline_first": true,
    "deterministic": true,
    "no_external_apis": true,
    "no_llm_dependency": true,
    "human_in_the_loop": true
  },
  "acceptance_criteria": {
    "loader": [
      "Opens reliably from any entrypoint.",
      "Does not crash on navigation.",
      "Closes cleanly and restores focus."
    ],
    "grid": [
      "Auto-navigates after CSV load.",
      "Renders columns and rows immediately.",
      "Shows explicit empty-state when applicable."
    ],
    "console": [
      "No references to updateLoaderModalUI.",
      "No null.style errors.",
      "No loader-related errors during routing."
    ]
  },
  "next_action": {
    "owner": "replit_build",
    "instruction": "Apply the phased implementation plan exactly as specified, preserving portal-only modal architecture and removing all legacy DOM-toggle loader code.",
    "verification": "Re-run Kiwi acceptance tests after implementation and confirm no regression before proceeding to additional UX work."
  }
}