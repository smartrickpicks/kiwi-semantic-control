openapi: '3.1.0'
info:
  title: Orchestrate OS API
  version: 2.5.0-draft
  description: 'Governance-only semantic control plane API. Resource-style endpoints for multi-user Postgres-backed persistence
    with append-only audit logging.

    '
  contact:
    name: Orchestrate OS Team
servers:
- url: /api/v2.5
  description: Canonical API base
paths:
  /health:
    get:
      operationId: getHealth
      summary: Health check
      tags:
      - System
      responses:
        '200':
          description: Server healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum:
                    - ok
                  db:
                    type: string
                    enum:
                    - connected
                    - disconnected
                  version:
                    type: string
  /workspaces:
    get:
      operationId: listWorkspaces
      summary: List workspaces
      tags:
      - Workspaces
      parameters:
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Workspace list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkspaceCollection'
    post:
      operationId: createWorkspace
      summary: Create workspace
      tags:
      - Workspaces
      parameters:
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkspaceCreate'
      responses:
        '201':
          description: Workspace created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkspaceResponse'
  /workspaces/{workspace_id}:
    get:
      operationId: getWorkspace
      summary: Get workspace
      tags:
      - Workspaces
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      responses:
        '200':
          description: Workspace details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkspaceResponse'
    patch:
      operationId: updateWorkspace
      summary: Update workspace
      tags:
      - Workspaces
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkspaceUpdate'
      responses:
        '200':
          description: Workspace updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkspaceResponse'
        '409':
          $ref: '#/components/responses/StaleVersion'
  /workspaces/{workspace_id}/batches:
    get:
      operationId: listBatches
      summary: List batches in workspace
      tags:
      - Batches
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Batch list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchCollection'
    post:
      operationId: createBatch
      summary: Create batch
      tags:
      - Batches
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchCreate'
      responses:
        '201':
          description: Batch created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchResponse'
  /batches/{batch_id}:
    get:
      operationId: getBatch
      summary: Get batch
      tags:
      - Batches
      parameters:
      - $ref: '#/components/parameters/BatchId'
      responses:
        '200':
          description: Batch details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchResponse'
    patch:
      operationId: updateBatch
      summary: Update batch
      tags:
      - Batches
      parameters:
      - $ref: '#/components/parameters/BatchId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchUpdate'
      responses:
        '200':
          description: Batch updated
        '409':
          $ref: '#/components/responses/StaleVersion'
  /workspaces/{workspace_id}/patches:
    get:
      operationId: listPatches
      summary: List patches in workspace
      tags:
      - Patches
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      - name: status
        in: query
        schema:
          type: string
      - name: author_id
        in: query
        schema:
          type: string
      responses:
        '200':
          description: Patch list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchCollection'
    post:
      operationId: createPatch
      summary: Create patch (Draft status)
      tags:
      - Patches
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PatchCreate'
      responses:
        '201':
          description: Patch created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchResponse'
  /patches/{patch_id}:
    get:
      operationId: getPatch
      summary: Get patch with history
      tags:
      - Patches
      parameters:
      - $ref: '#/components/parameters/PatchId'
      responses:
        '200':
          description: Patch details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchResponse'
    patch:
      operationId: updatePatch
      summary: Update patch status or fields
      description: 'Status transitions are validated against the transition matrix. Self-approval is blocked for Verifier_Approved
        and Admin_Approved. Requires version field for optimistic concurrency.

        '
      tags:
      - Patches
      parameters:
      - $ref: '#/components/parameters/PatchId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PatchUpdate'
      responses:
        '200':
          description: Patch updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchResponse'
        '403':
          description: Self-approval blocked or insufficient role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '409':
          $ref: '#/components/responses/StaleVersion'
  /patches/{patch_id}/evidence-packs:
    get:
      operationId: listEvidencePacks
      summary: List evidence packs for patch
      tags:
      - Evidence Packs
      parameters:
      - $ref: '#/components/parameters/PatchId'
      responses:
        '200':
          description: Evidence pack list
    post:
      operationId: createEvidencePack
      summary: Create evidence pack
      tags:
      - Evidence Packs
      parameters:
      - $ref: '#/components/parameters/PatchId'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EvidencePackCreate'
      responses:
        '201':
          description: Evidence pack created
  /workspaces/{workspace_id}/annotations:
    get:
      operationId: listAnnotations
      summary: List annotations
      tags:
      - Annotations
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Annotation list
    post:
      operationId: createAnnotation
      summary: Create annotation
      tags:
      - Annotations
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnnotationCreate'
      responses:
        '201':
          description: Annotation created
  /workspaces/{workspace_id}/rfis:
    get:
      operationId: listRfis
      summary: List RFIs
      tags:
      - RFIs
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: RFI list
    post:
      operationId: createRfi
      summary: Create RFI
      tags:
      - RFIs
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RfiCreate'
      responses:
        '201':
          description: RFI created
  /batches/{batch_id}/triage-items:
    get:
      operationId: listTriageItems
      summary: List triage items
      tags:
      - Triage
      parameters:
      - $ref: '#/components/parameters/BatchId'
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Triage item list
    post:
      operationId: createTriageItem
      summary: Create triage item
      tags:
      - Triage
      parameters:
      - $ref: '#/components/parameters/BatchId'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TriageItemCreate'
      responses:
        '201':
          description: Triage item created
  /batches/{batch_id}/signals:
    get:
      operationId: listSignals
      summary: List signals
      tags:
      - Signals
      parameters:
      - $ref: '#/components/parameters/BatchId'
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Signal list
    post:
      operationId: createSignal
      summary: Create signal
      tags:
      - Signals
      parameters:
      - $ref: '#/components/parameters/BatchId'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignalCreate'
      responses:
        '201':
          description: Signal created
  /documents/{document_id}/selection-captures:
    get:
      operationId: listSelectionCaptures
      summary: List selection captures
      tags:
      - Selection Captures
      parameters:
      - name: document_id
        in: path
        required: true
        schema:
          type: string
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Selection capture list
    post:
      operationId: createSelectionCapture
      summary: Create selection capture
      tags:
      - Selection Captures
      parameters:
      - name: document_id
        in: path
        required: true
        schema:
          type: string
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SelectionCaptureCreate'
      responses:
        '201':
          description: Selection capture created
  /workspaces/{workspace_id}/audit-events:
    get:
      operationId: listAuditEvents
      summary: List audit events (read-only)
      tags:
      - Audit
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      - name: event_type
        in: query
        schema:
          type: string
      - name: actor_id
        in: query
        schema:
          type: string
      - name: since
        in: query
        schema:
          type: string
          format: date-time
      responses:
        '200':
          description: Audit event list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditEventCollection'
  /workspaces/{workspace_id}/events/stream:
    get:
      operationId: streamEvents
      summary: SSE event stream
      tags:
      - Events
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      responses:
        '200':
          description: SSE event stream
          content:
            text/event-stream:
              schema:
                type: string
  /workspaces/{workspace_id}/drive/connect:
    post:
      operationId: connectDrive
      summary: Initiate Google Drive OAuth connection
      tags:
      - Drive
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                redirect_uri:
                  type: string
                  description: OAuth callback URL
              required:
              - redirect_uri
      responses:
        '200':
          description: OAuth authorization URL returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      auth_url:
                        type: string
                        description: Google OAuth consent URL to redirect user to
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
        '403':
          description: Insufficient permissions (admin/architect only)
  /workspaces/{workspace_id}/drive/callback:
    post:
      operationId: driveOAuthCallback
      summary: Handle Drive OAuth callback and store tokens
      tags:
      - Drive
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                code:
                  type: string
                  description: OAuth authorization code from Google
                redirect_uri:
                  type: string
              required:
              - code
              - redirect_uri
      responses:
        '200':
          description: Drive connected successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      connected:
                        type: boolean
                      drive_email:
                        type: string
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
  /workspaces/{workspace_id}/drive/disconnect:
    delete:
      operationId: disconnectDrive
      summary: Disconnect Google Drive and revoke tokens
      tags:
      - Drive
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      responses:
        '200':
          description: Drive disconnected
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      disconnected:
                        type: boolean
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
        '403':
          description: Insufficient permissions (admin/architect only)
  /workspaces/{workspace_id}/drive/status:
    get:
      operationId: getDriveStatus
      summary: Check Drive connection status
      tags:
      - Drive
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      responses:
        '200':
          description: Connection status
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      connected:
                        type: boolean
                      drive_email:
                        type:
                        - string
                        - 'null'
                      connected_at:
                        type:
                        - string
                        - 'null'
                        format: date-time
                      connected_by:
                        type:
                        - string
                        - 'null'
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
  /workspaces/{workspace_id}/drive/browse:
    get:
      operationId: browseDrive
      summary: Browse Drive folders and files
      tags:
      - Drive
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      - name: parent_id
        in: query
        schema:
          type: string
        description: Folder ID to list contents of. Omit for root / shared drives.
      - name: drive_id
        in: query
        schema:
          type: string
        description: Shared drive ID (required for shared drive browsing)
      - name: type
        in: query
        schema:
          type: string
          enum:
          - drives
          - files
          default: files
        description: '''drives'' lists shared drives, ''files'' lists folder contents'
      responses:
        '200':
          description: Drive contents
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                            name:
                              type: string
                            mime_type:
                              type: string
                            kind:
                              type: string
                              enum:
                              - drive
                              - folder
                              - file
                            modified_time:
                              type:
                              - string
                              - 'null'
                              format: date-time
                            size:
                              type:
                              - integer
                              - 'null'
                      breadcrumb:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                            name:
                              type: string
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
  /workspaces/{workspace_id}/drive/import:
    post:
      operationId: importFromDrive
      summary: Import a file from Google Drive as working copy
      tags:
      - Drive
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                file_id:
                  type: string
                  description: Google Drive file ID
                drive_id:
                  type:
                  - string
                  - 'null'
                  description: Shared drive ID (if applicable)
              required:
              - file_id
      responses:
        '200':
          description: File imported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      import_id:
                        type: string
                        description: Provenance record ID (drv_ prefix)
                      filename:
                        type: string
                      mime_type:
                        type: string
                      size_bytes:
                        type: integer
                      source_file_id:
                        type: string
                      source_drive_id:
                        type:
                        - string
                        - 'null'
                      has_external_modifications:
                        type: boolean
                      baseline_unknown:
                        type: boolean
                      version_number:
                        type: integer
                        description: Import version number (1 for first import, incremented on refresh)
                      supersedes_id:
                        type:
                        - string
                        - 'null'
                        description: Previous version's import_id (null for first import)
                      download_url:
                        type: string
                        description: Temporary URL to fetch file bytes
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
  /workspaces/{workspace_id}/drive/import-history:
    get:
      operationId: getDriveImportHistory
      summary: List all imported versions of a Drive file
      tags:
      - Drive
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      - name: source_file_id
        in: query
        required: true
        schema:
          type: string
        description: Google Drive file ID to list import versions for
      responses:
        '200':
          description: Import version history
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      versions:
                        type: array
                        items:
                          type: object
                          properties:
                            import_id:
                              type: string
                            version_number:
                              type: integer
                            imported_at:
                              type: string
                              format: date-time
                            imported_by:
                              type: string
                            supersedes_id:
                              type:
                              - string
                              - 'null'
                            is_current:
                              type: boolean
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
  /workspaces/{workspace_id}/drive/export:
    post:
      operationId: exportToDrive
      summary: Export working copy back to Google Drive
      tags:
      - Drive
      parameters:
      - $ref: '#/components/parameters/WorkspaceId'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: The workbook file to upload
                export_type:
                  type: string
                  enum:
                  - in_progress
                  - final
                  description: '''in_progress'' for Save In Progress, ''final'' for Export Final'
                target_folder_id:
                  type: string
                  description: Drive folder to save into (defaults to source folder)
                source_import_id:
                  type: string
                  description: Original import provenance ID for traceability
                changes_log:
                  type: string
                  description: JSON-encoded changes log artifact
              required:
              - file
              - export_type
      responses:
        '200':
          description: File exported to Drive
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      drive_file_id:
                        type: string
                        description: ID of the created Drive file
                      drive_file_name:
                        type: string
                        description: Filename with status convention applied
                      drive_file_url:
                        type: string
                        description: Web URL to the file in Drive
                      export_type:
                        type: string
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
        '403':
          description: Role not authorized for this export type
  /documents/{doc_id}/reader-nodes:
    get:
      operationId: getReaderNodes
      summary: Get cached reader nodes for a document
      description: 'Returns cached text extraction nodes for a document. Cache key is (document_id, source_pdf_hash, ocr_version).
        If no cache entry exists, returns empty nodes with quality_flag=missing_text_layer. Feature-gated behind EVIDENCE_INSPECTOR_V251.

        '
      tags:
      - Evidence Viewer
      parameters:
      - name: doc_id
        in: path
        required: true
        schema:
          type: string
      - name: source_pdf_hash
        in: query
        schema:
          type: string
        description: SHA-256 hash of the source PDF
      - name: ocr_version
        in: query
        schema:
          type: string
          default: v1
      responses:
        '200':
          description: Reader node cache hit or fallback
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReaderNodeResponse'
        '404':
          description: Document not found or feature disabled
    put:
      operationId: upsertReaderNodes
      summary: Upsert reader node cache for a document
      description: 'Creates or updates the reader node cache entry for a document. Each node receives a deterministic node_id
        based on (document_id, page_number, block_index). Quality flag is auto-detected if not provided. Cache key: (document_id,
        source_pdf_hash, ocr_version). Emits reader_node_cache.upserted audit event. Feature-gated behind EVIDENCE_INSPECTOR_V251.'
      tags:
      - Evidence Viewer
      parameters:
      - name: doc_id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - source_pdf_hash
              - nodes
              properties:
                source_pdf_hash:
                  type: string
                  description: SHA-256 hash of the source PDF bytes
                ocr_version:
                  type: string
                  default: v1
                  description: OCR engine version string
                page_count:
                  type: integer
                  description: Total page count in the PDF
                quality_flag:
                  type: string
                  enum:
                  - ok
                  - suspect_mojibake
                  - unreadable
                  - missing_text_layer
                  description: Override quality flag (auto-detected if omitted)
                nodes:
                  type: array
                  items:
                    type: object
                    properties:
                      page_number:
                        type: integer
                      block_index:
                        type: integer
                      text:
                        type: string
                      bbox:
                        type: array
                        items:
                          type: number
                        description: '[x0, y0, x1, y1] bounding box'
      responses:
        '200':
          description: Reader node cache created or updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReaderNodeResponse'
        '400':
          description: Validation error (missing source_pdf_hash)
        '404':
          description: Document not found or feature disabled
  /documents/{doc_id}/anchors:
    post:
      operationId: createAnchor
      summary: Create a text anchor on a document
      description: 'Creates a text anchor with fingerprint-based dedup. If an anchor with the same fingerprint already exists,
        returns the existing anchor (200) instead of creating a duplicate. Emits anchor.created audit event. Feature-gated
        behind EVIDENCE_INSPECTOR_V251.

        '
      tags:
      - Evidence Viewer
      parameters:
      - name: doc_id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnchorCreate'
      responses:
        '201':
          description: Anchor created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnchorResponse'
        '200':
          description: Existing anchor returned (fingerprint dedup)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnchorResponse'
        '404':
          description: Document not found or feature disabled
    get:
      operationId: listAnchors
      summary: List anchors for a document
      description: 'Returns paginated list of anchors for a document. Feature-gated behind EVIDENCE_INSPECTOR_V251.

        '
      tags:
      - Evidence Viewer
      parameters:
      - name: doc_id
        in: path
        required: true
        schema:
          type: string
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      - name: include_deleted
        in: query
        schema:
          type: boolean
          default: false
      responses:
        '200':
          description: Anchor list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnchorCollection'
        '404':
          description: Document not found or feature disabled
  /documents/{doc_id}/corrections:
    post:
      operationId: createCorrection
      summary: Create a field-level correction
      description: 'Creates a correction linked to a document, optionally referencing an anchor and/or RFI. Auto-classifies
        as minor (auto_applied) or non_trivial (pending_verifier) based on policy: abs(length_delta)<=2 AND no digits AND
        no currency/percent = minor. Emits correction.created audit event. Feature-gated behind EVIDENCE_INSPECTOR_V251.

        '
      tags:
      - Evidence Viewer
      parameters:
      - name: doc_id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CorrectionCreate'
      responses:
        '201':
          description: Correction created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CorrectionResponse'
        '400':
          description: Validation error (missing corrected_value, invalid anchor/rfi ref)
        '404':
          description: Document not found or feature disabled
  /corrections/{cor_id}:
    patch:
      operationId: updateCorrection
      summary: Update a correction (approve/reject/modify)
      description: 'Updates correction status, corrected_value, or metadata. Requires version for optimistic concurrency (409
        STALE_VERSION on mismatch). Setting status to approved/rejected auto-sets decided_by and decided_at. Emits correction.updated
        audit event. Feature-gated behind EVIDENCE_INSPECTOR_V251.

        '
      tags:
      - Evidence Viewer
      parameters:
      - name: cor_id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CorrectionUpdate'
      responses:
        '200':
          description: Correction updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CorrectionResponse'
        '400':
          description: Validation error
        '404':
          description: Correction not found or feature disabled
        '409':
          description: Stale version â€” concurrent modification
  /batches/{bat_id}/corrections:
    get:
      operationId: listBatchCorrections
      summary: List corrections across all documents in a batch
      description: 'Returns paginated corrections for all documents in the batch, optionally filtered by status. Feature-gated
        behind EVIDENCE_INSPECTOR_V251.

        '
      tags:
      - Evidence Viewer
      parameters:
      - name: bat_id
        in: path
        required: true
        schema:
          type: string
      - name: status
        in: query
        schema:
          type: string
          enum:
          - pending_verifier
          - approved
          - rejected
          - auto_applied
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Correction list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CorrectionCollection'
        '404':
          description: Batch not found or feature disabled
  /batches/{bat_id}/rfis:
    get:
      operationId: listBatchRfis
      summary: List RFIs scoped to a batch with custody_status filter
      description: 'Returns paginated RFIs for documents in the batch. Filters on custody_status with fallback to legacy status
        column for backward compatibility. Feature-gated behind EVIDENCE_INSPECTOR_V251.

        '
      tags:
      - Evidence Viewer
      parameters:
      - name: bat_id
        in: path
        required: true
        schema:
          type: string
      - name: status
        in: query
        schema:
          type: string
          enum:
          - open
          - awaiting_verifier
          - returned_to_analyst
          - resolved
          - dismissed
        description: Filter by custody_status (falls back to legacy status mapping)
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: RFI list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RfiCollection'
        '404':
          description: Batch not found or feature disabled
  /batches/{bat_id}/health:
    get:
      operationId: getBatchHealth
      summary: Get health aggregation for a batch
      description: 'Returns aggregate counts of open RFIs, pending corrections, mojibake suspects, and unreadable documents.
        Includes blockers list. Feature-gated behind EVIDENCE_INSPECTOR_V251.

        '
      tags:
      - Evidence Viewer
      parameters:
      - name: bat_id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Batch health summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchHealthResponse'
        '404':
          description: Batch not found or feature disabled
  /documents/{doc_id}/ocr-escalations:
    post:
      operationId: createOcrEscalation
      summary: Request OCR reprocessing for a document (mock)
      description: 'Creates an OCR escalation request. Currently a mock endpoint that records the request and emits an audit
        event but does not trigger actual OCR reprocessing. Response includes _mock=true flag. Feature-gated behind EVIDENCE_INSPECTOR_V251.

        '
      tags:
      - Evidence Viewer
      parameters:
      - name: doc_id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                escalation_type:
                  type: string
                  default: ocr_reprocess
                metadata:
                  type: object
      responses:
        '201':
          description: OCR escalation recorded (mock)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OcrEscalationResponse'
        '404':
          description: Document not found or feature disabled
  /glossary/terms:
    get:
      operationId: listGlossaryTerms
      summary: List glossary terms for a workspace
      description: >
        Returns paginated glossary terms filtered by workspace. Requires workspace selection
        via X-Workspace-Id header. Supports search by query string and category filter.
      tags:
      - Suggested Fields
      parameters:
      - name: X-Workspace-Id
        in: header
        required: true
        schema:
          type: string
        description: Workspace ID for scoping. Returns 422 MISSING_WORKSPACE if absent.
      - name: query
        in: query
        schema:
          type: string
        description: Search across field_key, display_name, and description (ILIKE)
      - name: category
        in: query
        schema:
          type: string
        description: Filter by term category
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Glossary terms list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GlossaryTermCollection'
        '403':
          description: No access to specified workspace
        '422':
          description: Missing workspace selector (X-Workspace-Id header)
    post:
      operationId: createGlossaryTerm
      summary: Create a glossary term in a workspace
      description: >
        Creates a canonical glossary term with field_key uniqueness enforced per workspace.
        Returns 409 DUPLICATE if field_key already exists. Emits glossary_term.created audit event.
      tags:
      - Suggested Fields
      parameters:
      - name: X-Workspace-Id
        in: header
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GlossaryTermCreate'
      responses:
        '201':
          description: Term created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GlossaryTermResponse'
        '400':
          description: Validation error (missing field_key)
        '409':
          description: Duplicate field_key in workspace
        '422':
          description: Missing workspace selector
  /glossary/aliases:
    post:
      operationId: createGlossaryAlias
      summary: Create an alias for a glossary term
      description: >
        Links an alternate name to a canonical glossary term. Normalized alias uniqueness
        enforced per workspace. Returns 409 DUPLICATE_ALIAS with existing mapping details
        if normalized alias already exists. Emits glossary_alias.created audit event.
      tags:
      - Suggested Fields
      parameters:
      - name: X-Workspace-Id
        in: header
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GlossaryAliasCreate'
      responses:
        '201':
          description: Alias created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GlossaryAliasResponse'
        '400':
          description: Validation error (missing term_id or alias)
        '404':
          description: Referenced glossary term not found
        '409':
          description: Duplicate alias in workspace (includes existing mapping details)
        '422':
          description: Missing workspace selector
  /glossary/aliases/{alias_id}:
    patch:
      operationId: updateGlossaryAlias
      summary: Update a glossary alias (reassign term or rename)
      description: >
        Updates an alias's term_id and/or alias text. Requires version for optimistic
        concurrency (409 STALE_VERSION on mismatch). Validates new term_id exists and
        checks for duplicate normalized alias. Emits glossary_alias.updated audit event.
      tags:
      - Suggested Fields
      parameters:
      - name: alias_id
        in: path
        required: true
        schema:
          type: string
      - name: X-Workspace-Id
        in: header
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GlossaryAliasUpdate'
      responses:
        '200':
          description: Alias updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GlossaryAliasResponse'
        '400':
          description: Validation error (missing version or no fields to update)
        '404':
          description: Alias or referenced term not found
        '409':
          description: Stale version or duplicate alias
        '422':
          description: Missing workspace selector
  /suggestions/run:
    post:
      operationId: runSuggestions
      summary: Run the suggestion engine against a document
      description: >
        Analyzes source document column headers and proposes mappings to canonical glossary
        terms. Uses three matching strategies: exact (score 1.0), fuzzy (Levenshtein >= 0.6),
        and keyword (category-based). Creates a suggestion_run record and individual suggestion
        records. Emits suggestion_run.completed audit event.
      tags:
      - Suggested Fields
      parameters:
      - name: X-Workspace-Id
        in: header
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - document_id
              properties:
                document_id:
                  type: string
      responses:
        '200':
          description: Suggestion run completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuggestionRunResponse'
        '404':
          description: Document not found
        '422':
          description: Missing workspace selector
  /suggestions:
    get:
      operationId: listSuggestions
      summary: List suggestions for a document
      description: >
        Returns suggestions for a specific document, optionally filtered by status.
        Results grouped by match_method (exact, fuzzy, keyword, none).
      tags:
      - Suggested Fields
      parameters:
      - name: X-Workspace-Id
        in: header
        required: true
        schema:
          type: string
      - name: document_id
        in: query
        required: true
        schema:
          type: string
      - name: status
        in: query
        schema:
          type: string
          enum:
          - pending
          - accepted
          - rejected
          - dismissed
      - $ref: '#/components/parameters/CursorParam'
      - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Suggestions list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuggestionCollection'
        '422':
          description: Missing workspace selector
  /suggestions/{suggestion_id}:
    patch:
      operationId: updateSuggestion
      summary: Accept or decline a suggestion
      description: >
        Updates a suggestion status (accepted/rejected). On accept, auto-creates a glossary
        alias linking the source field to the suggested term. Requires version for optimistic
        concurrency. Emits suggestion.accepted or suggestion.rejected audit event.
      tags:
      - Suggested Fields
      parameters:
      - name: suggestion_id
        in: path
        required: true
        schema:
          type: string
      - name: X-Workspace-Id
        in: header
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SuggestionUpdate'
      responses:
        '200':
          description: Suggestion updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuggestionResponse'
        '400':
          description: Validation error
        '404':
          description: Suggestion not found
        '409':
          description: Stale version
        '422':
          description: Missing workspace selector
components:
  parameters:
    WorkspaceId:
      name: workspace_id
      in: path
      required: true
      schema:
        type: string
        pattern: ^ws_[A-Za-z0-9]{26}$
    BatchId:
      name: batch_id
      in: path
      required: true
      schema:
        type: string
        pattern: ^bat_[A-Za-z0-9]{26}$
    PatchId:
      name: patch_id
      in: path
      required: true
      schema:
        type: string
        pattern: ^pat_[A-Za-z0-9]{26}$
    CursorParam:
      name: cursor
      in: query
      required: false
      schema:
        type: string
    LimitParam:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 50
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      schema:
        type: string
  schemas:
    GlossaryTerm:
      type: object
      properties:
        id:
          type: string
          description: ULID with glt_ prefix
        workspace_id:
          type: string
        field_key:
          type: string
        display_name:
          type: string
        description:
          type: string
        data_type:
          type: string
          default: string
        category:
          type: string
        is_required:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type:
          - string
          - 'null'
          format: date-time
        version:
          type: integer
        metadata:
          type: object
    GlossaryTermCreate:
      type: object
      required:
      - field_key
      properties:
        field_key:
          type: string
        display_name:
          type: string
        description:
          type: string
        data_type:
          type: string
          default: string
        category:
          type: string
        is_required:
          type: boolean
          default: false
        metadata:
          type: object
    GlossaryTermResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/GlossaryTerm'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    GlossaryTermCollection:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/GlossaryTerm'
        meta:
          $ref: '#/components/schemas/CollectionMeta'
    GlossaryAlias:
      type: object
      properties:
        id:
          type: string
          description: ULID with gla_ prefix
        workspace_id:
          type: string
        term_id:
          type: string
        alias:
          type: string
        normalized_alias:
          type: string
        source:
          type: string
          enum:
          - manual
          - suggestion
          - import
        created_by:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type:
          - string
          - 'null'
          format: date-time
        version:
          type: integer
        metadata:
          type: object
    GlossaryAliasCreate:
      type: object
      required:
      - term_id
      - alias
      properties:
        term_id:
          type: string
        alias:
          type: string
        metadata:
          type: object
    GlossaryAliasUpdate:
      type: object
      required:
      - version
      properties:
        version:
          type: integer
          description: Required for optimistic concurrency
        term_id:
          type: string
          description: Reassign alias to a different glossary term
        alias:
          type: string
          description: Rename the alias text
    GlossaryAliasResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/GlossaryAlias'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    SuggestionRun:
      type: object
      properties:
        id:
          type: string
          description: ULID with sgr_ prefix
        workspace_id:
          type: string
        document_id:
          type: string
        status:
          type: string
          enum:
          - running
          - completed
          - failed
        total_suggestions:
          type: integer
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        created_by:
          type: string
        metadata:
          type: object
    SuggestionRunResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/SuggestionRun'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    Suggestion:
      type: object
      properties:
        id:
          type: string
          description: ULID with sug_ prefix
        workspace_id:
          type: string
        run_id:
          type: string
        document_id:
          type: string
        source_field:
          type: string
        suggested_term_id:
          type:
          - string
          - 'null'
        match_score:
          type: number
          format: float
        match_method:
          type: string
          enum:
          - exact
          - fuzzy
          - keyword
          - none
        status:
          type: string
          enum:
          - pending
          - accepted
          - rejected
          - dismissed
        resolved_by:
          type:
          - string
          - 'null'
        resolved_at:
          type:
          - string
          - 'null'
          format: date-time
        candidates:
          type: array
          items:
            type: object
        created_at:
          type: string
          format: date-time
        version:
          type: integer
        metadata:
          type: object
    SuggestionUpdate:
      type: object
      required:
      - version
      - status
      properties:
        version:
          type: integer
          description: Required for optimistic concurrency
        status:
          type: string
          enum:
          - accepted
          - rejected
          - dismissed
    SuggestionResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Suggestion'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    SuggestionCollection:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Suggestion'
        meta:
          $ref: '#/components/schemas/CollectionMeta'
    WorkspaceCreate:
      type: object
      required:
      - name
      properties:
        name:
          type: string
        mode:
          type: string
          enum:
          - sandbox
          - production
          default: sandbox
        metadata:
          type: object
    WorkspaceUpdate:
      type: object
      required:
      - version
      properties:
        name:
          type: string
        mode:
          type: string
          enum:
          - sandbox
          - production
        version:
          type: integer
        metadata:
          type: object
    WorkspaceResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Workspace'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    WorkspaceCollection:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Workspace'
        meta:
          $ref: '#/components/schemas/CollectionMeta'
    Workspace:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        mode:
          type: string
          enum:
          - sandbox
          - production
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        version:
          type: integer
        metadata:
          type: object
    BatchCreate:
      type: object
      required:
      - name
      properties:
        name:
          type: string
        source:
          type: string
          enum:
          - upload
          - merge
          - import
          default: upload
        batch_fingerprint:
          type: string
        metadata:
          type: object
    BatchUpdate:
      type: object
      required:
      - version
      properties:
        name:
          type: string
        status:
          type: string
          enum:
          - active
          - archived
        version:
          type: integer
        metadata:
          type: object
    BatchResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Batch'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    BatchCollection:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Batch'
        meta:
          $ref: '#/components/schemas/CollectionMeta'
    Batch:
      type: object
      properties:
        id:
          type: string
        workspace_id:
          type: string
        name:
          type: string
        source:
          type: string
        batch_fingerprint:
          type: string
        status:
          type: string
        record_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        version:
          type: integer
        metadata:
          type: object
    PatchCreate:
      type: object
      required:
      - batch_id
      - record_id
      - field_key
      - intent
      properties:
        batch_id:
          type: string
        record_id:
          type: string
        field_key:
          type: string
        intent:
          type: string
        when_clause:
          type: object
        then_clause:
          type: array
        because_clause:
          type: string
        file_name:
          type: string
        file_url:
          type: string
        before_value:
          type: string
        after_value:
          type: string
        metadata:
          type: object
    PatchUpdate:
      type: object
      required:
      - version
      properties:
        status:
          type: string
          enum:
          - Draft
          - Submitted
          - Needs_Clarification
          - Verifier_Responded
          - Verifier_Approved
          - Admin_Approved
          - Admin_Hold
          - Applied
          - Rejected
          - Cancelled
          - Sent_to_Kiwi
          - Kiwi_Returned
        notes:
          type: string
        version:
          type: integer
        metadata:
          type: object
    PatchResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Patch'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    PatchCollection:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Patch'
        meta:
          $ref: '#/components/schemas/CollectionMeta'
    Patch:
      type: object
      properties:
        id:
          type: string
        workspace_id:
          type: string
        batch_id:
          type: string
        record_id:
          type: string
        field_key:
          type: string
        author_id:
          type: string
        status:
          type: string
        intent:
          type: string
        when_clause:
          type: object
        then_clause:
          type: array
        because_clause:
          type: string
        evidence_pack_id:
          type: string
        submitted_at:
          type: string
          format: date-time
        resolved_at:
          type: string
          format: date-time
        file_name:
          type: string
        file_url:
          type: string
        before_value:
          type: string
        after_value:
          type: string
        history:
          type: array
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        version:
          type: integer
        metadata:
          type: object
    EvidencePackCreate:
      type: object
      properties:
        blocks:
          type: object
          properties:
            context:
              type: object
            data_reference:
              type: object
            pdf_anchor:
              type: object
            rationale:
              type: object
        metadata:
          type: object
    AnnotationCreate:
      type: object
      required:
      - target_type
      - target_id
      - content
      properties:
        target_type:
          type: string
          enum:
          - field
          - record
          - contract
          - document
        target_id:
          type: string
        content:
          type: string
        annotation_type:
          type: string
          enum:
          - note
          - flag
          - question
          default: note
        metadata:
          type: object
    RfiCreate:
      type: object
      required:
      - target_record_id
      - question
      properties:
        patch_id:
          type: string
        target_record_id:
          type: string
        target_field_key:
          type: string
        question:
          type: string
        metadata:
          type: object
    TriageItemCreate:
      type: object
      required:
      - record_id
      - issue_type
      - severity
      properties:
        record_id:
          type: string
        field_key:
          type: string
        issue_type:
          type: string
        severity:
          type: string
          enum:
          - info
          - warning
          - blocker
        source:
          type: string
          enum:
          - qa_rule
          - preflight
          - system_pass
          - manual
          default: manual
        metadata:
          type: object
    SignalCreate:
      type: object
      required:
      - record_id
      - field_key
      - signal_type
      - severity
      - message
      properties:
        record_id:
          type: string
        field_key:
          type: string
        signal_type:
          type: string
        severity:
          type: string
          enum:
          - info
          - warning
          - blocking
        rule_id:
          type: string
        message:
          type: string
        metadata:
          type: object
    SelectionCaptureCreate:
      type: object
      required:
      - purpose
      properties:
        field_id:
          type: string
        rfi_id:
          type: string
        page_number:
          type: integer
        coordinates:
          type: object
        selected_text:
          type: string
        purpose:
          type: string
          enum:
          - evidence
          - annotation
          - rfi_anchor
        metadata:
          type: object
    AuditEvent:
      type: object
      properties:
        id:
          type: string
        workspace_id:
          type: string
        event_type:
          type: string
        actor_id:
          type: string
        actor_role:
          type: string
          enum:
          - analyst
          - verifier
          - admin
          - architect
        timestamp_iso:
          type: string
          format: date-time
        dataset_id:
          type: string
        batch_id:
          type: string
        record_id:
          type: string
        field_key:
          type: string
        patch_id:
          type: string
        before_value:
          type: string
        after_value:
          type: string
        metadata:
          type: object
    AuditEventCollection:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/AuditEvent'
        meta:
          $ref: '#/components/schemas/CollectionMeta'
    ErrorEnvelope:
      type: object
      required:
      - error
      - meta
      properties:
        error:
          type: object
          required:
          - code
          - message
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    ResponseMeta:
      type: object
      properties:
        request_id:
          type: string
        timestamp:
          type: string
          format: date-time
    CollectionMeta:
      type: object
      properties:
        request_id:
          type: string
        timestamp:
          type: string
          format: date-time
        pagination:
          type: object
          properties:
            cursor:
              type: string
            has_more:
              type: boolean
            limit:
              type: integer
    Anchor:
      type: object
      properties:
        id:
          type: string
          description: ULID with anc_ prefix
        document_id:
          type: string
        workspace_id:
          type: string
        anchor_fingerprint:
          type: string
          description: SHA-256 fingerprint for dedup
        node_id:
          type: string
        char_start:
          type: integer
        char_end:
          type: integer
        selected_text:
          type: string
        field_id:
          type: string
        field_key:
          type: string
        page_number:
          type: integer
        created_by:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type:
          - string
          - 'null'
          format: date-time
        version:
          type: integer
        metadata:
          type: object
        selected_text_hash:
          type: string
          description: SHA-256 hash of selected_text, computed server-side
    AnchorCreate:
      type: object
      properties:
        node_id:
          type: string
        char_start:
          type: integer
        char_end:
          type: integer
        selected_text:
          type: string
        field_id:
          type: string
        field_key:
          type: string
        page_number:
          type: integer
        metadata:
          type: object
    AnchorResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Anchor'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    AnchorCollection:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Anchor'
        meta:
          $ref: '#/components/schemas/CollectionMeta'
    Correction:
      type: object
      properties:
        id:
          type: string
          description: ULID with cor_ prefix
        document_id:
          type: string
        workspace_id:
          type: string
        anchor_id:
          type:
          - string
          - 'null'
        rfi_id:
          type:
          - string
          - 'null'
        field_id:
          type: string
        field_key:
          type: string
        original_value:
          type:
          - string
          - 'null'
        corrected_value:
          type: string
        correction_type:
          type: string
          enum:
          - minor
          - non_trivial
          description: 'Auto-classified: minor if abs(length_delta)<=2, no digits, no currency/percent symbols. Otherwise
            non_trivial.

            '
        status:
          type: string
          enum:
          - pending_verifier
          - approved
          - rejected
          - auto_applied
        decided_by:
          type:
          - string
          - 'null'
        decided_at:
          type:
          - string
          - 'null'
          format: date-time
        created_by:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type:
          - string
          - 'null'
          format: date-time
        version:
          type: integer
        metadata:
          type: object
    CorrectionCreate:
      type: object
      required:
      - corrected_value
      properties:
        original_value:
          type: string
        corrected_value:
          type: string
        anchor_id:
          type: string
        rfi_id:
          type: string
        field_id:
          type: string
        field_key:
          type: string
        metadata:
          type: object
    CorrectionUpdate:
      type: object
      required:
      - version
      properties:
        version:
          type: integer
          description: Required for optimistic concurrency
        status:
          type: string
          enum:
          - pending_verifier
          - approved
          - rejected
          - auto_applied
        corrected_value:
          type: string
        metadata:
          type: object
    CorrectionResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Correction'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    CorrectionCollection:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Correction'
        meta:
          $ref: '#/components/schemas/CollectionMeta'
    ReaderNodeCache:
      type: object
      properties:
        id:
          type: string
        document_id:
          type: string
        source_pdf_hash:
          type: string
        ocr_version:
          type: string
        quality_flag:
          type: string
          enum:
          - ok
          - suspect_mojibake
          - unreadable
          - missing_text_layer
        nodes:
          type: array
          items:
            type: object
        page_count:
          type: integer
        cached:
          type: boolean
          description: 'false when returning fallback (no cache entry found), true or omitted when returning from DB cache

            '
        created_at:
          type: string
          format: date-time
        metadata:
          type: object
    ReaderNodeResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/ReaderNodeCache'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    OcrEscalation:
      type: object
      properties:
        id:
          type: string
          description: ULID with oce_ prefix
        document_id:
          type: string
        workspace_id:
          type: string
        escalation_type:
          type: string
          default: ocr_reprocess
        status:
          type: string
          enum:
          - pending
          - resolved
          - dismissed
        requested_by:
          type: string
        resolved_by:
          type:
          - string
          - 'null'
        resolved_at:
          type:
          - string
          - 'null'
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type:
          - string
          - 'null'
          format: date-time
        version:
          type: integer
        metadata:
          type: object
        _mock:
          type: boolean
          description: Always true â€” OCR pipeline not yet implemented
        _note:
          type: string
    OcrEscalationResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/OcrEscalation'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    BatchHealth:
      type: object
      properties:
        batch_id:
          type: string
        counts:
          type: object
          properties:
            rfis_open:
              type: integer
            rfis_awaiting_verifier:
              type: integer
            corrections_pending:
              type: integer
            mojibake_suspect_docs:
              type: integer
            reader_unreadable_docs:
              type: integer
        blockers:
          type: array
          items:
            type: string
        updated_at:
          type: string
          format: date-time
    BatchHealthResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/BatchHealth'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    Rfi:
      type: object
      description: Request for Information (v2.5 core + v2.51 custody_status)
      properties:
        id:
          type: string
        document_id:
          type: string
        workspace_id:
          type: string
        field_id:
          type: string
        question:
          type: string
        status:
          type: string
          enum:
          - open
          - responded
          - closed
          description: Legacy v2.5 status
        custody_status:
          type:
          - string
          - 'null'
          enum:
          - open
          - awaiting_verifier
          - returned_to_analyst
          - resolved
          - dismissed
          description: v2.51 custody lifecycle status (additive)
        created_by:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type:
          - string
          - 'null'
          format: date-time
        version:
          type: integer
        metadata:
          type: object
    RfiCollection:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Rfi'
        meta:
          $ref: '#/components/schemas/CollectionMeta'
  responses:
    StaleVersion:
      description: Optimistic concurrency conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          example:
            error:
              code: STALE_VERSION
              message: Resource has been modified since your last read
              details:
                current_version: 5
                provided_version: 3
            meta:
              request_id: req_abc123
              timestamp: '2026-02-12T00:00:00Z'
  securitySchemes:
    GoogleOAuth:
      type: oauth2
      description: 'Google OAuth 2.0 (OIDC) for production human users. Required for human-governed endpoints (patch transitions,
        approvals, annotations).

        '
      flows:
        authorizationCode:
          authorizationUrl: https://accounts.google.com/o/oauth2/v2/auth
          tokenUrl: https://oauth2.googleapis.com/token
          scopes:
            email: Read user email
            profile: Read user profile
    BearerToken:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: 'Server-issued JWT (1h expiry) obtained after Google OAuth code exchange. Used in Authorization header
        for all authenticated requests.

        '
    ScopedApiKey:
      type: apiKey
      in: header
      name: X-API-Key
      description: 'Workspace-scoped API key for sandbox and service ingestion endpoints. Keys carry explicit scopes (e.g.,
        signals:write, batches:write, read:all). Required for service ingestion endpoints (POST /signals, POST /triage-items).
        Accepted as alternative auth on read endpoints.

        '
security:
- BearerToken: []
- ScopedApiKey: []
