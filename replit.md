# Orchestrate OS — Semantic Control Board

## Overview
Orchestrate OS is a governance-only semantic control plane designed to define, validate, and preview semantic rules offline. It serves as a single source of semantic truth for authoring and reviewing semantic rules as configuration. The project aims to improve operator ergonomics, streamline the patch request and review pipeline, and provide an analyst-first reference for explicit, deterministic, and auditable decisions. It captures semantic decisions as reviewable configuration artifacts and operates offline-first, ensuring deterministic outputs using only the Python standard library for local previews.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
The core design principle involves capturing semantic decisions as reviewable configuration artifacts. The system uses a canonical join strategy for data handling and a Config Pack Model with strict version matching. It supports an 11-status lifecycle for patch requests, including comment systems and role-based access control (Analyst, Verifier, Admin, Architect).

The UI features a dashboard with a queue-centric sidebar, right-side drawers for data sources and record details, and role-based navigation. Admin configurations are presented in a workflow-ordered view. A Patch Studio facilitates drafting, preflight checks, and evidence packing with live previews and revision tracking. UI elements include color-coded grid highlighting, Excel-style column headers, and a PDF viewer.

Data handling supports CSV/XLSX import, inline editing, and a lock-on-commit mechanism. A change map engine tracks cell-level changes. The Verifier Triage employs a 4-queue system, and a localStorage-backed mock filesystem manages artifacts. Workbook session caching persists uploaded Excel data to IndexedDB, supporting multi-session storage and auto-save. Triage Analytics schema matching uses normalized key comparison and `COLUMN_ALIAS_MAP` resolution to match workbook headers against canonical keys.

Semantic rules generate deterministic cell-level signals on dataset load using `field_meta.json` and `qa_flags.json` for validation, populating Analyst Triage queues and driving grid coloring. Rules follow a WHEN/THEN pattern. Record identity is defined by `tenant_id`, `division_id`, `dataset_id`, `record_id`. The system uses email-based access control with Google sign-in for production OAuth.

Features include "Catalog Items Group" for batch adding and deduplication. Export functionality generates XLSX files including all data sheets, change logs, signals summaries, and metadata. An Audit Timeline system uses an IndexedDB-backed store for all governance actions, accessible via a UI with filtering options and exportable to XLSX.

The system incorporates a Schema Tree Editor for managing the canonical rules bundle, including `field_meta.json`, `hinge_groups.json`, `sheet_order.json`, `qa_flags.json`, `document_types.json`, and `column_aliases.json`. It supports column alias resolution and tracking of schema changes. A Batch Merge feature allows combining source batches into a single governance container, with explicit rule promotion for tenant rules.

Document roles are inferred with user confirmation. A `SystemPass` module provides a deterministic, rerunnable, proposal-only engine for system changes, routed to a "System Changes" triage bucket. Pre-Flight triage buckets handle blockers like unknown columns or unreadable OCR. A Contract Index Engine builds a hierarchy of batch→contract→document→sheet→row, persisting summary references to SessionDB.

`SystemPass.acceptProposal()` for hinge-field proposals auto-creates a `system_suggested` patch artifact and routes it through the standard patch lifecycle. `UndoManager` provides local, session-scoped undo for draft-only SRR inline edits. `RollbackEngine` creates governed rollback artifacts at 4 scopes (field, patch, contract, batch), capturing before/after state snapshots and triggering reruns if hinge-field modifications are detected. Audit events are generated for all these actions.

The Triage Analytics module aggregates metrics into a lightweight cache, rendering above the triage grid with 3-lane cards, a horizontal lifecycle tracker, and a contract summary drilldown table. Triage Telemetry provides live pipeline telemetry with processing status banners, lifecycle deltas, and derived contract state chips. Record Inspector Guidance provides section-specific advice and knowledge links.

Contract ID derivation enforces priority. ContractIndex is always rebuilt from the workbook on all load paths. Unknown column routing uses sheet-scoped frequency voting for contract attachment with severity thresholds. Header-echo rows are removed at parse time. Sandbox mode is permissionless; Production uses strict role gates. A Pre-Flight Calibration Suite ensures the accuracy of pre-flight detectors. A TruthPack module with an `architect` role enables a clean-room state machine for calibration and baseline marking. A Role Registry with stable role IDs, permission-based access checks, and a People workspace are integrated. Truth Config versioning stores baselines in SessionDB with a test_mode/established lifecycle and rollback capability. An Invite system provides single-use invite creation, use, and revocation with audit events.

The system routes to triage by default for all roles. Contract-first navigation is implemented in the All Data Grid. A legacy double-slash annotation sanitizer cleans URL and business fields during XLSX and CSV parsing. Pre-Flight items now include sheet-specific tabs and show more human-readable labels for blockers.

## External Dependencies
A FastAPI server acts as a local PDF proxy for CORS-safe PDF fetching and text extraction using PyMuPDF. SheetJS (XLSX) is loaded via CDN for Excel import/export functionality. The application includes several modules for specific functionalities:
- **P1C Contract Composite Grid**: Enhances the All Data Grid with nested, collapsible sheet sections when a specific contract is selected.
- **P1F Batch PDF Scan**: Adds batch-level PDF scanning for mojibake/non-searchable content on workbook load, routing flagged contracts to Pre-Flight.
- **P1X Canonical Contract Triage View**: Adds canonical triage metrics and contract-centric terminology, refining how sheets count towards canonical record totals and displaying OCR issues.
- **P1E PDF Reliability Spike**: Diagnoses and hardens PDF anchor search reliability, including mojibake/non-searchable detection and improved anchor matching strategies.
- **P1D.1 Contract Health Pre-Flight Table**: Replaces card-based grouping with a single unified nested table for contract health, displaying parent contract rows with expandable child issue rows.
- **P1F.1 Real-Time Pre-Flight Intake**: Provides real-time visibility into the batch PDF scan as it processes files, displaying live status and immediately emitting Pre-Flight items upon detection.
- **P1F.2 Clean-to-SystemPass Routing**: Routes clean-scanned contracts (no OCR/mojibake issues) to the System Pass queue as `PDF_VERIFIED_CLEAN` signals. Adds contract rollup status fields (`preflight_pdf_status`, `preflight_pdf_clean_at`, `preflight_pdf_run_id`, `preflight_pdf_reason_codes`). Fixes metric deduplication, enforces `affected_contracts <= total_contracts`. Pre-Flight table ID column strips `file:` prefix, Source column is clickable with URL tooltip. Live intake auto-collapses on scan completion into a compact summary with toggle.
- **P1G Contract Health Score**: A lifecycle-wide health scoring engine that tracks contract health from extraction through promotion. Computes a 0-100 score using a penalty model (Pre-Flight blockers=20, warnings=5, capped at 60; System Pass ready=10, proposals pending=15; lifecycle stage penalties; unknown columns=6; doc type missing=8; staleness=2 per 30min capped at 10). Health bands: Critical (0-34, red), At Risk (35-59, orange), Watch (60-84, yellow), Healthy (85-100, green). Health column appears in Contract Summary table plus all lifecycle queue tables: Pre-Flight (P1D.1), System Pass, Patch Console, and generic triage queues. Scores are mirrored from the central ContractHealthScore engine into each table, with colored band chips and penalty breakdown tooltips. Filter chips (Critical, At Risk, Watch, Healthy, All) allow filtering Contract Summary by health band. Worst-first sorting surfaces critical contracts. Trend tracking shows score deltas between refreshes.
### Recent Changes (P1F UX/Triage Follow-up)
- **PDF scan banner**: 3-second auto-fade after completion, hover-hold behavior (mouseenter pauses fade, mouseleave resumes), completion toast with clean/flagged counts, `[PDF-RELIABILITY][P1E-FOLLOWUP]` logs.
- **Returning-session change detection**: Fingerprint-based scan diff detection on session restore. Computes hash from contract IDs + issue signatures, stores in localStorage, compares on reload. Shows toast "Pre-Flight changed since last session: +X/-Y issues across Z contracts" when changed.
- **Accounts guidance specificity**: getSectionGuidance now tries exact sheetName match first, then normalized match, then docRole::docType, then docRole alone, then 'default'. Logs `guidance_section_resolved:<section>` or `guidance_fallback_used`.
- **SRR panel swap**: CSS order property swaps Field Inspector to right, Patch Editor to left. Patch editor auto-collapses on row open in analyst mode, auto-expands on field select, auto-collapses after submit/save.
- **Catalog Group UX**: Simplified from toggle-then-button to single "Set Catalog Group" direct action. Removed On/Off status indicator.
- **Pre-Flight child row dedupe**: Duplicate child issue rows collapsed by composite key (contract_id|sheet_name|field_name|blocker_type|severity) with "x2" count badges. Parent row aggregation uses deduped counts.
- **Contract/source naming**: Already implemented — file: prefix stripped from ID column, human-friendly clickable source labels.
- **Pre-Flight Contract Section + Glossary Term Mapping**: Canonical section normalization via `_SECTION_CANON` map (accounts→Accounts, v2_add_ons→V2 Add Ons, etc.) with Title Case fallback. Field term resolution via `resolvePreflightFieldTerm` using `field_meta.json` glossary: exact (section+key) → global (key) → humanized → unknown. `enrichPreflightItem` stamps `contract_section_key`, `contract_section_label`, `field_label`, `reason_code`, `reason_label` on all Pre-Flight items. Term cache invalidated per render cycle. Child rows show enriched labels (field_label primary + field_key secondary + definition tooltip). Section chips, sheet tabs, and filters all group by `contract_section_label`. Stats logged via `[PREFLIGHT-TERMS][MAP]`.
- **Pre-Flight Parent Dedupe + Contract-Key Grouping**: `resolvePreflightContractKey(item)` derives stable `contract_group_id` via 4-level resolution: contract_id → row lookup → canonical URL hash → slug fallback. `_p1dGetGroupKey` now resolves and caches `_contract_group_id` on each item. Parent rows group strictly at contract level (no ROW_* parent IDs). Parent ID column shows `ctr_*` slugs. Child dedupe uses `contract_group_id|contract_section_key|reason_code|field_key|severity`. Section chips aggregate from deduped children only. Counters reconciled: Affected Contracts = unique(contract_group_id), Records Impacted = unique(record_id). Health score lookup tries both `ctr_*` key and original contract_key. View Contract button passes original contract_key for grid navigation. Logging: `[P1D-DEDUPE][GROUP]`, `[P1D-DEDUPE][COUNTS]`, `[P1D-DEDUPE][FALLBACK]`.
### Recent Changes (V1 SRR + Pre-Flight Enrichment)
- **Pre-Flight ingress enrichment**: `enrichPreflightItem(item)` now called inside `_p1fRouteToPreFlight` at ingress time, so all batch scan items get contract_section_label, field_label, and field_definition stamped before entering triage queues. Fixed `_SECTION_CANON` map: 'opportunity' correctly maps to 'Opportunities'.
- **V1 SRR Contract/Account Context**: Contract View / Account View toggle pills in Field Inspector header. Account selector dropdown populated deterministically from ContractIndex sheets via `_srrGetAccountName()` using `isAccountNameField()` and `ACCOUNT_NAME_ALIASES`. Account switching preserves sheet context and reopens the correct row. `srrState` extended with `contextMode`, `accountOptions`, `selectedAccountIdx`.
- **V1 SRR Patch Prefill Templates**: `_PATCH_PREFILL_TEMPLATES` maps 6 issue types (OCR_MOJIBAKE, MISSING_REQUIRED, PICKLIST_INVALID, RESOLVER_MISMATCH, UNKNOWN_COLUMN, DOC_EVIDENCE_MISMATCH) to observation_type, expected_type, repro_type, and justification. `srrPrefillPatchTemplate(issueSource)` applies template to draft form. Repro file input shown only when `doc_evidence_mismatch` selected.
- **V1 SRR Doc Type Modal**: "+ Add New Doc Type..." option in SRR doc type dropdown opens wizard modal with name + justification fields. `srrSubmitNewDocType()` creates a governed patch artifact with `action_type: ADD_DOC_TYPE` routed through standard patch lifecycle.
- **V1 SRR Contract Preflight Gate**: `srrCheckContractPreflightGate()` scans `analystTriageState.manualItems` + `_p1fBatchScanItems` for unresolved blockers matching current contract. Blocks submit with explicit reason list (max 3 shown, overflow count). Called in `srrSubmitPatchRequest` after evidence gate.
