# Orchestrate OS — Semantic Control Board

## Overview
Orchestrate OS is a governance-only semantic control plane designed to define, validate, and preview semantic rules offline. It acts as a single source of semantic truth, enabling rule authoring and review as configuration. The project aims to improve operator ergonomics, streamline the patch request and review pipeline, and provide an analyst-first reference with clear interfaces for explicit, deterministic, and auditable decisions. It captures semantic decisions as reviewable configuration artifacts and operates offline-first, ensuring deterministic outputs using only the Python standard library for local previews.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
The core design involves capturing semantic decisions as reviewable configuration artifacts. Data handling employs a canonical join strategy and a Config Pack Model with strict version matching. The system supports an 11-status lifecycle for patch requests, including comment systems and role-based access control (Analyst, Verifier, Admin, Architect).

The UI features a dashboard with a queue-centric sidebar, right-side drawers for data sources and record details, and role-based navigation. Admin configurations are presented in a workflow-ordered view. A Patch Studio enables drafting, preflight checks, and evidence packing with live previews and revision tracking. UI elements include color-coded grid highlighting, Excel-style column headers, and a PDF viewer. Record Inspection (SRR) provides navigation.

Data handling supports CSV/XLSX import, a Field Inspector for search-filtered fields, inline editing, and a lock-on-commit mechanism. A change map engine tracks cell-level changes. The Verifier Triage uses a 4-queue system, and a localStorage-backed mock filesystem manages artifacts. Workbook session caching persists uploaded Excel data to IndexedDB, supporting multi-session storage and auto-save.

Semantic rules generate deterministic cell-level signals on dataset load using `field_meta.json` and `qa_flags.json` for validation, populating Analyst Triage queues and driving grid coloring. Rules follow a WHEN/THEN pattern. Record identity is defined by `tenant_id`, `division_id`, `dataset_id`, `record_id`. The system uses email-based access control with Google sign-in for production OAuth.

Features include "Catalog Items Group" for batch adding and deduplication, and a `_document_type` and `_capabilities` object per record, with document types loaded from `config/document_types.json`. Export functionality generates XLSX files including all data sheets, change logs, signals summaries, and metadata. An Audit Timeline system uses an IndexedDB-backed store for all governance actions, accessible via a UI with filtering options and exportable to XLSX.

The system incorporates a Schema Tree Editor for managing the canonical rules bundle, including `field_meta.json`, `hinge_groups.json`, `sheet_order.json`, `qa_flags.json`, `document_types.json`, and `column_aliases.json`. It supports column alias resolution and tracking of schema changes. A Batch Merge feature allows combining source batches into a single governance container, with explicit rule promotion for tenant rules.

Document roles are inferred with user confirmation. A `SystemPass` module provides a deterministic, rerunnable, proposal-only engine for system changes, routed to a "System Changes" triage bucket. Pre-Flight triage buckets handle blockers like unknown columns or unreadable OCR. A Contract Index Engine builds a hierarchy of batch→contract→document→sheet→row, persisting summary references to SessionDB.

The `SystemPass.acceptProposal()` for hinge-field proposals auto-creates a `system_suggested` patch artifact and routes it through the standard patch lifecycle. `UndoManager` provides local, session-scoped undo for draft-only SRR inline edits. `RollbackEngine` creates governed rollback artifacts at 4 scopes (field, patch, contract, batch), capturing before/after state snapshots and triggering reruns if hinge-field modifications are detected. Audit events are generated for all these actions.

The Triage Analytics module aggregates metrics from various stores into a lightweight cache, rendering above the triage grid with 3-lane cards (Pre-Flight, Semantic, Patch Review), a horizontal lifecycle tracker, and a contract summary drilldown table. Triage Telemetry provides live pipeline telemetry with processing status banners, lifecycle deltas, and derived contract state chips. Record Inspector Guidance provides section-specific advice and knowledge links.

Contract ID derivation enforces priority (extracted path ID → hash(canonical URL) → fallback signature). ContractIndex is always rebuilt from the workbook on all load paths. Unknown column routing uses sheet-scoped frequency voting for contract attachment with severity thresholds. Header-echo rows are removed at parse time. Sandbox mode is permissionless; Production uses strict role gates. A Pre-Flight Calibration Suite ensures the accuracy of pre-flight detectors. A TruthPack module with an `architect` role enables a clean-room state machine for calibration and baseline marking. P0.7 adds a Role Registry with stable role IDs (`architect`, `admin`, `verifier`, `analyst`), permission-based access checks, and a People workspace (Members/Roles/Invites). Truth Config versioning stores baselines in SessionDB with a test_mode/established lifecycle and rollback capability. An Invite system provides single-use invite creation, use, and revocation with audit events.

### P0.7 Truth Config + Role Governance + People (v2.3)
13 targeted edits via `scripts/p07_delta.py` + 6 post-apply quote-escaping fixes: (A) Role Registry with stable IDs (`architect`, `admin`, `verifier`, `analyst`), permissions arrays, `getRoleRegistry`/`saveRoleRegistry`/`hasPermission` functions, `migrateRoleLegacy` for label→ID normalization. (B) TruthConfig module: versioned baselines stored in SessionDB.WORKBOOK_STORE with pointer in localStorage (`active_truth_version_id`), lifecycle: upload→test_mode→established→rollback. Controls: Upload Truth Config (JSON file), Create Baseline (runtime snapshot), Set Test Mode, Promote to Established (with confirm), Rollback Baseline (Admin+Architect). (C) InviteManager: single-use invite system with `active`→`used`/`expired`/`revoked` status lifecycle, member creation on use with assigned role, expiry support. (D) People workspace: new Admin panel tab with Members/Roles/Invites sub-tabs; Members shows user table with role assignment dropdowns; Roles shows registry with architect-only inline editing of display names and active toggle; Invites shows create form and status table. (E) UI: status chips (`No Baseline`/`Test Mode`/`Established`) in truth config controls and calibration panel, version readout, compact buttons. (F) ES5 fixes: `const`→`var`, arrow→`function()`, `forEach`→`for`, `includes`→`indexOf`, `dataset.adminTab`→`getAttribute('data-admin-tab')`, dynamic HTML quote conflicts fixed with `"'" +` concatenation pattern. (G) Audit events: `truth_config_uploaded`, `truth_baseline_created`, `truth_mode_set`, `truth_baseline_promoted`, `truth_baseline_rolled_back`, `invite_created`, `invite_used`, `invite_revoked`, `member_role_assigned`, `role_display_updated`. Runtime attestation: P0.2.2 GREEN (13/13), P1 GREEN (10/10), Calibration GREEN (7/7, 4/4), P0.7 GREEN (13/13).

### P0.8 Triage Record-Link Integrity (v2.3.1)
Applied via `scripts/p08_delta.py`: (A) Unified triage record resolver `resolveRecordForTriageItem(item, activeDatasetId)` with 5-step fallback: exact_record → sheet_row → contract_field → contract_grid → unresolved_modal. (B) Rewired `openSignalTriageItem`, `openPreflightItem`, `openAnalystTriageItem` to use the unified resolver — eliminates fallback toast "Please load the associated dataset". (C) Unresolved-record diagnostics modal (`p08-unresolved-modal`) with item summary, debug JSON, and actions: Open Contract in Grid, Open Sheet Row, Copy Debug JSON, Dismiss. (D) Dataset mismatch purge `p08PurgeStaleTriageItems(newDatasetId)` hooked into both workbook load paths — removes PATCH_REQUEST_STORE items whose dataset_id doesn't match the new active dataset. (E) Deterministic `[P0.8-LINK]` logging: route_attempt, route_resolved_record, route_resolved_contract, route_unresolved_modal, dataset_mismatch_purged. (F) Audit events: `triage_record_unresolved`, `dataset_mismatch_purged`. (G) ES5 compliant. Runtime attestation: P0.8 GREEN (15/15), P0.2.2 GREEN, P1 GREEN (10/10), Calibration GREEN (7/7, 4/4).

### P0.9 Runtime Cleanup + Data Hygiene (v2.3.2)
Applied via `scripts/p09_delta.py` (19 edits): (A) Default route to triage for all roles (analyst, verifier, admin, architect) with `[P0.9-CLEANUP] route_default_triage` log. (B) Contract-first navigation in All Data Grid — contract selector appears before sheet selector with `contract_filter_primary` log. (C) False unresolved routing noise eliminated — `executeTriageResolution` logs `ds_route_resolved` for valid items, no stale-dataset toasts for active dataset items. (D) Legacy double-slash annotation sanitizer `sanitizeDoubleSlashAnnotations()`: URL fields split to clean URL + imported annotation, business fields split value//annotation into clean value + `_imported_comment` metadata, hooked into both XLSX and CSV parse paths, `legacy_slash_sanitized` audit event. (E) Pre-Flight/Schema consistency: `handleSchemaClick` empty-state shows source-specific explanation (e.g., "batch-level drift only" for Schema Drift). (F) Guidance label cleanup: "Unknown/Unknown" chips replaced with sheet-derived labels (e.g., "Contract A Guidance") with `guidance_labels_resolved` log. (G) Analyst replay hide: replay-contract controls hidden for Analyst, visible for Verifier/Admin only. (H) Top-bar overlap cleanup: toast positioned at `top:100px` clear of sticky toolbar, audit container has `position:relative` for proper dropdown anchoring, `overlap_guard_ok` log. (I) ES5 fixes in `setMode()` and init: `const`→`var`, arrow→`function()`, template literals→concatenation. Runtime attestation: P0.9 GREEN (10/10), P0.8 GREEN (15/15), P0.2.2 GREEN, P1 GREEN (10/10), Calibration GREEN (7/7, 4/4).

### P1A Triage Clarity + Sheet-Scoped Pre-Flight (v2.3.3)
Applied via `scripts/p1a_delta.py` (12 edits) + post-apply fixes (quote escaping in tab builder, `_preflightBlockerTypes` hoisted to global scope): (A) Pre-Flight label cleanup: `getTriageTypeLabel` returns human-readable labels (`Missing Required`, `Invalid Picklist`, `Encoding Issue`, `Extraction Error`, etc.) with internal codes as tooltips via `getTriageTypeTip`. Label map `_p1aLabelMap` provides both label and tooltip for each type. (B) Pre-Flight sheet tabs: tab bar above Pre-Flight queue (`p1a-preflight-sheet-tabs`) with `All` + per-sheet tabs showing item counts. `_p1aBuildSheetTabs` builds tabs, `_p1aFilterBySheet` filters items, `_p1aSelectSheet` handles tab clicks. Deterministic tab counts match filtered row counts. (C) Record column clarity: Pre-Flight rows show `Contract + Sheet:Row` when available (e.g., `CTR-001 Accounts:5`), or `Batch-level` when no row-level info exists. Non-preflight items unchanged. (D) Reason column: blocker type chips show human-readable label (e.g., `Missing Required` not `MISSING_REQUIRED`) with hover tooltip from `_preflightBlockerTypes.desc`. (E) Schema deep-link behavior: `handleSchemaClick` shows batch-level explanation when items have no row target (`"N item(s) found. This is batch-level drift; no individual record row available. Items are listed in the Pre-Flight queue below."`). Drift empty-state updated with explicit batch-level messaging. `[P1A] schema_deeplink_batch_level` and `schema_deeplink_navigate` logs. (F) `_preflightBlockerTypes` hoisted to global scope with new entries: `MISSING_REQUIRED` (fail), `PICKLIST_INVALID` (warn). `DOCUMENT_TYPE_MISSING` label updated to `Document Type Missing`. (G) `sheet_name` propagation: UNKNOWN_COLUMN and extraction blocker items now include `sheet_name`, `contract_id`, `contract_key` fields. (H) Filtered count: Pre-Flight queue count reflects active sheet filter. (I) CSS: `.p1a-sheet-tab` hover transitions. (J) ES5 compliant throughout. Logging prefix: `[P1A]`. Runtime attestation: P1A GREEN (12/12), P0.2.2 GREEN, P1 GREEN (10/10), Calibration GREEN (7/7, 4/4), P0.8 GREEN (15/15), P0.9 GREEN.

## External Dependencies
A FastAPI server acts as a local PDF proxy for CORS-safe PDF fetching and text extraction using PyMuPDF. SheetJS (XLSX) is loaded via CDN for Excel import/export functionality.